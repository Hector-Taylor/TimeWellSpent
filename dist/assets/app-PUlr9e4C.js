import{r as t,j as e,c as Nt,R as wt}from"./client-D_dPGLb3.js";const hs=4;function St(s,n=hs){return((s-n)%24+24)%24}function kt(s,n=hs){const a=new Date(s);return a.getHours()<n&&a.setDate(a.getDate()-1),a.setHours(n,0,0,0),a.getTime()}function Ct(s){const n=s.trim().replace(/^site:/i,"");if(!n||/^app:/i.test(n))return null;const a=n.replace(/^\*\./,""),i=/^https?:\/\//i.test(a)?a:`https://${a}`;try{const d=new URL(i),u=d.hostname.replace(/^www\./i,"").replace(/\.$/,"").toLowerCase();if(!u)return null;const o=d.pathname&&d.pathname!=="/"?d.pathname.replace(/\/+$/,""):"";return`${u}${o}`}catch{const d=a.replace(/^https?:\/\//i,""),u=(d.split(/[/?#]/)[0]??"").replace(/:\d+$/,"").replace(/^www\./i,"").replace(/\.$/,"").toLowerCase();if(!u)return null;const o=d.indexOf("/");if(o<0)return u;const v=d.slice(o).split(/[?#]/)[0]?.trim()??"",x=v&&v!=="/"?v.replace(/\/+$/,""):"";return`${u}${x}`}}function Is(s){const n=s.trim();if(!n)return null;if(/^app:/i.test(n)){const i=n.replace(/^app:/i,"").trim().toLowerCase();return i?{kind:"app",value:i}:null}const a=Ct(n);return a?{kind:"site",value:a}:null}function Mt({api:s}){const[n,a]=t.useState(null),[i,d]=t.useState(0),[u,o]=t.useState("strict"),[v,x]=t.useState(25),[N,S]=t.useState(5),[M,g]=t.useState(5),[D,p]=t.useState([]),[y,F]=t.useState([]),[A,w]=t.useState(""),[l,f]=t.useState(!1);t.useEffect(()=>{s.pomodoro.status().then(G=>{G&&(a(G),d(G.remainingMs),o(G.mode))});const k=s.events.on("pomodoro:tick",G=>{a($=>$?{...$,...G}:G),d(G.remainingMs)}),R=s.events.on("pomodoro:start",G=>{a(G),d(G.remainingMs),o(G.mode)}),Y=s.events.on("pomodoro:stop",()=>{a(null),d(0)}),B=s.events.on("pomodoro:pause",G=>a(G)),Z=s.events.on("pomodoro:resume",G=>a(G));return()=>{k(),R(),Y(),B(),Z()}},[s]),t.useEffect(()=>{s.settings.categorisation().then(k=>{const R=(k?.productive??[]).map($=>Is($)).filter($=>$!=null&&$.kind==="site"),Y=[{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"},{value:"github.com",kind:"site"},{value:"stackoverflow.com",kind:"site"}],B=[...R,...Y],Z=[],G=new Set;for(const $ of B){const q=`${$.kind}:${$.value.toLowerCase()}`;G.has(q)||(G.add(q),Z.push($))}F(Z),p(Z.slice(0,3))}).catch(()=>{F([{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"}]),p([{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"}])})},[s.settings]);const C=t.useMemo(()=>{const k=n?i:v*60*1e3,R=Math.max(0,Math.round(k/1e3)),Y=Math.floor(R/60),B=R%60;return`${Y.toString().padStart(2,"0")}:${B.toString().padStart(2,"0")}`},[i,v,n]);async function I(){try{f(!0);const k=D.map((B,Z)=>({id:`${B.value}-${Z}`,kind:B.kind,value:B.value})),R={durationSec:v*60,breakDurationSec:N*60,mode:u,allowlist:k,temporaryUnlockSec:M*60},Y=await s.pomodoro.start(R);a(Y),d(Y.remainingMs)}catch(k){console.error("Failed to start pomodoro",k)}finally{f(!1)}}function r(k){const R=Is(k);if(!R)return;const Y=`${R.kind}:${R.value.toLowerCase()}`;D.some(B=>`${B.kind}:${B.value.toLowerCase()}`===Y)||p(B=>[...B,R])}function j(k){p(R=>R.filter(Y=>!(Y.kind===k.kind&&Y.value===k.value)))}async function P(k="canceled"){f(!0);try{await s.pomodoro.stop(k),a(null),d(0)}catch(R){console.error("Failed to stop pomodoro",R)}finally{f(!1)}}async function L(){f(!0);try{const k=await s.pomodoro.pause();a(k)}catch(k){console.error(k)}finally{f(!1)}}async function z(){f(!0);try{const k=await s.pomodoro.resume();a(k)}catch(k){console.error(k)}finally{f(!1)}}async function K(){f(!0);try{const k=await s.pomodoro.startBreak(N*60);a(k)}catch(k){console.error(k)}finally{f(!1)}}return e.jsxs("div",{className:"card pomodoro-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Pomodoro"}),e.jsx("h2",{children:"Allowlist focus"})]}),e.jsx("span",{className:"pill ghost",children:n?n.mode:u})]}),e.jsxs("div",{className:"pomodoro-grid",children:[e.jsxs("div",{className:"pomodoro-timer",children:[e.jsxs("div",{className:"pomodoro-face",children:[e.jsx("span",{className:"pomodoro-time",children:C}),e.jsx("span",{className:"pomodoro-label",children:n?n.state:"idle"})]}),e.jsx("div",{className:"pomodoro-controls",children:n?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>P("canceled"),disabled:l,className:"ghost",children:"End"}),n.state==="paused"?e.jsx("button",{onClick:z,disabled:l,className:"primary",children:"Resume"}):e.jsx("button",{onClick:L,disabled:l,className:"ghost",children:"Pause"}),e.jsx("button",{onClick:K,disabled:l,className:"ghost",children:"Start break"})]}):e.jsx("button",{onClick:I,disabled:l,className:"primary",children:"Start focus"})})]}),e.jsxs("div",{className:"pomodoro-config",children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Duration (minutes)"}),e.jsx("input",{type:"number",min:5,max:180,value:v,onChange:k=>x(Number(k.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Break length (minutes)"}),e.jsx("input",{type:"number",min:1,max:60,value:N,onChange:k=>S(Number(k.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Mode"}),e.jsxs("div",{className:"segmented",children:[e.jsx("button",{className:u==="strict"?"active":"",onClick:()=>o("strict"),children:"Strict"}),e.jsx("button",{className:u==="soft"?"active":"",onClick:()=>o("soft"),children:"Soft"})]})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Soft unlock minutes"}),e.jsx("input",{type:"number",min:1,max:30,value:M,onChange:k=>g(Number(k.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsxs("div",{className:"field-label",children:[e.jsx("span",{children:"Allowlist"}),e.jsx("span",{className:"info-tooltip",title:"Add productive domains in the Domains section!",children:"?"})]}),e.jsxs("div",{className:"allowlist-picker",children:[e.jsxs("select",{value:"",onChange:k=>{r(k.target.value)},children:[e.jsx("option",{value:"",disabled:!0,children:"Select a site"}),y.filter(k=>!D.some(R=>R.value===k.value&&R.kind===k.kind)).map(k=>e.jsx("option",{value:k.value,children:k.value},k.value))]}),e.jsxs("div",{className:"allowlist-custom",children:[e.jsx("input",{type:"text",placeholder:"site.com or app:Slack",value:A,onChange:k=>w(k.target.value)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{r(A),w("")},disabled:!A.trim(),children:"Add"})]}),D.length>0&&e.jsx("div",{className:"allowlist-tags",children:D.map(k=>e.jsxs("span",{className:"pill",children:[k.kind==="app"?`app:${k.value}`:k.value,e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>j(k),"aria-label":`Remove ${k.value}`,children:"Ã—"})]},`${k.kind}:${k.value}`))})]})]})]})]})]})}const Te={productive:"var(--cat-productive)",neutral:"var(--cat-neutral)",frivolity:"var(--cat-frivolity)",draining:"var(--cat-draining)",idle:"var(--cat-idle)"};function Pt({summary:s,economy:n}){const[a,i]=t.useState("aggregate"),[d,u]=t.useState(null),o=t.useMemo(()=>{if(!s)return null;const p=s.totalsByCategory,y=[{key:"productive",label:"Productive",seconds:p.productive??0,color:Te.productive},{key:"neutral",label:"Neutral",seconds:(p.neutral??0)+(p.uncategorised??0),color:Te.neutral},{key:"frivolity",label:"Frivolity",seconds:p.frivolity??0,color:Te.frivolity},{key:"draining",label:"Draining",seconds:p.draining??0,color:Te.draining},{key:"idle",label:"Idle",seconds:p.idle??0,color:Te.idle}].filter(l=>l.seconds>0),F=y.reduce((l,f)=>l+f.seconds,0);let A=-90;return{arcs:y.map(l=>{const f=F?l.seconds/F*360:0,C=Rs(150,150,120,A,A+f);return A+=f,{path:C,color:l.color,label:l.label,seconds:l.seconds}}),slices:y,totalSeconds:Math.max(0,F)}},[s]),v=t.useMemo(()=>{if(!s||s.timeline.length===0)return{arcs:[],centerSeconds:0};const p=360/s.timeline.length,y=(s.windowHours??24)*3600,F=s.timeline.map((w,l)=>{const f=l*p-90,C=f+p,I=Rs(150,150,120,f,C),r=Te[w.dominant]??Te.neutral;return{path:I,color:r,label:w.hour,slot:w,seconds:w.productive+w.neutral+w.frivolity+w.draining+w.idle}}),A=Math.min(y,(s.totalSeconds??0)+(s.totalsByCategory.idle??0));return{arcs:F,centerSeconds:A}},[s]);if(!s)return e.jsxs("article",{className:"card compass-card",children:[e.jsx("h2",{children:"Day compass"}),e.jsx("p",{className:"subtle",children:"We need at least one tracked session to build your orbit."})]});const x=a==="timeline"?d!==null?s.timeline[d]:s.timeline[s.timeline.length-1]:null,N=x?.dominant,S=a==="aggregate"?o?.slices??[]:x?[{label:"Productive",seconds:x.productive,color:Te.productive},{label:"Neutral",seconds:x.neutral,color:Te.neutral},{label:"Frivolity",seconds:x.frivolity,color:Te.frivolity},{label:"Draining",seconds:x.draining,color:Te.draining},{label:"Idle",seconds:x.idle,color:Te.idle}]:[],M=(s?.windowHours??24)*3600,g=a==="aggregate"?Math.min(M,o?.totalSeconds??0):v.centerSeconds,D=a==="aggregate"?o?.arcs??[]:v.arcs;return e.jsxs("article",{className:"card compass-card",children:[e.jsxs("div",{className:"card-header-row compass-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day diagram"}),e.jsx("h2",{children:"Orbit of attention"})]}),e.jsxs("div",{className:"compass-controls",children:[e.jsxs("div",{className:"compass-toggle",children:[e.jsx("button",{className:a==="aggregate"?"active":"",onClick:()=>{i("aggregate"),u(null)},children:"Total day"}),e.jsx("button",{className:a==="timeline"?"active":"",onClick:()=>{i("timeline"),u(null)},children:"24h orbit"})]}),e.jsxs("span",{className:"pill ghost",children:[n?.activeCategory??"idle"," â€¢ live"]})]})]}),e.jsxs("div",{className:"compass-body",children:[e.jsxs("div",{className:"compass-visual",children:[e.jsxs("svg",{viewBox:"0 0 300 300",role:"img","aria-label":"Day compass",children:[e.jsx("circle",{cx:"150",cy:"150",r:"140",fill:"rgba(255,255,255,0.02)",stroke:"rgba(255,255,255,0.05)",strokeWidth:"1"}),D.map((p,y)=>e.jsx("path",{d:p.path,fill:p.color,opacity:d!==null&&d!==y?.35:.92,onMouseEnter:()=>u(y),onMouseLeave:()=>u(null)},`${p.label}-${y}`)),e.jsx("circle",{cx:"150",cy:"150",r:"80",fill:"var(--bg-soft)",stroke:"rgba(255,255,255,0.08)",strokeWidth:"2"}),e.jsx("text",{x:"150",y:"140",textAnchor:"middle",className:"compass-center",children:Tt(g)}),e.jsx("text",{x:"150",y:"165",textAnchor:"middle",className:"compass-center-sub",children:a==="aggregate"?"hours captured":`${s.windowHours}h window`})]}),a==="timeline"&&x&&e.jsxs("div",{className:"compass-tooltip",children:[e.jsxs("div",{children:[e.jsx("span",{className:"tooltip-hour",children:x.hour}),e.jsx("span",{className:"tooltip-dominant",children:N})]}),x.topContext?e.jsxs("p",{children:[x.topContext.label,e.jsx("br",{}),e.jsxs("small",{children:[Math.round(x.topContext.seconds/60)," min captured"]})]}):e.jsx("p",{children:"No activity recorded"})]})]}),e.jsx("div",{className:"compass-details",children:S.map(p=>e.jsxs("div",{className:"detail-row",children:[e.jsxs("div",{className:"legend-chip",children:[e.jsx("span",{style:{background:p.color}}),e.jsx("span",{children:p.label})]}),e.jsx("strong",{children:Dt(p.seconds)})]},p.label))})]})]})}function Rs(s,n,a,i,d){const u=Ls(s,n,a,d),o=Ls(s,n,a,i),v=d-i<=180?"0":"1";return["M",u.x,u.y,"A",a,a,0,v,0,o.x,o.y,"L",s,n,"Z"].join(" ")}function Ls(s,n,a,i){const d=i*Math.PI/180;return{x:s+a*Math.cos(d),y:n+a*Math.sin(d)}}function Dt(s){return s?`${Math.round(s/60)}m`:"0m"}function Tt(s){const n=Math.max(0,s)/3600;return`${Math.round(n*10)/10}h`}function $t({activities:s,summary:n}){const a={productive:"var(--cat-productive)",neutral:"var(--cat-neutral)",frivolity:"var(--cat-frivolity)",draining:"var(--cat-draining)",emergency:"var(--cat-emergency)",idle:"var(--cat-idle)"},i=w=>w in a,[d,u]=t.useState(null),o=Date.now()-24*60*60*1e3,v=t.useMemo(()=>{const w={productive:0,neutral:0,frivolity:0,draining:0,emergency:0,idle:0};if(n){const j=n.totalsByCategory,P=j.productive??0,L=(j.neutral??0)+(j.uncategorised??0),z=j.frivolity??0,K=j.draining??0,k=j.emergency??0,R=j.idle??0,Y=P+L+z+K+k+R,B={...w,productive:P,neutral:L,frivolity:z,draining:K,emergency:k,idle:R};return{total:Y,byCategory:B}}const l=s.filter(j=>new Date(j.startedAt).getTime()>=o),f=l.reduce((j,P)=>j+P.secondsActive,0),C=l.reduce((j,P)=>j+P.idleSeconds,0),I=f+C,r={...w};return l.forEach(j=>{const P=j.category||"neutral",L=i(P)?P:"neutral";r[L]+=j.secondsActive}),r.idle=C,{total:I,byCategory:r}},[s,n,o]),x=t.useMemo(()=>{const w={productive:[],neutral:[],frivolity:[],draining:[],emergency:[],idle:[]};if(n?.topContexts)n.topContexts.forEach(l=>{if(!l.category||!i(l.category))return;const f=l.category;w[f].push({label:l.label,seconds:l.seconds})});else{const l=s.filter(C=>new Date(C.startedAt).getTime()>=o),f=new Map;l.forEach(C=>{const I=C.category||"neutral",r=i(I)?I:"neutral",j=C.domain??C.appName??"Unknown",P=`${r}:${j}`;f.has(P)||f.set(P,{label:j,cat:r,seconds:0});const L=f.get(P);L.seconds+=C.secondsActive}),f.forEach(C=>w[C.cat].push({label:C.label,seconds:C.seconds}))}return Object.keys(w).forEach(l=>{w[l]=w[l].sort((f,C)=>C.seconds-f.seconds)}),w},[s,n,o]);if(v.total===0)return e.jsx("div",{className:"card",style:{alignItems:"center",justifyContent:"center",minHeight:"240px"},children:e.jsx("p",{className:"subtle",children:"No activity recorded yet"})});let N=0;const S=90,M=110,D=Object.entries(v.byCategory).map(([w,l])=>{const f=l/v.total,C=f*360,I=M+S*Math.cos(Math.PI*N/180),r=M+S*Math.sin(Math.PI*N/180),j=M+S*Math.cos(Math.PI*(N+C)/180),P=M+S*Math.sin(Math.PI*(N+C)/180),L=C>180?1:0,z=[`M ${M} ${M}`,`L ${I} ${r}`,`A ${S} ${S} 0 ${L} 1 ${j} ${P}`,"Z"].join(" ");return N+=C,{category:w,path:z,color:a[w]||a.neutral,percentage:Math.round(f*100)}}),p=n?.topContexts?.[0],y=d,F=y?v.byCategory[y]??0:0,A=y&&v.total>0?Math.round(F/v.total*100):0;return e.jsxs("div",{className:"card activity-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Time distribution"}),e.jsx("p",{className:"subtle",children:"Blended from desktop apps and the extension feed."})]}),p&&e.jsxs("div",{className:"pill ghost",children:[p.label," Â· ",Math.round(p.seconds/60),"m"]})]}),e.jsxs("div",{className:"activity-chart",style:{position:"relative",overflow:"visible"},children:[y&&e.jsxs("div",{className:"activity-tooltip",style:{position:"absolute",top:"50%",left:"260px",transform:"translateY(-50%)",background:"var(--bg-raised, #12141a)",border:`1px solid ${a[y]}`,boxShadow:"0 8px 32px rgba(0,0,0,0.5)",zIndex:100,padding:"14px 16px",borderRadius:"10px",minWidth:"200px",maxWidth:"260px",lineHeight:1.45,fontSize:"13px",color:"var(--fg, #f0f0f0)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px",paddingBottom:"10px",borderBottom:"1px solid rgba(255,255,255,0.08)"},children:[e.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",background:a[y],flexShrink:0}}),e.jsx("strong",{style:{textTransform:"capitalize",fontSize:"14px"},children:y}),e.jsxs("span",{style:{marginLeft:"auto",opacity:.6,fontSize:"12px"},children:[A,"%"]})]}),e.jsxs("div",{style:{marginBottom:"10px",fontSize:"11px",opacity:.7},children:[Hs(F)," total"]}),e.jsxs("ul",{style:{listStyle:"none",padding:0,margin:0,maxHeight:"160px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"3px"},children:[x[y]?.length===0&&e.jsx("li",{style:{opacity:.5,fontSize:"12px"},children:"No entries"}),x[y]?.slice(0,6).map(w=>e.jsxs("li",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 6px",borderRadius:"4px",background:"rgba(255,255,255,0.04)",fontSize:"12px"},children:[e.jsx("span",{style:{maxWidth:"60%",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:w.label}),e.jsxs("span",{style:{opacity:.6,fontSize:"11px"},children:[Math.round(w.seconds/60),"m"]})]},`${y}-${w.label}`))]})]}),e.jsxs("div",{className:"donut-shell",style:{position:"relative"},children:[e.jsx("div",{className:"donut-glow"}),e.jsxs("svg",{width:"240",height:"240",viewBox:"0 0 220 220",children:[D.map(w=>e.jsx("path",{d:w.path,fill:w.color,stroke:"rgba(255,255,255,0.14)",strokeWidth:"2",onMouseEnter:()=>u(w.category),onMouseLeave:()=>u(null)},w.category)),e.jsx("circle",{cx:M,cy:M,r:S*.6,fill:"var(--bg-soft)"})]}),e.jsxs("div",{className:"donut-center",children:[e.jsx("strong",{children:Hs(v.total)}),e.jsx("span",{children:"logged"})]})]}),e.jsx("ul",{className:"detail-list",style:{flex:1},children:D.map(w=>e.jsxs("li",{onMouseEnter:()=>u(w.category),onMouseLeave:()=>u(null),children:[e.jsxs("div",{className:"legend-chip",children:[e.jsx("span",{style:{width:"12px",height:"12px",borderRadius:"50%",background:w.color}}),e.jsx("span",{style:{textTransform:"capitalize"},children:w.category})]}),e.jsxs("div",{className:"legend-values",children:[e.jsxs("strong",{children:[w.percentage,"%"]}),e.jsxs("span",{className:"subtle",children:[Math.round((v.byCategory[w.category]??0)/60),"m"]})]})]},w.category))})]})]})}function Hs(s){const n=Math.max(0,Math.round(s/60)),a=Math.floor(n/60),i=n%60;return`${a}h ${i}m`}const Bs={productive:"Productive",neutral:"Neutral",frivolity:"Frivolity",draining:"Draining",emergency:"Emergency",idle:"Idle"};function Et({journey:s,loading:n,isRemote:a}){const i=t.useMemo(()=>s?s.segments.reduce((u,o)=>u+o.seconds,0):0,[s]);if(!s||s.segments.length===0)return e.jsxs("div",{className:"card journey-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day journey"}),e.jsx("h2",{children:"Attention trail"})]}),e.jsx("span",{className:"pill ghost",children:n?"Loading...":a?"Local device only":"Local device"})]}),e.jsx("p",{className:"subtle",children:a?"Journey data is available on the active device.":"No activity recorded in this window yet."})]});const d=s.neutralCounts??[];return e.jsxs("div",{className:"card journey-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day journey"}),e.jsx("h2",{children:"Attention trail"})]}),e.jsxs("span",{className:"pill ghost",children:[s.windowHours,"h window"]})]}),e.jsxs("div",{className:"journey-layout",children:[e.jsxs("div",{className:"journey-bar-wrap",children:[e.jsx("div",{className:"journey-bar",role:"img","aria-label":"Timeline of context switches",children:s.segments.map((u,o)=>{const v=i>0?u.seconds/i*100:0,x=u.label??"",N=[x||Bs[u.category]||"Session",`${Os(u.seconds)} active`].join(" - ");return e.jsx("div",{className:`journey-seg ${u.category}`,style:{flexGrow:u.seconds},title:N,children:x&&v>=6?e.jsx("span",{children:x}):null},`${u.start}-${o}`)})}),e.jsx("div",{className:"journey-legend",children:["productive","neutral","draining","frivolity","emergency","idle"].map(u=>e.jsxs("span",{className:"legend-chip",children:[e.jsx("span",{className:`dot ${u}`}),Bs[u]]},u))})]}),e.jsxs("div",{className:"journey-neutral",children:[e.jsx("span",{className:"label",children:"Neutral touchpoints"}),d.length===0?e.jsx("span",{className:"subtle",children:"No neutral apps surfaced yet."}):e.jsx("div",{className:"journey-neutral-list",children:d.slice(0,5).map(u=>e.jsxs("div",{className:"journey-neutral-row",children:[e.jsx("span",{children:u.label}),e.jsxs("span",{className:"subtle",children:[u.count,"Ã— â€¢ ",Os(u.seconds)]})]},u.label))})]})]})]})}function Os(s){return`${Math.max(1,Math.round(s/60))}m`}const At=8,Ft=14,Ws=32,gs=520,Ke=24;function It({journey:s,loading:n,isRemote:a}){const[i,d]=t.useState("flow"),{nodes:u,transitions:o}=t.useMemo(()=>{if(!s?.segments?.length)return{nodes:[],transitions:[]};const p=s.segments.filter(l=>!!l.label);if(p.length<2)return{nodes:[],transitions:[]};const y=new Map;for(let l=1;l<p.length;l+=1){const f=p[l-1].label??"",C=p[l].label??"";if(!f||!C||f===C)continue;const I=`${f}->${C}`,r=y.get(I);r?r.count+=1:y.set(I,{from:f,to:C,count:1})}const F=new Map;for(const l of y.values())F.set(l.from,(F.get(l.from)??0)+l.count),F.set(l.to,(F.get(l.to)??0)+l.count);const A=Array.from(F.entries()).sort((l,f)=>f[1]-l[1]).slice(0,At).map(([l])=>l),w=Array.from(y.values()).filter(l=>A.includes(l.from)&&A.includes(l.to)).sort((l,f)=>f.count-l.count).slice(0,Ft);return{nodes:A,transitions:w}},[s]),v=t.useMemo(()=>s?.segments?.length?s.segments.filter(y=>!!y.label).slice(-36):[],[s]),x=o.reduce((p,y)=>Math.max(p,y.count),1),N=Math.max(220,u.length*Ws+Ke*2),S=140,M=gs-140,g=gs/2,D=new Map;return u.forEach((p,y)=>{D.set(p,Ke+y*Ws)}),!s||s.segments.length===0?e.jsxs("div",{className:"card attention-map-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention map"}),e.jsx("h2",{children:"Context flow"})]}),e.jsx("span",{className:"pill ghost",children:n?"Loading...":a?"Local device only":"Local device"})]}),e.jsx("p",{className:"subtle",children:a?"Flow maps are generated on the active device.":"No activity recorded in this window yet."})]}):e.jsxs("div",{className:"card attention-map-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention map"}),e.jsx("h2",{children:"Context flow"})]}),e.jsxs("div",{className:"attention-map-controls",children:[e.jsx("button",{type:"button",className:`pill ghost ${i==="flow"?"active":""}`,onClick:()=>d("flow"),children:"Flow map"}),e.jsx("button",{type:"button",className:`pill ghost ${i==="path"?"active":""}`,onClick:()=>d("path"),children:"Day path"})]})]}),i==="flow"?e.jsxs("div",{className:"attention-map",children:[u.length===0||o.length===0?e.jsx("p",{className:"subtle",children:"Not enough context changes yet."}):e.jsxs("svg",{className:"attention-map-svg",viewBox:`0 0 ${gs} ${N}`,preserveAspectRatio:"xMidYMid meet",role:"img","aria-label":"Most common context switches",children:[e.jsx("defs",{children:e.jsx("marker",{id:"arrow",markerWidth:"8",markerHeight:"8",refX:"6",refY:"3",orient:"auto",children:e.jsx("path",{d:"M0,0 L6,3 L0,6",fill:"currentColor"})})}),o.map(p=>{const y=D.get(p.from)??Ke,F=D.get(p.to)??Ke,A=1+p.count/x*6,w=`M ${S} ${y} C ${g} ${y}, ${g} ${F}, ${M} ${F}`;return e.jsx("path",{d:w,className:"attention-map-link",strokeWidth:A,markerEnd:"url(#arrow)"},`${p.from}-${p.to}`)}),u.map(p=>{const y=D.get(p)??Ke;return e.jsxs("g",{children:[e.jsx("circle",{cx:S,cy:y,r:4,className:"attention-map-node"}),e.jsx("text",{x:S-12,y:y+4,textAnchor:"end",className:"attention-map-label",children:p})]},`left-${p}`)}),u.map(p=>{const y=D.get(p)??Ke;return e.jsxs("g",{children:[e.jsx("circle",{cx:M,cy:y,r:4,className:"attention-map-node"}),e.jsx("text",{x:M+12,y:y+4,textAnchor:"start",className:"attention-map-label",children:p})]},`right-${p}`)})]}),o.length>0&&e.jsx("div",{className:"attention-map-list",children:o.map(p=>e.jsxs("div",{className:"attention-map-row",children:[e.jsx("span",{children:p.from}),e.jsx("span",{className:"subtle",children:"->"}),e.jsx("span",{children:p.to}),e.jsxs("span",{className:"attention-map-count",children:[p.count,"x"]})]},`list-${p.from}-${p.to}`))})]}):e.jsxs("div",{className:"attention-path",children:[v.length===0?e.jsx("p",{className:"subtle",children:"Not enough labeled context yet."}):e.jsx("div",{className:"attention-path-strip",children:v.map((p,y)=>e.jsxs("div",{className:"attention-path-item",children:[e.jsx("span",{className:`attention-chip ${p.category}`,children:p.label}),e.jsx("span",{className:"subtle",children:Rt(p.start)})]},`${p.start}-${y}`))}),e.jsx("p",{className:"subtle",children:"Showing recent labeled contexts in order."})]})]})}function Rt(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Lt({api:s,overview:n,loading:a,onRefresh:i}){const d=typeof n<"u"||typeof a<"u",[u,o]=t.useState(null),[v,x]=t.useState(!0),[N,S]=t.useState([]),M=t.useCallback(async()=>{if(i){i();return}x(!0);try{const w=await s.analytics.overview(7);o(w)}catch(w){console.error("Failed to load insights:",w)}x(!1)},[s,i]);t.useEffect(()=>{d||M()},[d,M]),t.useEffect(()=>{s.settings.excludedKeywords().then(S).catch(()=>{})},[s]);const g=d?n??null:u,D=d?!!a:v,p=w=>{const l=w>=12?"PM":"AM";return`${w%12||12}${l}`};if(D)return e.jsxs("div",{className:"card insights-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Insights"}),e.jsx("span",{className:"loading-spinner"})]}),e.jsxs("div",{className:"insights-loading",children:[e.jsx("div",{className:"skeleton skeleton-text"}),e.jsx("div",{className:"skeleton skeleton-text short"}),e.jsx("div",{className:"skeleton skeleton-text"})]})]});if(!g)return null;const y=g.focusTrend==="improving"?"ðŸ“ˆ":g.focusTrend==="declining"?"ðŸ“‰":"âž¡ï¸",F=g.focusTrend==="improving"?"Improving":g.focusTrend==="declining"?"Declining":"Stable",A=w=>{if(!N.length)return w;let l=w;for(const f of N){if(!f)continue;const C=f.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");l=l.replace(new RegExp(C,"gi"),"[hidden]")}return l};return e.jsxs("div",{className:"card insights-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Insights"}),e.jsx("button",{className:"pill ghost",onClick:M,disabled:D,children:"Refresh"})]}),e.jsxs("div",{className:"insights-summary",children:[e.jsxs("div",{className:"insight-metric",children:[e.jsxs("span",{className:"insight-value",children:[g.productivityScore,"%"]}),e.jsx("span",{className:"insight-label",children:"Productivity"})]}),e.jsxs("div",{className:"insight-metric",children:[e.jsx("span",{className:"insight-value",children:p(g.peakProductiveHour)}),e.jsx("span",{className:"insight-label",children:"Peak hour"})]}),e.jsxs("div",{className:"insight-metric",children:[e.jsx("span",{className:"insight-value",children:y}),e.jsx("span",{className:"insight-label",children:F})]})]}),e.jsxs("ul",{className:"insights-list",children:[g.insights.map((w,l)=>e.jsx("li",{className:"insight-item",children:A(w)},l)),g.insights.length===0&&e.jsx("li",{className:"insight-item subtle",children:"Not enough data yet. Keep tracking your activity!"})]}),g.riskHour!==g.peakProductiveHour&&e.jsxs("div",{className:"insight-warning",children:[e.jsx("span",{className:"warning-icon",children:"âš ï¸"}),e.jsxs("span",{children:["Watch out at ",e.jsx("strong",{children:p(g.riskHour)})," - that's when you're most likely to get distracted."]})]})]})}function ct({open:s,friend:n,summary:a,timeline:i,publicLibraryItems:d=[],trophies:u=[],onClose:o}){if(!s||!n)return null;const v=i?.totalsByCategory??a?.categoryBreakdown??null,x=a?.totalActiveSeconds??0,N=a?.productivityScore??0,S=new Map(u.map(g=>[g.id,g])),M=(n.pinnedTrophies??[]).map(g=>S.get(g)).filter(g=>!!g);return e.jsx("div",{className:"friend-modal-overlay",onClick:o,children:e.jsxs("div",{className:"friend-modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"friend-modal-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:n.displayName??n.handle??"Friend"}),e.jsxs("p",{className:"subtle",children:["@",n.handle??"no-handle"]})]}),e.jsx("button",{className:"ghost",onClick:o,children:"Close"})]}),e.jsxs("div",{className:"friend-modal-metrics",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsx("strong",{children:a?`${N}%`:"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsx("strong",{children:a?Ye(x):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Updated"}),e.jsx("strong",{children:a?new Date(a.updatedAt).toLocaleTimeString():"--"})]})]}),M.length>0&&e.jsx("div",{className:"friends-trophies",children:M.slice(0,4).map(g=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:g.emoji}),g.name]},g.id))}),v&&e.jsxs("div",{className:"friend-modal-breakdown",children:[e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Productive"}),e.jsx("span",{children:Ye(v.productive)})]}),e.jsxs("div",{className:"friend-modal-bar",children:[e.jsx("span",{className:"cat-productive",style:{width:`${Ze(v,"productive")}%`}}),e.jsx("span",{className:"cat-neutral",style:{width:`${Ze(v,"neutral")}%`}}),e.jsx("span",{className:"cat-frivolity",style:{width:`${Ze(v,"frivolity")}%`}}),e.jsx("span",{className:"cat-draining",style:{width:`${Ze(v,"draining")}%`}}),e.jsx("span",{className:"cat-idle",style:{width:`${Ze(v,"idle")}%`}})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Neutral"}),e.jsx("span",{children:Ye(v.neutral)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Frivolity"}),e.jsx("span",{children:Ye(v.frivolity)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Draining"}),e.jsx("span",{children:Ye(v.draining??0)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Idle"}),e.jsx("span",{children:Ye(v.idle)})]})]}),d.length>0&&e.jsxs("div",{className:"friend-modal-library",children:[e.jsxs("div",{className:"friend-modal-timeline-header",style:{marginBottom:12},children:[e.jsx("span",{className:"label",children:"Public library"}),e.jsx("span",{className:"subtle",children:"Shared links"})]}),e.jsx("div",{className:"friend-modal-library-list",children:d.map(g=>{const D=g.title??g.domain??g.url;return e.jsxs("div",{className:"friend-modal-library-item",children:[e.jsxs("div",{className:"friend-modal-library-main",children:[e.jsx("strong",{children:D}),e.jsx("span",{className:"subtle",children:g.note??g.url})]}),e.jsxs("div",{className:"friend-modal-library-meta",children:[e.jsxs("span",{children:["Added ",Bt(g.createdAt)]}),typeof g.price=="number"&&e.jsxs("span",{children:[g.price," f-coins"]}),e.jsx("a",{className:"ghost",href:g.url,target:"_blank",rel:"noopener noreferrer",children:"Open"})]})]},g.id)})})]}),e.jsxs("div",{className:"friend-modal-timeline",children:[e.jsxs("div",{className:"friend-modal-timeline-header",children:[e.jsxs("span",{className:"label",children:["Last ",i?.windowHours??24,"h"]}),e.jsx("span",{className:"subtle",children:"Dominant attention per hour"})]}),e.jsx("div",{className:"friend-modal-timeline-bars",children:(i?.timeline??[]).map((g,D)=>{const p=g.productive+g.neutral+g.frivolity+g.draining+g.idle,y=p===0?8:Math.max(12,Math.min(52,Math.round(p/Ht(i)*52))),F=g.dominant;return e.jsx("div",{className:"friend-modal-bar-col",title:`${g.hour}`,children:e.jsx("span",{className:`friend-modal-bar-fill cat-${F}`,style:{height:`${y}px`}})},`${g.start}-${D}`)})})]})]})})}function Ze(s,n){const a=s.productive+s.neutral+s.frivolity+(s.draining??0)+s.idle,i=s[n]??0;return a>0?Math.round(i/a*100):0}function Ye(s){const n=s/3600;return n>=10?`${n.toFixed(0)}h`:`${n.toFixed(1)}h`}function Ht(s){return!s||s.timeline.length===0?1:Math.max(...s.timeline.map(n=>n.productive+n.neutral+n.frivolity+n.draining+n.idle),1)}function Bt(s){const n=new Date(s);return Number.isNaN(n.getTime())?s:n.toLocaleDateString([],{month:"short",day:"numeric"})}const Us=[{id:"focus",label:"Focus",hint:"Ring, streak, and core metrics"},{id:"signals",label:"Signals",hint:"Flow quality and attention telemetry"},{id:"journey",label:"Journey",hint:"Day timeline and orbit map"},{id:"social",label:"Social",hint:"Friends and trophy highlights"}];function Ot({api:s,wallet:n,economy:a,productivityGoalHoursOverride:i}){const[d,u]=t.useState([]),[o,v]=t.useState(null),[x,N]=t.useState(!0),[S,M]=t.useState(null),[g,D]=t.useState(!0),[p,y]=t.useState(null),[F,A]=t.useState(!1),[w,l]=t.useState(null),[f,C]=t.useState(Date.now()),[I,r]=t.useState([]),[j,P]=t.useState(null),[L,z]=t.useState(null),[K,k]=t.useState([]),[R,Y]=t.useState({}),[B,Z]=t.useState(!1),[G,$]=t.useState(null),[q,H]=t.useState(null),[ge,ie]=t.useState(null),[W,Q]=t.useState(null),[le,te]=t.useState([]),[oe,be]=t.useState(!1),[Ne,ve]=t.useState([]),[ke,T]=t.useState(null),[O,ee]=t.useState(null),[V,ue]=t.useState("productivity"),[ye,U]=t.useState(null),[me,he]=t.useState([]),[b,J]=t.useState(!1),[ce,de]=t.useState(!1),[we,pe]=t.useState(2),[Se,ae]=t.useState(()=>{try{const c=window.localStorage.getItem("tws-dashboard-scene");if(c&&Us.some(E=>E.id===c))return c}catch{}return"focus"}),Pe=t.useCallback(async(c=!1)=>{c||N(!0);const E=!!(j&&(j==="all"||L&&j!==L)),[X,ne,fe]=await Promise.all([E?Promise.resolve([]):s.activities.recent(30),s.activities.summary(24,j??void 0),E?Promise.resolve(null):s.activities.journey(24,j??void 0)]);u(X),v(ne),U(fe),N(!1)},[s,L,j]),h=t.useCallback(async()=>{D(!0);try{const c=await s.analytics.overview(7);M(c)}catch(c){console.error("Failed to load analytics overview:",c)}finally{D(!1)}},[s]),_=t.useCallback(async()=>{A(!1);try{const c=Date.now()-864e5,E=Xs(new Date),X=Xs(new Date(Date.now()-24*60*60*1e3)),Fe=(await Promise.all([s.history.list(E),s.history.list(X)])).flat().filter(Ie=>Ie.kind==="frivolous-session"&&Date.parse(Ie.occurredAt)>=c).length;l(Fe);const Oe=await s.history.days(60);for(const Ie of Oe){const Fs=(await s.history.list(Ie.day)).find(bt=>bt.kind==="frivolous-session");if(Fs){y(new Date(Fs.occurredAt).getTime()),A(!0);return}}y(null)}catch(c){console.error("Failed to load frivolity history:",c),y(null),l(null)}finally{A(!0)}},[s]),xe=t.useCallback(async()=>{try{const c=await s.sync.status(),E=c.configured&&c.authenticated?await s.sync.listDevices():[],X=c.device?.id??null,ne=E.map(fe=>({id:fe.id,name:fe.name,isCurrent:fe.id===X}));r(ne),z(X),X&&!j&&P(X)}catch(c){console.error("Failed to load devices",c)}},[s,j]),Ce=t.useCallback(async()=>{try{const c=await s.sync.status();if(!c.configured||!c.authenticated){k([]),Y({}),Z(!1);return}const[E,X,ne]=await Promise.all([s.friends.list(),s.friends.summaries(24),s.friends.meSummary(24)]);k(E),Y(X),$(ne);const fe=await s.friends.profile();H(fe),Z(!0)}catch(c){console.error("Failed to load friends",c),k([]),Y({}),Z(!1),$(null)}},[s]),Ee=t.useCallback(async()=>{try{const[c,E]=await Promise.all([s.trophies.profile(),s.trophies.list()]);T(c),ve(E)}catch(c){console.error("Failed to load trophies",c)}},[s]),De=t.useCallback(async c=>{ie(c),Q(null),te([]),be(!0);try{const[E,X]=await Promise.all([s.friends.timeline(c.userId,24),s.friends.publicLibrary(c.userId,168)]);Q(E),te(X??[])}catch(E){console.error("Failed to load friend timeline",E)}},[s]);t.useEffect(()=>{Pe(),h(),_(),xe(),Ce(),Ee()},[Pe,h,_,xe,Ce,Ee]),t.useEffect(()=>{s.settings.excludedKeywords().then(he).catch(()=>{})},[s]),t.useEffect(()=>{s.settings.competitiveOptIn().then(J).catch(()=>{})},[s]),t.useEffect(()=>{s.settings.productivityGoalHours().then(pe).catch(()=>{})},[s]),t.useEffect(()=>{try{window.localStorage.setItem("tws-dashboard-scene",Se)}catch{}},[Se]),t.useEffect(()=>{const c=s.events.on("economy:activity",()=>{Pe(!0)}),E=s.events.on("paywall:session-started",()=>{y(Date.now()),A(!0)});return()=>{c(),E()}},[s,Pe]),t.useEffect(()=>{const c=window.setInterval(()=>{C(Date.now())},1e3);return()=>window.clearInterval(c)},[]),t.useEffect(()=>{const c=s.events.on("trophies:earned",E=>{ee(E),Ee(),window.setTimeout(()=>ee(null),6e3)});return()=>{c()}},[s,Ee]);const Re=j==="all",Le=!!(j&&L&&j!==L&&!Re),He=Re?"All devices":Le?I.find(c=>c.id===j)?.name??"Remote device":a?.activeDomain??a?.activeApp??"Waiting...",We=Le?"neutral":a?.activeCategory??"idle",ze=t.useMemo(()=>Math.max(0,Math.round((o?.totalSeconds??0)/3600*10)/10),[o]),Ue=t.useCallback(c=>{if(!me.length)return!1;const E=c.toLowerCase();return me.some(X=>X&&E.includes(X))},[me]),je=t.useMemo(()=>o?.topContexts?.length?o.topContexts.filter(c=>!Ue(c.label)):[],[o,Ue]),Be=o?.windowHours??24,Ae=(o?.timeline??[]).slice(-Be),m=t.useMemo(()=>[...d].sort((c,E)=>Date.parse(c.startedAt)-Date.parse(E.startedAt)),[d]),re=90,Me=t.useMemo(()=>{const c=new Map;if(!m.length)return c;let E=null,X=null;for(const ne of m){const fe=qs(ne.startedAt);c.has(fe)||c.set(fe,0);const Fe=ne.domain??ne.appName??ne.windowTitle??"unknown";X===fe&&E&&Fe!==E&&c.set(fe,(c.get(fe)??0)+1),X=fe,E=Fe}return c},[m]),ss=t.useMemo(()=>{const c=new Map;if(m.length<2)return c;let E=m[0];for(let X=1;X<m.length;X+=1){const ne=m[X],fe=E.domain??E.appName??E.windowTitle??"unknown",Fe=ne.domain??ne.appName??ne.windowTitle??"unknown",Oe=(E.secondsActive??0)+(E.idleSeconds??0);if(fe&&Fe!==fe&&Oe>0&&Oe<=re){const Ie=qs(ne.startedAt);c.set(Ie,(c.get(Ie)??0)+1)}E=ne}return c},[m]),ks=t.useMemo(()=>{if(!o||m.length<2)return null;let c=0,E=null;for(const X of m){const ne=X.domain??X.appName??X.windowTitle??"unknown";E&&ne!==E&&(c+=1),E=ne}return c/o.windowHours},[m,o]),Cs=t.useMemo(()=>{if(!o||m.length<2)return null;let c=0,E=m[0];for(let X=1;X<m.length;X+=1){const ne=m[X],fe=E.domain??E.appName??E.windowTitle??"unknown",Fe=ne.domain??ne.appName??ne.windowTitle??"unknown",Oe=(E.secondsActive??0)+(E.idleSeconds??0);fe&&Fe!==fe&&Oe>0&&Oe<=re&&(c+=1),E=ne}return c/o.windowHours},[m,o]),ts=t.useMemo(()=>G||(o?_t(o):null),[G,o]),Ms=t.useMemo(()=>Ae.length?V==="switches"?Ae.map(c=>Me.get(c.start)??0):V==="thrash"?Ae.map(c=>ss.get(c.start)??0):V==="idle"?Ae.map(c=>{const E=c.productive+c.neutral+c.frivolity+c.draining+c.idle;return E>0?c.idle/E:0}):Ae.map(c=>{const E=c.productive+c.neutral+c.frivolity+c.draining;return E>0?c.productive/E:0}):[],[V,Ae,Me,ss]),Ps=t.useMemo(()=>{if(!o)return null;const c=o.totalsByCategory.idle??0,E=o.totalSeconds+c;return E>0?c/E:0},[o]),ht=t.useMemo(()=>{if(!Ae.length)return 0;let c=0,E=0;for(const X of Ae)X.dominant==="productive"?(E+=1,E>c&&(c=E)):E=0;return c},[Ae]),Xe=p?Math.max(0,f-p):null,mt=72*60*60*1e3,ns=Xe?Math.min(1,Xe/mt):0,pt=Math.round(20+30*ns),xt=Math.round(48+18*ns),gt=Xe?`hsl(${pt} 70% ${xt}%)`:"rgba(200, 149, 108, 0.7)",as=t.useMemo(()=>o?Math.round(o.deepWorkSeconds/60):null,[o]),Ds=t.useMemo(()=>kt(f,hs),[f]),is=t.useMemo(()=>o?o.timeline?.length?o.timeline.reduce((c,E)=>{const X=Date.parse(E.start);return!Number.isFinite(X)||X<Ds?c:c+(E.productive??0)},0):o.totalsByCategory.productive??0:0,[o,Ds]),ms=Number.isFinite(i)&&(i??0)>0?i:Number.isFinite(we)&&we>0?we:2,ls=ms*3600,ps=ls>0?is/ls:0,jt=Math.max(0,Math.min(1,ps)),vt=Math.round(ps*100),xs=52,Ts=2*Math.PI*xs,yt=Ts*(1-jt),$s=ps>=1,ft=Math.max(0,ls-is),Es=t.useMemo(()=>{const c=new Map;return Ne.forEach(E=>c.set(E.id,E)),c},[Ne]),As=(ke?.pinnedTrophies?.length?ke.pinnedTrophies:Ne.filter(c=>c.pinned).map(c=>c.id)).map(c=>Es.get(c)).filter(c=>!!c).slice(0,3),Ge=Ne.filter(c=>c.progress.state==="locked").sort((c,E)=>E.progress.ratio-c.progress.ratio)[0]??null;return e.jsxs("section",{className:"panel",children:[e.jsxs("header",{className:"panel-header dashboard-header",children:[e.jsx("div",{className:"dashboard-hero-left",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention control"}),e.jsx("h1",{children:"Your day at a glance"}),e.jsxs("div",{className:"pill-row pill-row-tight topbar-actions",children:[e.jsxs("div",{className:"pill-group",children:[e.jsxs("span",{className:"pill ghost",children:["Wallet ",n.balance," f-coins"]}),e.jsx("button",{type:"button",className:"pomodoro-trigger",onClick:()=>de(!0),children:"Locking in?"})]}),e.jsx("span",{className:"pill ghost",children:as==null?"Deep work â€”":`Deep work ${as} min`})]}),I.length>0&&e.jsxs("div",{className:"dashboard-device-switch",children:[e.jsx("span",{className:"subtle",children:"Viewing"}),e.jsxs("select",{value:j??"",onChange:c=>P(c.target.value),children:[I.length>1&&e.jsx("option",{value:"all",children:"All devices"}),I.map(c=>e.jsxs("option",{value:c.id,children:[c.name,c.isCurrent?" (this device)":""]},c.id))]})]})]})}),e.jsx("div",{className:"card dashboard-time",children:e.jsx($t,{activities:d,summary:o})})]}),e.jsx("div",{className:"dashboard-controls",children:e.jsx("div",{className:"dashboard-tabs",role:"tablist","aria-label":"Dashboard scenes",children:Us.map(c=>e.jsxs("button",{type:"button",role:"tab",className:Se===c.id?"active":"","aria-selected":Se===c.id,onClick:()=>ae(c.id),children:[e.jsx("span",{className:"dashboard-tab-label",children:c.label}),e.jsx("span",{className:"dashboard-tab-hint",children:c.hint})]},c.id))})}),ce&&e.jsxs("div",{className:"pomodoro-flyout",children:[e.jsxs("div",{className:"pomodoro-flyout-bar",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Deep work"}),e.jsx("strong",{children:"Pomodoro control"})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>de(!1),children:"Close"})]}),e.jsx(Mt,{api:s})]}),e.jsxs("div",{className:"dashboard-scenes",children:[Se==="focus"&&e.jsxs("div",{className:"dashboard-focus-grid",children:[e.jsxs("div",{className:`card productivity-ring ${$s?"complete":""}`,children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Daily productivity"}),e.jsx("h2",{children:"Close your ring"})]}),e.jsxs("span",{className:"pill ghost",children:[Gs(ms)," goal"]})]}),e.jsxs("div",{className:"productivity-ring-body",children:[e.jsxs("div",{className:"productivity-ring-graphic",role:"img","aria-label":`Productivity ring ${rs(is)} of ${Gs(ms)}`,children:[e.jsx("div",{className:"productivity-ring-glow"}),e.jsxs("svg",{viewBox:"0 0 120 120","aria-hidden":!0,children:[e.jsx("circle",{className:"productivity-ring-track",cx:"60",cy:"60",r:xs,strokeWidth:"10"}),e.jsx("circle",{className:"productivity-ring-progress",cx:"60",cy:"60",r:xs,strokeWidth:"10",strokeDasharray:Ts,strokeDashoffset:yt})]}),e.jsxs("div",{className:"productivity-ring-center",children:[e.jsx("strong",{children:rs(is)}),e.jsx("span",{children:"productive"})]})]}),e.jsxs("div",{className:"productivity-ring-meta",children:[e.jsx("strong",{children:x?"--":`${vt}%`}),e.jsx("span",{className:"subtle",children:x?"Collecting signal...":$s?"You've closed your circle.":`${rs(ft)} to go`}),e.jsxs("span",{className:"subtle",children:["Today - ",rs(ls)," target"]})]})]})]}),e.jsxs("div",{className:`card dashboard-streak ${ns>=1?"streak-max":""}`,style:{"--streak-color":gt,"--streak-progress":`${Math.round(ns*100)}%`},children:[e.jsxs("div",{className:"streak-header",children:[e.jsx("span",{className:"eyebrow",children:"Recovery timer"}),e.jsx("span",{className:`pill inline ${We}`,children:We})]}),e.jsx("h2",{children:"Time since last frivolity"}),e.jsx("div",{className:"streak-time",children:F?Xe?_s(Xe):"No frivolity logged":"Loading..."}),e.jsxs("div",{className:"streak-meta",children:[e.jsx("span",{className:"subtle",children:p?`Last spend ${new Date(p).toLocaleString()}`:"No paid sessions recorded yet."}),e.jsxs("div",{className:"streak-meta-row",children:[e.jsx("span",{className:"pill ghost",children:"Goal: 3 days"}),e.jsxs("span",{className:"pill ghost",children:[w??0," frivolity uses (24h)"]})]})]}),e.jsx("div",{className:"streak-bar","aria-hidden":!0,children:e.jsx("span",{})})]}),e.jsxs("div",{className:"card dashboard-focus-metrics",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Focus deck"}),e.jsx("h2",{children:"Session highlights"})]}),e.jsx("span",{className:"pill ghost",children:o?`${o.windowHours}h window`:"Rolling day"})]}),e.jsxs("div",{className:"overview-grid",children:[e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsxs("strong",{children:[ze.toFixed(1),"h"]}),e.jsxs("span",{className:"subtle",children:["last ",o?.windowHours??24,"h"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsxs("strong",{children:[S?.productivityScore??"--","%"]}),e.jsxs("span",{className:"subtle",children:["last ",S?.periodDays??7,"d"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Deep work"}),e.jsx("strong",{children:as==null?"--":`${as}m`}),e.jsx("span",{className:"subtle",children:"today"})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Frivolity"}),e.jsx("strong",{children:w??"--"}),e.jsx("span",{className:"subtle",children:"last 24h"})]})]}),e.jsxs("div",{className:"dashboard-focus-meta",children:[e.jsxs("div",{children:[e.jsx("span",{className:"metric-label",children:"Active context"}),e.jsx("strong",{children:He})]}),e.jsx("span",{className:`pill inline ${We}`,children:We})]})]})]}),Se==="signals"&&e.jsxs("div",{className:"dashboard-signals-grid",children:[e.jsxs("div",{className:"dashboard-signals-main",children:[e.jsxs("div",{className:"card flow-card dashboard-flow",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention stability"}),e.jsx("h2",{children:"Flow signals"})]}),e.jsx("span",{className:"pill ghost",children:"Last 24h"})]}),e.jsxs("div",{className:"flow-metrics",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Context switches"}),e.jsx("strong",{children:ks==null?"--":`${ks.toFixed(1)}/h`}),e.jsx("span",{className:"subtle",children:"avg across window"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Thrash rate"}),e.jsx("strong",{children:Cs==null?"--":`${Cs.toFixed(1)}/h`}),e.jsx("span",{className:"subtle",children:"rapid hops"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Idle ratio"}),e.jsx("strong",{children:Ps==null?"--":`${Math.round(Ps*100)}%`}),e.jsx("span",{className:"subtle",children:"passive time"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Longest run"}),e.jsxs("strong",{children:[ht,"h"]}),e.jsx("span",{className:"subtle",children:"productive streak"})]})]}),e.jsxs("div",{className:"flow-toggle",children:[e.jsx("button",{type:"button",className:`pill ghost ${V==="productivity"?"active":""}`,onClick:()=>ue("productivity"),children:"Productivity"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="switches"?"active":""}`,onClick:()=>ue("switches"),children:"Switches"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="thrash"?"active":""}`,onClick:()=>ue("thrash"),children:"Thrash"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="idle"?"active":""}`,onClick:()=>ue("idle"),children:"Idle"})]}),e.jsxs("div",{className:"flow-sparkline",children:[e.jsx("span",{className:"label",children:V==="switches"?"Switches trend":V==="thrash"?"Thrash trend":V==="idle"?"Idle trend":"Productive trend"}),e.jsx("div",{className:"flow-sparkline-track",children:Ms.length>1?e.jsx("svg",{viewBox:"0 0 100 40",preserveAspectRatio:"none","aria-hidden":!0,children:e.jsx("path",{d:Ut(Ms),fill:"none",stroke:"currentColor",strokeWidth:"2"})}):e.jsx("span",{className:"subtle",children:"Collecting signalâ€¦"})})]})]}),e.jsx("div",{className:"dashboard-insights",children:e.jsx(Lt,{api:s,overview:S,loading:g,onRefresh:h})})]}),e.jsxs("div",{className:"card dashboard-overview",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Signal deck"}),e.jsx("h2",{children:"Focus telemetry"})]}),e.jsx("span",{className:"pill ghost",children:o?`${o.windowHours}h window`:"Rolling day"})]}),e.jsxs("div",{className:"overview-grid",children:[e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsxs("strong",{children:[ze.toFixed(1),"h"]}),e.jsxs("span",{className:"subtle",children:["last ",o?.windowHours??24,"h"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsxs("strong",{children:[S?.productivityScore??"--","%"]}),e.jsxs("span",{className:"subtle",children:["last ",S?.periodDays??7,"d"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Avg session"}),e.jsx("strong",{children:S?_s(S.avgSessionLength*1e3):"--"}),e.jsxs("span",{className:"subtle",children:[S?.totalSessions??"--"," sessions"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Peak hour"}),e.jsx("strong",{children:S?zs(S.peakProductiveHour):"--"}),e.jsxs("span",{className:"subtle",children:["risk ",S?zs(S.riskHour):"--"]})]})]}),e.jsxs("div",{className:"overview-breakdown",children:[e.jsx("span",{className:"label",children:"Category mix"}),e.jsxs("div",{className:"overview-bars",children:[qe("Productive","productive",S),qe("Neutral","neutral",S),qe("Frivolity","frivolity",S),qe("Draining","draining",S),qe("Emergency","emergency",S),qe("Idle","idle",S)]})]}),e.jsxs("div",{className:"overview-top",children:[e.jsx("span",{className:"label",children:"Top contexts"}),e.jsxs("ul",{className:"overview-list",children:[je.slice(0,3).map(c=>e.jsxs("li",{children:[e.jsx("strong",{children:c.label}),e.jsxs("span",{className:"subtle",children:[Math.round(c.seconds/60),"m â€¢ ",c.source==="url"?"Browser":"App"]})]},c.label)),je.length===0&&e.jsx("li",{className:"subtle",children:"No streams yet."})]}),S?.topEngagementDomain&&!Ue(S.topEngagementDomain)&&e.jsxs("div",{className:"overview-highlight",children:[e.jsx("span",{className:"label",children:"Most engaging"}),e.jsx("strong",{children:S.topEngagementDomain}),e.jsx("span",{className:"subtle",children:"highest attention hold this week"})]})]})]})]}),Se==="journey"&&e.jsxs("div",{className:"dashboard-journey-grid",children:[e.jsx("div",{className:"dashboard-orbit",children:e.jsx(Pt,{summary:o,economy:a})}),e.jsxs("div",{className:"dashboard-timeline",children:[e.jsx(Et,{journey:ye,loading:x,isRemote:Le}),e.jsx(It,{journey:ye,loading:x,isRemote:Le})]})]}),Se==="social"&&e.jsxs("div",{className:"dashboard-social-grid",children:[e.jsxs("div",{className:"card friends-strip",children:[e.jsxs("div",{className:"friends-strip-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Friends"}),e.jsx("h2",{children:"In the zone"})]}),e.jsx("span",{className:"pill ghost",children:"Last 24h"})]}),B?K.length===0?e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"No friends yet"}),e.jsx("span",{className:"subtle",children:"Add a handle in the Friends tab."})]}):e.jsx("div",{className:"friends-strip-row",children:K.map(c=>{const E=R[c.userId],X=E?.categoryBreakdown??null,ne=E?.totalActiveSeconds??0,fe=ne>0?X.productive/ne*100:0,Fe=ne>0?X.neutral/ne*100:0,Oe=ne>0?X.frivolity/ne*100:0,Ie=(c.pinnedTrophies??[]).map(_e=>Es.get(_e)).filter(_e=>!!_e);return e.jsxs("button",{type:"button",className:"friends-chip",onClick:()=>De(c),children:[e.jsxs("div",{className:"friends-chip-header",children:[e.jsxs("div",{children:[e.jsx("strong",{children:c.displayName??c.handle??"Friend"}),e.jsxs("span",{className:"subtle",children:["@",c.handle??"no-handle"]})]}),e.jsx("span",{className:"pill ghost",children:E?`${E.productivityScore}%`:"--"})]}),e.jsxs("div",{className:"friends-chip-activity",children:[e.jsxs("span",{children:[E?Wt(E.totalActiveSeconds):"--"," active"]}),e.jsx("span",{className:"subtle",children:E?`Updated ${new Date(E.updatedAt).toLocaleTimeString()}`:"No data yet"})]}),e.jsxs("div",{className:"friends-chip-bar",children:[e.jsx("span",{className:"cat-productive",style:{width:`${fe}%`}}),e.jsx("span",{className:"cat-neutral",style:{width:`${Fe}%`}}),e.jsx("span",{className:"cat-frivolity",style:{width:`${Oe}%`}})]}),b?e.jsx("div",{className:"head-to-head",children:R[c.userId]?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"head-to-head-row",children:[e.jsx("span",{children:"You"}),e.jsx("span",{children:c.displayName??c.handle??"Friend"})]}),e.jsxs("div",{className:"head-to-head-bar fancy",children:[e.jsx("span",{className:"head-to-head-left",style:{width:`${Vs(ts,R[c.userId])}%`,background:q?.color??"var(--accent)"}}),e.jsx("span",{className:"head-to-head-right",style:{width:`${100-Vs(ts,R[c.userId])}%`,background:c.color??"rgba(255, 255, 255, 0.3)"}}),e.jsx("div",{className:"head-to-head-glow"})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[Ks(ts?.categoryBreakdown.productive??0)," productive"]}),e.jsxs("span",{children:[Ks(R[c.userId]?.categoryBreakdown.productive??0)," productive"]})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[Ys(ts?.emergencySessions)," emergency"]}),e.jsxs("span",{children:[Ys(R[c.userId]?.emergencySessions)," emergency"]})]})]}):e.jsx("p",{className:"subtle",style:{marginTop:6},children:"Waiting for shared activity data."})}):e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Competitive view is off."}),Ie.length>0&&e.jsx("div",{className:"friends-trophies",children:Ie.slice(0,3).map(_e=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:_e.emoji}),_e.name]},_e.id))})]},c.id)})}):e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"Syncing friendsâ€¦"}),e.jsx("span",{className:"subtle",children:"Connect the desktop app to pull stats."})]})]}),Ne.length>0&&e.jsxs("div",{className:"card trophy-strip",children:[e.jsxs("div",{className:"trophy-strip-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Trophies"}),e.jsx("h2",{children:"Case highlights"})]}),e.jsx("span",{className:"pill ghost",children:"Profile view"})]}),e.jsx("div",{className:"trophy-strip-row",children:As.length===0?e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"No pinned trophies"}),e.jsx("span",{className:"subtle",children:"Pin trophies in your Profile page."})]}):As.map(c=>e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:c.emoji}),e.jsx("span",{children:c.name})]},c.id))}),Ge&&e.jsxs("div",{className:"trophy-next",children:[e.jsx("span",{className:"label",children:"Next up"}),e.jsxs("div",{className:"trophy-next-body",children:[e.jsx("span",{className:"emoji",children:Ge.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:Ge.name}),e.jsx("span",{className:"subtle",children:Ge.progress.label??`${Ge.progress.current}/${Ge.progress.target}`})]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(Ge.progress.ratio*100)}%`}})})]}),O&&e.jsxs("div",{className:"trophy-toast",children:[e.jsx("span",{className:"emoji",children:O.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:O.name}),e.jsx("span",{className:"subtle",children:"New trophy earned"})]})]})]})]})]}),e.jsx(ct,{open:oe,friend:ge,summary:ge?R[ge.userId]??null:null,timeline:W,publicLibraryItems:le,trophies:Ne,onClose:()=>be(!1)})]})}function _s(s){const n=Math.max(0,Math.floor(s/6e4)),a=Math.floor(n/(60*24)),i=Math.floor(n%(60*24)/60),d=n%60;return a>0?`${a}d ${i}h ${d}m`:`${i}h ${d}m`}function zs(s){const n=s>=12?"PM":"AM";return`${s%12||12}${n}`}function Wt(s){const n=s/3600;return n>=10?`${n.toFixed(0)}h`:`${n.toFixed(1)}h`}function rs(s){const n=Math.max(0,Math.round(s/60)),a=Math.floor(n/60),i=n%60;return`${a}h ${i}m`}function Gs(s){return Number.isFinite(s)?s%1===0?`${s.toFixed(0)}h`:`${s.toFixed(1)}h`:"0h"}function Ks(s){return`${Math.round(s/60)}m`}function Ys(s){return typeof s!="number"?"â€”":String(s)}function qs(s){const n=new Date(s);return n.setMinutes(0,0,0),n.toISOString()}function Ut(s){if(s.length<2)return"";const n=Math.max(...s),a=Math.min(...s),i=Math.max(.001,n-a);return s.map((d,u)=>{const o=u/(s.length-1)*100,v=36-(d-a)/i*32;return`${u===0?"M":"L"}${o.toFixed(2)} ${v.toFixed(2)}`}).join(" ")}function _t(s){return{userId:"me",updatedAt:new Date().toISOString(),periodHours:s.windowHours,totalActiveSeconds:s.totalSeconds,deepWorkSeconds:s.deepWorkSeconds,categoryBreakdown:{productive:s.totalsByCategory.productive??0,neutral:s.totalsByCategory.neutral??0,frivolity:s.totalsByCategory.frivolity??0,draining:s.totalsByCategory.draining??0,emergency:s.totalsByCategory.emergency??0,idle:s.totalsByCategory.idle??0},productivityScore:s.totalSeconds>0?Math.round(s.totalsByCategory.productive/s.totalSeconds*100):0}}function Vs(s,n){const a=s?.categoryBreakdown.productive??0,i=n?.categoryBreakdown.productive??0,d=a+i;return d===0?50:Math.round(a/d*100)}function qe(s,n,a){const i=a?.categoryBreakdown??{productive:0,neutral:0,frivolity:0,draining:0,emergency:0,idle:0},d=i.productive+i.neutral+i.frivolity+i.draining+i.emergency+i.idle,u=i[n]??0,o=d>0?Math.round(u/d*100):0;return e.jsxs("div",{className:"overview-bar",children:[e.jsxs("div",{className:"overview-bar-label",children:[e.jsx("span",{children:s}),e.jsxs("span",{className:"subtle",children:[o,"%"]})]}),e.jsx("div",{className:"overview-bar-track",children:e.jsx("span",{className:`overview-bar-fill cat-${n}`,style:{width:`${o}%`}})})]},n)}function Xs(s){const n=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0");return`${n}-${a}-${i}`}function $e(s){const n=s.trim().toLowerCase();if(!n)return null;if(n.startsWith("http://")||n.startsWith("https://"))try{return new URL(n).hostname.replace(/^www\./,"")}catch{return null}return n.split("/")[0].replace(/^www\./,"")}function cs(s){const n=new Set,a=[];for(const i of s){const d=$e(i);!d||n.has(d)||(n.add(d),a.push(d))}return a}function zt({api:s,variant:n="page"}){const[a,i]=t.useState(null),[d,u]=t.useState(!0),[o,v]=t.useState(!1),[x,N]=t.useState(!1),[S,M]=t.useState(null),[g,D]=t.useState(""),[p,y]=t.useState("frivolous"),F=t.useCallback(async()=>{try{const r=await s.settings.categorisation();i(r)}catch(r){console.error("Failed to load categorisation",r),M("Could not load domain lists.")}finally{u(!1)}},[s.settings]);t.useEffect(()=>{F()},[F]);const A=t.useMemo(()=>a?{productive:a.productive.length,neutral:a.neutral.length,frivolity:a.frivolity.length,draining:a.draining?.length??0}:{productive:0,neutral:0,frivolity:0,draining:0},[a]),w=async r=>{v(!0),M(null);try{await s.settings.updateCategorisation(r),i(r),N(!0),window.setTimeout(()=>N(!1),1500)}catch(j){M(j.message||"Failed to save")}finally{v(!1)}},l=async(r,j)=>{if(!a)return;const P=$e(r);if(!P){M("Please enter a valid domain.");return}const L=cs(a.productive.filter(R=>$e(R)!==P)),z=cs(a.neutral.filter(R=>$e(R)!==P)),K=cs(a.frivolity.filter(R=>$e(R)!==P)),k=cs((a.draining??[]).filter(R=>$e(R)!==P));j==="productive"&&L.unshift(P),j==="neutral"&&z.unshift(P),j==="frivolous"&&K.unshift(P),j==="draining"&&k.unshift(P),await w({productive:L,neutral:z,frivolity:K,draining:k})},f=async r=>{if(!a)return;const j=$e(r);j&&await w({productive:a.productive.filter(P=>$e(P)!==j),neutral:a.neutral.filter(P=>$e(P)!==j),frivolity:a.frivolity.filter(P=>$e(P)!==j),draining:a.draining?.filter(P=>$e(P)!==j)??[]})},C=async()=>{M(null);const r=$e(g);if(!r){M("Enter a domain like twitter.com");return}D(""),await l(r,p)};if(d)return e.jsx("div",{className:"panel",children:"Loading domainsâ€¦"});if(!a)return e.jsx("div",{className:"panel",children:"Could not load domains."});const I=n==="settings"?"store-page settings-domains":"page store-page";return e.jsxs("section",{className:I,children:[n==="page"?e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Domains"}),e.jsxs("p",{className:"subtle",children:["Keep this simple: ",e.jsx("strong",{children:"productive"}),", ",e.jsx("strong",{children:"neutral"}),", ",e.jsx("strong",{children:"draining"}),", or ",e.jsx("strong",{children:"frivolous"}),". Idle is inferred automatically."]})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill ghost",children:[A.productive," productive"]}),e.jsxs("span",{className:"pill ghost",children:[A.neutral," neutral"]}),e.jsxs("span",{className:"pill ghost",children:[A.frivolity," frivolous"]}),e.jsxs("span",{className:"pill ghost",children:[A.draining," draining"]})]})]}):e.jsxs("div",{className:"settings-section-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Domains"}),e.jsxs("p",{className:"subtle",children:["Keep this simple: ",e.jsx("strong",{children:"productive"}),", ",e.jsx("strong",{children:"neutral"}),", ",e.jsx("strong",{children:"draining"}),", or ",e.jsx("strong",{children:"frivolous"}),". Idle is inferred automatically."]})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill ghost",children:[A.productive," productive"]}),e.jsxs("span",{className:"pill ghost",children:[A.neutral," neutral"]}),e.jsxs("span",{className:"pill ghost",children:[A.frivolity," frivolous"]}),e.jsxs("span",{className:"pill ghost",children:[A.draining," draining"]})]})]}),S&&e.jsx("p",{className:"error-text",children:S}),x&&e.jsx("p",{className:"subtle",children:"Saved."}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Quick classify"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1.2fr 1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Domain",e.jsx("input",{value:g,onChange:r=>D(r.target.value),placeholder:"twitter.com",disabled:o})]}),e.jsxs("label",{children:["Category",e.jsxs("select",{value:p,onChange:r=>y(r.target.value),disabled:o,children:[e.jsx("option",{value:"productive",children:"productive"}),e.jsx("option",{value:"neutral",children:"neutral"}),e.jsx("option",{value:"frivolous",children:"frivolous"}),e.jsx("option",{value:"draining",children:"draining"})]})]}),e.jsx("button",{className:"primary",type:"button",disabled:o,onClick:C,children:"Add"})]}),e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Tip: you can also label domains from the browser extension popup."})]}),e.jsxs("div",{className:"store-grid",style:{gridTemplateColumns:"repeat(auto-fit, minmax(260px, 1fr))"},children:[e.jsx(os,{title:"Productive",subtitle:"Earns f-coins.",items:a.productive,onRemove:f,onMove:r=>l(r,"productive"),disabled:o}),e.jsx(os,{title:"Neutral",subtitle:"Safe by default (earning depends on your clock-in settings).",items:a.neutral,onRemove:f,onMove:r=>l(r,"neutral"),disabled:o}),e.jsx(os,{title:"Frivolous",subtitle:"Paywall applies here.",items:a.frivolity,onRemove:f,onMove:r=>l(r,"frivolous"),disabled:o}),e.jsx(os,{title:"Draining",subtitle:"Passively costs coins (no paywall).",items:a.draining??[],onRemove:f,onMove:r=>l(r,"draining"),disabled:o})]})]})}function os(s){const{title:n,subtitle:a,items:i,disabled:d,onRemove:u}=s;return e.jsxs("div",{className:"card store-item",children:[e.jsxs("div",{className:"store-item-headline",children:[e.jsxs("div",{children:[e.jsx("p",{className:"store-item-domain",children:n}),e.jsxs("h3",{className:"store-item-title",children:[i.length," domains"]})]}),e.jsxs("div",{className:"store-item-price-pill",children:[e.jsx("strong",{children:i.length}),e.jsx("span",{children:"items"})]})]}),e.jsx("p",{className:"subtle",style:{marginTop:6},children:a}),i.length===0?e.jsx("div",{className:"empty-state",style:{padding:0},children:e.jsx("p",{className:"subtle",children:"None yet."})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,marginTop:8},children:[i.slice(0,12).map(o=>e.jsxs("div",{style:{display:"flex",gap:10,justifyContent:"space-between",alignItems:"center"},children:[e.jsx("code",{style:{fontSize:12,color:"var(--fg-muted)"},children:o}),e.jsx("button",{className:"ghost danger",disabled:d,onClick:()=>u(o),children:"Remove"})]},o)),i.length>12&&e.jsxs("p",{className:"subtle",style:{margin:0},children:["Showing 12 of ",i.length,". Use search/edit tools in a future iteration."]})]})]})}function Gt({values:s,onChange:n,color:a,disabled:i=!1}){const[d,u]=t.useState(!1),o=t.useRef(null),v=x=>{if(i||!o.current)return;const N=o.current.getBoundingClientRect(),S="touches"in x?x.touches[0].clientX:x.clientX,M="touches"in x?x.touches[0].clientY:x.clientY,g=S-N.left,D=M-N.top,p=N.width,y=N.height,F=p/24,A=Math.floor(g/F);if(A>=0&&A<24){const l=1-D/y,f=Math.max(0,Math.min(3,l*3)),C=[...s];C[A]=Number(f.toFixed(1)),n(C)}};return e.jsxs("div",{className:"curve-editor",style:{userSelect:"none",opacity:i?.5:1},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",fontSize:"12px",color:"var(--text-subtle)"},children:[e.jsx("span",{children:"00:00"}),e.jsx("span",{children:"06:00"}),e.jsx("span",{children:"12:00"}),e.jsx("span",{children:"18:00"}),e.jsx("span",{children:"23:59"})]}),e.jsxs("svg",{ref:o,width:"100%",height:"200",style:{background:"rgba(0,0,0,0.05)",borderRadius:"8px",cursor:i?"not-allowed":"crosshair"},onMouseDown:x=>{i||(u(!0),v(x))},onMouseMove:x=>{!i&&d&&v(x)},onMouseUp:()=>u(!1),onMouseLeave:()=>u(!1),onTouchStart:x=>{i||(u(!0),v(x))},onTouchMove:x=>{!i&&d&&v(x)},onTouchEnd:()=>u(!1),children:[[.5,1,1.5,2,2.5].map(x=>e.jsx("line",{x1:"0",y1:200-x/3*200,x2:"100%",y2:200-x/3*200,stroke:"rgba(0,0,0,0.1)",strokeDasharray:"4 4"},x)),s.map((x,N)=>{const S=x/3*200;return e.jsx("rect",{x:`${N/24*100}%`,y:200-S,width:`${100/24}%`,height:S,fill:a,stroke:"#fff",strokeWidth:"1",opacity:"0.8"},N)})]}),e.jsx("div",{style:{textAlign:"center",marginTop:"8px",fontSize:"12px"},children:i?"Active session detected â€” edits locked until it ends.":"Click and drag to adjust hourly multipliers (0x - 3x)"})]})}function Kt({api:s}){const[n,a]=t.useState([]),[i,d]=t.useState(null),[u,o]=t.useState("productive"),[v,x]=t.useState(!1),[N,S]=t.useState({}),[M,g]=t.useState(null),[D,p]=t.useState(null),[y,F]=t.useState(null),[A,w]=t.useState(!1),[l,f]=t.useState(null),[C,I]=t.useState(!0),[r,j]=t.useState(!1),[P,L]=t.useState(!1),[z,K]=t.useState(""),[k,R]=t.useState(10),[Y,B]=t.useState(8),[Z,G]=t.useState(!1);t.useEffect(()=>{$(),s.settings.economyExchangeRate().then(b=>{typeof b=="number"&&Number.isFinite(b)&&F(b)}).catch(()=>{}),s.settings.dailyWalletResetEnabled().then(I).catch(()=>{})},[]),t.useEffect(()=>{const b=()=>s.paywall.sessions().then(pe=>{const Se={};pe.forEach(ae=>{Se[ae.domain]=ae}),S(Se)}).catch(()=>{});b();const J=s.events.on("paywall:session-started",b),ce=s.events.on("paywall:session-ended",b),de=s.events.on("paywall:session-paused",b),we=s.events.on("paywall:session-resumed",b);return()=>{J(),ce(),de(),we()}},[s]);async function $(){const[b,J,ce]=await Promise.all([s.market.list(),s.settings.categorisation(),s.paywall.sessions()]),de=[],we=new Map(b.map(ae=>[ae.domain,ae])),pe=(ae,Pe)=>we.get(ae)||{domain:ae,ratePerMin:Pe,packs:[],hourlyModifiers:Array(24).fill(1)};J.productive.forEach(ae=>{de.push({id:ae,type:"productive",rate:pe(ae,5)})}),J.frivolity.forEach(ae=>{de.push({id:ae,type:"frivolity",rate:pe(ae,3)})}),b.forEach(ae=>{de.find(Pe=>Pe.id===ae.domain)||de.push({id:ae.domain,type:"neutral",rate:ae})}),a(de);const Se={};ce.forEach(ae=>{Se[ae.domain]=ae}),S(Se)}const q=n.filter(b=>u==="productive"?b.type==="productive":b.type==="frivolity"||b.type==="neutral");t.useEffect(()=>{!P&&q.length>0&&(!i||!q.find(b=>b.id===i))?d(q[0].id):q.length===0&&!P&&d(null)},[u,n,P]),t.useEffect(()=>{g(null)},[i]),t.useEffect(()=>{if(!l)return;const b=setTimeout(()=>f(null),2400);return()=>clearTimeout(b)},[l]);const H=n.find(b=>b.id===i),ie=!!(H?N[H.id]:void 0);t.useEffect(()=>{if(!D)return;const b=setTimeout(()=>p(null),2e3);return()=>clearTimeout(b)},[D]);const W=b=>{!H||ie||te(H.id,{...H.rate,ratePerMin:b})},Q=b=>{!H||ie||te(H.id,{...H.rate,hourlyModifiers:b})},le=async b=>{if(!r){j(!0);try{await s.settings.updateDailyWalletResetEnabled(b),I(b),f(b?"Daily coin reset enabled â€” wallet starts at 0 each day.":"Daily coin reset disabled.")}catch(J){g(J.message)}finally{j(!1)}}},te=(b,J)=>{a(ce=>ce.map(de=>de.id===b?{...de,rate:J}:de))},oe=async()=>{if(H){if(ie){g("Active session detected â€” end it before changing this rate.");return}x(!0),g(null),p(null);try{await s.market.upsert(H.rate),p("Saved to market"),await $(),d(H.id)}catch(b){g(b.message)}finally{x(!1)}}},be=async b=>{if(b.preventDefault(),!z.trim())return;const J=z.trim();if(n.find(de=>de.id===J)){g("Profile already exists");return}const ce={domain:J,ratePerMin:3,packs:[],hourlyModifiers:Array(24).fill(1)};await s.market.upsert(ce),await $(),K(""),L(!1),d(J),o("frivolity")},Ne=t.useMemo(()=>u==="productive"?"Earn profiles":"Spend profiles",[u]),ve=t.useMemo(()=>u==="productive"?"Tune how productive apps reward you over the day.":"Shape how costly domains evolve over the day.",[u]),ke=t.useMemo(()=>{if(!H)return[];const b=H.rate.hourlyModifiers,J=Math.max(...b),ce=Math.min(...b);return[{label:"Base rate",value:`${H.rate.ratePerMin} f-coins/min`},{label:"Peak multiplier",value:`${J.toFixed(1)}x`},{label:"Off-peak",value:`${ce.toFixed(1)}x`}]},[H]),T=H?.type==="productive";function O(b){const J=b.filter(we=>typeof we=="number"&&Number.isFinite(we));if(!J.length)return null;const ce=[...J].sort((we,pe)=>we-pe),de=Math.floor(ce.length/2);return ce.length%2===0?(ce[de-1]+ce[de])/2:ce[de]}function ee(b){const J=Number(b);return Number.isFinite(J)?Math.round(J*100)/100:0}const V=t.useMemo(()=>O(n.filter(b=>b.type==="productive").map(b=>b.rate.ratePerMin))??5,[n]),ue=t.useMemo(()=>O(n.filter(b=>b.type==="frivolity").map(b=>b.rate.ratePerMin))??3,[n]),ye=t.useMemo(()=>!ue||ue<=0?0:V/ue,[V,ue]),U=y??ye,me=t.useMemo(()=>{const b=typeof U=="number"&&Number.isFinite(U)?U:1;return!ue||ue<=0||!V||V<=0||b<=0?1:V/(ue*b)},[U,V,ue]),he=async()=>{if(A)return;const b=typeof U=="number"&&Number.isFinite(U)?U:null;if(!(!b||b<=0)){w(!0),g(null);try{const J=n.filter(pe=>pe.type==="frivolity"),ce=J.filter(pe=>!!N[pe.id]).map(pe=>pe.id),de=J.filter(pe=>!N[pe.id]);if(!de.length){f("All spend profiles are locked by active sessions.");return}await s.settings.updateEconomyExchangeRate(b);let we=0;for(const pe of de){const Se={...pe.rate,ratePerMin:ee(pe.rate.ratePerMin*me),packs:pe.rate.packs.map(ae=>({...ae,price:Math.max(1,Math.round(ae.price*me))}))};await s.market.upsert(Se),we+=1}await $(),f(ce.length?`Scaled ${we} spend profiles. Skipped ${ce.length} locked by active sessions.`:`Scaled ${we} spend profiles.`)}catch(J){g(J.message)}finally{w(!1)}}};return e.jsxs("section",{className:"panel tuner-panel",children:[e.jsxs("header",{className:"panel-header tuner-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Economy"}),e.jsx("h1",{children:Ne}),e.jsx("p",{className:"subtle",children:ve})]}),e.jsxs("div",{className:"toggle-wrap",children:[e.jsx("span",{className:"subtle",children:"Productive"}),e.jsxs("label",{className:"ios-switch",children:[e.jsx("input",{type:"checkbox",checked:u==="frivolity",onChange:b=>o(b.target.checked?"frivolity":"productive")}),e.jsx("span",{className:"slider"})]}),e.jsx("span",{className:"subtle",children:"Frivolous"})]})]}),D&&e.jsx("div",{className:"inline-note",style:{maxWidth:"420px"},children:D}),l&&e.jsx("div",{className:"inline-note",style:{maxWidth:"520px"},children:l}),e.jsxs("section",{className:"card",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:16,flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0},children:"Daily coin reset"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Start each day at 0 f-coins so frivolity must be re-earned today."})]}),e.jsxs("label",{className:"settings-inline",style:{margin:0},children:[e.jsx("input",{type:"checkbox",checked:C,onChange:b=>le(b.target.checked),disabled:r}),e.jsx("span",{className:"subtle",children:C?"Enabled":"Disabled"})]})]}),e.jsxs("section",{className:"card economy-exchange-card",children:[e.jsxs("div",{className:"economy-exchange-header",children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0},children:"Exchange rate"}),e.jsx("p",{className:"subtle",style:{marginBottom:0},children:"Make the system feel intuitive: how much â€œfrivolity timeâ€ 1 minute of productive time buys."})]}),e.jsx("button",{className:"primary",onClick:he,disabled:A||!U||U<=0,children:A?"Applyingâ€¦":"Apply to spend profiles"})]}),e.jsxs("div",{className:"economy-exchange-grid",children:[e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Current (typical)"}),e.jsxs("strong",{children:["1 min work â†’ ",ye?ye.toFixed(2):"â€”"," min frivolity"]})]}),e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Target"}),e.jsxs("strong",{children:["1 min work â†’ ",U?U.toFixed(2):"â€”"," min frivolity"]})]}),e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Effect"}),e.jsxs("strong",{children:[me?`${me.toFixed(2)}Ã—`:"â€”"," spend costs"]})]})]}),e.jsxs("div",{className:"economy-exchange-controls",children:[e.jsxs("div",{className:"economy-exchange-presets",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(.5),disabled:A,children:"0.5Ã—"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(1),disabled:A,children:"1Ã— (1:1)"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(2),disabled:A,children:"2Ã—"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(ye),disabled:A||!ye,children:"Reset"})]}),e.jsxs("label",{style:{display:"grid",gap:8,margin:0},children:[e.jsx("span",{className:"subtle",children:"Minutes of frivolity per minute of work"}),e.jsx("input",{type:"range",min:.25,max:4,step:.05,value:U||1,onChange:b=>F(Number(b.target.value)),disabled:A})]})]}),e.jsxs("p",{className:"subtle",style:{marginBottom:0},children:["This scales all ",e.jsx("strong",{children:"spend"})," profiles (frivolity domains) while keeping your individual profile shapes and pack options. Use â€œAdvancedâ€ below if you want domain-specific tuning."]})]}),e.jsxs("details",{className:"card economy-advanced",open:!1,children:[e.jsxs("summary",{className:"economy-advanced-summary",children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx("strong",{children:"Advanced: per-domain tuning"}),e.jsx("span",{className:"subtle",children:"Power-user controls for rates, curves, and packs."})]}),e.jsx("span",{className:"economy-advanced-toggle","aria-hidden":"true"})]}),e.jsx("div",{className:"economy-advanced-body",children:e.jsxs("div",{className:"tuner-layout",children:[e.jsxs("aside",{className:"tuner-list",children:[e.jsx("div",{style:{padding:"0 4px 8px 4px",borderBottom:"1px solid rgba(255,255,255,0.05)",marginBottom:"8px"},children:P?e.jsxs("form",{onSubmit:be,style:{display:"flex",gap:"6px"},children:[e.jsx("input",{autoFocus:!0,placeholder:"domain.com",value:z,onChange:b=>K(b.target.value),style:{flex:1,minWidth:0,padding:"6px 8px",fontSize:"13px",background:"rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"6px",color:"white"}}),e.jsx("button",{type:"submit",className:"primary",style:{padding:"6px 10px",fontSize:"13px"},children:"Add"}),e.jsx("button",{type:"button",className:"ghost",style:{padding:"6px",fontSize:"13px"},onClick:()=>L(!1),children:"âœ•"})]}):e.jsx("button",{className:"ghost",style:{width:"100%",textAlign:"center",fontSize:"13px"},onClick:()=>L(!0),children:"+ Add Profile"})}),q.map(b=>e.jsxs("button",{className:`tuner-list-item ${i===b.id?"active":""}`,onClick:()=>d(b.id),children:[e.jsx("div",{className:"tuner-list-title",children:b.id}),e.jsxs("div",{className:"tuner-list-sub",children:[b.rate.ratePerMin," f-coins/min â€¢ ",b.type]})]},b.id)),q.length===0&&e.jsx("div",{className:"subtle",style:{padding:"12px"},children:"No items in this category."})]}),e.jsx("div",{className:"tuner-editor",children:H?e.jsxs("div",{className:"tuner-grid",children:[e.jsxs("div",{className:"card tuner-primary",children:[e.jsxs("div",{className:"tuner-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:H.id}),e.jsx("p",{className:"subtle",children:H.type==="productive"?"Earn profile":"Spend profile"})]}),e.jsx("button",{className:"primary",onClick:oe,disabled:v||ie,children:ie?"Locked by active session":v?"Saving...":"Save changes"}),e.jsx("button",{className:"ghost danger",disabled:ie,onClick:async()=>{H&&confirm(`Delete profile for ${H.id}?`)&&(await s.market.delete(H.id),await $(),d(null))},children:"Delete"})]}),ie&&e.jsx("div",{className:"inline-note danger",style:{marginBottom:"8px"},children:"Active session running for this domain â€” end it to adjust the exchange rate."}),M&&e.jsx("div",{className:"inline-note warning",style:{marginBottom:"8px"},children:M}),ke.length>0&&e.jsx("div",{className:"tuner-metrics",children:ke.map(b=>e.jsxs("div",{className:"metric-card",children:[e.jsx("span",{className:"metric-label",children:b.label}),e.jsx("strong",{className:"metric-value",children:b.value})]},b.label))}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Base rate (per minute)"}),e.jsx("input",{type:"number",value:H.rate.ratePerMin,onChange:b=>W(Number(b.target.value)),step:"0.1",min:"0.1",max:"100",disabled:ie}),e.jsx("p",{className:"subtle",children:H.type==="productive"?"f-coins earned per minute.":"f-coins spent per minute when metered."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Time multiplier curve"}),e.jsx("p",{className:"subtle",children:"Adjust how the value changes throughout the day. 1x is standard."}),e.jsx(Gt,{values:H.rate.hourlyModifiers,onChange:Q,color:H.type==="productive"?"var(--cat-productive)":"var(--cat-frivolity)",disabled:ie})]})]}),e.jsxs("div",{className:"card tuner-secondary",children:[e.jsx("div",{className:"tuner-header",children:e.jsxs("div",{children:[e.jsx("h3",{children:T?"Earnings preview":"Packs preview"}),e.jsx("p",{className:"subtle",children:T?"How this profileâ€™s rate and curve would surface in payout views.":"Show what users see when buying time."})]})}),e.jsxs("div",{className:"packs-preview",children:[H.rate.packs.length===0&&e.jsx("p",{className:"subtle",children:T?"No packs defined â€” optional for earn profiles.":"No packs defined â€” consider adding 10/30/60 minute options."}),H.rate.packs.map((b,J)=>e.jsxs("div",{className:"pack-card",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[b.minutes," minute session"]}),e.jsxs("p",{className:"subtle",children:[b.price," f-coins â€¢ ",(b.price/b.minutes*60).toFixed(1)," f-coins/hour"]})]}),e.jsx("button",{className:"ghost danger",disabled:ie,onClick:()=>{const ce=[...H.rate.packs];ce.splice(J,1),te(H.id,{...H.rate,packs:ce})},children:"Remove"})]},b.minutes)),!T&&e.jsx("div",{style:{marginTop:"8px"},children:Z?e.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("input",{type:"number",placeholder:"Minutes",value:k,onChange:b=>R(Number(b.target.value)),min:"5",max:"120",style:{width:"80px"}}),e.jsx("input",{type:"number",placeholder:"Price",value:Y,onChange:b=>B(Number(b.target.value)),min:"1",max:"500",style:{width:"80px"}}),e.jsx("button",{className:"primary",disabled:ie,onClick:()=>{const b=[...H.rate.packs,{minutes:k,price:Y}];te(H.id,{...H.rate,packs:b}),G(!1),R(10),B(8)},children:"Add"}),e.jsx("button",{className:"ghost",onClick:()=>G(!1),children:"Cancel"})]}):e.jsx("button",{className:"ghost",disabled:ie,onClick:()=>G(!0),children:"+ Add pack"})})]})]})]}):e.jsx("div",{className:"empty-state",children:"Select an item to tune"})})]})})]})]})}const Je=[{id:"sync",label:"Sync & Profile",description:"Devices, cloud sync, and identity."},{id:"activity",label:"Activity",description:"Idle thresholds and continuity rules."},{id:"paywall",label:"Paywall & Rituals",description:"Emergency access, peek, and journaling."},{id:"integrations",label:"Integrations",description:"Bring in external libraries."},{id:"domains",label:"Domains",description:"Productive vs neutral vs frivolous."},{id:"economy",label:"Economy",description:"Tune earn + spend profiles."},{id:"system",label:"System",description:"Reset data and permissions."}];function Yt({api:s,theme:n,onThemeChange:a}){const[i,d]=t.useState(!1),[u,o]=t.useState(!1),[v,x]=t.useState(null),[N,S]=t.useState("sync"),[M,g]=t.useState(15),[D,p]=t.useState(15),[y,F]=t.useState("balanced"),[A,w]=t.useState(300),[l,f]=t.useState(""),[C,I]=t.useState(10),[r,j]=t.useState(!0),[P,L]=t.useState(!1),[z,K]=t.useState(120),[k,R]=t.useState(""),[Y,B]=t.useState(2),[Z,G]=t.useState(null),[$,q]=t.useState([]),[H,ge]=t.useState(""),[ie,W]=t.useState(""),[Q,le]=t.useState("#7cf4d4"),[te,oe]=t.useState(!1),[be,Ne]=t.useState({mode:"recent",collectionId:null,includeSubcollections:!0}),[ve,ke]=t.useState([]),[T,O]=t.useState(!1),[ee,V]=t.useState("trophies"),[ue,ye]=t.useState(!1),[U,me]=t.useState(null),[he,b]=t.useState(!1),[J,ce]=t.useState("full-color"),[de,we]=t.useState(!1),[pe,Se]=t.useState([]),[ae,Pe]=t.useState(!1),[h,_]=t.useState(null);t.useEffect(()=>{if(!U)return;const m=window.setTimeout(()=>me(null),5e3);return()=>window.clearTimeout(m)},[U]),t.useEffect(()=>{s.settings.idleThreshold().then(g),s.settings.frivolousIdleThreshold().then(p),s.settings.emergencyPolicy().then(F),s.settings.emergencyReminderInterval().then(w),s.settings.journalConfig().then(m=>{f(m.url??""),I(m.minutes??10)}).catch(()=>{}),s.settings.peekConfig().then(m=>{j(m.enabled),L(m.allowOnNewPages)}).catch(()=>{}),s.settings.continuityWindowSeconds().then(K).catch(()=>{}),s.settings.productivityGoalHours().then(B).catch(()=>{}),s.settings.excludedKeywords().then(m=>{R((m??[]).join(`
`))}).catch(()=>{}),s.settings.cameraModeEnabled().then(b).catch(()=>{}),s.settings.guardrailColorFilter().then(ce).catch(()=>{}),s.settings.alwaysGreyscale().then(we).catch(()=>{}),s.integrations.zotero.config().then(Ne).catch(()=>{})},[s.settings,s.integrations.zotero]);const xe=async()=>{Pe(!0),_(null);try{const m=await s.camera.listPhotos(120);Se(m)}catch(m){console.error("Failed to load camera photos",m),_("Failed to load camera photos.")}finally{Pe(!1)}};t.useEffect(()=>{xe()},[]);const Ce=async()=>{if(!navigator.mediaDevices?.getUserMedia)throw new Error("Camera capture is not supported in this environment.");let m=null;try{m=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}finally{m?.getTracks().forEach(re=>re.stop())}},Ee=async m=>{if(_(null),m)try{await Ce()}catch(re){console.error("Camera permission request failed",re),_("Camera access is blocked. Enable TimeWellSpent in macOS System Settings â†’ Privacy & Security â†’ Camera, then try again."),b(!1);return}b(m)},De=async()=>{try{const m=await s.sync.status();if(G(m),ge(m.device?.name??""),m.configured&&m.authenticated){const re=await s.friends.profile();W(re?.handle??""),le(re?.color??"#7cf4d4");const Me=await s.sync.listDevices();q(Me)}else q([])}catch(m){console.error("Failed to load sync status",m)}};t.useEffect(()=>{De()},[]);const Re=t.useMemo(()=>be.collectionId==null?null:ve.find(m=>m.id===be.collectionId)??null,[ve,be.collectionId]);async function Le(){O(!0);try{const m=await s.integrations.zotero.collections();ke(m)}catch(m){console.error("Failed to load Zotero collections",m),x("Failed to load Zotero collections. Is Zotero installed and opened at least once?")}finally{O(!1)}}async function He(m){m?.preventDefault(),d(!0),o(!1),x(null);try{await s.settings.updateIdleThreshold(M),await s.settings.updateFrivolousIdleThreshold(D);const re=k.split(/[\n,]+/).map(Me=>Me.trim().toLowerCase()).filter(Boolean);await s.settings.updateExcludedKeywords(re),R(re.join(`
`)),await s.settings.updateEmergencyPolicy(y),await s.settings.updateEmergencyReminderInterval(A),await s.settings.updateJournalConfig({url:l.trim()?l.trim():null,minutes:C}),await s.settings.updatePeekConfig({enabled:r,allowOnNewPages:P}),await s.settings.updateContinuityWindowSeconds(z),await s.settings.updateProductivityGoalHours(Y),await s.settings.updateCameraModeEnabled(he),await s.settings.updateGuardrailColorFilter(J),await s.settings.updateAlwaysGreyscale(de),await s.integrations.zotero.updateConfig(be),o(!0),window.setTimeout(()=>o(!1),2e3)}catch(re){x(re.message||"Failed to save settings")}finally{d(!1)}}async function We(){if(ue)return;me(null);const m={trophies:"This will clear all earned trophies, pinned trophies, and personal bests.",wallet:"This will zero your bank balance and erase wallet transactions.",all:"This will clear trophies, activity history, wallet, library, and sync state. This cannot be undone."};if(window.confirm(`${m[ee]}

Continue?`)&&!(ee==="all"&&!window.confirm("Final check: erase all local/cloud stats now?"))){ye(!0),x(null);try{await s.system.reset(ee),me({trophies:"Trophy case reset locally and in sync.",wallet:"Bank reset locally and in sync.",all:"All stats reset locally and in sync."}[ee]),await De()}catch(re){x(re.message||"Failed to reset")}finally{ye(!1)}}}const ze=async m=>{try{await s.camera.revealPhoto(m)}catch(re){console.error("Failed to reveal camera photo",re),_("Failed to reveal camera photo.")}},Ue=async m=>{if(window.confirm("Delete this photo?"))try{await s.camera.deletePhoto(m),Se(re=>re.filter(Me=>Me.id!==m))}catch(re){console.error("Failed to delete camera photo",re),_("Failed to delete camera photo.")}},je=Je.find(m=>m.id===N)??Je[0],Be=Math.max(0,Je.findIndex(m=>m.id===N))+1,Ae=N!=="domains"&&N!=="economy";return e.jsxs("section",{className:"panel",children:[e.jsx("header",{className:"panel-header",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Settings"}),e.jsx("p",{className:"subtle",children:"Tune policies, domains, economy, and sync."})]})}),v&&e.jsx("p",{className:"error-text",children:v}),e.jsxs("div",{className:"settings-layout",children:[e.jsx("nav",{className:"settings-nav","aria-label":"Settings sections",children:Je.map(m=>e.jsxs("button",{type:"button",className:N===m.id?"active":"",onClick:()=>S(m.id),"aria-current":N===m.id?"page":void 0,children:[e.jsx("span",{className:"settings-nav-label",children:m.label}),e.jsx("span",{className:"settings-nav-desc",children:m.description})]},m.id))}),e.jsxs("div",{className:"settings-pane",children:[Ae&&e.jsxs("div",{className:"settings-pane-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:je.label}),e.jsx("p",{className:"subtle",children:je.description})]}),e.jsxs("span",{className:"pill ghost",children:["Section ",Be," of ",Je.length]})]}),N==="sync"&&e.jsx("div",{className:"settings-pane-body",children:e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Cloud sync"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Keep wallet, library, and summaries aligned across devices."})]}),e.jsx("button",{type:"button",className:"ghost",onClick:De,disabled:te,children:"Refresh"})]}),!Z?.configured&&e.jsx("p",{className:"subtle",children:"Supabase not configured. Add `SUPABASE_URL` and `SUPABASE_ANON_KEY`, then restart the app."}),Z?.configured&&!Z.authenticated&&e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"primary",onClick:async()=>{oe(!0),await s.sync.signIn("google"),oe(!1)},disabled:te,children:"Connect with Google"}),e.jsx("button",{type:"button",className:"secondary",onClick:async()=>{oe(!0),await s.sync.signIn("github"),oe(!1)},disabled:te,children:"Connect with GitHub"})]}),Z?.configured&&Z.authenticated&&e.jsxs("div",{className:"settings-stack",children:[e.jsxs("div",{className:"settings-pills",children:[e.jsx("span",{className:"pill ghost",children:Z.user?.email??Z.user?.id}),e.jsxs("span",{className:"pill ghost",children:["Device ",Z.device?.id?.slice(0,8)]}),Z.lastSyncAt&&e.jsxs("span",{className:"pill ghost",children:["Last sync ",new Date(Z.lastSyncAt).toLocaleString()]})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Device name",e.jsx("input",{type:"text",value:H,onChange:m=>ge(m.target.value),placeholder:"My MacBook"})]}),e.jsxs("label",{children:["Handle",e.jsx("input",{type:"text",value:ie,onChange:m=>W(m.target.value),placeholder:"your_handle"})]}),e.jsxs("label",{children:["Accent color",e.jsx("input",{type:"color",value:Q,onChange:m=>le(m.target.value)})]})]}),e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"primary",onClick:async()=>{oe(!0),x(null);try{await s.sync.setDeviceName(H),await s.friends.updateProfile({handle:ie.trim()||void 0,color:Q}),await s.sync.syncNow(),await De()}catch(m){x(m.message||"Failed to sync now")}finally{oe(!1)}},disabled:te,children:"Sync now"}),e.jsx("button",{type:"button",className:"secondary",onClick:async()=>{oe(!0),await s.sync.signOut(),await De(),oe(!1)},disabled:te,children:"Sign out"})]}),$.length>0&&e.jsx("div",{className:"devices-list",children:$.map(m=>e.jsxs("div",{className:`device-row ${m.isCurrent?"current":""}`,children:[e.jsxs("div",{children:[e.jsx("strong",{children:m.name}),e.jsx("span",{className:"subtle",children:m.platform})]}),e.jsx("span",{className:"subtle",children:m.lastSeenAt?`Seen ${new Date(m.lastSeenAt).toLocaleString()}`:"Pending"})]},m.id))})]})]})}),N==="activity"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Activity detection"}),e.jsx("p",{className:"subtle",children:"Tune idle detection."})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Idle threshold (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:M,onChange:m=>g(Number(m.target.value))})]}),e.jsxs("label",{children:["Frivolous idle (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:D,onChange:m=>p(Number(m.target.value))})]}),e.jsxs("label",{children:["Continuity window (seconds)",e.jsx("input",{type:"number",min:"0",max:"900",value:z,onChange:m=>K(Number(m.target.value))})]})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{children:["Daily productivity goal (hours)",e.jsx("input",{type:"number",min:"0.5",max:"12",step:"0.1",value:Y,onChange:m=>B(Number(m.target.value))})]})}),e.jsxs("label",{children:["Keywords to exclude",e.jsx("textarea",{rows:3,value:k,onChange:m=>R(m.target.value),placeholder:"One keyword per line"})]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Lower values mark passive browsing as idle sooner."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Excluded keywords stay neutral and are hidden from stream trackers."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Continuity keeps short research hops in the same productive run."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Daily productivity goal powers the dashboard ring."})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:i,children:i?"Savingâ€¦":u?"Saved!":"Save changes"})})]}),N==="paywall"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Paywall controls"}),e.jsx("p",{className:"subtle",children:"Emergency + peek behavior."})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Emergency policy",e.jsxs("select",{value:y,onChange:m=>F(m.target.value),children:[e.jsx("option",{value:"off",children:"Off"}),e.jsx("option",{value:"gentle",children:"Gentle"}),e.jsx("option",{value:"balanced",children:"Balanced"}),e.jsx("option",{value:"strict",children:"Strict"})]})]}),e.jsxs("label",{children:["Reminder interval (seconds)",e.jsx("input",{type:"number",min:"30",max:"3600",value:A,onChange:m=>w(Number(m.target.value))})]})]}),e.jsxs("details",{className:"settings-details",children:[e.jsx("summary",{children:"Policy details"}),e.jsxs("div",{className:"subtle",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Off"}),": no emergency access."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Gentle"}),": 5m, URL-locked, unlimited/day."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Balanced"}),": 3m, 2/day, 30m cooldown."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Strict"}),": 2m, 1/day, 60m cooldown."]})]})]}),e.jsxs("div",{className:"settings-inline",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r,onChange:m=>j(m.target.checked)}),e.jsx("span",{className:"subtle",children:"Enable peek"})]}),e.jsxs("label",{style:{opacity:r?1:.6},children:[e.jsx("input",{type:"checkbox",checked:P,onChange:m=>L(m.target.checked),disabled:!r}),e.jsx("span",{className:"subtle",children:"Allow peek on new pages"})]})]})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Guardrails: color filters"}),e.jsx("p",{className:"subtle",children:"Make frivolity visually and economically cheaper when filtered."})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{children:["Frivolity color filter",e.jsxs("select",{value:J,onChange:m=>ce(m.target.value),children:[e.jsx("option",{value:"full-color",children:"Full color (standard cost)"}),e.jsx("option",{value:"greyscale",children:"Greyscale (cheaper)"}),e.jsx("option",{value:"redscale",children:"Redscale (cheaper)"})]})]})}),e.jsx("div",{className:"settings-inline",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:de,onChange:m=>we(m.target.checked)}),e.jsx("span",{className:"subtle",children:"Always greyscale (global override)"})]})}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Pricing applies when starting new frivolity sessions."})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Camera mode"}),e.jsx("p",{className:"subtle",children:"Captures a still every minute during frivolity. Stored locally on this Mac. macOS will prompt for camera access when enabling."})]}),e.jsxs("div",{className:"settings-inline",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:he,onChange:m=>{Ee(m.target.checked)}}),e.jsx("span",{className:"subtle",children:"Enable camera mode"})]}),e.jsx("button",{type:"button",className:"ghost",onClick:xe,disabled:ae,children:ae?"Refreshingâ€¦":"Refresh gallery"}),e.jsxs("span",{className:"subtle",children:[pe.length," photos"]})]}),h&&e.jsx("p",{className:"error-text",children:h}),pe.length===0?e.jsx("p",{className:"subtle",style:{marginTop:12},children:"No photos yet."}):e.jsx("div",{className:"camera-gallery-grid",children:pe.map(m=>e.jsxs("div",{className:"camera-card",children:[e.jsx("img",{className:"camera-photo",src:m.fileUrl,alt:"Camera capture",loading:"lazy"}),e.jsxs("div",{className:"camera-meta",children:[e.jsx("strong",{children:m.subject??"Frivolity"}),e.jsx("span",{className:"subtle",children:new Date(m.capturedAt).toLocaleString()})]}),e.jsxs("div",{className:"camera-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>ze(m.id),children:"Reveal"}),e.jsx("button",{type:"button",className:"danger",onClick:()=>Ue(m.id),children:"Delete"})]})]},m.id))})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Journaling"}),e.jsx("p",{className:"subtle",children:"Quick launch for reset prompts."})]}),e.jsxs("label",{children:["Journal URL",e.jsx("input",{type:"text",placeholder:"https://app.tana.inc/â€¦",value:l,onChange:m=>f(m.target.value)})]}),e.jsxs("label",{style:{maxWidth:260},children:["Duration (minutes)",e.jsx("input",{type:"number",min:"1",max:"180",value:C,onChange:m=>I(Number(m.target.value))})]})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:i,children:i?"Savingâ€¦":u?"Saved!":"Save changes"})})]}),N==="integrations"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Integrations"}),e.jsx("p",{className:"subtle",children:"Curate â€œTry this insteadâ€."})]}),e.jsxs("label",{children:["Zotero source",e.jsxs("select",{value:be.mode,onChange:m=>{const re=m.target.value;Ne(Me=>({...Me,mode:re==="collection"?"collection":"recent"}))},children:[e.jsx("option",{value:"recent",children:"Recent items"}),e.jsx("option",{value:"collection",children:"Specific collection"})]})]}),be.mode==="collection"&&e.jsxs("div",{className:"settings-stack",children:[e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Le,disabled:T,children:T?"Loadingâ€¦":"Refresh collections"}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"checkbox",checked:be.includeSubcollections,onChange:m=>Ne(re=>({...re,includeSubcollections:m.target.checked}))}),e.jsx("span",{className:"subtle",children:"Include subcollections"})]})]}),e.jsxs("select",{value:be.collectionId??"",onChange:m=>{const re=m.target.value,Me=re?Number(re):null;Ne(ss=>({...ss,collectionId:Me&&Number.isFinite(Me)?Me:null}))},children:[e.jsx("option",{value:"",children:"Select a collectionâ€¦"}),ve.map(m=>e.jsx("option",{value:m.id,children:m.path},m.id))]}),e.jsx("p",{className:"subtle",style:{margin:0},children:Re?`Selected: ${Re.path}`:"No collection selected."})]})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:i,children:i?"Savingâ€¦":u?"Saved!":"Save changes"})})]}),N==="domains"&&e.jsx(zt,{api:s,variant:"settings"}),N==="economy"&&e.jsx(Kt,{api:s}),N==="system"&&e.jsxs("div",{className:"settings-pane-body",children:[e.jsxs("section",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Theme"}),e.jsx("p",{className:"subtle",children:"Choose your vibe."})]}),e.jsxs("div",{className:"settings-stack",children:[e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"theme",value:"lavender",checked:n==="lavender",onChange:()=>a("lavender")}),e.jsx("span",{children:"Lavender (default)"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"theme",value:"olive",checked:n==="olive",onChange:()=>a("olive")}),e.jsx("span",{children:"Olive Garden Feast"})]})]})]}),U&&e.jsx("div",{className:`settings-banner ${ee==="all"?"danger":"success"}`,children:e.jsxs("div",{children:[e.jsx("strong",{children:U}),e.jsx("div",{className:"subtle",children:"You may need to refresh to see empty states."})]})}),e.jsxs("section",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Reset data"}),e.jsx("p",{className:"subtle",children:"Start fresh. Choose what to clear."})]}),e.jsxs("div",{className:"settings-stack",children:[e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"trophies",checked:ee==="trophies",onChange:()=>V("trophies")}),e.jsx("span",{className:"subtle",children:"Reset trophy case only"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"wallet",checked:ee==="wallet",onChange:()=>V("wallet")}),e.jsx("span",{className:"subtle",children:"Reset bank only (wallet balance and transactions)"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"all",checked:ee==="all",onChange:()=>V("all")}),e.jsx("span",{className:"subtle",children:"Reset everything (wallet, history, trophies, library)"})]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"This also removes the selected data from cloud sync if you are signed in."}),e.jsx("button",{type:"button",className:"secondary",onClick:We,disabled:ue,children:ue?"Resettingâ€¦":"Reset now"})]})]}),e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Accessibility permissions"}),e.jsxs("ol",{className:"instructions",children:[e.jsx("li",{children:"Open System Settings â†’ Privacy & Security â†’ Accessibility."}),e.jsx("li",{children:"Click the lock to make changes and authenticate."}),e.jsx("li",{children:"Find â€œTimeWellSpentâ€ in the list and toggle it on."}),e.jsx("li",{children:"Repeat under â€œAutomationâ€ to allow browser control."})]}),e.jsxs("p",{className:"subtle",children:["You can paste ",e.jsx("code",{children:"x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"})," into Spotlight to jump there quickly."]})]})]})]})]})]})}function qt({api:s}){const[n,a]=t.useState("7d"),[i,d]=t.useState(null),[u,o]=t.useState([]),[v,x]=t.useState([]),[N,S]=t.useState([]),[M,g]=t.useState(!0),[D,p]=t.useState([]),y=t.useMemo(()=>{switch(n){case"24h":return 1;case"7d":return 7;case"30d":return 30}},[n]),F=t.useCallback(async()=>{g(!0);const[r,j,P,L]=await Promise.all([s.analytics.overview(y),s.analytics.timeOfDay(y),s.analytics.patterns(y),s.analytics.trends(y<=1?"hour":"day")]);d(r),o(j),x(P),S(L),g(!1)},[s,y]);t.useEffect(()=>{F()},[F]),t.useEffect(()=>{s.settings.excludedKeywords().then(p).catch(()=>{})},[s]);const A=r=>{const j=r>=12?"PM":"AM";return`${r%12||12}${j}`},w=t.useMemo(()=>Math.max(...u.map(r=>r.productive+r.neutral+r.frivolity+r.draining+r.emergency+r.idle),1),[u]),l=t.useMemo(()=>v.filter(r=>r.toContext.category==="frivolity").slice(0,6),[v]),f=t.useCallback(r=>{if(!D.length)return!1;const j=r.toLowerCase();return D.some(P=>P&&j.includes(P))},[D]),C=t.useCallback(r=>r?f(r)?"Hidden":r:null,[f]),I=t.useCallback(r=>{if(!D.length)return r;let j=r;for(const P of D){if(!P)continue;const L=P.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");j=j.replace(new RegExp(L,"gi"),"[hidden]")}return j},[D]);return e.jsxs("section",{className:"panel analytics-panel",children:[e.jsxs("header",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Behavioral intelligence"}),e.jsx("h1",{children:"Analytics"})]}),e.jsxs("div",{className:"time-range-selector",children:[e.jsx("button",{className:n==="24h"?"active":"",onClick:()=>a("24h"),children:"24h"}),e.jsx("button",{className:n==="7d"?"active":"",onClick:()=>a("7d"),children:"7d"}),e.jsx("button",{className:n==="30d"?"active":"",onClick:()=>a("30d"),children:"30d"})]})]}),M?e.jsxs("div",{className:"panel-body analytics-loading",children:[e.jsx("div",{className:"loader-spinner"}),e.jsx("p",{children:"Analyzing behavioral data..."})]}):e.jsxs("div",{className:"panel-body analytics-grid",children:[e.jsxs("div",{className:"analytics-overview",children:[e.jsxs("div",{className:"overview-card primary",children:[e.jsxs("div",{className:"overview-value",children:[i?.productivityScore??0,"%"]}),e.jsx("div",{className:"overview-label",children:"Productivity Score"}),e.jsxs("div",{className:`overview-trend trend-${i?.focusTrend??"stable"}`,children:[i?.focusTrend==="improving"&&"â†‘ Improving",i?.focusTrend==="declining"&&"â†“ Declining",i?.focusTrend==="stable"&&"â†’ Stable"]})]}),e.jsxs("div",{className:"overview-card glow",children:[e.jsxs("div",{className:"overview-value",children:[i?Math.round(i.deepWorkSeconds/3600*10)/10:0,"h"]}),e.jsx("div",{className:"overview-label",children:"Deep Work"})]}),e.jsxs("div",{className:"overview-card",children:[e.jsxs("div",{className:"overview-value",children:[i?.totalActiveHours??0,"h"]}),e.jsx("div",{className:"overview-label",children:"Active Time"})]}),e.jsxs("div",{className:"overview-card",children:[e.jsx("div",{className:"overview-value",children:i?.totalSessions??0}),e.jsx("div",{className:"overview-label",children:"Sessions"})]}),e.jsxs("div",{className:"overview-card accent",children:[e.jsx("div",{className:"overview-value",children:A(i?.peakProductiveHour??9)}),e.jsx("div",{className:"overview-label",children:"Peak Focus Hour"})]}),e.jsxs("div",{className:"overview-card danger",children:[e.jsx("div",{className:"overview-value",children:A(i?.riskHour??15)}),e.jsx("div",{className:"overview-label",children:"Risk Hour"})]})]}),e.jsxs("div",{className:"card insights-card",children:[e.jsx("h2",{children:"ðŸ§  AI Insights"}),e.jsxs("ul",{className:"insights-list",children:[(i?.insights??[]).map((r,j)=>e.jsx("li",{children:I(r)},j)),(i?.insights??[]).length===0&&e.jsx("li",{className:"subtle",children:"Keep using the app to generate insights..."})]})]}),e.jsxs("div",{className:"card heatmap-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Time of Day Activity"}),e.jsx("span",{className:"subtle",children:"24-hour pattern"})]}),e.jsx("div",{className:"time-heatmap",children:u.map(r=>{const j=r.productive+r.neutral+r.frivolity+r.draining+r.emergency+r.idle,P=j>0?Math.max(8,Math.round(j/w*100)):4,L=j>0?r.productive/j*100:0,z=j>0?r.neutral/j*100:0,K=j>0?r.frivolity/j*100:0,k=j>0?r.draining/j*100:0,R=j>0?r.emergency/j*100:0,Y=r.dominantCategory;return e.jsxs("div",{className:`heatmap-col ${Y}`,title:`${A(r.hour)}: ${Math.round(j/60)}m total`,children:[e.jsxs("div",{className:"heatmap-bar",style:{height:`${P}%`},children:[e.jsx("span",{className:"bar-segment productive",style:{height:`${L}%`}}),e.jsx("span",{className:"bar-segment neutral",style:{height:`${z}%`}}),e.jsx("span",{className:"bar-segment frivolity",style:{height:`${K}%`}}),e.jsx("span",{className:"bar-segment draining",style:{height:`${k}%`}}),e.jsx("span",{className:"bar-segment emergency",style:{height:`${R}%`}})]}),e.jsx("span",{className:"heatmap-label",children:St(r.hour,hs)%6===0?A(r.hour):""})]},r.hour)})}),e.jsxs("div",{className:"heatmap-legend",children:[e.jsxs("span",{children:[e.jsx("span",{className:"dot productive"})," Productive"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot neutral"})," Neutral"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot frivolity"})," Frivolity"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot draining"})," Draining"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot emergency"})," Emergency"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot deepwork"})," Deep work"]})]})]}),e.jsxs("div",{className:"card breakdown-card",children:[e.jsx("h2",{children:"Category Breakdown"}),e.jsx("div",{className:"breakdown-bars",children:i&&["productive","deepWork","neutral","frivolity","draining","emergency","idle"].map(r=>{const j=Object.values(i.categoryBreakdown).reduce((K,k)=>K+k,0),P=r==="deepWork"?i.deepWorkSeconds:i.categoryBreakdown[r]??0,L=j>0?Math.round(P/j*100):0,z=Math.round(P/3600*10)/10;return e.jsxs("div",{className:"breakdown-row",children:[e.jsx("span",{className:"breakdown-label",children:r==="deepWork"?"deep work":r}),e.jsx("div",{className:"breakdown-bar-track",children:e.jsx("div",{className:`breakdown-bar-fill ${r}`,style:{width:`${L}%`}})}),e.jsxs("span",{className:"breakdown-value",children:[z,"h"]}),e.jsxs("span",{className:"breakdown-percent",children:[L,"%"]})]},r)})})]}),e.jsxs("div",{className:"card trends-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Activity Trends"}),e.jsx("span",{className:"subtle",children:"Quality over time"})]}),e.jsx("div",{className:"trends-chart",children:N.map((r,j)=>{const P=r.draining??0,L=r.productive+r.neutral+r.frivolity+r.emergency+P,z=Math.max(...N.map(ge=>ge.productive+ge.neutral+ge.frivolity+ge.emergency+(ge.draining??0)),1),K=Math.max(4,Math.round(L/z*100)),k=L>0?r.deepWork/L*100:0,R=L>0?r.emergency/L*100:0,Y=L>0?P/L*100:0,B=L>0?r.frivolity/L*100:0,Z=L>0?r.neutral/L*100:0,G=R,$=G+Y,q=$+B,H=$+B+Z;return e.jsxs("div",{className:"trend-bar",title:`${r.label}: ${Math.round(L/60)}m active, ${r.qualityScore}% quality`,children:[e.jsx("div",{className:"trend-bar-fill",style:{height:`${K}%`,background:`linear-gradient(to top, 
                          var(--cat-emergency) ${G||0}%,
                          var(--cat-draining) ${$||0}%, 
                          var(--cat-frivolity) ${q||0}%, 
                          var(--cat-neutral) ${H||50}%, 
                          var(--cat-productive) 100%)`},children:k>0&&e.jsx("span",{className:"trend-deepwork-overlay",style:{height:`${k}%`}})}),e.jsx("span",{className:"trend-label",children:r.label})]},j)})})]}),e.jsxs("div",{className:"card patterns-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"ðŸ”€ What Leads to Frivolity"}),e.jsx("span",{className:"subtle",children:"Transition patterns"})]}),e.jsxs("ul",{className:"patterns-list",children:[l.map((r,j)=>e.jsxs("li",{className:"pattern-row",children:[e.jsxs("div",{className:"pattern-from",children:[e.jsx("span",{className:`category-chip category-${r.fromContext.category??"neutral"}`,children:r.fromContext.category??"neutral"}),e.jsx("span",{className:"pattern-domain",children:C(r.fromContext.domain)??"Any"})]}),e.jsx("span",{className:"pattern-arrow",children:"â†’"}),e.jsxs("div",{className:"pattern-to",children:[e.jsx("span",{className:"category-chip category-frivolity",children:"frivolity"}),e.jsx("span",{className:"pattern-domain",children:C(r.toContext.domain)??"Any"})]}),e.jsxs("div",{className:"pattern-stats",children:[e.jsxs("span",{className:"pattern-frequency",children:[r.frequency,"Ã—"]}),e.jsxs("span",{className:"pattern-time",children:[Math.round(r.avgTimeBefore/60),"m avg"]})]})]},j)),l.length===0&&e.jsx("li",{className:"subtle",children:"No significant patterns detected yet"})]})]}),i?.topEngagementDomain&&e.jsxs("div",{className:"card top-domain-card",children:[e.jsx("h2",{children:"ðŸŽ¯ Top Engagement"}),e.jsx("div",{className:"top-domain-name",children:C(i.topEngagementDomain)}),e.jsx("p",{className:"subtle",children:"Most time spent domain this period"})]})]})]})}const us=[[8,0,0,0,0,0,0,0,0],[0,0,3,6,0,0,0,0,0],[0,7,0,0,9,0,2,0,0],[0,5,0,0,0,7,0,0,0],[0,0,0,0,4,5,7,0,0],[0,0,0,1,0,0,0,3,0],[0,0,1,0,0,0,0,6,8],[0,0,8,5,0,0,0,1,0],[0,9,0,0,0,0,4,0,0]],Zs=[[8,1,2,7,5,3,6,4,9],[9,4,3,6,8,2,1,7,5],[6,7,5,4,9,1,2,8,3],[1,5,4,2,3,7,8,9,6],[3,6,9,8,4,5,7,2,1],[2,8,7,1,6,9,5,3,4],[5,2,1,9,7,4,3,6,8],[4,3,8,5,2,6,9,1,7],[7,9,6,3,1,8,4,5,2]],Js=us.flatMap((s,n)=>s.flatMap((a,i)=>a===0?[{row:n,col:i}]:[]));function js(){return us.map(s=>s.map(n=>n===0?"":String(n)))}function ot({title:s,subtitle:n,requiredCorrect:a=12,unlockLabel:i="Unlock",onUnlock:d,disabled:u=!1,puzzleKey:o}){const[v,x]=t.useState(()=>js()),[N,S]=t.useState(()=>Date.now()),[M,g]=t.useState(!1),[D,p]=t.useState(null),y=t.useMemo(()=>Math.max(1,Math.min(Js.length,Math.round(a))),[a]),F=t.useMemo(()=>Js.reduce((I,r)=>{const j=v[r.row]?.[r.col];return j&&Number(j)===Zs[r.row][r.col]?I+1:I},0),[v]),A=F>=y,w=Math.min(100,F/y*100);t.useEffect(()=>{x(js()),S(Date.now()),p(null),g(!1)},[o]);const l=(I,r,j)=>{if(us[I][r]!==0||u)return;const P=j.replace(/[^1-9]/g,"").slice(-1);x(L=>{const z=L.map(K=>[...K]);return z[I][r]=P,z})},f=()=>{x(js()),S(Date.now()),p(null)},C=async()=>{if(!(!d||!A||M||u)){g(!0),p(null);try{await d({correctSquares:F,requiredSquares:y,elapsedSeconds:Math.max(1,Math.round((Date.now()-N)/1e3))})}catch(I){p(I.message)}finally{g(!1)}}};return e.jsxs("section",{className:"sudoku-challenge",children:[e.jsxs("div",{className:"sudoku-header",children:[e.jsx("strong",{children:s}),n&&e.jsx("p",{className:"subtle",children:n})]}),e.jsxs("div",{className:"sudoku-progress-row",children:[e.jsxs("span",{children:["Correct squares: ",F,"/",y]}),e.jsxs("span",{children:[w.toFixed(0),"%"]})]}),e.jsx("div",{className:"sudoku-progress-track","aria-hidden":!0,children:e.jsx("span",{style:{width:`${w}%`}})}),e.jsx("div",{className:"sudoku-grid",role:"group","aria-label":"Sudoku puzzle",children:us.map((I,r)=>I.map((j,P)=>{const L=j!==0,z=L?String(j):v[r][P],K=z.length>0,k=!L&&K&&Number(z)===Zs[r][P],Y=["sudoku-cell",L?"is-fixed":"",k?"is-correct":"",!L&&K&&!k?"is-incorrect":""].filter(Boolean).join(" ");return e.jsx("input",{className:Y,type:"text",inputMode:"numeric",pattern:"[1-9]",maxLength:1,value:z,disabled:L||u||M,onChange:B=>l(r,P,B.target.value),style:{borderTopWidth:r%3===0?2:1,borderLeftWidth:P%3===0?2:1,borderRightWidth:P===8?2:1,borderBottomWidth:r===8?2:1},"aria-label":`Row ${r+1} column ${P+1}`},`${r}-${P}`)}))}),e.jsxs("div",{className:"sudoku-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:f,disabled:M,children:"Reset puzzle"}),d?e.jsx("button",{type:"button",className:"primary",onClick:C,disabled:!A||M||u,children:M?"Unlocking...":i}):e.jsx("span",{className:"subtle",children:A?"Challenge complete.":"Practice mode"})]}),D&&e.jsx("p",{className:"warning subtle",children:D})]})}const Vt=(s,n,a)=>Math.min(Math.max(s,n),a),Qs=12,vs=12;function Xt({open:s,state:n,wallet:a,api:i,marketRates:d,onWallet:u,onClose:o}){const[v,x]=t.useState(!1),[N,S]=t.useState(null),[M,g]=t.useState(15),D=t.useMemo(()=>{if(n)return d.find($=>$.domain===n.domain)},[d,n?.domain]),p=t.useMemo(()=>{const $=D?.packs.map(ie=>ie.minutes)??[],q=$.length?Math.min(...$):10,H=$.length?Math.max(...$):30,ge=Math.max(H,q+15,45);return{min:Math.max(5,q),max:ge,step:5}},[D]);if(t.useEffect(()=>{if(!s||!n)return;const $=D?.packs?.[0]?.minutes??p.min;g(Vt($,p.min,p.max))},[s,D,p.max,p.min,n?.domain]),t.useEffect(()=>{s&&S(null)},[s,n?.domain]),!s||!n)return null;async function y(){if(n){x(!0),S(null);try{await i.paywall.startMetered(n.domain);const $=await i.wallet.get();u($),o()}catch($){console.error($),S($.message)}finally{x(!1)}}}async function F($){if(n){x(!0),S(null);try{await i.paywall.buyPack(n.domain,$);const q=await i.wallet.get();u(q),o()}catch(q){console.error(q),S(q.message)}finally{x(!1)}}}async function A($){if(n){x(!0),S(null);try{await i.paywall.startChallengePass(n.domain,{durationSeconds:vs*60,solvedSquares:$});const q=await i.wallet.get();u(q),o()}catch(q){console.error(q),S(q.message)}finally{x(!1)}}}const w=n.reason==="blocked",l=n.reason==="insufficient-funds",f=D?.ratePerMin??n.ratePerMin??0,C=D?.packs.find($=>$.minutes===M),I=C?C.price:Math.max(1,Math.round(M*f)),r=a.balance>0?Math.min(1,I/a.balance):1,j=Math.max(0,a.balance-I),P=72,L=2*Math.PI*P,z=L*(1-r),K=a.balance>=I,k=Math.round((p.min+p.max)/2),R=a.balance>0?Math.min(1,f*15/a.balance):1,Y=Math.min(1,M/(24*60)),B=r*100,Z=Math.round(Y*100),G=[{label:"Quick peek",minutes:Math.max(5,Math.round(M*.4))},{label:"This choice",minutes:M},{label:"Deep dive",minutes:Math.min(120,Math.round(M*1.6))}].map($=>({...$,cost:Math.max(1,Math.round($.minutes*f))}));return e.jsx("div",{className:"paywall-overlay",children:e.jsxs("div",{className:"paywall-modal",children:[e.jsxs("header",{className:"paywall-modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:n.domain}),e.jsx("p",{className:"subtle",children:w?"Access blocked â€” unlock by spending f-coins.":"Spend f-coins to access this site."})]}),e.jsx("button",{className:"close-button",onClick:o,"aria-label":"Close paywall",children:"âœ•"})]}),e.jsxs("div",{className:"wallet-inline",children:[e.jsx("span",{children:"Balance"}),e.jsxs("strong",{children:[a.balance," f-coins"]})]}),w&&!N&&e.jsx("p",{className:"warning",children:"Start a metered session or buy a time pack to access this site."}),l&&!N&&e.jsx("p",{className:"warning",children:"Session paused â€” add more coins or choose a smaller pack."}),e.jsxs("section",{className:"spend-lab",children:[e.jsxs("div",{className:"budget-visual",children:[e.jsxs("div",{className:"budget-circle",role:"img","aria-label":`Spending ${I} coins for ${M} minutes`,children:[e.jsxs("svg",{viewBox:"0 0 200 200",width:"200",height:"200",children:[e.jsx("circle",{className:"budget-track",cx:"100",cy:"100",r:P,strokeWidth:"14"}),e.jsx("circle",{className:"budget-fill",cx:"100",cy:"100",r:P,strokeWidth:"14",strokeDasharray:L,strokeDashoffset:z})]}),e.jsxs("div",{className:"budget-figures",children:[e.jsxs("strong",{children:[I," f-coins"]}),e.jsxs("span",{children:[M," minute session"]}),e.jsxs("small",{className:"subtle",children:[B.toFixed(0),"% of balance"]})]})]}),e.jsxs("div",{className:"impact-bars",children:[e.jsxs("div",{children:[e.jsx("div",{className:"impact-label",children:"Wallet impact"}),e.jsx("div",{className:"impact-meter",children:e.jsx("span",{style:{width:`${B}%`}})}),e.jsxs("small",{className:"subtle",children:["Leaves ",j," f-coins"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"impact-label",children:"Day share"}),e.jsx("div",{className:"impact-meter day",children:e.jsx("span",{style:{width:`${Z}%`}})}),e.jsxs("small",{className:"subtle",children:[Z,"% of your day if you stay that long"]})]})]})]}),e.jsxs("div",{className:"budget-controls",children:[e.jsx("div",{className:"eyebrow",children:"Session length"}),e.jsx("p",{className:"subtle",children:"Choose how long you want to access this site."}),e.jsx("input",{id:"focus-budget",type:"range",min:p.min,max:p.max,step:p.step,value:M,onChange:$=>g(Number($.target.value))}),e.jsxs("div",{className:"budget-scale",children:[e.jsxs("span",{children:[p.min," min"]}),e.jsxs("span",{children:[k," min"]}),e.jsxs("span",{children:[p.max,"+ min"]})]}),e.jsx("div",{className:"projection-grid",children:G.map($=>e.jsxs("div",{className:"projection-card",children:[e.jsxs("div",{className:"projection-minutes",children:[$.minutes,"m"]}),e.jsx("div",{className:"projection-label",children:$.label}),e.jsxs("div",{className:"projection-cost",children:[$.cost," coins"]}),e.jsx("div",{className:"projection-bar",children:e.jsx("span",{style:{width:`${Math.min(100,$.cost/Math.max(a.balance,$.cost)*100)}%`}})})]},$.label))}),e.jsxs("button",{className:"primary",disabled:v||!K,onClick:()=>F(M),children:["Unlock for ",I," f-coins"]}),!K&&e.jsxs("p",{className:"warning subtle",children:["Need ",I-a.balance," more f-coins."]})]})]}),e.jsxs("section",{className:"paywall-section",children:[e.jsx("div",{className:"eyebrow",children:"Other unlocks"}),e.jsxs("div",{className:"option-grid",children:[e.jsxs("button",{className:"option-card",disabled:v,onClick:y,children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Pay as you go"}),e.jsx("p",{className:"subtle",children:"Only pay while the tab is active."})]}),e.jsx("div",{className:"option-meter",children:e.jsx("span",{style:{width:`${R*100}%`}})}),e.jsxs("small",{className:"chip",children:[f," f-coins/min"]})]}),D?.packs.map($=>{const q=a.balance>0?Math.min(1,$.price/a.balance):1;return e.jsxs("button",{className:"option-card",disabled:v||a.balance<$.price,onClick:()=>F($.minutes),children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[$.minutes," minute session"]}),e.jsx("p",{className:"subtle",children:"Fixed time â€” pause anytime."})]}),e.jsx("div",{className:"option-meter",children:e.jsx("span",{style:{width:`${q*100}%`}})}),e.jsxs("small",{className:"chip",children:[$.price," f-coins"]})]},$.minutes)})]})]}),e.jsxs("section",{className:"paywall-section challenge-section",children:[e.jsx("div",{className:"eyebrow",children:"Free unlock (game gate)"}),e.jsx(ot,{puzzleKey:n.domain,title:"Hard Sudoku checkpoint",subtitle:`Solve ${Qs} correct squares to earn a ${vs}-minute free pass.`,requiredCorrect:Qs,unlockLabel:`Claim ${vs}-minute free pass`,onUnlock:({correctSquares:$})=>A($),disabled:v})]}),typeof n.remainingSeconds=="number"&&n.remainingSeconds>0&&e.jsxs("p",{className:"subtle",children:["Remaining: ",Math.round(n.remainingSeconds/60)," min"]})]})})}const Ve=[{value:"replace",label:"Replace",hint:"Shown in â€œTry this insteadâ€ when you hit a paywall."},{value:"productive",label:"Productive",hint:"Counts as productive time and appears in your productive shelf."},{value:"allow",label:"Allow",hint:"Good stuff you want nearby. Optional one-time unlock pricing."},{value:"temptation",label:"Temptation",hint:"Things you enjoy, but want contained and intentional."}];function Zt(s){return Ve.find(n=>n.value===s)?.label??s}function Jt(s){return s==="replace"||s==="productive"?"productive":s==="temptation"?"frivolity":"neutral"}function Qt(s){let n=s.trim();if(!n)return null;!n.startsWith("http://")&&!n.startsWith("https://")&&(n=`https://${n}`);try{return new URL(n),n}catch{return null}}function et(s){const n=Number(s);return!Number.isFinite(n)||!Number.isInteger(n)||n<1?null:n}function ys(s){return new Date(s).toLocaleDateString()}function en(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function sn(s){return new Date(`${s}T00:00:00`).toLocaleDateString([],{month:"short",day:"numeric"})}function tn(s){const n=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0");return`${n}-${a}-${i}`}function nn(s){return s&&s.charAt(0).toUpperCase()+s.slice(1)}function an(s){let n=0;for(let a=0;a<s.length;a+=1)n=(n<<5)-n+s.charCodeAt(a),n|=0;return Math.abs(n)}function Ss(s){try{return new URL(s).hostname.replace(/^www\./,"")}catch{return s}}function ln(s){const n=Ss(s);return`https://www.google.com/s2/favicons?domain=${encodeURIComponent(n)}&sz=64`}function rn(s){return`https://image.thum.io/get/width/640/${encodeURIComponent(s)}`}function cn({api:s}){const[n,a]=t.useState([]),[i,d]=t.useState(!0),[u,o]=t.useState("replace"),[v,x]=t.useState(!1),[N,S]=t.useState("library"),[M,g]=t.useState(()=>tn(new Date)),[D,p]=t.useState([]),[y,F]=t.useState([]),[A,w]=t.useState(!1),[l,f]=t.useState(null),[C,I]=t.useState(!1),[r,j]=t.useState(""),[P,L]=t.useState("replace"),[z,K]=t.useState(!1),[k,R]=t.useState(12),[Y,B]=t.useState(""),[Z,G]=t.useState(""),[$,q]=t.useState(!1),[H,ge]=t.useState(null),[ie,W]=t.useState(null),[Q,le]=t.useState("replace"),[te,oe]=t.useState(!1),[be,Ne]=t.useState(12),[ve,ke]=t.useState(""),[T,O]=t.useState(""),[ee,V]=t.useState(!1),[ue,ye]=t.useState(null),[U,me]=t.useState(!1),he=t.useCallback(async()=>{try{const h=await s.library.list();a(h),ie&&!h.some(_=>_.id===ie)&&W(null)}catch(h){console.error("Failed to load library items:",h)}finally{d(!1)}},[s.library,ie]),b=t.useCallback(async h=>{w(!0),f(null);try{const[_,xe]=await Promise.all([s.history.list(h),s.history.days(30)]);p(_),F(xe)}catch(_){console.error("Failed to load consumption history:",_),f(_.message||"Failed to load history")}finally{w(!1)}},[s.history]);t.useEffect(()=>{he()},[he]),t.useEffect(()=>{N==="history"&&b(M)},[M,b,N]),t.useEffect(()=>{const h=s.events.on("library:changed",()=>he());return()=>h()},[s,he]),t.useEffect(()=>{N==="history"&&I(!1)},[N]);const J=t.useMemo(()=>{let h=u==="all"?n:n.filter(_=>_.purpose===u);return v&&(h=h.filter(_=>typeof _.price=="number")),h},[u,n,v]),ce=()=>{j(""),L("replace"),K(!1),R(12),B(""),G(""),q(!1),ge(null)},de=async h=>{h.preventDefault(),ge(null);const _=Qt(r);if(!_)return ge("Enter a valid URL (e.g. https://example.com).");let xe=null;if(P==="allow"&&z){const Ce=et(k);if(!Ce)return ge("Unlock price must be a whole number of at least 1.");xe=Ce}me(!0);try{await s.library.add({kind:"url",url:_,title:Y.trim()||void 0,note:Z.trim()||void 0,purpose:P,price:xe,isPublic:$}),I(!1),ce(),await he()}catch(Ce){ge(Ce.message||"Failed to add item")}finally{me(!1)}},we=h=>{W(h.id),le(h.purpose),oe(typeof h.price=="number"),Ne(typeof h.price=="number"?h.price:12),ke(h.title??""),O(h.note??""),V(!!h.isPublic),ye(null)},pe=()=>{W(null),ye(null)},Se=async h=>{if(h.preventDefault(),!ie)return;ye(null);let _=null;if(Q==="allow"&&te){const xe=et(be);if(!xe)return ye("Unlock price must be a whole number of at least 1.");_=xe}me(!0);try{const xe=ve.trim(),Ce=T.trim();await s.library.update(ie,{title:xe||null,note:Ce||null,purpose:Q,price:_,isPublic:ee}),W(null),await he()}catch(xe){ye(xe.message||"Failed to update item")}finally{me(!1)}},ae=async h=>{if(confirm("Remove this item from your library?"))try{await s.library.remove(h),await he()}catch(_){console.error("Failed to remove library item:",_)}},Pe=async h=>{me(!0);try{const _=h.consumedAt?null:new Date().toISOString();await s.library.update(h.id,{consumedAt:_}),await he()}catch(_){console.error("Failed to update consumed status:",_)}finally{me(!1)}};return i?e.jsx("div",{className:"panel",children:"Loading library..."}):e.jsxs("section",{className:"page store-page",children:[e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Library"}),e.jsx("p",{className:"subtle",children:N==="history"?"Review what you consumed by day â€” productive items and frivolous sessions.":"A calm, curated pool of â€œwhat I meant to doâ€. Replace is what the paywall offers you first."}),e.jsxs("div",{className:"library-tabs",children:[e.jsx("button",{type:"button",className:`library-tab ${N==="library"?"active":""}`,onClick:()=>S("library"),children:"Library"}),e.jsx("button",{type:"button",className:`library-tab ${N==="history"?"active":""}`,onClick:()=>S("history"),children:"History"})]})]}),N==="library"&&e.jsx("button",{className:"primary",onClick:()=>I(!0),children:"+ Add Link"})]}),N==="library"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",gap:14},children:[e.jsxs("label",{children:["View",e.jsxs("select",{value:u,onChange:h=>o(h.target.value),disabled:U,children:[e.jsx("option",{value:"replace",children:"Replace"}),e.jsx("option",{value:"productive",children:"Productive"}),e.jsx("option",{value:"allow",children:"Allow"}),e.jsx("option",{value:"temptation",children:"Temptation"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center",marginTop:22},children:[e.jsx("input",{type:"checkbox",checked:v,onChange:h=>x(h.target.checked),disabled:U}),e.jsx("span",{className:"subtle",children:"Priced only"})]})]}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:u==="all"?"All library items.":Ve.find(h=>h.value===u)?.hint})]}),C&&e.jsxs("div",{className:"card add-item-form",children:[e.jsx("h3",{children:"Add to Library"}),e.jsxs("form",{onSubmit:de,children:[H&&e.jsx("p",{className:"error-text",children:H}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"URL"}),e.jsx("input",{type:"text",placeholder:"https://â€¦",value:r,onChange:h=>j(h.target.value),disabled:U})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Purpose"}),e.jsx("select",{value:P,onChange:h=>{const _=h.target.value;L(_),_!=="allow"&&K(!1)},disabled:U,children:Ve.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:Ve.find(h=>h.value===P)?.hint})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:z,disabled:U||P!=="allow",onChange:h=>K(h.target.checked)}),"One-time unlock price (optional)"]}),e.jsx("input",{type:"number",min:1,max:500,step:1,value:k,disabled:U||P!=="allow"||!z,onChange:h=>{const _=Number.parseInt(h.target.value,10);R(Number.isNaN(_)?1:_)}}),e.jsxs("p",{className:"subtle",style:{marginTop:8},children:["Pricing only applies to ",e.jsx("strong",{children:"Allow"})," items. It appears under â€œProceed anywayâ€ when you land on that exact URL."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Title (optional)"}),e.jsx("input",{type:"text",value:Y,onChange:h=>B(h.target.value),disabled:U})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Note (optional)"}),e.jsx("textarea",{value:Z,onChange:h=>G(h.target.value),disabled:U})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:$,disabled:U,onChange:h=>q(h.target.checked)}),"Share with friends (public)"]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Only friends will see this in their feeds."})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{I(!1),ce()},disabled:U,children:"Cancel"}),e.jsx("button",{type:"submit",className:"primary",disabled:U,children:"Add"})]})]})]}),J.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No items here yet."}),e.jsx("p",{className:"subtle",children:"Tip: right-click a page or link and â€œSave to TimeWellSpentâ€."})]}):e.jsx("div",{className:"library-grid",children:J.map(h=>{const _=h.title||h.domain||h.app||"Saved item",xe=h.note||(h.url?Ss(h.url):h.app||h.domain||""),Ce=h.url?Ss(h.url):"",Ee=h.url?ln(h.url):null,De=h.url?rn(h.url):null,Re=h.domain??h.app??_,He={"--cover-hue":`${an(Re)%360}`},We=_.trim().charAt(0).toUpperCase()||"T",ze=ie===h.id,Ue=h.consumedAt?"Unmark done":"Mark done";return e.jsxs("article",{className:`card library-card ${h.consumedAt?"is-done":""}`,children:[e.jsxs("div",{className:`library-thumb ${h.kind==="app"?"app":""}`,style:He,children:[De&&h.kind==="url"&&e.jsx("img",{src:De,alt:"",loading:"lazy",onError:je=>{je.currentTarget.style.display="none"}}),e.jsxs("div",{className:"library-thumb-fallback",children:[e.jsx("span",{children:We}),h.kind==="app"&&e.jsx("small",{children:"App"})]}),Ee?e.jsx("img",{className:"library-favicon",src:Ee,alt:"",loading:"lazy"}):e.jsx("div",{className:"library-favicon library-favicon-placeholder","aria-hidden":"true"}),h.consumedAt&&e.jsx("div",{className:"library-done-badge",title:"Completed",children:"âœ“"})]}),e.jsxs("div",{className:"library-body",children:[e.jsxs("div",{className:"library-title-row",children:[e.jsxs("div",{children:[e.jsx("h3",{children:_}),e.jsx("p",{className:"subtle",children:xe})]}),e.jsx("span",{className:`pill ${Jt(h.purpose)}`,children:Zt(h.purpose)})]}),e.jsxs("div",{className:"library-meta",children:[e.jsx("span",{children:Ce||h.app||"Saved item"}),typeof h.price=="number"&&e.jsxs("span",{children:[h.price," f-coins unlock"]}),h.isPublic&&e.jsx("span",{children:"Public to friends"}),h.kind==="app"&&e.jsx("span",{children:"Desktop app"})]}),e.jsxs("div",{className:"library-dates",children:[e.jsxs("span",{children:["Added ",ys(h.createdAt)]}),h.consumedAt?e.jsxs("span",{children:["Done ",ys(h.consumedAt)]}):h.lastUsedAt?e.jsxs("span",{children:["Last used ",ys(h.lastUsedAt)]}):e.jsx("span",{children:"Not used yet"})]}),e.jsxs("div",{className:"library-actions",children:[h.url?e.jsx("a",{href:h.url,target:"_blank",rel:"noopener noreferrer",className:"icon-button",title:"Open link","aria-label":"Open link",children:e.jsx(st,{})}):e.jsx("button",{className:"icon-button",type:"button",disabled:!0,title:"Open link","aria-label":"Open link",children:e.jsx(st,{})}),e.jsx("button",{className:"icon-button",type:"button",onClick:()=>Pe(h),disabled:U,title:Ue,"aria-label":Ue,children:e.jsx(on,{})}),ze?e.jsx("button",{className:"icon-button",onClick:pe,disabled:U,title:"Cancel edit","aria-label":"Cancel edit",children:"X"}):e.jsx("button",{className:"icon-button",onClick:()=>we(h),disabled:U,title:"Edit","aria-label":"Edit",children:e.jsx(dn,{})}),e.jsx("button",{className:"icon-button danger",onClick:()=>ae(h.id),disabled:U,title:"Remove","aria-label":"Remove",children:e.jsx(un,{})})]}),ze&&e.jsxs("form",{className:"library-edit",onSubmit:Se,children:[ue&&e.jsx("p",{className:"error-text",children:ue}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Purpose"}),e.jsx("select",{value:Q,onChange:je=>{const Be=je.target.value;le(Be),Be!=="allow"&&oe(!1)},disabled:U,children:Ve.map(je=>e.jsx("option",{value:je.value,children:je.label},je.value))}),e.jsx("p",{className:"subtle",style:{margin:0},children:Ve.find(je=>je.value===Q)?.hint})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:te,disabled:U||Q!=="allow",onChange:je=>oe(je.target.checked)}),"One-time unlock price (optional)"]}),e.jsx("input",{type:"number",min:1,max:500,step:1,value:be,disabled:U||Q!=="allow"||!te,onChange:je=>{const Be=Number.parseInt(je.target.value,10);Ne(Number.isNaN(Be)?1:Be)}})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Title"}),e.jsx("input",{type:"text",value:ve,onChange:je=>ke(je.target.value),disabled:U})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Note"}),e.jsx("textarea",{value:T,onChange:je=>O(je.target.value),disabled:U})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:ee,disabled:U||h.kind==="app",onChange:je=>V(je.target.checked)}),"Share with friends (public)"]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Only friends will see this in their feeds."})]}),e.jsx("div",{className:"form-actions",style:{justifyContent:"flex-end"},children:e.jsx("button",{type:"submit",className:"primary",disabled:U,children:"Save"})})]})]})]},h.id)})})]}),N==="history"&&e.jsxs("div",{className:"card history-card",children:[e.jsxs("div",{className:"history-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Consumption log"}),e.jsx("p",{className:"subtle",children:"Productive items and frivolous sessions you opened each day."})]}),e.jsxs("label",{className:"history-picker",children:["Day",e.jsx("input",{type:"date",value:M,onChange:h=>g(h.target.value)})]})]}),y.length>0&&e.jsx("div",{className:"history-days",children:y.map(h=>e.jsxs("button",{type:"button",className:`history-day ${h.day===M?"active":""}`,onClick:()=>g(h.day),children:[e.jsx("span",{children:sn(h.day)}),e.jsx("span",{className:"history-day-count",children:h.count})]},h.day))}),A?e.jsx("div",{className:"subtle",children:"Loading historyâ€¦"}):l?e.jsx("div",{className:"error-text",children:l}):D.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No entries for this day yet."}),e.jsx("p",{className:"subtle",children:"Mark items as consumed or open a session to see them here."})]}):e.jsx("ul",{className:"history-list",children:D.map(h=>{const _=h.kind==="frivolous-session",xe=typeof h.meta?.purpose=="string"?h.meta.purpose:null,Ee=_?"pill frivolity":`pill ${xe==="temptation"?"frivolity":xe==="productive"||xe==="replace"?"productive":"neutral"}`,De=h.title??h.domain??"Untitled",Re=_?`Mode ${h.meta?.mode??"session"}`:h.url??h.domain??"Library item",Le=typeof h.meta?.mode=="string"?h.meta.mode:null,He=_?Le==="store"?"Store unlock":"Frivolous session":xe?`${nn(xe)} item`:"Library item";return e.jsxs("li",{className:"history-item",children:[e.jsx("div",{className:"history-time",children:en(h.occurredAt)}),e.jsxs("div",{className:"history-main",children:[e.jsx("strong",{children:De}),e.jsx("span",{className:"subtle",children:Re})]}),e.jsxs("div",{className:"history-actions",children:[e.jsx("span",{className:Ee,children:He}),h.url&&e.jsx("a",{className:"ghost",href:h.url,target:"_blank",rel:"noopener noreferrer",children:"Open"})]})]},h.id)})})]})]})}function st(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M14 4h6v6M10 14l10-10M20 14v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"})})}function on(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}function dn(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M4 20h4l10-10-4-4L4 16v4zM14 6l4 4"})})}function un(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M6 7h12M9 7V5h6v2M8 7l1 12h6l1-12"})})}function fs(s){return s.trim().replace(/^@/,"").toLowerCase()}function Qe(s){const n=s/3600;return n>=10?`${n.toFixed(0)}h`:`${n.toFixed(1)}h`}function ds(s){return`${Math.max(0,Math.min(100,Math.round(s)))}%`}function bs(s){return`${Math.round(s/60)}m`}function tt(s){return typeof s!="number"?"â€”":String(s)}function nt(s,n){const a=s?.categoryBreakdown.productive??0,i=n?.categoryBreakdown.productive??0,d=a+i;return d===0?50:Math.round(a/d*100)}function hn({api:s}){const[n,a]=t.useState(null),[i,d]=t.useState([]),[u,o]=t.useState({incoming:[],outgoing:[]}),[v,x]=t.useState({}),[N,S]=t.useState(null),[M,g]=t.useState(null),[D,p]=t.useState(null),[y,F]=t.useState(null),[A,w]=t.useState([]),[l,f]=t.useState(!1),[C,I]=t.useState([]),[r,j]=t.useState(""),[P,L]=t.useState(""),[z,K]=t.useState(null),[k,R]=t.useState(!1),[Y,B]=t.useState(null),[Z,G]=t.useState(!1),[$,q]=t.useState(!1);async function H(){B(null);try{const T=await s.sync.status(),O=T.configured&&T.authenticated;if(G(O),!O)return;const[ee,V,ue,ye,U,me,he]=await Promise.all([s.friends.profile(),s.friends.list(),s.friends.requests(),s.friends.summaries(24),s.friends.meSummary(24),s.trophies.list(),s.settings.competitiveOptIn()]);a(ee),g(ee),j(ee?.handle??""),d(V),o(ue),x(ye),S(U),I(me),q(he)}catch(T){console.error(T),B(T.message)}}t.useEffect(()=>{H()},[]);const ge=t.useMemo(()=>i.map(T=>{const O=v[T.userId],ee=O?.categoryBreakdown??null,V=O?.totalActiveSeconds??0,ue=ee?.draining??0,ye=V>0?ee.productive/V*100:0,U=V>0?ee.neutral/V*100:0,me=V>0?ee.frivolity/V*100:0,he=V>0?ue/V*100:0;return{friend:T,summary:O,totals:ee,productivePct:ye,neutralPct:U,frivolityPct:me,drainingPct:he}}),[i,v]),ie=t.useMemo(()=>{const T=new Map;return C.forEach(O=>T.set(O.id,O)),T},[C]);async function W(){B(null),R(!0);try{const T=await s.friends.updateProfile({handle:fs(r)});a(T),j(T.handle??"")}catch(T){B(T.message)}finally{R(!1)}}async function Q(){K(null);const T=fs(P);if(T)try{const O=await s.friends.findByHandle(T);K(O)}catch{K(null)}}async function le(){B(null),R(!0);try{await s.friends.request(fs(P)),L(""),K(null),await H()}catch(T){B(T.message)}finally{R(!1)}}async function te(T){R(!0),B(null);try{await s.friends.accept(T),await H()}catch(O){B(O.message)}finally{R(!1)}}async function oe(T){R(!0),B(null);try{await s.friends.decline(T),await H()}catch(O){B(O.message)}finally{R(!1)}}async function be(T){R(!0),B(null);try{await s.friends.cancel(T),await H()}catch(O){B(O.message)}finally{R(!1)}}async function Ne(T){if(confirm("Remove this friend?")){R(!0),B(null);try{await s.friends.remove(T),await H()}catch(O){B(O.message)}finally{R(!1)}}}async function ve(T){p(T),F(null),w([]),f(!0);try{const[O,ee]=await Promise.all([s.friends.timeline(T.userId,24),s.friends.publicLibrary(T.userId,168)]);F(O),w(ee??[])}catch(O){console.error("Failed to load friend detail",O)}}async function ke(T){q(T);try{await s.settings.updateCompetitiveOptIn(T)}catch(O){B(O.message||"Failed to update preference"),q(!T)}}return Z?e.jsxs("section",{className:"page store-page",children:[e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Friends"}),e.jsx("p",{className:"subtle",children:"A low-key feed of daily focus â€” aggregates only (no URLs)."})]}),e.jsx("div",{style:{display:"flex",gap:10},children:e.jsx("button",{className:"ghost",disabled:k,onClick:H,children:"Refresh"})})]}),Y&&e.jsx("p",{className:"error-text",children:Y}),e.jsxs("div",{className:"card settings-section",style:{marginBottom:16},children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Competitive view"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Opt in to show winners/losers and head-to-head bars."})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{className:"settings-inline",style:{alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:$,onChange:T=>ke(T.target.checked)}),e.jsx("span",{className:"subtle",children:$?"Enabled":"Disabled"})]})})]}),e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Your handle"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Handle",e.jsx("input",{value:r,onChange:T=>j(T.target.value),placeholder:"e.g. timewell"})]}),e.jsx("button",{className:"primary",disabled:k,onClick:W,children:"Update"})]}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:"Handles are lowercase letters, numbers, and underscores (3-20)."})]}),e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Add friend"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Friend handle",e.jsx("input",{value:P,onChange:T=>L(T.target.value),onBlur:Q,placeholder:"@friend"})]}),e.jsx("button",{className:"primary",disabled:k||!P.trim(),onClick:le,children:"Send request"})]}),z&&e.jsxs("p",{className:"subtle",style:{marginTop:8},children:["Found ",z.displayName??z.handle??"friend","."]})]}),(u.incoming.length>0||u.outgoing.length>0)&&e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Requests"}),u.incoming.map(T=>e.jsxs("div",{className:"device-row",style:{marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:T.displayName??T.handle??"Friend"}),e.jsx("span",{className:"subtle",children:"Incoming"})]}),e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{className:"primary",disabled:k,onClick:()=>te(T.id),children:"Accept"}),e.jsx("button",{className:"ghost",disabled:k,onClick:()=>oe(T.id),children:"Decline"})]})]},T.id)),u.outgoing.map(T=>e.jsxs("div",{className:"device-row",style:{marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:T.displayName??T.handle??"Friend"}),e.jsx("span",{className:"subtle",children:"Pending"})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"ghost",disabled:k,onClick:()=>be(T.id),children:"Cancel"})})]},T.id))]}),e.jsx("div",{className:"store-grid",children:i.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No friends yet."}),e.jsx("p",{className:"subtle",children:"Add a handle to start a tiny, supportive feed."})]}):ge.map(({friend:T,summary:O,totals:ee,productivePct:V,neutralPct:ue,frivolityPct:ye,drainingPct:U})=>{const me=(T.pinnedTrophies??[]).map(he=>ie.get(he)).filter(he=>!!he);return e.jsxs("div",{className:"card store-item",children:[e.jsxs("div",{className:"store-item-headline",children:[e.jsxs("div",{children:[e.jsx("p",{className:"store-item-domain",children:T.displayName??T.handle??"Friend"}),e.jsx("h3",{className:"store-item-title",children:O?`${O.productivityScore}% productive`:"No data yet"})]}),e.jsxs("div",{className:"store-item-price-pill",children:[e.jsx("strong",{children:O?Qe(O.totalActiveSeconds):"â€”"}),e.jsx("span",{children:"active"})]}),O&&e.jsxs("div",{className:"pill deepwork",style:{marginLeft:"auto"},children:[bs(O.deepWorkSeconds)," deep work"]})]}),$?e.jsx("div",{className:"head-to-head",children:O?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"head-to-head-row",children:[e.jsx("span",{children:"You"}),e.jsx("span",{children:O?T.displayName??T.handle??"Friend":"Friend"})]}),e.jsxs("div",{className:"head-to-head-bar fancy",children:[e.jsx("span",{className:"head-to-head-left",style:{width:`${nt(N,O)}%`,background:M?.color??"var(--accent)"}}),e.jsx("span",{className:"head-to-head-right",style:{width:`${100-nt(N,O)}%`,background:T.color??"rgba(255, 255, 255, 0.3)"}}),e.jsx("div",{className:"head-to-head-glow"})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[bs(N?.categoryBreakdown.productive??0)," productive"]}),e.jsxs("span",{children:[bs(O?.categoryBreakdown.productive??0)," productive"]})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[tt(N?.emergencySessions)," emergency"]}),e.jsxs("span",{children:[tt(O?.emergencySessions)," emergency"]})]})]}):e.jsx("p",{className:"subtle",style:{marginTop:6},children:"Waiting for shared activity data."})}):e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Competitive view is off."}),me.length>0&&e.jsx("div",{className:"friends-trophies",children:me.slice(0,3).map(he=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:he.emoji}),he.name]},he.id))}),O&&ee&&e.jsxs("div",{style:{marginTop:10},children:[e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Productive"}),e.jsxs("span",{children:[Qe(ee.productive)," (",ds(V),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${V}%`,background:"var(--cat-productive)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Neutral"}),e.jsxs("span",{children:[Qe(ee.neutral)," (",ds(ue),")"]})]}),e.jsx("div",{className:"impact-meter day",style:{marginTop:6},children:e.jsx("span",{style:{width:`${ue}%`,background:"var(--cat-neutral)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Frivolity"}),e.jsxs("span",{children:[Qe(ee.frivolity)," (",ds(ye),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${ye}%`,background:"var(--cat-frivolity)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Draining"}),e.jsxs("span",{children:[Qe(ee.draining??0)," (",ds(U),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${U}%`,background:"var(--cat-draining)"}})})]}),e.jsxs("div",{className:"store-item-meta",children:[e.jsxs("span",{children:["Last update ",O?new Date(O.updatedAt).toLocaleString():"â€”"]}),e.jsxs("span",{children:["@",T.handle??"no-handle"]})]}),e.jsxs("div",{className:"store-item-actions",children:[e.jsx("button",{className:"ghost",disabled:k,onClick:()=>ve(T),children:"Details"}),e.jsx("button",{className:"ghost danger",disabled:k,onClick:()=>Ne(T.id),children:"Remove"})]})]},T.id)})}),e.jsx(ct,{open:l,friend:D,summary:D?v[D.userId]??null:null,timeline:y,publicLibraryItems:A,trophies:C,onClose:()=>f(!1)})]}):e.jsxs("section",{className:"page store-page",children:[e.jsx("header",{className:"page-header",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Friends"}),e.jsx("p",{className:"subtle",children:"Add a friend by handle once you are signed in."})]})}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Connect Sync"}),e.jsx("p",{className:"subtle",children:"Friends require Supabase auth. Go to Settings â†’ Cloud sync and connect."})]})]})}const mn={attention:"Attention Control",recovery:"Recovery & Resilience",streaks:"Anti-Frivolity Streaks",economy:"Economy & Discipline",library:"Library & Intentionality",time:"Time-of-Day",stability:"Stability & Dynamics",fun:"Fun Flavor",social:"Social & Friends",secret:"Secret"},at=6;function pn(s){return`${Math.round(s)}m`}function xn(s){return s>=10?`${s.toFixed(0)}h`:`${s.toFixed(1)}h`}function gn({api:s}){const[n,a]=t.useState(null),[i,d]=t.useState([]),[u,o]=t.useState(!1),[v,x]=t.useState(!1),N=async()=>{const[l,f]=await Promise.all([s.trophies.profile(),s.trophies.list()]);a(l),d(f)};t.useEffect(()=>{N()},[]);const S=t.useMemo(()=>n?.pinnedTrophies?.length?n.pinnedTrophies:i.filter(l=>l.pinned).map(l=>l.id),[n,i]),M=t.useMemo(()=>{const l=new Map;return i.forEach(f=>l.set(f.id,f)),l},[i]),g=S.map(l=>M.get(l)).filter(l=>!!l),D=t.useMemo(()=>i.filter(l=>l.progress.state==="locked").sort((l,f)=>f.progress.ratio-l.progress.ratio).slice(0,4),[i]),p=t.useMemo(()=>{const l=new Map;return i.forEach(f=>{const C=f.category;l.has(C)||l.set(C,[]),l.get(C).push(f)}),l},[i]),y=async l=>{if(!v){x(!0);try{const f=S.includes(l)?S.filter(I=>I!==l):[...S,l].slice(0,at),C=await s.trophies.pin(f);a(I=>I&&{...I,pinnedTrophies:C}),d(I=>I.map(r=>({...r,pinned:C.includes(r.id)})))}finally{x(!1)}}},F=n?.profile?.displayName??n?.profile?.handle??"You",A=n?.profile?.handle?`@${n.profile.handle}`:"Not synced yet",w=n?.profile?.color??"var(--accent)";return e.jsxs("section",{className:"panel",children:[e.jsxs("header",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Profile"}),e.jsx("h1",{children:"Trophy case"}),e.jsx("p",{className:"subtle",children:"Your public card, progression, and achievements."})]}),e.jsx("button",{type:"button",className:`pill ghost ${u?"active":""}`,onClick:()=>o(l=>!l),children:u?"Hide preview":"Public preview"})]}),e.jsxs("div",{className:"profile-grid",children:[e.jsxs("div",{className:"card profile-card",children:[e.jsxs("div",{className:"profile-card-header",children:[e.jsx("div",{className:"profile-avatar",style:{background:w},children:F.trim().slice(0,2).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h2",{children:F}),e.jsx("span",{className:"subtle",children:A})]})]}),e.jsxs("div",{className:"profile-stats",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Weekly productive"}),e.jsx("strong",{children:n?pn(n.stats.weeklyProductiveMinutes):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Best run"}),e.jsx("strong",{children:n?xn(n.stats.bestRunMinutes/60):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Recovery median"}),e.jsx("strong",{children:n?.stats.recoveryMedianMinutes!=null?`${Math.round(n.stats.recoveryMedianMinutes)}m`:"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Frivolity streak"}),e.jsx("strong",{children:n?`${n.stats.currentFrivolityStreakHours}h`:"--"})]})]}),e.jsxs("div",{className:"profile-pinned",children:[e.jsxs("div",{className:"profile-pinned-header",children:[e.jsx("span",{className:"label",children:"Pinned trophies"}),e.jsxs("span",{className:"subtle",children:[g.length,"/",at]})]}),g.length===0?e.jsx("p",{className:"subtle",style:{margin:0},children:"Pin a few trophies so friends can see them."}):e.jsx("div",{className:"profile-badges",children:g.map(l=>e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:l.emoji}),e.jsx("span",{children:l.name})]},l.id))})]})]}),e.jsxs("div",{className:"card profile-next",children:[e.jsx("div",{className:"card-header-row",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Next up"}),e.jsx("h2",{children:"Close to unlocking"})]})}),D.length===0?e.jsx("p",{className:"subtle",children:"No tracked trophies yet. Keep logging activity."}):e.jsx("div",{className:"next-list",children:D.map(l=>e.jsxs("div",{className:"next-item",children:[e.jsxs("div",{className:"next-item-header",children:[e.jsx("span",{className:"emoji",children:l.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:l.name}),e.jsx("span",{className:"subtle",children:l.description})]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(l.progress.ratio*100)}%`}})}),e.jsx("span",{className:"subtle",children:l.progress.label??`${l.progress.current}/${l.progress.target}`})]},l.id))}),n?.earnedToday?.length?e.jsxs("div",{className:"earned-today",children:[e.jsx("span",{className:"label",children:"Earned today"}),e.jsx("div",{className:"profile-badges",children:n.earnedToday.map(l=>{const f=M.get(l);return f?e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:f.emoji}),e.jsx("span",{children:f.name})]},l):null})})]}):null]})]}),u&&e.jsxs("div",{className:"card profile-preview",children:[e.jsx("div",{className:"card-header-row",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Public preview"}),e.jsx("h2",{children:"What friends see"})]})}),e.jsxs("div",{className:"profile-preview-card",children:[e.jsx("div",{className:"profile-avatar",style:{background:w},children:F.trim().slice(0,2).toUpperCase()}),e.jsxs("div",{children:[e.jsx("strong",{children:F}),e.jsx("span",{className:"subtle",children:A})]}),e.jsx("div",{className:"profile-preview-badges",children:g.length===0?e.jsx("span",{className:"subtle",children:"No pinned trophies yet."}):g.map(l=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:l.emoji}),l.name]},l.id))})]})]}),e.jsxs("div",{className:"card trophy-case",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Trophy case"}),e.jsx("h2",{children:"Full collection"})]}),e.jsx("span",{className:"subtle",children:"Pin trophies to feature them on your card."})]}),Array.from(p.entries()).map(([l,f])=>e.jsxs("div",{className:"trophy-group",children:[e.jsx("h3",{children:mn[l]}),e.jsx("div",{className:"trophy-grid",children:f.map(C=>{const I=!C.earnedAt,r=C.secret&&I;return e.jsxs("div",{className:`trophy-card ${I?"locked":"earned"}`,children:[e.jsxs("div",{className:"trophy-card-header",children:[e.jsx("span",{className:"emoji",children:r?"â“":C.emoji}),e.jsx("button",{type:"button",className:`pill ghost ${C.pinned?"active":""}`,onClick:()=>y(C.id),disabled:v||!C.earnedAt,title:C.earnedAt?"Pin to profile":"Earn to pin",children:C.pinned?"Pinned":"Pin"})]}),e.jsx("strong",{children:r?"Classified":C.name}),e.jsx("p",{className:"subtle",children:r?"Keep going to reveal this trophy.":C.description}),C.progress.state==="untracked"?e.jsx("span",{className:"subtle",children:C.progress.label}):e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(C.progress.ratio*100)}%`}})}),C.earnedAt&&e.jsxs("span",{className:"subtle",children:["Earned ",new Date(C.earnedAt).toLocaleDateString()]})]},C.id)})})]},l))]})]})}const jn=[{name:"The Crossword",hint:"Full daily crossword.",url:"https://www.nytimes.com/crosswords/game/daily"},{name:"The Mini",hint:"Quick 5-minute crossword.",url:"https://www.nytimes.com/crosswords/game/mini"},{name:"Connections",hint:"Find the four hidden groups.",url:"https://www.nytimes.com/games/connections"},{name:"Wordle",hint:"One word, six tries.",url:"https://www.nytimes.com/games/wordle/index.html"},{name:"Spelling Bee",hint:"Build words from seven letters.",url:"https://www.nytimes.com/puzzles/spelling-bee"},{name:"Strands",hint:"Find the themed word web.",url:"https://www.nytimes.com/games/strands"}];function vn({wallet:s}){return e.jsxs("section",{className:"games-view panel",children:[e.jsxs("header",{className:"games-hero",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Games"}),e.jsx("p",{className:"subtle",children:"Intentional time burners: quick fun, finite sessions, less doom-scroll."})]}),e.jsxs("div",{className:"games-wallet-pill",children:[e.jsx("span",{children:"Wallet"}),e.jsxs("strong",{children:[s.balance," f-coins"]})]})]}),e.jsxs("section",{className:"games-links-section",children:[e.jsxs("div",{className:"section-header-row",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"NYT quick launch"}),e.jsx("p",{className:"subtle",children:"If you want to burn a little time, do it on purpose."})]}),e.jsx("a",{href:"https://www.nytimes.com/crosswords",target:"_blank",rel:"noopener noreferrer",className:"ghost button-link",children:"Open NYT games hub"})]}),e.jsx("div",{className:"games-links-grid",children:jn.map(n=>e.jsxs("a",{className:"nyt-link-card",href:n.url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx("div",{className:"nyt-link-title",children:n.name}),e.jsx("p",{className:"subtle",children:n.hint}),e.jsx("span",{className:"chip",children:"Open"})]},n.name))})]}),e.jsxs("section",{className:"games-sudoku-section",children:[e.jsx("div",{className:"section-header-row",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Paywall Sudoku drill"}),e.jsx("p",{className:"subtle",children:"Practice the same challenge used in the paywall free-pass flow."})]})}),e.jsx(ot,{title:"Hard Sudoku practice",subtitle:"Solve any 9 blank squares correctly.",requiredCorrect:9})]})]})}const dt=window.twsp,yn=160,fn=120,bn=4e3,Ns=104,Nn=.78;function ut(s){return new Promise(n=>window.setTimeout(n,s))}async function wn(s){const n=Date.now();for(;Date.now()-n<bn;){const a=s.videoWidth,i=s.videoHeight;if(s.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&a>=yn&&i>=fn)return{width:a,height:i};await ut(80)}throw new Error(`Camera stream resolution unusable (${s.videoWidth}x${s.videoHeight})`)}function it(s,n,a){const i=Math.max(1,Math.min(48,n)),d=Math.max(1,Math.min(48,a)),{data:u}=s.getImageData(0,0,i,d);let o=0;for(let v=0;v<u.length;v+=16){const x=u[v]??0,N=u[v+1]??0,S=u[v+2]??0;.2126*x+.7152*N+.0722*S>10&&(o+=1)}return o<=1}function ws(s){return Math.max(0,Math.min(1,s))}function lt(s,n,a,i,d=4){const u=Math.max(0,Math.min(n-1,Math.floor(i.x))),o=Math.max(0,Math.min(a-1,Math.floor(i.y))),v=Math.max(u+1,Math.min(n,Math.ceil(i.x+i.width))),x=Math.max(o+1,Math.min(a,Math.ceil(i.y+i.height)));let N=0,S=0;for(let M=o;M<x;M+=d)for(let g=u;g<v;g+=d){const D=(M*n+g)*4,p=s[D]??0,y=s[D+1]??0,F=s[D+2]??0;N+=.2126*p+.7152*y+.0722*F,S+=1}return S?N/S:0}function Sn(s,n,a){const i=s.getImageData(0,0,n,a),{data:d}=i,u=lt(d,n,a,{x:0,y:0,width:n,height:a},6),o=lt(d,n,a,{x:n*.22,y:a*.16,width:n*.56,height:a*.68},4),v=Math.max(0,u-o);if(!(o<Ns))return;const N=(Ns-o)/Ns,S=v/92,M=Math.min(Nn,Math.max(.18,N*.9+S*.45)),g=1-M*.38,D=1+M*.08,p=.38+M*.3;for(let y=0;y<d.length;y+=4){const F=(d[y]??0)/255,A=(d[y+1]??0)/255,w=(d[y+2]??0)/255,l=.2126*F+.7152*A+.0722*w,f=p*Math.max(0,(l-.68)/.32),C=I=>{const r=ws(I+M*(1-I)*.72),j=ws((Math.pow(r,g)-.5)*D+.5);return ws(j*(1-f)+I*f)};d[y]=Math.round(C(F)*255),d[y+1]=Math.round(C(A)*255),d[y+2]=Math.round(C(w)*255)}s.putImageData(i,0,0)}async function kn(s){const n=s.getCapabilities;if(typeof n!="function")return;const a=n.call(s),i=[];Array.isArray(a.exposureMode)&&a.exposureMode.includes("continuous")&&i.push({exposureMode:"continuous"}),Array.isArray(a.whiteBalanceMode)&&a.whiteBalanceMode.includes("continuous")&&i.push({whiteBalanceMode:"continuous"});const d=a.exposureCompensation;if(d&&Number.isFinite(d.max)&&Number.isFinite(d.min)){const u=Number(d.min),o=Number(d.max),v=Number.isFinite(d.step)&&Number(d.step)>0?Number(d.step):.1,x=Math.min(o,Math.max(u,.7)),N=Math.round(x/v)*v;i.push({exposureCompensation:Math.min(o,Math.max(u,N))})}if(i.length)try{await s.applyConstraints({advanced:i})}catch{}}async function Cn(s){let n=null;try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:!1});const[a]=n.getVideoTracks();a&&await kn(a);const i=document.createElement("video");i.srcObject=n,i.playsInline=!0,i.muted=!0,await i.play();const{width:d,height:u}=await wn(i),v=Math.min(1,640/d),x=Math.round(d*v),N=Math.round(u*v),S=document.createElement("canvas");S.width=x,S.height=N;const M=S.getContext("2d");if(!M)throw new Error("Unable to capture camera frame");if(M.drawImage(i,0,0,x,N),it(M,x,N)&&(await ut(180),M.drawImage(i,0,0,x,N),it(M,x,N)))throw new Error("Captured frame appears blank");Sn(M,x,N);const g=S.toDataURL("image/jpeg",.82);await dt.camera.storePhoto({dataUrl:g,subject:s.subject??null,domain:s.domain??null})}finally{n&&n.getTracks().forEach(a=>a.stop())}}function Mn(){const s=t.useRef(!1);return t.useEffect(()=>{const n=dt.events.on("camera:capture",async a=>{if(!s.current){s.current=!0;try{await Cn(a??{})}catch(i){console.warn("Camera capture failed",i)}finally{s.current=!1}}});return()=>{n()}},[]),null}const Pn=["Hello beautiful.","Good morning, bright mind.","Hey superstar.","Hello again, steady heart.","Welcome back, focus machine."],Dn=["Set the tone. The day follows.","Small levers, huge outcomes.","One clear choice beats a thousand edits.","Pick your rules before the feed does.","Today is made in small agreements."];function Tn(s){let n=0;for(let a=0;a<s.length;a+=1)n=(n<<5)-n+s.charCodeAt(a),n|=0;return Math.abs(n)}function rt(s,n){if(!s.length)return"";const a=Tn(n)%s.length;return s[a]}function $n({open:s,dayKey:n,initial:a,saving:i,error:d,onSave:u,onSkip:o}){const[v,x]=t.useState(a.goalHours),[N,S]=t.useState(a.idleThreshold),[M,g]=t.useState(a.continuityWindowSeconds),[D,p]=t.useState(a.emergencyPolicy),[y,F]=t.useState(a.note);t.useEffect(()=>{s&&(x(a.goalHours),S(a.idleThreshold),g(a.continuityWindowSeconds),p(a.emergencyPolicy),F(a.note))},[s,a]);const A=t.useMemo(()=>rt(Pn,n),[n]),w=t.useMemo(()=>rt(Dn,n+"tag"),[n]);return s?e.jsx("div",{className:"daily-onboarding-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"daily-onboarding-card",children:[e.jsxs("div",{className:"daily-onboarding-header",children:[e.jsxs("div",{className:"daily-onboarding-hero",children:[e.jsx("div",{className:"daily-onboarding-orb","aria-hidden":!0}),e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Daily landing"}),e.jsx("h2",{children:A}),e.jsx("p",{className:"subtle",children:w})]})]}),e.jsxs("div",{className:"daily-onboarding-meta",children:[e.jsx("span",{className:"pill ghost",children:"Morning tuning"}),e.jsx("span",{className:"pill ghost",children:"One screen"})]})]}),e.jsxs("div",{className:"daily-onboarding-panels",children:[e.jsxs("div",{className:"daily-onboarding-panel",children:[e.jsx("h3",{children:"Set your day"}),e.jsxs("div",{className:"daily-onboarding-grid",children:[e.jsxs("label",{children:["Productivity goal (hours)",e.jsx("input",{type:"number",min:"0.5",max:"12",step:"0.1",value:v,onChange:l=>x(Number(l.target.value))})]}),e.jsxs("label",{children:["Idle threshold (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:N,onChange:l=>S(Number(l.target.value))})]}),e.jsxs("label",{children:["Continuity window (seconds)",e.jsx("input",{type:"number",min:"0",max:"900",value:M,onChange:l=>g(Number(l.target.value))})]}),e.jsxs("label",{children:["Emergency policy",e.jsxs("select",{value:D,onChange:l=>p(l.target.value),children:[e.jsx("option",{value:"off",children:"Off"}),e.jsx("option",{value:"gentle",children:"Gentle"}),e.jsx("option",{value:"balanced",children:"Balanced"}),e.jsx("option",{value:"strict",children:"Strict"})]})]})]})]}),e.jsxs("div",{className:"daily-onboarding-panel",children:[e.jsx("h3",{children:"Note for end-of-day you"}),e.jsx("label",{className:"daily-onboarding-note",children:e.jsx("textarea",{rows:4,value:y,onChange:l=>F(l.target.value),placeholder:"Write something kind, firm, or honest. We'll bring it back later."})})]})]}),d&&e.jsx("p",{className:"error-text",children:d}),e.jsxs("div",{className:"daily-onboarding-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>o({note:y}),disabled:i,children:"Not now"}),e.jsx("button",{type:"button",className:"primary",onClick:()=>u({goalHours:v,idleThreshold:N,continuityWindowSeconds:M,emergencyPolicy:D,note:y}),disabled:i,children:i?"Saving...":"Set my day"})]})]})}):null}function En({open:s,note:n,onClose:a}){return s?e.jsx("div",{className:"daily-onboarding-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"daily-onboarding-card daily-note-card",children:[e.jsxs("div",{className:"daily-onboarding-header",children:[e.jsx("p",{className:"eyebrow",children:"End-of-day note"}),e.jsx("h2",{children:"For you, from you."})]}),e.jsx("div",{className:"daily-note-body",children:e.jsx("p",{children:n})}),e.jsx("div",{className:"daily-onboarding-actions",children:e.jsx("button",{type:"button",className:"primary",onClick:a,children:"Got it"})})]})}):null}const se=window.twsp,An=["dashboard","library","games","analytics","settings","friends","profile"],Fn=s=>An.includes(s),In=4,Rn=17;function es(s){const n=new Date(s);n.getHours()<In&&n.setDate(n.getDate()-1);const a=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0"),d=String(n.getDate()).padStart(2,"0");return`${a}-${i}-${d}`}function Ln(){const[s,n]=t.useState("dashboard"),[a,i]=t.useState({balance:0}),[d,u]=t.useState([]),[o,v]=t.useState(null),[x,N]=t.useState(()=>{try{return localStorage.getItem("tws-theme")==="olive"?"olive":"lavender"}catch{return"lavender"}}),[S,M]=t.useState({connected:!0,lastSeen:null}),[g,D]=t.useState(null),[p,y]=t.useState(null),[F,A]=t.useState(!1),[w,l]=t.useState(!1),[f,C]=t.useState(null),[I,r]=t.useState(2),[j,P]=t.useState(15),[L,z]=t.useState(120),[K,k]=t.useState("balanced"),[R,Y]=t.useState(""),[B,Z]=t.useState(!1),[G,$]=t.useState(Date.now());t.useEffect(()=>{se.wallet.get().then(i),se.market.list().then(u),se.economy.state().then(v)},[]),t.useEffect(()=>{const W=window.setInterval(()=>$(Date.now()),6e4);return()=>window.clearInterval(W)},[]),t.useEffect(()=>{let W=!0;return(async()=>{const le=es(new Date),[te,oe,be,Ne,ve]=await Promise.all([se.settings.dailyOnboardingState(),se.settings.productivityGoalHours(),se.settings.idleThreshold(),se.settings.continuityWindowSeconds(),se.settings.emergencyPolicy()]);if(W&&(y(te),r(oe),P(be),z(Ne),k(ve),Y(te.note?.day===le?te.note.message:""),te.completedDay!==le&&te.lastPromptedDay!==le)){const ke=await se.settings.updateDailyOnboardingState({lastPromptedDay:le});if(!W)return;y(ke),A(!0)}})().catch(()=>{}),()=>{W=!1}},[]),t.useEffect(()=>{if(!p?.note)return;const W=p.note,Q=es(new Date(G));if(W.acknowledged||W.day&&W.day>Q)return;const le=new Date(G);if(!(W.day===Q&&le.getHours()<Rn)&&!B&&(Z(!0),!W.deliveredAt)){const oe={...W,deliveredAt:new Date().toISOString()};se.settings.updateDailyOnboardingState({note:oe}).then(y).catch(()=>{})}},[p,B,G]),t.useEffect(()=>{const W=document.body;W.classList.remove("theme-olive"),x==="olive"&&W.classList.add("theme-olive");try{localStorage.setItem("tws-theme",x)}catch{}},[x]),t.useEffect(()=>{const W=se.events.on("ui:navigate",Q=>{const le=Q?.view;typeof le=="string"&&Fn(le)&&n(le)});return()=>{W()}},[]);const q=t.useRef(S);t.useEffect(()=>{q.current=S},[S]),t.useEffect(()=>{const W=se.events.on("wallet:update",i),Q=se.events.on("economy:activity",v),le=se.events.on("market:update",()=>{se.market.list().then(u)}),te=se.events.on("paywall:required",ve=>{if(q.current.connected&&["Google Chrome","Chrome","Brave Browser","Brave","Microsoft Edge","Edge","Arc","Firefox","Safari"].some(T=>ve.appName.includes(T))){console.log("Ignoring desktop paywall for browser activity (extension active):",ve);return}D({...ve,reason:"blocked"})}),oe=se.events.on("paywall:session-started",()=>{D(null)}),be=se.events.on("extension:status",ve=>{M(ve)}),Ne=se.events.on("paywall:session-ended",ve=>{ve.reason==="insufficient-funds"&&D({domain:ve.domain,appName:"",reason:ve.reason})});return()=>{W(),Q(),le(),te(),oe(),Ne(),be()}},[]);const H=async W=>{if(w)return;l(!0),C(null);const Q=es(new Date);try{await se.settings.updateProductivityGoalHours(W.goalHours),await se.settings.updateIdleThreshold(W.idleThreshold),await se.settings.updateContinuityWindowSeconds(W.continuityWindowSeconds),await se.settings.updateEmergencyPolicy(W.emergencyPolicy),r(W.goalHours),P(W.idleThreshold),z(W.continuityWindowSeconds),k(W.emergencyPolicy);const le=W.note.trim(),te={completedDay:Q,lastPromptedDay:Q,lastSkippedDay:null,note:le?{day:Q,message:le,deliveredAt:null,acknowledged:!1}:null},oe=await se.settings.updateDailyOnboardingState(te);y(oe),A(!1)}catch{C("Failed to save your settings. Try again.")}finally{l(!1)}},ge=async W=>{if(w)return;l(!0),C(null);const Q=es(new Date);try{const le=W.note.trim(),te={lastPromptedDay:Q,lastSkippedDay:Q,note:le?{day:Q,message:le,deliveredAt:null,acknowledged:!1}:null},oe=await se.settings.updateDailyOnboardingState(te);y(oe),A(!1)}catch{C("Failed to save your note. Try again.")}finally{l(!1)}},ie=async()=>{if(!p?.note){Z(!1);return}const W={...p.note,acknowledged:!0};try{const Q=await se.settings.updateDailyOnboardingState({note:W});y(Q)}catch{}finally{Z(!1)}};return e.jsxs("div",{className:"app-shell",children:[e.jsx(Mn,{}),!S.connected&&e.jsxs("div",{className:"extension-banner",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Browser extension offline"}),e.jsx("span",{className:"subtle",children:" Install or enable the TimeWellSpent extension to enforce in-browser paywalls."})]}),e.jsx("button",{className:"primary",onClick:()=>window.open("https://chromewebstore.google.com","_blank","noopener"),children:"Get extension"})]}),e.jsxs("div",{className:"window-chrome",children:[e.jsxs("div",{className:"window-chrome-title","aria-hidden":!0,children:[e.jsx("div",{className:"title-dot"}),e.jsx("span",{children:"TimeWellSpent"})]}),e.jsx("div",{className:"window-chrome-meta",children:e.jsxs("span",{className:"pill ghost big",children:[a?.balance??0," f-coins"]})})]}),e.jsxs("aside",{className:"sidebar",children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"logo",children:"â³"}),e.jsx("span",{children:"TimeWellSpent"})]}),e.jsxs("nav",{className:"nav-menu",children:[e.jsx("button",{className:s==="dashboard"?"active":"",onClick:()=>n("dashboard"),children:"Dashboard"}),e.jsx("button",{className:s==="library"?"active":"",onClick:()=>n("library"),children:"Library"}),e.jsx("button",{className:s==="games"?"active":"",onClick:()=>n("games"),children:"Games"}),e.jsx("button",{className:s==="settings"?"active":"",onClick:()=>n("settings"),children:"Settings"}),e.jsx("button",{className:s==="analytics"?"active":"",onClick:()=>n("analytics"),children:"Analytics"}),e.jsx("button",{className:s==="friends"?"active":"",onClick:()=>n("friends"),children:"Friends"}),e.jsx("button",{className:s==="profile"?"active":"",onClick:()=>n("profile"),children:"Profile"})]}),e.jsxs("div",{className:"wallet-summary",children:[e.jsxs("div",{className:"balance",children:[e.jsx("span",{className:"coin",children:"ðŸª™"}),e.jsx("span",{className:"amount",children:a?.balance??0})]}),e.jsx("div",{className:"rate",children:o?.activeCategory==="productive"?"+5/min":o?.activeCategory==="neutral"?"+3/min":"0/min"})]})]}),e.jsxs("main",{className:"content",children:[s==="dashboard"&&e.jsx(Ot,{api:se,wallet:a,economy:o,productivityGoalHoursOverride:I}),s==="analytics"&&e.jsx(qt,{api:se}),s==="settings"&&e.jsx(Yt,{api:se,theme:x,onThemeChange:W=>N(W)}),s==="library"&&e.jsx(cn,{api:se}),s==="games"&&e.jsx(vn,{wallet:a}),s==="friends"&&e.jsx(hn,{api:se}),s==="profile"&&e.jsx(gn,{api:se})]}),e.jsx($n,{open:F,dayKey:es(new Date),saving:w,error:f,initial:{goalHours:I,idleThreshold:j,continuityWindowSeconds:L,emergencyPolicy:K,note:R},onSave:H,onSkip:ge}),e.jsx(En,{open:B,note:p?.note?.message??"",onClose:ie}),g&&e.jsx(Xt,{open:!!g,state:{domain:g.domain||g.appName,mode:g.mode??"pack",reason:g.reason},wallet:a,api:se,marketRates:d,onWallet:i,onClose:()=>D(null)})]})}Nt.createRoot(document.getElementById("root")).render(e.jsx(wt.StrictMode,{children:e.jsx(Ln,{})}));
//# sourceMappingURL=app-PUlr9e4C.js.map
