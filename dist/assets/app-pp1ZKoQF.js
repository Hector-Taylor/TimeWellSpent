import{r as t,j as e,c as vt,R as yt}from"./client-Dd90u0gX.js";const us=4;function ft(s,a=us){return((s-a)%24+24)%24}function bt(s,a=us){const n=new Date(s);return n.getHours()<a&&n.setDate(n.getDate()-1),n.setHours(a,0,0,0),n.getTime()}function Nt({api:s}){const[a,n]=t.useState(null),[l,j]=t.useState(0),[m,u]=t.useState("strict"),[w,p]=t.useState(25),[N,f]=t.useState(5),[F,g]=t.useState(5),[E,h]=t.useState([]),[k,R]=t.useState([]),[y,D]=t.useState(""),[i,x]=t.useState(!1);t.useEffect(()=>{s.pomodoro.status().then(K=>{K&&(n(K),j(K.remainingMs),u(K.mode))});const S=s.events.on("pomodoro:tick",K=>{n(A=>A?{...A,...K}:K),j(K.remainingMs)}),I=s.events.on("pomodoro:start",K=>{n(K),j(K.remainingMs),u(K.mode)}),q=s.events.on("pomodoro:stop",()=>{n(null),j(0)}),U=s.events.on("pomodoro:pause",K=>n(K)),X=s.events.on("pomodoro:resume",K=>n(K));return()=>{S(),I(),q(),U(),X()}},[s]),t.useEffect(()=>{s.settings.categorisation().then(S=>{const I=(S?.productive??[]).map(A=>({value:A,kind:"site"})),q=[{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"},{value:"github.com",kind:"site"},{value:"stackoverflow.com",kind:"site"}],U=[...I,...q],X=[],K=new Set;for(const A of U){const _=`${A.kind}:${A.value.toLowerCase()}`;K.has(_)||(K.add(_),X.push(A))}R(X),h(X.slice(0,3))}).catch(()=>{R([{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"}]),h([{value:"docs.google.com",kind:"site"},{value:"notion.so",kind:"site"},{value:"linear.app",kind:"site"}])})},[s.settings]);const T=t.useMemo(()=>{const S=a?l:w*60*1e3,I=Math.max(0,Math.round(S/1e3)),q=Math.floor(I/60),U=I%60;return`${q.toString().padStart(2,"0")}:${U.toString().padStart(2,"0")}`},[l,w,a]);async function M(){try{x(!0);const S=E.map((U,X)=>({id:`${U.value}-${X}`,kind:U.kind,value:U.value})),I={durationSec:w*60,breakDurationSec:N*60,mode:m,allowlist:S,temporaryUnlockSec:F*60},q=await s.pomodoro.start(I);n(q),j(q.remainingMs)}catch(S){console.error("Failed to start pomodoro",S)}finally{x(!1)}}function r(S){const I=S.trim();I&&(E.some(q=>q.value.toLowerCase()===I.toLowerCase())||h(q=>[...q,{value:I,kind:"site"}]))}function b(S){h(I=>I.filter(q=>q.value!==S))}async function C(S="canceled"){x(!0);try{await s.pomodoro.stop(S),n(null),j(0)}catch(I){console.error("Failed to stop pomodoro",I)}finally{x(!1)}}async function L(){x(!0);try{const S=await s.pomodoro.pause();n(S)}catch(S){console.error(S)}finally{x(!1)}}async function G(){x(!0);try{const S=await s.pomodoro.resume();n(S)}catch(S){console.error(S)}finally{x(!1)}}async function Y(){x(!0);try{const S=await s.pomodoro.startBreak(N*60);n(S)}catch(S){console.error(S)}finally{x(!1)}}return e.jsxs("div",{className:"card pomodoro-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Pomodoro"}),e.jsx("h2",{children:"Allowlist focus"})]}),e.jsx("span",{className:"pill ghost",children:a?a.mode:m})]}),e.jsxs("div",{className:"pomodoro-grid",children:[e.jsxs("div",{className:"pomodoro-timer",children:[e.jsxs("div",{className:"pomodoro-face",children:[e.jsx("span",{className:"pomodoro-time",children:T}),e.jsx("span",{className:"pomodoro-label",children:a?a.state:"idle"})]}),e.jsx("div",{className:"pomodoro-controls",children:a?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>C("canceled"),disabled:i,className:"ghost",children:"End"}),a.state==="paused"?e.jsx("button",{onClick:G,disabled:i,className:"primary",children:"Resume"}):e.jsx("button",{onClick:L,disabled:i,className:"ghost",children:"Pause"}),e.jsx("button",{onClick:Y,disabled:i,className:"ghost",children:"Start break"})]}):e.jsx("button",{onClick:M,disabled:i,className:"primary",children:"Start focus"})})]}),e.jsxs("div",{className:"pomodoro-config",children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Duration (minutes)"}),e.jsx("input",{type:"number",min:5,max:180,value:w,onChange:S=>p(Number(S.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Break length (minutes)"}),e.jsx("input",{type:"number",min:1,max:60,value:N,onChange:S=>f(Number(S.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Mode"}),e.jsxs("div",{className:"segmented",children:[e.jsx("button",{className:m==="strict"?"active":"",onClick:()=>u("strict"),children:"Strict"}),e.jsx("button",{className:m==="soft"?"active":"",onClick:()=>u("soft"),children:"Soft"})]})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{children:"Soft unlock minutes"}),e.jsx("input",{type:"number",min:1,max:30,value:F,onChange:S=>g(Number(S.target.value)||0)})]}),e.jsxs("label",{className:"field",children:[e.jsxs("div",{className:"field-label",children:[e.jsx("span",{children:"Allowlist"}),e.jsx("span",{className:"info-tooltip",title:"Add productive domains in the Domains section!",children:"?"})]}),e.jsxs("div",{className:"allowlist-picker",children:[e.jsxs("select",{value:"",onChange:S=>{r(S.target.value)},children:[e.jsx("option",{value:"",disabled:!0,children:"Select a site"}),k.filter(S=>!E.some(I=>I.value===S.value&&I.kind===S.kind)).map(S=>e.jsx("option",{value:S.value,children:S.value},S.value))]}),e.jsxs("div",{className:"allowlist-custom",children:[e.jsx("input",{type:"text",placeholder:"custom site or app",value:y,onChange:S=>D(S.target.value)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{r(y),D("")},disabled:!y.trim(),children:"Add"})]}),E.length>0&&e.jsx("div",{className:"allowlist-tags",children:E.map(S=>e.jsxs("span",{className:"pill",children:[S.value,e.jsx("button",{type:"button",className:"chip-remove",onClick:()=>b(S.value),"aria-label":`Remove ${S.value}`,children:"Ã—"})]},S.value))})]})]})]})]})]})}const Te={productive:"var(--cat-productive)",neutral:"var(--cat-neutral)",frivolity:"var(--cat-frivolity)",draining:"var(--cat-draining)",idle:"var(--cat-idle)"};function wt({summary:s,economy:a}){const[n,l]=t.useState("aggregate"),[j,m]=t.useState(null),u=t.useMemo(()=>{if(!s)return null;const h=s.totalsByCategory,k=[{key:"productive",label:"Productive",seconds:h.productive??0,color:Te.productive},{key:"neutral",label:"Neutral",seconds:(h.neutral??0)+(h.uncategorised??0),color:Te.neutral},{key:"frivolity",label:"Frivolity",seconds:h.frivolity??0,color:Te.frivolity},{key:"draining",label:"Draining",seconds:h.draining??0,color:Te.draining},{key:"idle",label:"Idle",seconds:h.idle??0,color:Te.idle}].filter(i=>i.seconds>0),R=k.reduce((i,x)=>i+x.seconds,0);let y=-90;return{arcs:k.map(i=>{const x=R?i.seconds/R*360:0,T=As(150,150,120,y,y+x);return y+=x,{path:T,color:i.color,label:i.label,seconds:i.seconds}}),slices:k,totalSeconds:Math.max(0,R)}},[s]),w=t.useMemo(()=>{if(!s||s.timeline.length===0)return{arcs:[],centerSeconds:0};const h=360/s.timeline.length,k=(s.windowHours??24)*3600,R=s.timeline.map((D,i)=>{const x=i*h-90,T=x+h,M=As(150,150,120,x,T),r=Te[D.dominant]??Te.neutral;return{path:M,color:r,label:D.hour,slot:D,seconds:D.productive+D.neutral+D.frivolity+D.draining+D.idle}}),y=Math.min(k,(s.totalSeconds??0)+(s.totalsByCategory.idle??0));return{arcs:R,centerSeconds:y}},[s]);if(!s)return e.jsxs("article",{className:"card compass-card",children:[e.jsx("h2",{children:"Day compass"}),e.jsx("p",{className:"subtle",children:"We need at least one tracked session to build your orbit."})]});const p=n==="timeline"?j!==null?s.timeline[j]:s.timeline[s.timeline.length-1]:null,N=p?.dominant,f=n==="aggregate"?u?.slices??[]:p?[{label:"Productive",seconds:p.productive,color:Te.productive},{label:"Neutral",seconds:p.neutral,color:Te.neutral},{label:"Frivolity",seconds:p.frivolity,color:Te.frivolity},{label:"Draining",seconds:p.draining,color:Te.draining},{label:"Idle",seconds:p.idle,color:Te.idle}]:[],F=(s?.windowHours??24)*3600,g=n==="aggregate"?Math.min(F,u?.totalSeconds??0):w.centerSeconds,E=n==="aggregate"?u?.arcs??[]:w.arcs;return e.jsxs("article",{className:"card compass-card",children:[e.jsxs("div",{className:"card-header-row compass-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day diagram"}),e.jsx("h2",{children:"Orbit of attention"})]}),e.jsxs("div",{className:"compass-controls",children:[e.jsxs("div",{className:"compass-toggle",children:[e.jsx("button",{className:n==="aggregate"?"active":"",onClick:()=>{l("aggregate"),m(null)},children:"Total day"}),e.jsx("button",{className:n==="timeline"?"active":"",onClick:()=>{l("timeline"),m(null)},children:"24h orbit"})]}),e.jsxs("span",{className:"pill ghost",children:[a?.activeCategory??"idle"," â€¢ live"]})]})]}),e.jsxs("div",{className:"compass-body",children:[e.jsxs("div",{className:"compass-visual",children:[e.jsxs("svg",{viewBox:"0 0 300 300",role:"img","aria-label":"Day compass",children:[e.jsx("circle",{cx:"150",cy:"150",r:"140",fill:"rgba(255,255,255,0.02)",stroke:"rgba(255,255,255,0.05)",strokeWidth:"1"}),E.map((h,k)=>e.jsx("path",{d:h.path,fill:h.color,opacity:j!==null&&j!==k?.35:.92,onMouseEnter:()=>m(k),onMouseLeave:()=>m(null)},`${h.label}-${k}`)),e.jsx("circle",{cx:"150",cy:"150",r:"80",fill:"var(--bg-soft)",stroke:"rgba(255,255,255,0.08)",strokeWidth:"2"}),e.jsx("text",{x:"150",y:"140",textAnchor:"middle",className:"compass-center",children:kt(g)}),e.jsx("text",{x:"150",y:"165",textAnchor:"middle",className:"compass-center-sub",children:n==="aggregate"?"hours captured":`${s.windowHours}h window`})]}),n==="timeline"&&p&&e.jsxs("div",{className:"compass-tooltip",children:[e.jsxs("div",{children:[e.jsx("span",{className:"tooltip-hour",children:p.hour}),e.jsx("span",{className:"tooltip-dominant",children:N})]}),p.topContext?e.jsxs("p",{children:[p.topContext.label,e.jsx("br",{}),e.jsxs("small",{children:[Math.round(p.topContext.seconds/60)," min captured"]})]}):e.jsx("p",{children:"No activity recorded"})]})]}),e.jsx("div",{className:"compass-details",children:f.map(h=>e.jsxs("div",{className:"detail-row",children:[e.jsxs("div",{className:"legend-chip",children:[e.jsx("span",{style:{background:h.color}}),e.jsx("span",{children:h.label})]}),e.jsx("strong",{children:St(h.seconds)})]},h.label))})]})]})}function As(s,a,n,l,j){const m=Fs(s,a,n,j),u=Fs(s,a,n,l),w=j-l<=180?"0":"1";return["M",m.x,m.y,"A",n,n,0,w,0,u.x,u.y,"L",s,a,"Z"].join(" ")}function Fs(s,a,n,l){const j=l*Math.PI/180;return{x:s+n*Math.cos(j),y:a+n*Math.sin(j)}}function St(s){return s?`${Math.round(s/60)}m`:"0m"}function kt(s){const a=Math.max(0,s)/3600;return`${Math.round(a*10)/10}h`}function Ct({activities:s,summary:a}){const n={productive:"var(--cat-productive)",neutral:"var(--cat-neutral)",frivolity:"var(--cat-frivolity)",draining:"var(--cat-draining)",idle:"var(--cat-idle)"},[l,j]=t.useState(null),m=Date.now()-24*60*60*1e3,u=t.useMemo(()=>{if(a){const M=a.totalsByCategory,r=M.productive??0,b=(M.neutral??0)+(M.uncategorised??0),C=M.frivolity??0,L=M.draining??0,G=M.idle??0;return{total:r+b+C+L+G,byCategory:{productive:r,neutral:b,frivolity:C,draining:L,idle:G}}}const y=s.filter(M=>new Date(M.startedAt).getTime()>=m),D=y.reduce((M,r)=>M+r.secondsActive,0),i=y.reduce((M,r)=>M+r.idleSeconds,0),x=D+i,T={productive:0,neutral:0,frivolity:0,draining:0,idle:0};return y.forEach(M=>{const r=M.category||"neutral";T[r]=(T[r]||0)+M.secondsActive}),T.idle=i,{total:x,byCategory:T}},[s,a,m]),w=t.useMemo(()=>{const y={productive:[],neutral:[],frivolity:[],draining:[],idle:[]};if(a?.topContexts)a.topContexts.forEach(D=>{if(!D.category)return;const i=D.category;y[i].push({label:D.label,seconds:D.seconds})});else{const D=s.filter(x=>new Date(x.startedAt).getTime()>=m),i=new Map;D.forEach(x=>{const M=x.category||"neutral",r=x.domain??x.appName??"Unknown",b=`${M}:${r}`;i.has(b)||i.set(b,{label:r,cat:M,seconds:0});const C=i.get(b);C.seconds+=x.secondsActive}),i.forEach(x=>y[x.cat].push({label:x.label,seconds:x.seconds}))}return Object.keys(y).forEach(D=>{y[D]=y[D].sort((i,x)=>x.seconds-i.seconds)}),y},[s,a,m]);if(u.total===0)return e.jsx("div",{className:"card",style:{alignItems:"center",justifyContent:"center",minHeight:"240px"},children:e.jsx("p",{className:"subtle",children:"No activity recorded yet"})});let p=0;const N=90,f=110,g=Object.entries(u.byCategory).map(([y,D])=>{const i=D/u.total,x=i*360,T=f+N*Math.cos(Math.PI*p/180),M=f+N*Math.sin(Math.PI*p/180),r=f+N*Math.cos(Math.PI*(p+x)/180),b=f+N*Math.sin(Math.PI*(p+x)/180),C=x>180?1:0,L=[`M ${f} ${f}`,`L ${T} ${M}`,`A ${N} ${N} 0 ${C} 1 ${r} ${b}`,"Z"].join(" ");return p+=x,{category:y,path:L,color:n[y]||n.neutral,percentage:Math.round(i*100)}}),E=a?.topContexts?.[0],h=l,k=h?u.byCategory[h]??0:0,R=h&&u.total>0?Math.round(k/u.total*100):0;return e.jsxs("div",{className:"card activity-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Time distribution"}),e.jsx("p",{className:"subtle",children:"Blended from desktop apps and the extension feed."})]}),E&&e.jsxs("div",{className:"pill ghost",children:[E.label," Â· ",Math.round(E.seconds/60),"m"]})]}),e.jsxs("div",{className:"activity-chart",style:{position:"relative",overflow:"visible"},children:[h&&e.jsxs("div",{className:"activity-tooltip",style:{position:"absolute",top:"50%",left:"260px",transform:"translateY(-50%)",background:"var(--bg-raised, #12141a)",border:`1px solid ${n[h]}`,boxShadow:"0 8px 32px rgba(0,0,0,0.5)",zIndex:100,padding:"14px 16px",borderRadius:"10px",minWidth:"200px",maxWidth:"260px",lineHeight:1.45,fontSize:"13px",color:"var(--fg, #f0f0f0)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px",paddingBottom:"10px",borderBottom:"1px solid rgba(255,255,255,0.08)"},children:[e.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",background:n[h],flexShrink:0}}),e.jsx("strong",{style:{textTransform:"capitalize",fontSize:"14px"},children:h}),e.jsxs("span",{style:{marginLeft:"auto",opacity:.6,fontSize:"12px"},children:[R,"%"]})]}),e.jsxs("div",{style:{marginBottom:"10px",fontSize:"11px",opacity:.7},children:[Is(k)," total"]}),e.jsxs("ul",{style:{listStyle:"none",padding:0,margin:0,maxHeight:"160px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"3px"},children:[w[h]?.length===0&&e.jsx("li",{style:{opacity:.5,fontSize:"12px"},children:"No entries"}),w[h]?.slice(0,6).map(y=>e.jsxs("li",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 6px",borderRadius:"4px",background:"rgba(255,255,255,0.04)",fontSize:"12px"},children:[e.jsx("span",{style:{maxWidth:"60%",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:y.label}),e.jsxs("span",{style:{opacity:.6,fontSize:"11px"},children:[Math.round(y.seconds/60),"m"]})]},`${h}-${y.label}`))]})]}),e.jsxs("div",{className:"donut-shell",style:{position:"relative"},children:[e.jsx("div",{className:"donut-glow"}),e.jsxs("svg",{width:"240",height:"240",viewBox:"0 0 220 220",children:[g.map(y=>e.jsx("path",{d:y.path,fill:y.color,stroke:"rgba(255,255,255,0.14)",strokeWidth:"2",onMouseEnter:()=>j(y.category),onMouseLeave:()=>j(null)},y.category)),e.jsx("circle",{cx:f,cy:f,r:N*.6,fill:"var(--bg-soft)"})]}),e.jsxs("div",{className:"donut-center",children:[e.jsx("strong",{children:Is(u.total)}),e.jsx("span",{children:"logged"})]})]}),e.jsx("ul",{className:"detail-list",style:{flex:1},children:g.map(y=>e.jsxs("li",{onMouseEnter:()=>j(y.category),onMouseLeave:()=>j(null),children:[e.jsxs("div",{className:"legend-chip",children:[e.jsx("span",{style:{width:"12px",height:"12px",borderRadius:"50%",background:y.color}}),e.jsx("span",{style:{textTransform:"capitalize"},children:y.category})]}),e.jsxs("div",{className:"legend-values",children:[e.jsxs("strong",{children:[y.percentage,"%"]}),e.jsxs("span",{className:"subtle",children:[Math.round((u.byCategory[y.category]??0)/60),"m"]})]})]},y.category))})]})]})}function Is(s){const a=Math.max(0,Math.round(s/60)),n=Math.floor(a/60),l=a%60;return`${n}h ${l}m`}const Rs={productive:"Productive",neutral:"Neutral",frivolity:"Frivolity",draining:"Draining",idle:"Idle"};function Mt({journey:s,loading:a,isRemote:n}){const l=t.useMemo(()=>s?s.segments.reduce((m,u)=>m+u.seconds,0):0,[s]);if(!s||s.segments.length===0)return e.jsxs("div",{className:"card journey-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day journey"}),e.jsx("h2",{children:"Attention trail"})]}),e.jsx("span",{className:"pill ghost",children:a?"Loading...":n?"Local device only":"Local device"})]}),e.jsx("p",{className:"subtle",children:n?"Journey data is available on the active device.":"No activity recorded in this window yet."})]});const j=s.neutralCounts??[];return e.jsxs("div",{className:"card journey-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Day journey"}),e.jsx("h2",{children:"Attention trail"})]}),e.jsxs("span",{className:"pill ghost",children:[s.windowHours,"h window"]})]}),e.jsxs("div",{className:"journey-layout",children:[e.jsxs("div",{className:"journey-bar-wrap",children:[e.jsx("div",{className:"journey-bar",role:"img","aria-label":"Timeline of context switches",children:s.segments.map((m,u)=>{const w=l>0?m.seconds/l*100:0,p=m.label??"",N=[p||Rs[m.category]||"Session",`${Ls(m.seconds)} active`].join(" - ");return e.jsx("div",{className:`journey-seg ${m.category}`,style:{flexGrow:m.seconds},title:N,children:p&&w>=6?e.jsx("span",{children:p}):null},`${m.start}-${u}`)})}),e.jsx("div",{className:"journey-legend",children:["productive","neutral","draining","frivolity","idle"].map(m=>e.jsxs("span",{className:"legend-chip",children:[e.jsx("span",{className:`dot ${m}`}),Rs[m]]},m))})]}),e.jsxs("div",{className:"journey-neutral",children:[e.jsx("span",{className:"label",children:"Neutral touchpoints"}),j.length===0?e.jsx("span",{className:"subtle",children:"No neutral apps surfaced yet."}):e.jsx("div",{className:"journey-neutral-list",children:j.slice(0,5).map(m=>e.jsxs("div",{className:"journey-neutral-row",children:[e.jsx("span",{children:m.label}),e.jsxs("span",{className:"subtle",children:[m.count,"Ã— â€¢ ",Ls(m.seconds)]})]},m.label))})]})]})]})}function Ls(s){return`${Math.max(1,Math.round(s/60))}m`}const Pt=8,Dt=14,Hs=32,gs=520,Ke=24;function Tt({journey:s,loading:a,isRemote:n}){const[l,j]=t.useState("flow"),{nodes:m,transitions:u}=t.useMemo(()=>{if(!s?.segments?.length)return{nodes:[],transitions:[]};const h=s.segments.filter(i=>!!i.label);if(h.length<2)return{nodes:[],transitions:[]};const k=new Map;for(let i=1;i<h.length;i+=1){const x=h[i-1].label??"",T=h[i].label??"";if(!x||!T||x===T)continue;const M=`${x}->${T}`,r=k.get(M);r?r.count+=1:k.set(M,{from:x,to:T,count:1})}const R=new Map;for(const i of k.values())R.set(i.from,(R.get(i.from)??0)+i.count),R.set(i.to,(R.get(i.to)??0)+i.count);const y=Array.from(R.entries()).sort((i,x)=>x[1]-i[1]).slice(0,Pt).map(([i])=>i),D=Array.from(k.values()).filter(i=>y.includes(i.from)&&y.includes(i.to)).sort((i,x)=>x.count-i.count).slice(0,Dt);return{nodes:y,transitions:D}},[s]),w=t.useMemo(()=>s?.segments?.length?s.segments.filter(k=>!!k.label).slice(-36):[],[s]),p=u.reduce((h,k)=>Math.max(h,k.count),1),N=Math.max(220,m.length*Hs+Ke*2),f=140,F=gs-140,g=gs/2,E=new Map;return m.forEach((h,k)=>{E.set(h,Ke+k*Hs)}),!s||s.segments.length===0?e.jsxs("div",{className:"card attention-map-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention map"}),e.jsx("h2",{children:"Context flow"})]}),e.jsx("span",{className:"pill ghost",children:a?"Loading...":n?"Local device only":"Local device"})]}),e.jsx("p",{className:"subtle",children:n?"Flow maps are generated on the active device.":"No activity recorded in this window yet."})]}):e.jsxs("div",{className:"card attention-map-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention map"}),e.jsx("h2",{children:"Context flow"})]}),e.jsxs("div",{className:"attention-map-controls",children:[e.jsx("button",{type:"button",className:`pill ghost ${l==="flow"?"active":""}`,onClick:()=>j("flow"),children:"Flow map"}),e.jsx("button",{type:"button",className:`pill ghost ${l==="path"?"active":""}`,onClick:()=>j("path"),children:"Day path"})]})]}),l==="flow"?e.jsxs("div",{className:"attention-map",children:[m.length===0||u.length===0?e.jsx("p",{className:"subtle",children:"Not enough context changes yet."}):e.jsxs("svg",{className:"attention-map-svg",viewBox:`0 0 ${gs} ${N}`,preserveAspectRatio:"xMidYMid meet",role:"img","aria-label":"Most common context switches",children:[e.jsx("defs",{children:e.jsx("marker",{id:"arrow",markerWidth:"8",markerHeight:"8",refX:"6",refY:"3",orient:"auto",children:e.jsx("path",{d:"M0,0 L6,3 L0,6",fill:"currentColor"})})}),u.map(h=>{const k=E.get(h.from)??Ke,R=E.get(h.to)??Ke,y=1+h.count/p*6,D=`M ${f} ${k} C ${g} ${k}, ${g} ${R}, ${F} ${R}`;return e.jsx("path",{d:D,className:"attention-map-link",strokeWidth:y,markerEnd:"url(#arrow)"},`${h.from}-${h.to}`)}),m.map(h=>{const k=E.get(h)??Ke;return e.jsxs("g",{children:[e.jsx("circle",{cx:f,cy:k,r:4,className:"attention-map-node"}),e.jsx("text",{x:f-12,y:k+4,textAnchor:"end",className:"attention-map-label",children:h})]},`left-${h}`)}),m.map(h=>{const k=E.get(h)??Ke;return e.jsxs("g",{children:[e.jsx("circle",{cx:F,cy:k,r:4,className:"attention-map-node"}),e.jsx("text",{x:F+12,y:k+4,textAnchor:"start",className:"attention-map-label",children:h})]},`right-${h}`)})]}),u.length>0&&e.jsx("div",{className:"attention-map-list",children:u.map(h=>e.jsxs("div",{className:"attention-map-row",children:[e.jsx("span",{children:h.from}),e.jsx("span",{className:"subtle",children:"->"}),e.jsx("span",{children:h.to}),e.jsxs("span",{className:"attention-map-count",children:[h.count,"x"]})]},`list-${h.from}-${h.to}`))})]}):e.jsxs("div",{className:"attention-path",children:[w.length===0?e.jsx("p",{className:"subtle",children:"Not enough labeled context yet."}):e.jsx("div",{className:"attention-path-strip",children:w.map((h,k)=>e.jsxs("div",{className:"attention-path-item",children:[e.jsx("span",{className:`attention-chip ${h.category}`,children:h.label}),e.jsx("span",{className:"subtle",children:$t(h.start)})]},`${h.start}-${k}`))}),e.jsx("p",{className:"subtle",children:"Showing recent labeled contexts in order."})]})]})}function $t(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Et({api:s,overview:a,loading:n,onRefresh:l}){const j=typeof a<"u"||typeof n<"u",[m,u]=t.useState(null),[w,p]=t.useState(!0),[N,f]=t.useState([]),F=t.useCallback(async()=>{if(l){l();return}p(!0);try{const D=await s.analytics.overview(7);u(D)}catch(D){console.error("Failed to load insights:",D)}p(!1)},[s,l]);t.useEffect(()=>{j||F()},[j,F]),t.useEffect(()=>{s.settings.excludedKeywords().then(f).catch(()=>{})},[s]);const g=j?a??null:m,E=j?!!n:w,h=D=>{const i=D>=12?"PM":"AM";return`${D%12||12}${i}`};if(E)return e.jsxs("div",{className:"card insights-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Insights"}),e.jsx("span",{className:"loading-spinner"})]}),e.jsxs("div",{className:"insights-loading",children:[e.jsx("div",{className:"skeleton skeleton-text"}),e.jsx("div",{className:"skeleton skeleton-text short"}),e.jsx("div",{className:"skeleton skeleton-text"})]})]});if(!g)return null;const k=g.focusTrend==="improving"?"ðŸ“ˆ":g.focusTrend==="declining"?"ðŸ“‰":"âž¡ï¸",R=g.focusTrend==="improving"?"Improving":g.focusTrend==="declining"?"Declining":"Stable",y=D=>{if(!N.length)return D;let i=D;for(const x of N){if(!x)continue;const T=x.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");i=i.replace(new RegExp(T,"gi"),"[hidden]")}return i};return e.jsxs("div",{className:"card insights-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Insights"}),e.jsx("button",{className:"pill ghost",onClick:F,disabled:E,children:"Refresh"})]}),e.jsxs("div",{className:"insights-summary",children:[e.jsxs("div",{className:"insight-metric",children:[e.jsxs("span",{className:"insight-value",children:[g.productivityScore,"%"]}),e.jsx("span",{className:"insight-label",children:"Productivity"})]}),e.jsxs("div",{className:"insight-metric",children:[e.jsx("span",{className:"insight-value",children:h(g.peakProductiveHour)}),e.jsx("span",{className:"insight-label",children:"Peak hour"})]}),e.jsxs("div",{className:"insight-metric",children:[e.jsx("span",{className:"insight-value",children:k}),e.jsx("span",{className:"insight-label",children:R})]})]}),e.jsxs("ul",{className:"insights-list",children:[g.insights.map((D,i)=>e.jsx("li",{className:"insight-item",children:y(D)},i)),g.insights.length===0&&e.jsx("li",{className:"insight-item subtle",children:"Not enough data yet. Keep tracking your activity!"})]}),g.riskHour!==g.peakProductiveHour&&e.jsxs("div",{className:"insight-warning",children:[e.jsx("span",{className:"warning-icon",children:"âš ï¸"}),e.jsxs("span",{children:["Watch out at ",e.jsx("strong",{children:h(g.riskHour)})," - that's when you're most likely to get distracted."]})]})]})}function nt({open:s,friend:a,summary:n,timeline:l,publicLibraryItems:j=[],trophies:m=[],onClose:u}){if(!s||!a)return null;const w=l?.totalsByCategory??n?.categoryBreakdown??null,p=n?.totalActiveSeconds??0,N=n?.productivityScore??0,f=new Map(m.map(g=>[g.id,g])),F=(a.pinnedTrophies??[]).map(g=>f.get(g)).filter(g=>!!g);return e.jsx("div",{className:"friend-modal-overlay",onClick:u,children:e.jsxs("div",{className:"friend-modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"friend-modal-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:a.displayName??a.handle??"Friend"}),e.jsxs("p",{className:"subtle",children:["@",a.handle??"no-handle"]})]}),e.jsx("button",{className:"ghost",onClick:u,children:"Close"})]}),e.jsxs("div",{className:"friend-modal-metrics",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsx("strong",{children:n?`${N}%`:"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsx("strong",{children:n?Ye(p):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Updated"}),e.jsx("strong",{children:n?new Date(n.updatedAt).toLocaleTimeString():"--"})]})]}),F.length>0&&e.jsx("div",{className:"friends-trophies",children:F.slice(0,4).map(g=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:g.emoji}),g.name]},g.id))}),w&&e.jsxs("div",{className:"friend-modal-breakdown",children:[e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Productive"}),e.jsx("span",{children:Ye(w.productive)})]}),e.jsxs("div",{className:"friend-modal-bar",children:[e.jsx("span",{className:"cat-productive",style:{width:`${Ze(w,"productive")}%`}}),e.jsx("span",{className:"cat-neutral",style:{width:`${Ze(w,"neutral")}%`}}),e.jsx("span",{className:"cat-frivolity",style:{width:`${Ze(w,"frivolity")}%`}}),e.jsx("span",{className:"cat-draining",style:{width:`${Ze(w,"draining")}%`}}),e.jsx("span",{className:"cat-idle",style:{width:`${Ze(w,"idle")}%`}})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Neutral"}),e.jsx("span",{children:Ye(w.neutral)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Frivolity"}),e.jsx("span",{children:Ye(w.frivolity)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Draining"}),e.jsx("span",{children:Ye(w.draining??0)})]}),e.jsxs("div",{className:"friend-modal-break-row",children:[e.jsx("span",{children:"Idle"}),e.jsx("span",{children:Ye(w.idle)})]})]}),j.length>0&&e.jsxs("div",{className:"friend-modal-library",children:[e.jsxs("div",{className:"friend-modal-timeline-header",style:{marginBottom:12},children:[e.jsx("span",{className:"label",children:"Public library"}),e.jsx("span",{className:"subtle",children:"Shared links"})]}),e.jsx("div",{className:"friend-modal-library-list",children:j.map(g=>{const E=g.title??g.domain??g.url;return e.jsxs("div",{className:"friend-modal-library-item",children:[e.jsxs("div",{className:"friend-modal-library-main",children:[e.jsx("strong",{children:E}),e.jsx("span",{className:"subtle",children:g.note??g.url})]}),e.jsxs("div",{className:"friend-modal-library-meta",children:[e.jsxs("span",{children:["Added ",Ft(g.createdAt)]}),typeof g.price=="number"&&e.jsxs("span",{children:[g.price," f-coins"]}),e.jsx("a",{className:"ghost",href:g.url,target:"_blank",rel:"noopener noreferrer",children:"Open"})]})]},g.id)})})]}),e.jsxs("div",{className:"friend-modal-timeline",children:[e.jsxs("div",{className:"friend-modal-timeline-header",children:[e.jsxs("span",{className:"label",children:["Last ",l?.windowHours??24,"h"]}),e.jsx("span",{className:"subtle",children:"Dominant attention per hour"})]}),e.jsx("div",{className:"friend-modal-timeline-bars",children:(l?.timeline??[]).map((g,E)=>{const h=g.productive+g.neutral+g.frivolity+g.draining+g.idle,k=h===0?8:Math.max(12,Math.min(52,Math.round(h/At(l)*52))),R=g.dominant;return e.jsx("div",{className:"friend-modal-bar-col",title:`${g.hour}`,children:e.jsx("span",{className:`friend-modal-bar-fill cat-${R}`,style:{height:`${k}px`}})},`${g.start}-${E}`)})})]})]})})}function Ze(s,a){const n=s.productive+s.neutral+s.frivolity+(s.draining??0)+s.idle,l=s[a]??0;return n>0?Math.round(l/n*100):0}function Ye(s){const a=s/3600;return a>=10?`${a.toFixed(0)}h`:`${a.toFixed(1)}h`}function At(s){return!s||s.timeline.length===0?1:Math.max(...s.timeline.map(a=>a.productive+a.neutral+a.frivolity+a.draining+a.idle),1)}function Ft(s){const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString([],{month:"short",day:"numeric"})}const Bs=[{id:"focus",label:"Focus",hint:"Ring, streak, and core metrics"},{id:"signals",label:"Signals",hint:"Flow quality and attention telemetry"},{id:"journey",label:"Journey",hint:"Day timeline and orbit map"},{id:"social",label:"Social",hint:"Friends and trophy highlights"}];function It({api:s,wallet:a,economy:n,productivityGoalHoursOverride:l}){const[j,m]=t.useState([]),[u,w]=t.useState(null),[p,N]=t.useState(!0),[f,F]=t.useState(null),[g,E]=t.useState(!0),[h,k]=t.useState(null),[R,y]=t.useState(!1),[D,i]=t.useState(null),[x,T]=t.useState(Date.now()),[M,r]=t.useState([]),[b,C]=t.useState(null),[L,G]=t.useState(null),[Y,S]=t.useState([]),[I,q]=t.useState({}),[U,X]=t.useState(!1),[K,A]=t.useState(null),[_,H]=t.useState(null),[Se,ie]=t.useState(null),[O,Q]=t.useState(null),[le,te]=t.useState([]),[oe,fe]=t.useState(!1),[be,je]=t.useState([]),[ke,P]=t.useState(null),[B,ee]=t.useState(null),[V,he]=t.useState("productivity"),[ve,W]=t.useState(null),[me,ue]=t.useState([]),[v,J]=t.useState(!1),[ce,de]=t.useState(!1),[Ne,pe]=t.useState(2),[we,ne]=t.useState(()=>{try{const c=window.localStorage.getItem("tws-dashboard-scene");if(c&&Bs.some($=>$.id===c))return c}catch{}return"focus"}),Pe=t.useCallback(async(c=!1)=>{c||N(!0);const $=!!(b&&(b==="all"||L&&b!==L)),[Z,ae,ye]=await Promise.all([$?Promise.resolve([]):s.activities.recent(30),s.activities.summary(24,b??void 0),$?Promise.resolve(null):s.activities.journey(24,b??void 0)]);m(Z),w(ae),W(ye),N(!1)},[s,L,b]),o=t.useCallback(async()=>{E(!0);try{const c=await s.analytics.overview(7);F(c)}catch(c){console.error("Failed to load analytics overview:",c)}finally{E(!1)}},[s]),z=t.useCallback(async()=>{y(!1);try{const c=Date.now()-864e5,$=Ys(new Date),Z=Ys(new Date(Date.now()-24*60*60*1e3)),Fe=(await Promise.all([s.history.list($),s.history.list(Z)])).flat().filter(Ie=>Ie.kind==="frivolous-session"&&Date.parse(Ie.occurredAt)>=c).length;i(Fe);const Oe=await s.history.days(60);for(const Ie of Oe){const Es=(await s.history.list(Ie.day)).find(jt=>jt.kind==="frivolous-session");if(Es){k(new Date(Es.occurredAt).getTime()),y(!0);return}}k(null)}catch(c){console.error("Failed to load frivolity history:",c),k(null),i(null)}finally{y(!0)}},[s]),xe=t.useCallback(async()=>{try{const c=await s.sync.status(),$=c.configured&&c.authenticated?await s.sync.listDevices():[],Z=c.device?.id??null,ae=$.map(ye=>({id:ye.id,name:ye.name,isCurrent:ye.id===Z}));r(ae),G(Z),Z&&!b&&C(Z)}catch(c){console.error("Failed to load devices",c)}},[s,b]),Ce=t.useCallback(async()=>{try{const c=await s.sync.status();if(!c.configured||!c.authenticated){S([]),q({}),X(!1);return}const[$,Z,ae]=await Promise.all([s.friends.list(),s.friends.summaries(24),s.friends.meSummary(24)]);S($),q(Z),A(ae);const ye=await s.friends.profile();H(ye),X(!0)}catch(c){console.error("Failed to load friends",c),S([]),q({}),X(!1),A(null)}},[s]),Ee=t.useCallback(async()=>{try{const[c,$]=await Promise.all([s.trophies.profile(),s.trophies.list()]);P(c),je($)}catch(c){console.error("Failed to load trophies",c)}},[s]),De=t.useCallback(async c=>{ie(c),Q(null),te([]),fe(!0);try{const[$,Z]=await Promise.all([s.friends.timeline(c.userId,24),s.friends.publicLibrary(c.userId,168)]);Q($),te(Z??[])}catch($){console.error("Failed to load friend timeline",$)}},[s]);t.useEffect(()=>{Pe(),o(),z(),xe(),Ce(),Ee()},[Pe,o,z,xe,Ce,Ee]),t.useEffect(()=>{s.settings.excludedKeywords().then(ue).catch(()=>{})},[s]),t.useEffect(()=>{s.settings.competitiveOptIn().then(J).catch(()=>{})},[s]),t.useEffect(()=>{s.settings.productivityGoalHours().then(pe).catch(()=>{})},[s]),t.useEffect(()=>{try{window.localStorage.setItem("tws-dashboard-scene",we)}catch{}},[we]),t.useEffect(()=>{const c=s.events.on("economy:activity",()=>{Pe(!0)}),$=s.events.on("paywall:session-started",()=>{k(Date.now()),y(!0)});return()=>{c(),$()}},[s,Pe]),t.useEffect(()=>{const c=window.setInterval(()=>{T(Date.now())},1e3);return()=>window.clearInterval(c)},[]),t.useEffect(()=>{const c=s.events.on("trophies:earned",$=>{ee($),Ee(),window.setTimeout(()=>ee(null),6e3)});return()=>{c()}},[s,Ee]);const Re=b==="all",Le=!!(b&&L&&b!==L&&!Re),He=Re?"All devices":Le?M.find(c=>c.id===b)?.name??"Remote device":n?.activeDomain??n?.activeApp??"Waiting...",We=Le?"neutral":n?.activeCategory??"idle",_e=t.useMemo(()=>Math.max(0,Math.round((u?.totalSeconds??0)/3600*10)/10),[u]),Ue=t.useCallback(c=>{if(!me.length)return!1;const $=c.toLowerCase();return me.some(Z=>Z&&$.includes(Z))},[me]),ge=t.useMemo(()=>u?.topContexts?.length?u.topContexts.filter(c=>!Ue(c.label)):[],[u,Ue]),Be=u?.windowHours??24,Ae=(u?.timeline??[]).slice(-Be),d=t.useMemo(()=>[...j].sort((c,$)=>Date.parse(c.startedAt)-Date.parse($.startedAt)),[j]),re=90,Me=t.useMemo(()=>{const c=new Map;if(!d.length)return c;let $=null,Z=null;for(const ae of d){const ye=Gs(ae.startedAt);c.has(ye)||c.set(ye,0);const Fe=ae.domain??ae.appName??ae.windowTitle??"unknown";Z===ye&&$&&Fe!==$&&c.set(ye,(c.get(ye)??0)+1),Z=ye,$=Fe}return c},[d]),ss=t.useMemo(()=>{const c=new Map;if(d.length<2)return c;let $=d[0];for(let Z=1;Z<d.length;Z+=1){const ae=d[Z],ye=$.domain??$.appName??$.windowTitle??"unknown",Fe=ae.domain??ae.appName??ae.windowTitle??"unknown",Oe=($.secondsActive??0)+($.idleSeconds??0);if(ye&&Fe!==ye&&Oe>0&&Oe<=re){const Ie=Gs(ae.startedAt);c.set(Ie,(c.get(Ie)??0)+1)}$=ae}return c},[d]),ws=t.useMemo(()=>{if(!u||d.length<2)return null;let c=0,$=null;for(const Z of d){const ae=Z.domain??Z.appName??Z.windowTitle??"unknown";$&&ae!==$&&(c+=1),$=ae}return c/u.windowHours},[d,u]),Ss=t.useMemo(()=>{if(!u||d.length<2)return null;let c=0,$=d[0];for(let Z=1;Z<d.length;Z+=1){const ae=d[Z],ye=$.domain??$.appName??$.windowTitle??"unknown",Fe=ae.domain??ae.appName??ae.windowTitle??"unknown",Oe=($.secondsActive??0)+($.idleSeconds??0);ye&&Fe!==ye&&Oe>0&&Oe<=re&&(c+=1),$=ae}return c/u.windowHours},[d,u]),ts=t.useMemo(()=>K||(u?Ht(u):null),[K,u]),ks=t.useMemo(()=>Ae.length?V==="switches"?Ae.map(c=>Me.get(c.start)??0):V==="thrash"?Ae.map(c=>ss.get(c.start)??0):V==="idle"?Ae.map(c=>{const $=c.productive+c.neutral+c.frivolity+c.draining+c.idle;return $>0?c.idle/$:0}):Ae.map(c=>{const $=c.productive+c.neutral+c.frivolity+c.draining;return $>0?c.productive/$:0}):[],[V,Ae,Me,ss]),Cs=t.useMemo(()=>{if(!u)return null;const c=u.totalsByCategory.idle??0,$=u.totalSeconds+c;return $>0?c/$:0},[u]),ct=t.useMemo(()=>{if(!Ae.length)return 0;let c=0,$=0;for(const Z of Ae)Z.dominant==="productive"?($+=1,$>c&&(c=$)):$=0;return c},[Ae]),Ve=h?Math.max(0,x-h):null,ot=72*60*60*1e3,as=Ve?Math.min(1,Ve/ot):0,dt=Math.round(20+30*as),ht=Math.round(48+18*as),ut=Ve?`hsl(${dt} 70% ${ht}%)`:"rgba(200, 149, 108, 0.7)",ns=t.useMemo(()=>u?Math.round(u.deepWorkSeconds/60):null,[u]),Ms=t.useMemo(()=>bt(x,us),[x]),is=t.useMemo(()=>u?u.timeline?.length?u.timeline.reduce((c,$)=>{const Z=Date.parse($.start);return!Number.isFinite(Z)||Z<Ms?c:c+($.productive??0)},0):u.totalsByCategory.productive??0:0,[u,Ms]),ms=Number.isFinite(l)&&(l??0)>0?l:Number.isFinite(Ne)&&Ne>0?Ne:2,ls=ms*3600,ps=ls>0?is/ls:0,mt=Math.max(0,Math.min(1,ps)),pt=Math.round(ps*100),xs=52,Ps=2*Math.PI*xs,xt=Ps*(1-mt),Ds=ps>=1,gt=Math.max(0,ls-is),Ts=t.useMemo(()=>{const c=new Map;return be.forEach($=>c.set($.id,$)),c},[be]),$s=(ke?.pinnedTrophies?.length?ke.pinnedTrophies:be.filter(c=>c.pinned).map(c=>c.id)).map(c=>Ts.get(c)).filter(c=>!!c).slice(0,3),Ge=be.filter(c=>c.progress.state==="locked").sort((c,$)=>$.progress.ratio-c.progress.ratio)[0]??null;return e.jsxs("section",{className:"panel",children:[e.jsxs("header",{className:"panel-header dashboard-header",children:[e.jsx("div",{className:"dashboard-hero-left",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention control"}),e.jsx("h1",{children:"Your day at a glance"}),e.jsxs("div",{className:"pill-row pill-row-tight topbar-actions",children:[e.jsxs("div",{className:"pill-group",children:[e.jsxs("span",{className:"pill ghost",children:["Wallet ",a.balance," f-coins"]}),e.jsx("button",{type:"button",className:"pomodoro-trigger",onClick:()=>de(!0),children:"Locking in?"})]}),e.jsx("span",{className:"pill ghost",children:ns==null?"Deep work â€”":`Deep work ${ns} min`})]}),M.length>0&&e.jsxs("div",{className:"dashboard-device-switch",children:[e.jsx("span",{className:"subtle",children:"Viewing"}),e.jsxs("select",{value:b??"",onChange:c=>C(c.target.value),children:[M.length>1&&e.jsx("option",{value:"all",children:"All devices"}),M.map(c=>e.jsxs("option",{value:c.id,children:[c.name,c.isCurrent?" (this device)":""]},c.id))]})]})]})}),e.jsx("div",{className:"card dashboard-time",children:e.jsx(Ct,{activities:j,summary:u})})]}),e.jsx("div",{className:"dashboard-controls",children:e.jsx("div",{className:"dashboard-tabs",role:"tablist","aria-label":"Dashboard scenes",children:Bs.map(c=>e.jsxs("button",{type:"button",role:"tab",className:we===c.id?"active":"","aria-selected":we===c.id,onClick:()=>ne(c.id),children:[e.jsx("span",{className:"dashboard-tab-label",children:c.label}),e.jsx("span",{className:"dashboard-tab-hint",children:c.hint})]},c.id))})}),ce&&e.jsxs("div",{className:"pomodoro-flyout",children:[e.jsxs("div",{className:"pomodoro-flyout-bar",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Deep work"}),e.jsx("strong",{children:"Pomodoro control"})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>de(!1),children:"Close"})]}),e.jsx(Nt,{api:s})]}),e.jsxs("div",{className:"dashboard-scenes",children:[we==="focus"&&e.jsxs("div",{className:"dashboard-focus-grid",children:[e.jsxs("div",{className:`card productivity-ring ${Ds?"complete":""}`,children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Daily productivity"}),e.jsx("h2",{children:"Close your ring"})]}),e.jsxs("span",{className:"pill ghost",children:[Us(ms)," goal"]})]}),e.jsxs("div",{className:"productivity-ring-body",children:[e.jsxs("div",{className:"productivity-ring-graphic",role:"img","aria-label":`Productivity ring ${rs(is)} of ${Us(ms)}`,children:[e.jsx("div",{className:"productivity-ring-glow"}),e.jsxs("svg",{viewBox:"0 0 120 120","aria-hidden":!0,children:[e.jsx("circle",{className:"productivity-ring-track",cx:"60",cy:"60",r:xs,strokeWidth:"10"}),e.jsx("circle",{className:"productivity-ring-progress",cx:"60",cy:"60",r:xs,strokeWidth:"10",strokeDasharray:Ps,strokeDashoffset:xt})]}),e.jsxs("div",{className:"productivity-ring-center",children:[e.jsx("strong",{children:rs(is)}),e.jsx("span",{children:"productive"})]})]}),e.jsxs("div",{className:"productivity-ring-meta",children:[e.jsx("strong",{children:p?"--":`${pt}%`}),e.jsx("span",{className:"subtle",children:p?"Collecting signal...":Ds?"You've closed your circle.":`${rs(gt)} to go`}),e.jsxs("span",{className:"subtle",children:["Today - ",rs(ls)," target"]})]})]})]}),e.jsxs("div",{className:`card dashboard-streak ${as>=1?"streak-max":""}`,style:{"--streak-color":ut,"--streak-progress":`${Math.round(as*100)}%`},children:[e.jsxs("div",{className:"streak-header",children:[e.jsx("span",{className:"eyebrow",children:"Recovery timer"}),e.jsx("span",{className:`pill inline ${We}`,children:We})]}),e.jsx("h2",{children:"Time since last frivolity"}),e.jsx("div",{className:"streak-time",children:R?Ve?Os(Ve):"No frivolity logged":"Loading..."}),e.jsxs("div",{className:"streak-meta",children:[e.jsx("span",{className:"subtle",children:h?`Last spend ${new Date(h).toLocaleString()}`:"No paid sessions recorded yet."}),e.jsxs("div",{className:"streak-meta-row",children:[e.jsx("span",{className:"pill ghost",children:"Goal: 3 days"}),e.jsxs("span",{className:"pill ghost",children:[D??0," frivolity uses (24h)"]})]})]}),e.jsx("div",{className:"streak-bar","aria-hidden":!0,children:e.jsx("span",{})})]}),e.jsxs("div",{className:"card dashboard-focus-metrics",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Focus deck"}),e.jsx("h2",{children:"Session highlights"})]}),e.jsx("span",{className:"pill ghost",children:u?`${u.windowHours}h window`:"Rolling day"})]}),e.jsxs("div",{className:"overview-grid",children:[e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsxs("strong",{children:[_e.toFixed(1),"h"]}),e.jsxs("span",{className:"subtle",children:["last ",u?.windowHours??24,"h"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsxs("strong",{children:[f?.productivityScore??"--","%"]}),e.jsxs("span",{className:"subtle",children:["last ",f?.periodDays??7,"d"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Deep work"}),e.jsx("strong",{children:ns==null?"--":`${ns}m`}),e.jsx("span",{className:"subtle",children:"today"})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Frivolity"}),e.jsx("strong",{children:D??"--"}),e.jsx("span",{className:"subtle",children:"last 24h"})]})]}),e.jsxs("div",{className:"dashboard-focus-meta",children:[e.jsxs("div",{children:[e.jsx("span",{className:"metric-label",children:"Active context"}),e.jsx("strong",{children:He})]}),e.jsx("span",{className:`pill inline ${We}`,children:We})]})]})]}),we==="signals"&&e.jsxs("div",{className:"dashboard-signals-grid",children:[e.jsxs("div",{className:"dashboard-signals-main",children:[e.jsxs("div",{className:"card flow-card dashboard-flow",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Attention stability"}),e.jsx("h2",{children:"Flow signals"})]}),e.jsx("span",{className:"pill ghost",children:"Last 24h"})]}),e.jsxs("div",{className:"flow-metrics",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Context switches"}),e.jsx("strong",{children:ws==null?"--":`${ws.toFixed(1)}/h`}),e.jsx("span",{className:"subtle",children:"avg across window"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Thrash rate"}),e.jsx("strong",{children:Ss==null?"--":`${Ss.toFixed(1)}/h`}),e.jsx("span",{className:"subtle",children:"rapid hops"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Idle ratio"}),e.jsx("strong",{children:Cs==null?"--":`${Math.round(Cs*100)}%`}),e.jsx("span",{className:"subtle",children:"passive time"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Longest run"}),e.jsxs("strong",{children:[ct,"h"]}),e.jsx("span",{className:"subtle",children:"productive streak"})]})]}),e.jsxs("div",{className:"flow-toggle",children:[e.jsx("button",{type:"button",className:`pill ghost ${V==="productivity"?"active":""}`,onClick:()=>he("productivity"),children:"Productivity"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="switches"?"active":""}`,onClick:()=>he("switches"),children:"Switches"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="thrash"?"active":""}`,onClick:()=>he("thrash"),children:"Thrash"}),e.jsx("button",{type:"button",className:`pill ghost ${V==="idle"?"active":""}`,onClick:()=>he("idle"),children:"Idle"})]}),e.jsxs("div",{className:"flow-sparkline",children:[e.jsx("span",{className:"label",children:V==="switches"?"Switches trend":V==="thrash"?"Thrash trend":V==="idle"?"Idle trend":"Productive trend"}),e.jsx("div",{className:"flow-sparkline-track",children:ks.length>1?e.jsx("svg",{viewBox:"0 0 100 40",preserveAspectRatio:"none","aria-hidden":!0,children:e.jsx("path",{d:Lt(ks),fill:"none",stroke:"currentColor",strokeWidth:"2"})}):e.jsx("span",{className:"subtle",children:"Collecting signalâ€¦"})})]})]}),e.jsx("div",{className:"dashboard-insights",children:e.jsx(Et,{api:s,overview:f,loading:g,onRefresh:o})})]}),e.jsxs("div",{className:"card dashboard-overview",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Signal deck"}),e.jsx("h2",{children:"Focus telemetry"})]}),e.jsx("span",{className:"pill ghost",children:u?`${u.windowHours}h window`:"Rolling day"})]}),e.jsxs("div",{className:"overview-grid",children:[e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Active time"}),e.jsxs("strong",{children:[_e.toFixed(1),"h"]}),e.jsxs("span",{className:"subtle",children:["last ",u?.windowHours??24,"h"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Productivity"}),e.jsxs("strong",{children:[f?.productivityScore??"--","%"]}),e.jsxs("span",{className:"subtle",children:["last ",f?.periodDays??7,"d"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Avg session"}),e.jsx("strong",{children:f?Os(f.avgSessionLength*1e3):"--"}),e.jsxs("span",{className:"subtle",children:[f?.totalSessions??"--"," sessions"]})]}),e.jsxs("div",{className:"overview-metric",children:[e.jsx("span",{className:"label",children:"Peak hour"}),e.jsx("strong",{children:f?Ws(f.peakProductiveHour):"--"}),e.jsxs("span",{className:"subtle",children:["risk ",f?Ws(f.riskHour):"--"]})]})]}),e.jsxs("div",{className:"overview-breakdown",children:[e.jsx("span",{className:"label",children:"Category mix"}),e.jsxs("div",{className:"overview-bars",children:[Xe("Productive","productive",f),Xe("Neutral","neutral",f),Xe("Frivolity","frivolity",f),Xe("Draining","draining",f),Xe("Idle","idle",f)]})]}),e.jsxs("div",{className:"overview-top",children:[e.jsx("span",{className:"label",children:"Top contexts"}),e.jsxs("ul",{className:"overview-list",children:[ge.slice(0,3).map(c=>e.jsxs("li",{children:[e.jsx("strong",{children:c.label}),e.jsxs("span",{className:"subtle",children:[Math.round(c.seconds/60),"m â€¢ ",c.source==="url"?"Browser":"App"]})]},c.label)),ge.length===0&&e.jsx("li",{className:"subtle",children:"No streams yet."})]}),f?.topEngagementDomain&&!Ue(f.topEngagementDomain)&&e.jsxs("div",{className:"overview-highlight",children:[e.jsx("span",{className:"label",children:"Most engaging"}),e.jsx("strong",{children:f.topEngagementDomain}),e.jsx("span",{className:"subtle",children:"highest attention hold this week"})]})]})]})]}),we==="journey"&&e.jsxs("div",{className:"dashboard-journey-grid",children:[e.jsx("div",{className:"dashboard-orbit",children:e.jsx(wt,{summary:u,economy:n})}),e.jsxs("div",{className:"dashboard-timeline",children:[e.jsx(Mt,{journey:ve,loading:p,isRemote:Le}),e.jsx(Tt,{journey:ve,loading:p,isRemote:Le})]})]}),we==="social"&&e.jsxs("div",{className:"dashboard-social-grid",children:[e.jsxs("div",{className:"card friends-strip",children:[e.jsxs("div",{className:"friends-strip-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Friends"}),e.jsx("h2",{children:"In the zone"})]}),e.jsx("span",{className:"pill ghost",children:"Last 24h"})]}),U?Y.length===0?e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"No friends yet"}),e.jsx("span",{className:"subtle",children:"Add a handle in the Friends tab."})]}):e.jsx("div",{className:"friends-strip-row",children:Y.map(c=>{const $=I[c.userId],Z=$?.categoryBreakdown??null,ae=$?.totalActiveSeconds??0,ye=ae>0?Z.productive/ae*100:0,Fe=ae>0?Z.neutral/ae*100:0,Oe=ae>0?Z.frivolity/ae*100:0,Ie=(c.pinnedTrophies??[]).map(ze=>Ts.get(ze)).filter(ze=>!!ze);return e.jsxs("button",{type:"button",className:"friends-chip",onClick:()=>De(c),children:[e.jsxs("div",{className:"friends-chip-header",children:[e.jsxs("div",{children:[e.jsx("strong",{children:c.displayName??c.handle??"Friend"}),e.jsxs("span",{className:"subtle",children:["@",c.handle??"no-handle"]})]}),e.jsx("span",{className:"pill ghost",children:$?`${$.productivityScore}%`:"--"})]}),e.jsxs("div",{className:"friends-chip-activity",children:[e.jsxs("span",{children:[$?Rt($.totalActiveSeconds):"--"," active"]}),e.jsx("span",{className:"subtle",children:$?`Updated ${new Date($.updatedAt).toLocaleTimeString()}`:"No data yet"})]}),e.jsxs("div",{className:"friends-chip-bar",children:[e.jsx("span",{className:"cat-productive",style:{width:`${ye}%`}}),e.jsx("span",{className:"cat-neutral",style:{width:`${Fe}%`}}),e.jsx("span",{className:"cat-frivolity",style:{width:`${Oe}%`}})]}),v?e.jsx("div",{className:"head-to-head",children:I[c.userId]?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"head-to-head-row",children:[e.jsx("span",{children:"You"}),e.jsx("span",{children:c.displayName??c.handle??"Friend"})]}),e.jsxs("div",{className:"head-to-head-bar fancy",children:[e.jsx("span",{className:"head-to-head-left",style:{width:`${Ks(ts,I[c.userId])}%`,background:_?.color??"var(--accent)"}}),e.jsx("span",{className:"head-to-head-right",style:{width:`${100-Ks(ts,I[c.userId])}%`,background:c.color??"rgba(255, 255, 255, 0.3)"}}),e.jsx("div",{className:"head-to-head-glow"})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[zs(ts?.categoryBreakdown.productive??0)," productive"]}),e.jsxs("span",{children:[zs(I[c.userId]?.categoryBreakdown.productive??0)," productive"]})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[_s(ts?.emergencySessions)," emergency"]}),e.jsxs("span",{children:[_s(I[c.userId]?.emergencySessions)," emergency"]})]})]}):e.jsx("p",{className:"subtle",style:{marginTop:6},children:"Waiting for shared activity data."})}):e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Competitive view is off."}),Ie.length>0&&e.jsx("div",{className:"friends-trophies",children:Ie.slice(0,3).map(ze=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:ze.emoji}),ze.name]},ze.id))})]},c.id)})}):e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"Syncing friendsâ€¦"}),e.jsx("span",{className:"subtle",children:"Connect the desktop app to pull stats."})]})]}),be.length>0&&e.jsxs("div",{className:"card trophy-strip",children:[e.jsxs("div",{className:"trophy-strip-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Trophies"}),e.jsx("h2",{children:"Case highlights"})]}),e.jsx("span",{className:"pill ghost",children:"Profile view"})]}),e.jsx("div",{className:"trophy-strip-row",children:$s.length===0?e.jsxs("div",{className:"friends-empty",children:[e.jsx("strong",{children:"No pinned trophies"}),e.jsx("span",{className:"subtle",children:"Pin trophies in your Profile page."})]}):$s.map(c=>e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:c.emoji}),e.jsx("span",{children:c.name})]},c.id))}),Ge&&e.jsxs("div",{className:"trophy-next",children:[e.jsx("span",{className:"label",children:"Next up"}),e.jsxs("div",{className:"trophy-next-body",children:[e.jsx("span",{className:"emoji",children:Ge.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:Ge.name}),e.jsx("span",{className:"subtle",children:Ge.progress.label??`${Ge.progress.current}/${Ge.progress.target}`})]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(Ge.progress.ratio*100)}%`}})})]}),B&&e.jsxs("div",{className:"trophy-toast",children:[e.jsx("span",{className:"emoji",children:B.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:B.name}),e.jsx("span",{className:"subtle",children:"New trophy earned"})]})]})]})]})]}),e.jsx(nt,{open:oe,friend:Se,summary:Se?I[Se.userId]??null:null,timeline:O,publicLibraryItems:le,trophies:be,onClose:()=>fe(!1)})]})}function Os(s){const a=Math.max(0,Math.floor(s/6e4)),n=Math.floor(a/(60*24)),l=Math.floor(a%(60*24)/60),j=a%60;return n>0?`${n}d ${l}h ${j}m`:`${l}h ${j}m`}function Ws(s){const a=s>=12?"PM":"AM";return`${s%12||12}${a}`}function Rt(s){const a=s/3600;return a>=10?`${a.toFixed(0)}h`:`${a.toFixed(1)}h`}function rs(s){const a=Math.max(0,Math.round(s/60)),n=Math.floor(a/60),l=a%60;return`${n}h ${l}m`}function Us(s){return Number.isFinite(s)?s%1===0?`${s.toFixed(0)}h`:`${s.toFixed(1)}h`:"0h"}function zs(s){return`${Math.round(s/60)}m`}function _s(s){return typeof s!="number"?"â€”":String(s)}function Gs(s){const a=new Date(s);return a.setMinutes(0,0,0),a.toISOString()}function Lt(s){if(s.length<2)return"";const a=Math.max(...s),n=Math.min(...s),l=Math.max(.001,a-n);return s.map((j,m)=>{const u=m/(s.length-1)*100,w=36-(j-n)/l*32;return`${m===0?"M":"L"}${u.toFixed(2)} ${w.toFixed(2)}`}).join(" ")}function Ht(s){return{userId:"me",updatedAt:new Date().toISOString(),periodHours:s.windowHours,totalActiveSeconds:s.totalSeconds,deepWorkSeconds:s.deepWorkSeconds,categoryBreakdown:{productive:s.totalsByCategory.productive??0,neutral:s.totalsByCategory.neutral??0,frivolity:s.totalsByCategory.frivolity??0,draining:s.totalsByCategory.draining??0,idle:s.totalsByCategory.idle??0},productivityScore:s.totalSeconds>0?Math.round(s.totalsByCategory.productive/s.totalSeconds*100):0}}function Ks(s,a){const n=s?.categoryBreakdown.productive??0,l=a?.categoryBreakdown.productive??0,j=n+l;return j===0?50:Math.round(n/j*100)}function Xe(s,a,n){const l=n?.categoryBreakdown??{productive:0,neutral:0,frivolity:0,draining:0,idle:0},j=l.productive+l.neutral+l.frivolity+l.draining+l.idle,m=l[a]??0,u=j>0?Math.round(m/j*100):0;return e.jsxs("div",{className:"overview-bar",children:[e.jsxs("div",{className:"overview-bar-label",children:[e.jsx("span",{children:s}),e.jsxs("span",{className:"subtle",children:[u,"%"]})]}),e.jsx("div",{className:"overview-bar-track",children:e.jsx("span",{className:`overview-bar-fill cat-${a}`,style:{width:`${u}%`}})})]},a)}function Ys(s){const a=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0");return`${a}-${n}-${l}`}function $e(s){const a=s.trim().toLowerCase();if(!a)return null;if(a.startsWith("http://")||a.startsWith("https://"))try{return new URL(a).hostname.replace(/^www\./,"")}catch{return null}return a.split("/")[0].replace(/^www\./,"")}function cs(s){const a=new Set,n=[];for(const l of s){const j=$e(l);!j||a.has(j)||(a.add(j),n.push(j))}return n}function Bt({api:s,variant:a="page"}){const[n,l]=t.useState(null),[j,m]=t.useState(!0),[u,w]=t.useState(!1),[p,N]=t.useState(!1),[f,F]=t.useState(null),[g,E]=t.useState(""),[h,k]=t.useState("frivolous"),R=t.useCallback(async()=>{try{const r=await s.settings.categorisation();l(r)}catch(r){console.error("Failed to load categorisation",r),F("Could not load domain lists.")}finally{m(!1)}},[s.settings]);t.useEffect(()=>{R()},[R]);const y=t.useMemo(()=>n?{productive:n.productive.length,neutral:n.neutral.length,frivolity:n.frivolity.length,draining:n.draining?.length??0}:{productive:0,neutral:0,frivolity:0,draining:0},[n]),D=async r=>{w(!0),F(null);try{await s.settings.updateCategorisation(r),l(r),N(!0),window.setTimeout(()=>N(!1),1500)}catch(b){F(b.message||"Failed to save")}finally{w(!1)}},i=async(r,b)=>{if(!n)return;const C=$e(r);if(!C){F("Please enter a valid domain.");return}const L=cs(n.productive.filter(I=>$e(I)!==C)),G=cs(n.neutral.filter(I=>$e(I)!==C)),Y=cs(n.frivolity.filter(I=>$e(I)!==C)),S=cs((n.draining??[]).filter(I=>$e(I)!==C));b==="productive"&&L.unshift(C),b==="neutral"&&G.unshift(C),b==="frivolous"&&Y.unshift(C),b==="draining"&&S.unshift(C),await D({productive:L,neutral:G,frivolity:Y,draining:S})},x=async r=>{if(!n)return;const b=$e(r);b&&await D({productive:n.productive.filter(C=>$e(C)!==b),neutral:n.neutral.filter(C=>$e(C)!==b),frivolity:n.frivolity.filter(C=>$e(C)!==b),draining:n.draining?.filter(C=>$e(C)!==b)??[]})},T=async()=>{F(null);const r=$e(g);if(!r){F("Enter a domain like twitter.com");return}E(""),await i(r,h)};if(j)return e.jsx("div",{className:"panel",children:"Loading domainsâ€¦"});if(!n)return e.jsx("div",{className:"panel",children:"Could not load domains."});const M=a==="settings"?"store-page settings-domains":"page store-page";return e.jsxs("section",{className:M,children:[a==="page"?e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Domains"}),e.jsxs("p",{className:"subtle",children:["Keep this simple: ",e.jsx("strong",{children:"productive"}),", ",e.jsx("strong",{children:"neutral"}),", ",e.jsx("strong",{children:"draining"}),", or ",e.jsx("strong",{children:"frivolous"}),". Idle is inferred automatically."]})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill ghost",children:[y.productive," productive"]}),e.jsxs("span",{className:"pill ghost",children:[y.neutral," neutral"]}),e.jsxs("span",{className:"pill ghost",children:[y.frivolity," frivolous"]}),e.jsxs("span",{className:"pill ghost",children:[y.draining," draining"]})]})]}):e.jsxs("div",{className:"settings-section-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Domains"}),e.jsxs("p",{className:"subtle",children:["Keep this simple: ",e.jsx("strong",{children:"productive"}),", ",e.jsx("strong",{children:"neutral"}),", ",e.jsx("strong",{children:"draining"}),", or ",e.jsx("strong",{children:"frivolous"}),". Idle is inferred automatically."]})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill ghost",children:[y.productive," productive"]}),e.jsxs("span",{className:"pill ghost",children:[y.neutral," neutral"]}),e.jsxs("span",{className:"pill ghost",children:[y.frivolity," frivolous"]}),e.jsxs("span",{className:"pill ghost",children:[y.draining," draining"]})]})]}),f&&e.jsx("p",{className:"error-text",children:f}),p&&e.jsx("p",{className:"subtle",children:"Saved."}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Quick classify"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1.2fr 1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Domain",e.jsx("input",{value:g,onChange:r=>E(r.target.value),placeholder:"twitter.com",disabled:u})]}),e.jsxs("label",{children:["Category",e.jsxs("select",{value:h,onChange:r=>k(r.target.value),disabled:u,children:[e.jsx("option",{value:"productive",children:"productive"}),e.jsx("option",{value:"neutral",children:"neutral"}),e.jsx("option",{value:"frivolous",children:"frivolous"}),e.jsx("option",{value:"draining",children:"draining"})]})]}),e.jsx("button",{className:"primary",type:"button",disabled:u,onClick:T,children:"Add"})]}),e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Tip: you can also label domains from the browser extension popup."})]}),e.jsxs("div",{className:"store-grid",style:{gridTemplateColumns:"repeat(auto-fit, minmax(260px, 1fr))"},children:[e.jsx(os,{title:"Productive",subtitle:"Earns f-coins.",items:n.productive,onRemove:x,onMove:r=>i(r,"productive"),disabled:u}),e.jsx(os,{title:"Neutral",subtitle:"Safe by default (earning depends on your clock-in settings).",items:n.neutral,onRemove:x,onMove:r=>i(r,"neutral"),disabled:u}),e.jsx(os,{title:"Frivolous",subtitle:"Paywall applies here.",items:n.frivolity,onRemove:x,onMove:r=>i(r,"frivolous"),disabled:u}),e.jsx(os,{title:"Draining",subtitle:"Passively costs coins (no paywall).",items:n.draining??[],onRemove:x,onMove:r=>i(r,"draining"),disabled:u})]})]})}function os(s){const{title:a,subtitle:n,items:l,disabled:j,onRemove:m}=s;return e.jsxs("div",{className:"card store-item",children:[e.jsxs("div",{className:"store-item-headline",children:[e.jsxs("div",{children:[e.jsx("p",{className:"store-item-domain",children:a}),e.jsxs("h3",{className:"store-item-title",children:[l.length," domains"]})]}),e.jsxs("div",{className:"store-item-price-pill",children:[e.jsx("strong",{children:l.length}),e.jsx("span",{children:"items"})]})]}),e.jsx("p",{className:"subtle",style:{marginTop:6},children:n}),l.length===0?e.jsx("div",{className:"empty-state",style:{padding:0},children:e.jsx("p",{className:"subtle",children:"None yet."})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,marginTop:8},children:[l.slice(0,12).map(u=>e.jsxs("div",{style:{display:"flex",gap:10,justifyContent:"space-between",alignItems:"center"},children:[e.jsx("code",{style:{fontSize:12,color:"var(--fg-muted)"},children:u}),e.jsx("button",{className:"ghost danger",disabled:j,onClick:()=>m(u),children:"Remove"})]},u)),l.length>12&&e.jsxs("p",{className:"subtle",style:{margin:0},children:["Showing 12 of ",l.length,". Use search/edit tools in a future iteration."]})]})]})}function Ot({values:s,onChange:a,color:n,disabled:l=!1}){const[j,m]=t.useState(!1),u=t.useRef(null),w=p=>{if(l||!u.current)return;const N=u.current.getBoundingClientRect(),f="touches"in p?p.touches[0].clientX:p.clientX,F="touches"in p?p.touches[0].clientY:p.clientY,g=f-N.left,E=F-N.top,h=N.width,k=N.height,R=h/24,y=Math.floor(g/R);if(y>=0&&y<24){const i=1-E/k,x=Math.max(0,Math.min(3,i*3)),T=[...s];T[y]=Number(x.toFixed(1)),a(T)}};return e.jsxs("div",{className:"curve-editor",style:{userSelect:"none",opacity:l?.5:1},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",fontSize:"12px",color:"var(--text-subtle)"},children:[e.jsx("span",{children:"00:00"}),e.jsx("span",{children:"06:00"}),e.jsx("span",{children:"12:00"}),e.jsx("span",{children:"18:00"}),e.jsx("span",{children:"23:59"})]}),e.jsxs("svg",{ref:u,width:"100%",height:"200",style:{background:"rgba(0,0,0,0.05)",borderRadius:"8px",cursor:l?"not-allowed":"crosshair"},onMouseDown:p=>{l||(m(!0),w(p))},onMouseMove:p=>{!l&&j&&w(p)},onMouseUp:()=>m(!1),onMouseLeave:()=>m(!1),onTouchStart:p=>{l||(m(!0),w(p))},onTouchMove:p=>{!l&&j&&w(p)},onTouchEnd:()=>m(!1),children:[[.5,1,1.5,2,2.5].map(p=>e.jsx("line",{x1:"0",y1:200-p/3*200,x2:"100%",y2:200-p/3*200,stroke:"rgba(0,0,0,0.1)",strokeDasharray:"4 4"},p)),s.map((p,N)=>{const f=p/3*200;return e.jsx("rect",{x:`${N/24*100}%`,y:200-f,width:`${100/24}%`,height:f,fill:n,stroke:"#fff",strokeWidth:"1",opacity:"0.8"},N)})]}),e.jsx("div",{style:{textAlign:"center",marginTop:"8px",fontSize:"12px"},children:l?"Active session detected â€” edits locked until it ends.":"Click and drag to adjust hourly multipliers (0x - 3x)"})]})}function Wt({api:s}){const[a,n]=t.useState([]),[l,j]=t.useState(null),[m,u]=t.useState("productive"),[w,p]=t.useState(!1),[N,f]=t.useState({}),[F,g]=t.useState(null),[E,h]=t.useState(null),[k,R]=t.useState(null),[y,D]=t.useState(!1),[i,x]=t.useState(null),[T,M]=t.useState(!0),[r,b]=t.useState(!1),[C,L]=t.useState(!1),[G,Y]=t.useState(""),[S,I]=t.useState(10),[q,U]=t.useState(8),[X,K]=t.useState(!1);t.useEffect(()=>{A(),s.settings.economyExchangeRate().then(v=>{typeof v=="number"&&Number.isFinite(v)&&R(v)}).catch(()=>{}),s.settings.dailyWalletResetEnabled().then(M).catch(()=>{})},[]),t.useEffect(()=>{const v=()=>s.paywall.sessions().then(pe=>{const we={};pe.forEach(ne=>{we[ne.domain]=ne}),f(we)}).catch(()=>{});v();const J=s.events.on("paywall:session-started",v),ce=s.events.on("paywall:session-ended",v),de=s.events.on("paywall:session-paused",v),Ne=s.events.on("paywall:session-resumed",v);return()=>{J(),ce(),de(),Ne()}},[s]);async function A(){const[v,J,ce]=await Promise.all([s.market.list(),s.settings.categorisation(),s.paywall.sessions()]),de=[],Ne=new Map(v.map(ne=>[ne.domain,ne])),pe=(ne,Pe)=>Ne.get(ne)||{domain:ne,ratePerMin:Pe,packs:[],hourlyModifiers:Array(24).fill(1)};J.productive.forEach(ne=>{de.push({id:ne,type:"productive",rate:pe(ne,5)})}),J.frivolity.forEach(ne=>{de.push({id:ne,type:"frivolity",rate:pe(ne,3)})}),v.forEach(ne=>{de.find(Pe=>Pe.id===ne.domain)||de.push({id:ne.domain,type:"neutral",rate:ne})}),n(de);const we={};ce.forEach(ne=>{we[ne.domain]=ne}),f(we)}const _=a.filter(v=>m==="productive"?v.type==="productive":v.type==="frivolity"||v.type==="neutral");t.useEffect(()=>{!C&&_.length>0&&(!l||!_.find(v=>v.id===l))?j(_[0].id):_.length===0&&!C&&j(null)},[m,a,C]),t.useEffect(()=>{g(null)},[l]),t.useEffect(()=>{if(!i)return;const v=setTimeout(()=>x(null),2400);return()=>clearTimeout(v)},[i]);const H=a.find(v=>v.id===l),ie=!!(H?N[H.id]:void 0);t.useEffect(()=>{if(!E)return;const v=setTimeout(()=>h(null),2e3);return()=>clearTimeout(v)},[E]);const O=v=>{!H||ie||te(H.id,{...H.rate,ratePerMin:v})},Q=v=>{!H||ie||te(H.id,{...H.rate,hourlyModifiers:v})},le=async v=>{if(!r){b(!0);try{await s.settings.updateDailyWalletResetEnabled(v),M(v),x(v?"Daily coin reset enabled â€” wallet starts at 0 each day.":"Daily coin reset disabled.")}catch(J){g(J.message)}finally{b(!1)}}},te=(v,J)=>{n(ce=>ce.map(de=>de.id===v?{...de,rate:J}:de))},oe=async()=>{if(H){if(ie){g("Active session detected â€” end it before changing this rate.");return}p(!0),g(null),h(null);try{await s.market.upsert(H.rate),h("Saved to market"),await A(),j(H.id)}catch(v){g(v.message)}finally{p(!1)}}},fe=async v=>{if(v.preventDefault(),!G.trim())return;const J=G.trim();if(a.find(de=>de.id===J)){g("Profile already exists");return}const ce={domain:J,ratePerMin:3,packs:[],hourlyModifiers:Array(24).fill(1)};await s.market.upsert(ce),await A(),Y(""),L(!1),j(J),u("frivolity")},be=t.useMemo(()=>m==="productive"?"Earn profiles":"Spend profiles",[m]),je=t.useMemo(()=>m==="productive"?"Tune how productive apps reward you over the day.":"Shape how costly domains evolve over the day.",[m]),ke=t.useMemo(()=>{if(!H)return[];const v=H.rate.hourlyModifiers,J=Math.max(...v),ce=Math.min(...v);return[{label:"Base rate",value:`${H.rate.ratePerMin} f-coins/min`},{label:"Peak multiplier",value:`${J.toFixed(1)}x`},{label:"Off-peak",value:`${ce.toFixed(1)}x`}]},[H]),P=H?.type==="productive";function B(v){const J=v.filter(Ne=>typeof Ne=="number"&&Number.isFinite(Ne));if(!J.length)return null;const ce=[...J].sort((Ne,pe)=>Ne-pe),de=Math.floor(ce.length/2);return ce.length%2===0?(ce[de-1]+ce[de])/2:ce[de]}function ee(v){const J=Number(v);return Number.isFinite(J)?Math.round(J*100)/100:0}const V=t.useMemo(()=>B(a.filter(v=>v.type==="productive").map(v=>v.rate.ratePerMin))??5,[a]),he=t.useMemo(()=>B(a.filter(v=>v.type==="frivolity").map(v=>v.rate.ratePerMin))??3,[a]),ve=t.useMemo(()=>!he||he<=0?0:V/he,[V,he]),W=k??ve,me=t.useMemo(()=>{const v=typeof W=="number"&&Number.isFinite(W)?W:1;return!he||he<=0||!V||V<=0||v<=0?1:V/(he*v)},[W,V,he]),ue=async()=>{if(y)return;const v=typeof W=="number"&&Number.isFinite(W)?W:null;if(!(!v||v<=0)){D(!0),g(null);try{const J=a.filter(pe=>pe.type==="frivolity"),ce=J.filter(pe=>!!N[pe.id]).map(pe=>pe.id),de=J.filter(pe=>!N[pe.id]);if(!de.length){x("All spend profiles are locked by active sessions.");return}await s.settings.updateEconomyExchangeRate(v);let Ne=0;for(const pe of de){const we={...pe.rate,ratePerMin:ee(pe.rate.ratePerMin*me),packs:pe.rate.packs.map(ne=>({...ne,price:Math.max(1,Math.round(ne.price*me))}))};await s.market.upsert(we),Ne+=1}await A(),x(ce.length?`Scaled ${Ne} spend profiles. Skipped ${ce.length} locked by active sessions.`:`Scaled ${Ne} spend profiles.`)}catch(J){g(J.message)}finally{D(!1)}}};return e.jsxs("section",{className:"panel tuner-panel",children:[e.jsxs("header",{className:"panel-header tuner-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Economy"}),e.jsx("h1",{children:be}),e.jsx("p",{className:"subtle",children:je})]}),e.jsxs("div",{className:"toggle-wrap",children:[e.jsx("span",{className:"subtle",children:"Productive"}),e.jsxs("label",{className:"ios-switch",children:[e.jsx("input",{type:"checkbox",checked:m==="frivolity",onChange:v=>u(v.target.checked?"frivolity":"productive")}),e.jsx("span",{className:"slider"})]}),e.jsx("span",{className:"subtle",children:"Frivolous"})]})]}),E&&e.jsx("div",{className:"inline-note",style:{maxWidth:"420px"},children:E}),i&&e.jsx("div",{className:"inline-note",style:{maxWidth:"520px"},children:i}),e.jsxs("section",{className:"card",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:16,flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0},children:"Daily coin reset"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Start each day at 0 f-coins so frivolity must be re-earned today."})]}),e.jsxs("label",{className:"settings-inline",style:{margin:0},children:[e.jsx("input",{type:"checkbox",checked:T,onChange:v=>le(v.target.checked),disabled:r}),e.jsx("span",{className:"subtle",children:T?"Enabled":"Disabled"})]})]}),e.jsxs("section",{className:"card economy-exchange-card",children:[e.jsxs("div",{className:"economy-exchange-header",children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0},children:"Exchange rate"}),e.jsx("p",{className:"subtle",style:{marginBottom:0},children:"Make the system feel intuitive: how much â€œfrivolity timeâ€ 1 minute of productive time buys."})]}),e.jsx("button",{className:"primary",onClick:ue,disabled:y||!W||W<=0,children:y?"Applyingâ€¦":"Apply to spend profiles"})]}),e.jsxs("div",{className:"economy-exchange-grid",children:[e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Current (typical)"}),e.jsxs("strong",{children:["1 min work â†’ ",ve?ve.toFixed(2):"â€”"," min frivolity"]})]}),e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Target"}),e.jsxs("strong",{children:["1 min work â†’ ",W?W.toFixed(2):"â€”"," min frivolity"]})]}),e.jsxs("div",{className:"economy-exchange-metric",children:[e.jsx("span",{className:"subtle",children:"Effect"}),e.jsxs("strong",{children:[me?`${me.toFixed(2)}Ã—`:"â€”"," spend costs"]})]})]}),e.jsxs("div",{className:"economy-exchange-controls",children:[e.jsxs("div",{className:"economy-exchange-presets",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(.5),disabled:y,children:"0.5Ã—"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(1),disabled:y,children:"1Ã— (1:1)"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(2),disabled:y,children:"2Ã—"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(ve),disabled:y||!ve,children:"Reset"})]}),e.jsxs("label",{style:{display:"grid",gap:8,margin:0},children:[e.jsx("span",{className:"subtle",children:"Minutes of frivolity per minute of work"}),e.jsx("input",{type:"range",min:.25,max:4,step:.05,value:W||1,onChange:v=>R(Number(v.target.value)),disabled:y})]})]}),e.jsxs("p",{className:"subtle",style:{marginBottom:0},children:["This scales all ",e.jsx("strong",{children:"spend"})," profiles (frivolity domains) while keeping your individual profile shapes and pack options. Use â€œAdvancedâ€ below if you want domain-specific tuning."]})]}),e.jsxs("details",{className:"card economy-advanced",open:!1,children:[e.jsxs("summary",{className:"economy-advanced-summary",children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx("strong",{children:"Advanced: per-domain tuning"}),e.jsx("span",{className:"subtle",children:"Power-user controls for rates, curves, and packs."})]}),e.jsx("span",{className:"economy-advanced-toggle","aria-hidden":"true"})]}),e.jsx("div",{className:"economy-advanced-body",children:e.jsxs("div",{className:"tuner-layout",children:[e.jsxs("aside",{className:"tuner-list",children:[e.jsx("div",{style:{padding:"0 4px 8px 4px",borderBottom:"1px solid rgba(255,255,255,0.05)",marginBottom:"8px"},children:C?e.jsxs("form",{onSubmit:fe,style:{display:"flex",gap:"6px"},children:[e.jsx("input",{autoFocus:!0,placeholder:"domain.com",value:G,onChange:v=>Y(v.target.value),style:{flex:1,minWidth:0,padding:"6px 8px",fontSize:"13px",background:"rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"6px",color:"white"}}),e.jsx("button",{type:"submit",className:"primary",style:{padding:"6px 10px",fontSize:"13px"},children:"Add"}),e.jsx("button",{type:"button",className:"ghost",style:{padding:"6px",fontSize:"13px"},onClick:()=>L(!1),children:"âœ•"})]}):e.jsx("button",{className:"ghost",style:{width:"100%",textAlign:"center",fontSize:"13px"},onClick:()=>L(!0),children:"+ Add Profile"})}),_.map(v=>e.jsxs("button",{className:`tuner-list-item ${l===v.id?"active":""}`,onClick:()=>j(v.id),children:[e.jsx("div",{className:"tuner-list-title",children:v.id}),e.jsxs("div",{className:"tuner-list-sub",children:[v.rate.ratePerMin," f-coins/min â€¢ ",v.type]})]},v.id)),_.length===0&&e.jsx("div",{className:"subtle",style:{padding:"12px"},children:"No items in this category."})]}),e.jsx("div",{className:"tuner-editor",children:H?e.jsxs("div",{className:"tuner-grid",children:[e.jsxs("div",{className:"card tuner-primary",children:[e.jsxs("div",{className:"tuner-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:H.id}),e.jsx("p",{className:"subtle",children:H.type==="productive"?"Earn profile":"Spend profile"})]}),e.jsx("button",{className:"primary",onClick:oe,disabled:w||ie,children:ie?"Locked by active session":w?"Saving...":"Save changes"}),e.jsx("button",{className:"ghost danger",disabled:ie,onClick:async()=>{H&&confirm(`Delete profile for ${H.id}?`)&&(await s.market.delete(H.id),await A(),j(null))},children:"Delete"})]}),ie&&e.jsx("div",{className:"inline-note danger",style:{marginBottom:"8px"},children:"Active session running for this domain â€” end it to adjust the exchange rate."}),F&&e.jsx("div",{className:"inline-note warning",style:{marginBottom:"8px"},children:F}),ke.length>0&&e.jsx("div",{className:"tuner-metrics",children:ke.map(v=>e.jsxs("div",{className:"metric-card",children:[e.jsx("span",{className:"metric-label",children:v.label}),e.jsx("strong",{className:"metric-value",children:v.value})]},v.label))}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Base rate (per minute)"}),e.jsx("input",{type:"number",value:H.rate.ratePerMin,onChange:v=>O(Number(v.target.value)),step:"0.1",min:"0.1",max:"100",disabled:ie}),e.jsx("p",{className:"subtle",children:H.type==="productive"?"f-coins earned per minute.":"f-coins spent per minute when metered."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Time multiplier curve"}),e.jsx("p",{className:"subtle",children:"Adjust how the value changes throughout the day. 1x is standard."}),e.jsx(Ot,{values:H.rate.hourlyModifiers,onChange:Q,color:H.type==="productive"?"var(--cat-productive)":"var(--cat-frivolity)",disabled:ie})]})]}),e.jsxs("div",{className:"card tuner-secondary",children:[e.jsx("div",{className:"tuner-header",children:e.jsxs("div",{children:[e.jsx("h3",{children:P?"Earnings preview":"Packs preview"}),e.jsx("p",{className:"subtle",children:P?"How this profileâ€™s rate and curve would surface in payout views.":"Show what users see when buying time."})]})}),e.jsxs("div",{className:"packs-preview",children:[H.rate.packs.length===0&&e.jsx("p",{className:"subtle",children:P?"No packs defined â€” optional for earn profiles.":"No packs defined â€” consider adding 10/30/60 minute options."}),H.rate.packs.map((v,J)=>e.jsxs("div",{className:"pack-card",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[v.minutes," minute session"]}),e.jsxs("p",{className:"subtle",children:[v.price," f-coins â€¢ ",(v.price/v.minutes*60).toFixed(1)," f-coins/hour"]})]}),e.jsx("button",{className:"ghost danger",disabled:ie,onClick:()=>{const ce=[...H.rate.packs];ce.splice(J,1),te(H.id,{...H.rate,packs:ce})},children:"Remove"})]},v.minutes)),!P&&e.jsx("div",{style:{marginTop:"8px"},children:X?e.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("input",{type:"number",placeholder:"Minutes",value:S,onChange:v=>I(Number(v.target.value)),min:"5",max:"120",style:{width:"80px"}}),e.jsx("input",{type:"number",placeholder:"Price",value:q,onChange:v=>U(Number(v.target.value)),min:"1",max:"500",style:{width:"80px"}}),e.jsx("button",{className:"primary",disabled:ie,onClick:()=>{const v=[...H.rate.packs,{minutes:S,price:q}];te(H.id,{...H.rate,packs:v}),K(!1),I(10),U(8)},children:"Add"}),e.jsx("button",{className:"ghost",onClick:()=>K(!1),children:"Cancel"})]}):e.jsx("button",{className:"ghost",disabled:ie,onClick:()=>K(!0),children:"+ Add pack"})})]})]})]}):e.jsx("div",{className:"empty-state",children:"Select an item to tune"})})]})})]})]})}const Je=[{id:"sync",label:"Sync & Profile",description:"Devices, cloud sync, and identity."},{id:"activity",label:"Activity",description:"Idle thresholds and continuity rules."},{id:"paywall",label:"Paywall & Rituals",description:"Emergency access, peek, and journaling."},{id:"integrations",label:"Integrations",description:"Bring in external libraries."},{id:"domains",label:"Domains",description:"Productive vs neutral vs frivolous."},{id:"economy",label:"Economy",description:"Tune earn + spend profiles."},{id:"system",label:"System",description:"Reset data and permissions."}];function Ut({api:s,theme:a,onThemeChange:n}){const[l,j]=t.useState(!1),[m,u]=t.useState(!1),[w,p]=t.useState(null),[N,f]=t.useState("sync"),[F,g]=t.useState(15),[E,h]=t.useState(15),[k,R]=t.useState("balanced"),[y,D]=t.useState(300),[i,x]=t.useState(""),[T,M]=t.useState(10),[r,b]=t.useState(!0),[C,L]=t.useState(!1),[G,Y]=t.useState(120),[S,I]=t.useState(""),[q,U]=t.useState(2),[X,K]=t.useState(null),[A,_]=t.useState([]),[H,Se]=t.useState(""),[ie,O]=t.useState(""),[Q,le]=t.useState("#7cf4d4"),[te,oe]=t.useState(!1),[fe,be]=t.useState({mode:"recent",collectionId:null,includeSubcollections:!0}),[je,ke]=t.useState([]),[P,B]=t.useState(!1),[ee,V]=t.useState("trophies"),[he,ve]=t.useState(!1),[W,me]=t.useState(null),[ue,v]=t.useState(!1),[J,ce]=t.useState("full-color"),[de,Ne]=t.useState(!1),[pe,we]=t.useState([]),[ne,Pe]=t.useState(!1),[o,z]=t.useState(null);t.useEffect(()=>{if(!W)return;const d=window.setTimeout(()=>me(null),5e3);return()=>window.clearTimeout(d)},[W]),t.useEffect(()=>{s.settings.idleThreshold().then(g),s.settings.frivolousIdleThreshold().then(h),s.settings.emergencyPolicy().then(R),s.settings.emergencyReminderInterval().then(D),s.settings.journalConfig().then(d=>{x(d.url??""),M(d.minutes??10)}).catch(()=>{}),s.settings.peekConfig().then(d=>{b(d.enabled),L(d.allowOnNewPages)}).catch(()=>{}),s.settings.continuityWindowSeconds().then(Y).catch(()=>{}),s.settings.productivityGoalHours().then(U).catch(()=>{}),s.settings.excludedKeywords().then(d=>{I((d??[]).join(`
`))}).catch(()=>{}),s.settings.cameraModeEnabled().then(v).catch(()=>{}),s.settings.guardrailColorFilter().then(ce).catch(()=>{}),s.settings.alwaysGreyscale().then(Ne).catch(()=>{}),s.integrations.zotero.config().then(be).catch(()=>{})},[s.settings,s.integrations.zotero]);const xe=async()=>{Pe(!0),z(null);try{const d=await s.camera.listPhotos(120);we(d)}catch(d){console.error("Failed to load camera photos",d),z("Failed to load camera photos.")}finally{Pe(!1)}};t.useEffect(()=>{xe()},[]);const Ce=async()=>{if(!navigator.mediaDevices?.getUserMedia)throw new Error("Camera capture is not supported in this environment.");let d=null;try{d=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}finally{d?.getTracks().forEach(re=>re.stop())}},Ee=async d=>{if(z(null),d)try{await Ce()}catch(re){console.error("Camera permission request failed",re),z("Camera access is blocked. Enable TimeWellSpent in macOS System Settings â†’ Privacy & Security â†’ Camera, then try again."),v(!1);return}v(d)},De=async()=>{try{const d=await s.sync.status();if(K(d),Se(d.device?.name??""),d.configured&&d.authenticated){const re=await s.friends.profile();O(re?.handle??""),le(re?.color??"#7cf4d4");const Me=await s.sync.listDevices();_(Me)}else _([])}catch(d){console.error("Failed to load sync status",d)}};t.useEffect(()=>{De()},[]);const Re=t.useMemo(()=>fe.collectionId==null?null:je.find(d=>d.id===fe.collectionId)??null,[je,fe.collectionId]);async function Le(){B(!0);try{const d=await s.integrations.zotero.collections();ke(d)}catch(d){console.error("Failed to load Zotero collections",d),p("Failed to load Zotero collections. Is Zotero installed and opened at least once?")}finally{B(!1)}}async function He(d){d?.preventDefault(),j(!0),u(!1),p(null);try{await s.settings.updateIdleThreshold(F),await s.settings.updateFrivolousIdleThreshold(E);const re=S.split(/[\n,]+/).map(Me=>Me.trim().toLowerCase()).filter(Boolean);await s.settings.updateExcludedKeywords(re),I(re.join(`
`)),await s.settings.updateEmergencyPolicy(k),await s.settings.updateEmergencyReminderInterval(y),await s.settings.updateJournalConfig({url:i.trim()?i.trim():null,minutes:T}),await s.settings.updatePeekConfig({enabled:r,allowOnNewPages:C}),await s.settings.updateContinuityWindowSeconds(G),await s.settings.updateProductivityGoalHours(q),await s.settings.updateCameraModeEnabled(ue),await s.settings.updateGuardrailColorFilter(J),await s.settings.updateAlwaysGreyscale(de),await s.integrations.zotero.updateConfig(fe),u(!0),window.setTimeout(()=>u(!1),2e3)}catch(re){p(re.message||"Failed to save settings")}finally{j(!1)}}async function We(){if(he)return;me(null);const d={trophies:"This will clear all earned trophies, pinned trophies, and personal bests.",wallet:"This will zero your bank balance and erase wallet transactions.",all:"This will clear trophies, activity history, wallet, library, and sync state. This cannot be undone."};if(window.confirm(`${d[ee]}

Continue?`)&&!(ee==="all"&&!window.confirm("Final check: erase all local/cloud stats now?"))){ve(!0),p(null);try{await s.system.reset(ee),me({trophies:"Trophy case reset locally and in sync.",wallet:"Bank reset locally and in sync.",all:"All stats reset locally and in sync."}[ee]),await De()}catch(re){p(re.message||"Failed to reset")}finally{ve(!1)}}}const _e=async d=>{try{await s.camera.revealPhoto(d)}catch(re){console.error("Failed to reveal camera photo",re),z("Failed to reveal camera photo.")}},Ue=async d=>{if(window.confirm("Delete this photo?"))try{await s.camera.deletePhoto(d),we(re=>re.filter(Me=>Me.id!==d))}catch(re){console.error("Failed to delete camera photo",re),z("Failed to delete camera photo.")}},ge=Je.find(d=>d.id===N)??Je[0],Be=Math.max(0,Je.findIndex(d=>d.id===N))+1,Ae=N!=="domains"&&N!=="economy";return e.jsxs("section",{className:"panel",children:[e.jsx("header",{className:"panel-header",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Settings"}),e.jsx("p",{className:"subtle",children:"Tune policies, domains, economy, and sync."})]})}),w&&e.jsx("p",{className:"error-text",children:w}),e.jsxs("div",{className:"settings-layout",children:[e.jsx("nav",{className:"settings-nav","aria-label":"Settings sections",children:Je.map(d=>e.jsxs("button",{type:"button",className:N===d.id?"active":"",onClick:()=>f(d.id),"aria-current":N===d.id?"page":void 0,children:[e.jsx("span",{className:"settings-nav-label",children:d.label}),e.jsx("span",{className:"settings-nav-desc",children:d.description})]},d.id))}),e.jsxs("div",{className:"settings-pane",children:[Ae&&e.jsxs("div",{className:"settings-pane-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:ge.label}),e.jsx("p",{className:"subtle",children:ge.description})]}),e.jsxs("span",{className:"pill ghost",children:["Section ",Be," of ",Je.length]})]}),N==="sync"&&e.jsx("div",{className:"settings-pane-body",children:e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Cloud sync"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Keep wallet, library, and summaries aligned across devices."})]}),e.jsx("button",{type:"button",className:"ghost",onClick:De,disabled:te,children:"Refresh"})]}),!X?.configured&&e.jsx("p",{className:"subtle",children:"Supabase not configured. Add `SUPABASE_URL` and `SUPABASE_ANON_KEY`, then restart the app."}),X?.configured&&!X.authenticated&&e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"primary",onClick:async()=>{oe(!0),await s.sync.signIn("google"),oe(!1)},disabled:te,children:"Connect with Google"}),e.jsx("button",{type:"button",className:"secondary",onClick:async()=>{oe(!0),await s.sync.signIn("github"),oe(!1)},disabled:te,children:"Connect with GitHub"})]}),X?.configured&&X.authenticated&&e.jsxs("div",{className:"settings-stack",children:[e.jsxs("div",{className:"settings-pills",children:[e.jsx("span",{className:"pill ghost",children:X.user?.email??X.user?.id}),e.jsxs("span",{className:"pill ghost",children:["Device ",X.device?.id?.slice(0,8)]}),X.lastSyncAt&&e.jsxs("span",{className:"pill ghost",children:["Last sync ",new Date(X.lastSyncAt).toLocaleString()]})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Device name",e.jsx("input",{type:"text",value:H,onChange:d=>Se(d.target.value),placeholder:"My MacBook"})]}),e.jsxs("label",{children:["Handle",e.jsx("input",{type:"text",value:ie,onChange:d=>O(d.target.value),placeholder:"your_handle"})]}),e.jsxs("label",{children:["Accent color",e.jsx("input",{type:"color",value:Q,onChange:d=>le(d.target.value)})]})]}),e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"primary",onClick:async()=>{oe(!0),p(null);try{await s.sync.setDeviceName(H),await s.friends.updateProfile({handle:ie.trim()||void 0,color:Q}),await s.sync.syncNow(),await De()}catch(d){p(d.message||"Failed to sync now")}finally{oe(!1)}},disabled:te,children:"Sync now"}),e.jsx("button",{type:"button",className:"secondary",onClick:async()=>{oe(!0),await s.sync.signOut(),await De(),oe(!1)},disabled:te,children:"Sign out"})]}),A.length>0&&e.jsx("div",{className:"devices-list",children:A.map(d=>e.jsxs("div",{className:`device-row ${d.isCurrent?"current":""}`,children:[e.jsxs("div",{children:[e.jsx("strong",{children:d.name}),e.jsx("span",{className:"subtle",children:d.platform})]}),e.jsx("span",{className:"subtle",children:d.lastSeenAt?`Seen ${new Date(d.lastSeenAt).toLocaleString()}`:"Pending"})]},d.id))})]})]})}),N==="activity"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Activity detection"}),e.jsx("p",{className:"subtle",children:"Tune idle detection."})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Idle threshold (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:F,onChange:d=>g(Number(d.target.value))})]}),e.jsxs("label",{children:["Frivolous idle (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:E,onChange:d=>h(Number(d.target.value))})]}),e.jsxs("label",{children:["Continuity window (seconds)",e.jsx("input",{type:"number",min:"0",max:"900",value:G,onChange:d=>Y(Number(d.target.value))})]})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{children:["Daily productivity goal (hours)",e.jsx("input",{type:"number",min:"0.5",max:"12",step:"0.1",value:q,onChange:d=>U(Number(d.target.value))})]})}),e.jsxs("label",{children:["Keywords to exclude",e.jsx("textarea",{rows:3,value:S,onChange:d=>I(d.target.value),placeholder:"One keyword per line"})]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Lower values mark passive browsing as idle sooner."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Excluded keywords stay neutral and are hidden from stream trackers."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Continuity keeps short research hops in the same productive run."}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Daily productivity goal powers the dashboard ring."})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:l,children:l?"Savingâ€¦":m?"Saved!":"Save changes"})})]}),N==="paywall"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Paywall controls"}),e.jsx("p",{className:"subtle",children:"Emergency + peek behavior."})]}),e.jsxs("div",{className:"settings-row",children:[e.jsxs("label",{children:["Emergency policy",e.jsxs("select",{value:k,onChange:d=>R(d.target.value),children:[e.jsx("option",{value:"off",children:"Off"}),e.jsx("option",{value:"gentle",children:"Gentle"}),e.jsx("option",{value:"balanced",children:"Balanced"}),e.jsx("option",{value:"strict",children:"Strict"})]})]}),e.jsxs("label",{children:["Reminder interval (seconds)",e.jsx("input",{type:"number",min:"30",max:"3600",value:y,onChange:d=>D(Number(d.target.value))})]})]}),e.jsxs("details",{className:"settings-details",children:[e.jsx("summary",{children:"Policy details"}),e.jsxs("div",{className:"subtle",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Off"}),": no emergency access."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Gentle"}),": 5m, URL-locked, unlimited/day."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Balanced"}),": 3m, 2/day, 30m cooldown."]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Strict"}),": 2m, 1/day, 60m cooldown."]})]})]}),e.jsxs("div",{className:"settings-inline",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r,onChange:d=>b(d.target.checked)}),e.jsx("span",{className:"subtle",children:"Enable peek"})]}),e.jsxs("label",{style:{opacity:r?1:.6},children:[e.jsx("input",{type:"checkbox",checked:C,onChange:d=>L(d.target.checked),disabled:!r}),e.jsx("span",{className:"subtle",children:"Allow peek on new pages"})]})]})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Guardrails: color filters"}),e.jsx("p",{className:"subtle",children:"Make frivolity visually and economically cheaper when filtered."})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{children:["Frivolity color filter",e.jsxs("select",{value:J,onChange:d=>ce(d.target.value),children:[e.jsx("option",{value:"full-color",children:"Full color (standard cost)"}),e.jsx("option",{value:"greyscale",children:"Greyscale (cheaper)"}),e.jsx("option",{value:"redscale",children:"Redscale (cheaper)"})]})]})}),e.jsx("div",{className:"settings-inline",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:de,onChange:d=>Ne(d.target.checked)}),e.jsx("span",{className:"subtle",children:"Always greyscale (global override)"})]})}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Pricing applies when starting new frivolity sessions."})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Camera mode"}),e.jsx("p",{className:"subtle",children:"Captures a still every minute during frivolity. Stored locally on this Mac. macOS will prompt for camera access when enabling."})]}),e.jsxs("div",{className:"settings-inline",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:ue,onChange:d=>{Ee(d.target.checked)}}),e.jsx("span",{className:"subtle",children:"Enable camera mode"})]}),e.jsx("button",{type:"button",className:"ghost",onClick:xe,disabled:ne,children:ne?"Refreshingâ€¦":"Refresh gallery"}),e.jsxs("span",{className:"subtle",children:[pe.length," photos"]})]}),o&&e.jsx("p",{className:"error-text",children:o}),pe.length===0?e.jsx("p",{className:"subtle",style:{marginTop:12},children:"No photos yet."}):e.jsx("div",{className:"camera-gallery-grid",children:pe.map(d=>e.jsxs("div",{className:"camera-card",children:[e.jsx("img",{className:"camera-photo",src:d.fileUrl,alt:"Camera capture",loading:"lazy"}),e.jsxs("div",{className:"camera-meta",children:[e.jsx("strong",{children:d.subject??"Frivolity"}),e.jsx("span",{className:"subtle",children:new Date(d.capturedAt).toLocaleString()})]}),e.jsxs("div",{className:"camera-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>_e(d.id),children:"Reveal"}),e.jsx("button",{type:"button",className:"danger",onClick:()=>Ue(d.id),children:"Delete"})]})]},d.id))})]}),e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Journaling"}),e.jsx("p",{className:"subtle",children:"Quick launch for reset prompts."})]}),e.jsxs("label",{children:["Journal URL",e.jsx("input",{type:"text",placeholder:"https://app.tana.inc/â€¦",value:i,onChange:d=>x(d.target.value)})]}),e.jsxs("label",{style:{maxWidth:260},children:["Duration (minutes)",e.jsx("input",{type:"number",min:"1",max:"180",value:T,onChange:d=>M(Number(d.target.value))})]})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:l,children:l?"Savingâ€¦":m?"Saved!":"Save changes"})})]}),N==="integrations"&&e.jsxs("form",{className:"settings-pane-form",onSubmit:He,children:[e.jsxs("div",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Integrations"}),e.jsx("p",{className:"subtle",children:"Curate â€œTry this insteadâ€."})]}),e.jsxs("label",{children:["Zotero source",e.jsxs("select",{value:fe.mode,onChange:d=>{const re=d.target.value;be(Me=>({...Me,mode:re==="collection"?"collection":"recent"}))},children:[e.jsx("option",{value:"recent",children:"Recent items"}),e.jsx("option",{value:"collection",children:"Specific collection"})]})]}),fe.mode==="collection"&&e.jsxs("div",{className:"settings-stack",children:[e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Le,disabled:P,children:P?"Loadingâ€¦":"Refresh collections"}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"checkbox",checked:fe.includeSubcollections,onChange:d=>be(re=>({...re,includeSubcollections:d.target.checked}))}),e.jsx("span",{className:"subtle",children:"Include subcollections"})]})]}),e.jsxs("select",{value:fe.collectionId??"",onChange:d=>{const re=d.target.value,Me=re?Number(re):null;be(ss=>({...ss,collectionId:Me&&Number.isFinite(Me)?Me:null}))},children:[e.jsx("option",{value:"",children:"Select a collectionâ€¦"}),je.map(d=>e.jsx("option",{value:d.id,children:d.path},d.id))]}),e.jsx("p",{className:"subtle",style:{margin:0},children:Re?`Selected: ${Re.path}`:"No collection selected."})]})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:l,children:l?"Savingâ€¦":m?"Saved!":"Save changes"})})]}),N==="domains"&&e.jsx(Bt,{api:s,variant:"settings"}),N==="economy"&&e.jsx(Wt,{api:s}),N==="system"&&e.jsxs("div",{className:"settings-pane-body",children:[e.jsxs("section",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Theme"}),e.jsx("p",{className:"subtle",children:"Choose your vibe."})]}),e.jsxs("div",{className:"settings-stack",children:[e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"theme",value:"lavender",checked:a==="lavender",onChange:()=>n("lavender")}),e.jsx("span",{children:"Lavender (default)"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"theme",value:"olive",checked:a==="olive",onChange:()=>n("olive")}),e.jsx("span",{children:"Olive Garden Feast"})]})]})]}),W&&e.jsx("div",{className:`settings-banner ${ee==="all"?"danger":"success"}`,children:e.jsxs("div",{children:[e.jsx("strong",{children:W}),e.jsx("div",{className:"subtle",children:"You may need to refresh to see empty states."})]})}),e.jsxs("section",{className:"card settings-section",children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Reset data"}),e.jsx("p",{className:"subtle",children:"Start fresh. Choose what to clear."})]}),e.jsxs("div",{className:"settings-stack",children:[e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"trophies",checked:ee==="trophies",onChange:()=>V("trophies")}),e.jsx("span",{className:"subtle",children:"Reset trophy case only"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"wallet",checked:ee==="wallet",onChange:()=>V("wallet")}),e.jsx("span",{className:"subtle",children:"Reset bank only (wallet balance and transactions)"})]}),e.jsxs("label",{className:"settings-inline",children:[e.jsx("input",{type:"radio",name:"reset-scope",value:"all",checked:ee==="all",onChange:()=>V("all")}),e.jsx("span",{className:"subtle",children:"Reset everything (wallet, history, trophies, library)"})]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"This also removes the selected data from cloud sync if you are signed in."}),e.jsx("button",{type:"button",className:"secondary",onClick:We,disabled:he,children:he?"Resettingâ€¦":"Reset now"})]})]}),e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Accessibility permissions"}),e.jsxs("ol",{className:"instructions",children:[e.jsx("li",{children:"Open System Settings â†’ Privacy & Security â†’ Accessibility."}),e.jsx("li",{children:"Click the lock to make changes and authenticate."}),e.jsx("li",{children:"Find â€œTimeWellSpentâ€ in the list and toggle it on."}),e.jsx("li",{children:"Repeat under â€œAutomationâ€ to allow browser control."})]}),e.jsxs("p",{className:"subtle",children:["You can paste ",e.jsx("code",{children:"x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"})," into Spotlight to jump there quickly."]})]})]})]})]})]})}function zt({api:s}){const[a,n]=t.useState("7d"),[l,j]=t.useState(null),[m,u]=t.useState([]),[w,p]=t.useState([]),[N,f]=t.useState([]),[F,g]=t.useState(!0),[E,h]=t.useState([]),k=t.useMemo(()=>{switch(a){case"24h":return 1;case"7d":return 7;case"30d":return 30}},[a]),R=t.useCallback(async()=>{g(!0);const[r,b,C,L]=await Promise.all([s.analytics.overview(k),s.analytics.timeOfDay(k),s.analytics.patterns(k),s.analytics.trends(k<=1?"hour":"day")]);j(r),u(b),p(C),f(L),g(!1)},[s,k]);t.useEffect(()=>{R()},[R]),t.useEffect(()=>{s.settings.excludedKeywords().then(h).catch(()=>{})},[s]);const y=r=>{const b=r>=12?"PM":"AM";return`${r%12||12}${b}`},D=t.useMemo(()=>Math.max(...m.map(r=>r.productive+r.neutral+r.frivolity+r.draining+r.idle),1),[m]),i=t.useMemo(()=>w.filter(r=>r.toContext.category==="frivolity").slice(0,6),[w]),x=t.useCallback(r=>{if(!E.length)return!1;const b=r.toLowerCase();return E.some(C=>C&&b.includes(C))},[E]),T=t.useCallback(r=>r?x(r)?"Hidden":r:null,[x]),M=t.useCallback(r=>{if(!E.length)return r;let b=r;for(const C of E){if(!C)continue;const L=C.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");b=b.replace(new RegExp(L,"gi"),"[hidden]")}return b},[E]);return e.jsxs("section",{className:"panel analytics-panel",children:[e.jsxs("header",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Behavioral intelligence"}),e.jsx("h1",{children:"Analytics"})]}),e.jsxs("div",{className:"time-range-selector",children:[e.jsx("button",{className:a==="24h"?"active":"",onClick:()=>n("24h"),children:"24h"}),e.jsx("button",{className:a==="7d"?"active":"",onClick:()=>n("7d"),children:"7d"}),e.jsx("button",{className:a==="30d"?"active":"",onClick:()=>n("30d"),children:"30d"})]})]}),F?e.jsxs("div",{className:"panel-body analytics-loading",children:[e.jsx("div",{className:"loader-spinner"}),e.jsx("p",{children:"Analyzing behavioral data..."})]}):e.jsxs("div",{className:"panel-body analytics-grid",children:[e.jsxs("div",{className:"analytics-overview",children:[e.jsxs("div",{className:"overview-card primary",children:[e.jsxs("div",{className:"overview-value",children:[l?.productivityScore??0,"%"]}),e.jsx("div",{className:"overview-label",children:"Productivity Score"}),e.jsxs("div",{className:`overview-trend trend-${l?.focusTrend??"stable"}`,children:[l?.focusTrend==="improving"&&"â†‘ Improving",l?.focusTrend==="declining"&&"â†“ Declining",l?.focusTrend==="stable"&&"â†’ Stable"]})]}),e.jsxs("div",{className:"overview-card glow",children:[e.jsxs("div",{className:"overview-value",children:[l?Math.round(l.deepWorkSeconds/3600*10)/10:0,"h"]}),e.jsx("div",{className:"overview-label",children:"Deep Work"})]}),e.jsxs("div",{className:"overview-card",children:[e.jsxs("div",{className:"overview-value",children:[l?.totalActiveHours??0,"h"]}),e.jsx("div",{className:"overview-label",children:"Active Time"})]}),e.jsxs("div",{className:"overview-card",children:[e.jsx("div",{className:"overview-value",children:l?.totalSessions??0}),e.jsx("div",{className:"overview-label",children:"Sessions"})]}),e.jsxs("div",{className:"overview-card accent",children:[e.jsx("div",{className:"overview-value",children:y(l?.peakProductiveHour??9)}),e.jsx("div",{className:"overview-label",children:"Peak Focus Hour"})]}),e.jsxs("div",{className:"overview-card danger",children:[e.jsx("div",{className:"overview-value",children:y(l?.riskHour??15)}),e.jsx("div",{className:"overview-label",children:"Risk Hour"})]})]}),e.jsxs("div",{className:"card insights-card",children:[e.jsx("h2",{children:"ðŸ§  AI Insights"}),e.jsxs("ul",{className:"insights-list",children:[(l?.insights??[]).map((r,b)=>e.jsx("li",{children:M(r)},b)),(l?.insights??[]).length===0&&e.jsx("li",{className:"subtle",children:"Keep using the app to generate insights..."})]})]}),e.jsxs("div",{className:"card heatmap-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Time of Day Activity"}),e.jsx("span",{className:"subtle",children:"24-hour pattern"})]}),e.jsx("div",{className:"time-heatmap",children:m.map(r=>{const b=r.productive+r.neutral+r.frivolity+r.draining+r.idle,C=b>0?Math.max(8,Math.round(b/D*100)):4,L=b>0?r.productive/b*100:0,G=b>0?r.neutral/b*100:0,Y=b>0?r.frivolity/b*100:0,S=b>0?r.draining/b*100:0,I=r.dominantCategory;return e.jsxs("div",{className:`heatmap-col ${I}`,title:`${y(r.hour)}: ${Math.round(b/60)}m total`,children:[e.jsxs("div",{className:"heatmap-bar",style:{height:`${C}%`},children:[e.jsx("span",{className:"bar-segment productive",style:{height:`${L}%`}}),e.jsx("span",{className:"bar-segment neutral",style:{height:`${G}%`}}),e.jsx("span",{className:"bar-segment frivolity",style:{height:`${Y}%`}}),e.jsx("span",{className:"bar-segment draining",style:{height:`${S}%`}})]}),e.jsx("span",{className:"heatmap-label",children:ft(r.hour,us)%6===0?y(r.hour):""})]},r.hour)})}),e.jsxs("div",{className:"heatmap-legend",children:[e.jsxs("span",{children:[e.jsx("span",{className:"dot productive"})," Productive"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot neutral"})," Neutral"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot frivolity"})," Frivolity"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot draining"})," Draining"]}),e.jsxs("span",{children:[e.jsx("span",{className:"dot deepwork"})," Deep work"]})]})]}),e.jsxs("div",{className:"card breakdown-card",children:[e.jsx("h2",{children:"Category Breakdown"}),e.jsx("div",{className:"breakdown-bars",children:l&&["productive","deepWork","neutral","frivolity","draining","idle"].map(r=>{const b=Object.values(l.categoryBreakdown).reduce((Y,S)=>Y+S,0),C=r==="deepWork"?l.deepWorkSeconds:l.categoryBreakdown[r]??0,L=b>0?Math.round(C/b*100):0,G=Math.round(C/3600*10)/10;return e.jsxs("div",{className:"breakdown-row",children:[e.jsx("span",{className:"breakdown-label",children:r==="deepWork"?"deep work":r}),e.jsx("div",{className:"breakdown-bar-track",children:e.jsx("div",{className:`breakdown-bar-fill ${r}`,style:{width:`${L}%`}})}),e.jsxs("span",{className:"breakdown-value",children:[G,"h"]}),e.jsxs("span",{className:"breakdown-percent",children:[L,"%"]})]},r)})})]}),e.jsxs("div",{className:"card trends-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Activity Trends"}),e.jsx("span",{className:"subtle",children:"Quality over time"})]}),e.jsx("div",{className:"trends-chart",children:N.map((r,b)=>{const C=r.draining??0,L=r.productive+r.neutral+r.frivolity+C,G=Math.max(...N.map(_=>_.productive+_.neutral+_.frivolity+(_.draining??0)),1),Y=Math.max(4,Math.round(L/G*100)),S=L>0?r.deepWork/L*100:0,I=L>0?C/L*100:0,q=L>0?r.frivolity/L*100:0,U=L>0?r.neutral/L*100:0,X=I,K=I+q,A=I+q+U;return e.jsxs("div",{className:"trend-bar",title:`${r.label}: ${Math.round(L/60)}m active, ${r.qualityScore}% quality`,children:[e.jsx("div",{className:"trend-bar-fill",style:{height:`${Y}%`,background:`linear-gradient(to top, 
                          var(--cat-draining) ${X||0}%, 
                          var(--cat-frivolity) ${K||0}%, 
                          var(--cat-neutral) ${A||50}%, 
                          var(--cat-productive) 100%)`},children:S>0&&e.jsx("span",{className:"trend-deepwork-overlay",style:{height:`${S}%`}})}),e.jsx("span",{className:"trend-label",children:r.label})]},b)})})]}),e.jsxs("div",{className:"card patterns-card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"ðŸ”€ What Leads to Frivolity"}),e.jsx("span",{className:"subtle",children:"Transition patterns"})]}),e.jsxs("ul",{className:"patterns-list",children:[i.map((r,b)=>e.jsxs("li",{className:"pattern-row",children:[e.jsxs("div",{className:"pattern-from",children:[e.jsx("span",{className:`category-chip category-${r.fromContext.category??"neutral"}`,children:r.fromContext.category??"neutral"}),e.jsx("span",{className:"pattern-domain",children:T(r.fromContext.domain)??"Any"})]}),e.jsx("span",{className:"pattern-arrow",children:"â†’"}),e.jsxs("div",{className:"pattern-to",children:[e.jsx("span",{className:"category-chip category-frivolity",children:"frivolity"}),e.jsx("span",{className:"pattern-domain",children:T(r.toContext.domain)??"Any"})]}),e.jsxs("div",{className:"pattern-stats",children:[e.jsxs("span",{className:"pattern-frequency",children:[r.frequency,"Ã—"]}),e.jsxs("span",{className:"pattern-time",children:[Math.round(r.avgTimeBefore/60),"m avg"]})]})]},b)),i.length===0&&e.jsx("li",{className:"subtle",children:"No significant patterns detected yet"})]})]}),l?.topEngagementDomain&&e.jsxs("div",{className:"card top-domain-card",children:[e.jsx("h2",{children:"ðŸŽ¯ Top Engagement"}),e.jsx("div",{className:"top-domain-name",children:T(l.topEngagementDomain)}),e.jsx("p",{className:"subtle",children:"Most time spent domain this period"})]})]})]})}const hs=[[8,0,0,0,0,0,0,0,0],[0,0,3,6,0,0,0,0,0],[0,7,0,0,9,0,2,0,0],[0,5,0,0,0,7,0,0,0],[0,0,0,0,4,5,7,0,0],[0,0,0,1,0,0,0,3,0],[0,0,1,0,0,0,0,6,8],[0,0,8,5,0,0,0,1,0],[0,9,0,0,0,0,4,0,0]],qs=[[8,1,2,7,5,3,6,4,9],[9,4,3,6,8,2,1,7,5],[6,7,5,4,9,1,2,8,3],[1,5,4,2,3,7,8,9,6],[3,6,9,8,4,5,7,2,1],[2,8,7,1,6,9,5,3,4],[5,2,1,9,7,4,3,6,8],[4,3,8,5,2,6,9,1,7],[7,9,6,3,1,8,4,5,2]],Vs=hs.flatMap((s,a)=>s.flatMap((n,l)=>n===0?[{row:a,col:l}]:[]));function js(){return hs.map(s=>s.map(a=>a===0?"":String(a)))}function it({title:s,subtitle:a,requiredCorrect:n=12,unlockLabel:l="Unlock",onUnlock:j,disabled:m=!1,puzzleKey:u}){const[w,p]=t.useState(()=>js()),[N,f]=t.useState(()=>Date.now()),[F,g]=t.useState(!1),[E,h]=t.useState(null),k=t.useMemo(()=>Math.max(1,Math.min(Vs.length,Math.round(n))),[n]),R=t.useMemo(()=>Vs.reduce((M,r)=>{const b=w[r.row]?.[r.col];return b&&Number(b)===qs[r.row][r.col]?M+1:M},0),[w]),y=R>=k,D=Math.min(100,R/k*100);t.useEffect(()=>{p(js()),f(Date.now()),h(null),g(!1)},[u]);const i=(M,r,b)=>{if(hs[M][r]!==0||m)return;const C=b.replace(/[^1-9]/g,"").slice(-1);p(L=>{const G=L.map(Y=>[...Y]);return G[M][r]=C,G})},x=()=>{p(js()),f(Date.now()),h(null)},T=async()=>{if(!(!j||!y||F||m)){g(!0),h(null);try{await j({correctSquares:R,requiredSquares:k,elapsedSeconds:Math.max(1,Math.round((Date.now()-N)/1e3))})}catch(M){h(M.message)}finally{g(!1)}}};return e.jsxs("section",{className:"sudoku-challenge",children:[e.jsxs("div",{className:"sudoku-header",children:[e.jsx("strong",{children:s}),a&&e.jsx("p",{className:"subtle",children:a})]}),e.jsxs("div",{className:"sudoku-progress-row",children:[e.jsxs("span",{children:["Correct squares: ",R,"/",k]}),e.jsxs("span",{children:[D.toFixed(0),"%"]})]}),e.jsx("div",{className:"sudoku-progress-track","aria-hidden":!0,children:e.jsx("span",{style:{width:`${D}%`}})}),e.jsx("div",{className:"sudoku-grid",role:"group","aria-label":"Sudoku puzzle",children:hs.map((M,r)=>M.map((b,C)=>{const L=b!==0,G=L?String(b):w[r][C],Y=G.length>0,S=!L&&Y&&Number(G)===qs[r][C],q=["sudoku-cell",L?"is-fixed":"",S?"is-correct":"",!L&&Y&&!S?"is-incorrect":""].filter(Boolean).join(" ");return e.jsx("input",{className:q,type:"text",inputMode:"numeric",pattern:"[1-9]",maxLength:1,value:G,disabled:L||m||F,onChange:U=>i(r,C,U.target.value),style:{borderTopWidth:r%3===0?2:1,borderLeftWidth:C%3===0?2:1,borderRightWidth:C===8?2:1,borderBottomWidth:r===8?2:1},"aria-label":`Row ${r+1} column ${C+1}`},`${r}-${C}`)}))}),e.jsxs("div",{className:"sudoku-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:x,disabled:F,children:"Reset puzzle"}),j?e.jsx("button",{type:"button",className:"primary",onClick:T,disabled:!y||F||m,children:F?"Unlocking...":l}):e.jsx("span",{className:"subtle",children:y?"Challenge complete.":"Practice mode"})]}),E&&e.jsx("p",{className:"warning subtle",children:E})]})}const _t=(s,a,n)=>Math.min(Math.max(s,a),n),Zs=12,vs=12;function Gt({open:s,state:a,wallet:n,api:l,marketRates:j,onWallet:m,onClose:u}){const[w,p]=t.useState(!1),[N,f]=t.useState(null),[F,g]=t.useState(15),E=t.useMemo(()=>{if(a)return j.find(A=>A.domain===a.domain)},[j,a?.domain]),h=t.useMemo(()=>{const A=E?.packs.map(ie=>ie.minutes)??[],_=A.length?Math.min(...A):10,H=A.length?Math.max(...A):30,Se=Math.max(H,_+15,45);return{min:Math.max(5,_),max:Se,step:5}},[E]);if(t.useEffect(()=>{if(!s||!a)return;const A=E?.packs?.[0]?.minutes??h.min;g(_t(A,h.min,h.max))},[s,E,h.max,h.min,a?.domain]),t.useEffect(()=>{s&&f(null)},[s,a?.domain]),!s||!a)return null;async function k(){if(a){p(!0),f(null);try{await l.paywall.startMetered(a.domain);const A=await l.wallet.get();m(A),u()}catch(A){console.error(A),f(A.message)}finally{p(!1)}}}async function R(A){if(a){p(!0),f(null);try{await l.paywall.buyPack(a.domain,A);const _=await l.wallet.get();m(_),u()}catch(_){console.error(_),f(_.message)}finally{p(!1)}}}async function y(A){if(a){p(!0),f(null);try{await l.paywall.startChallengePass(a.domain,{durationSeconds:vs*60,solvedSquares:A});const _=await l.wallet.get();m(_),u()}catch(_){console.error(_),f(_.message)}finally{p(!1)}}}const D=a.reason==="blocked",i=a.reason==="insufficient-funds",x=E?.ratePerMin??a.ratePerMin??0,T=E?.packs.find(A=>A.minutes===F),M=T?T.price:Math.max(1,Math.round(F*x)),r=n.balance>0?Math.min(1,M/n.balance):1,b=Math.max(0,n.balance-M),C=72,L=2*Math.PI*C,G=L*(1-r),Y=n.balance>=M,S=Math.round((h.min+h.max)/2),I=n.balance>0?Math.min(1,x*15/n.balance):1,q=Math.min(1,F/(24*60)),U=r*100,X=Math.round(q*100),K=[{label:"Quick peek",minutes:Math.max(5,Math.round(F*.4))},{label:"This choice",minutes:F},{label:"Deep dive",minutes:Math.min(120,Math.round(F*1.6))}].map(A=>({...A,cost:Math.max(1,Math.round(A.minutes*x))}));return e.jsx("div",{className:"paywall-overlay",children:e.jsxs("div",{className:"paywall-modal",children:[e.jsxs("header",{className:"paywall-modal-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:a.domain}),e.jsx("p",{className:"subtle",children:D?"Access blocked â€” unlock by spending f-coins.":"Spend f-coins to access this site."})]}),e.jsx("button",{className:"close-button",onClick:u,"aria-label":"Close paywall",children:"âœ•"})]}),e.jsxs("div",{className:"wallet-inline",children:[e.jsx("span",{children:"Balance"}),e.jsxs("strong",{children:[n.balance," f-coins"]})]}),D&&!N&&e.jsx("p",{className:"warning",children:"Start a metered session or buy a time pack to access this site."}),i&&!N&&e.jsx("p",{className:"warning",children:"Session paused â€” add more coins or choose a smaller pack."}),e.jsxs("section",{className:"spend-lab",children:[e.jsxs("div",{className:"budget-visual",children:[e.jsxs("div",{className:"budget-circle",role:"img","aria-label":`Spending ${M} coins for ${F} minutes`,children:[e.jsxs("svg",{viewBox:"0 0 200 200",width:"200",height:"200",children:[e.jsx("circle",{className:"budget-track",cx:"100",cy:"100",r:C,strokeWidth:"14"}),e.jsx("circle",{className:"budget-fill",cx:"100",cy:"100",r:C,strokeWidth:"14",strokeDasharray:L,strokeDashoffset:G})]}),e.jsxs("div",{className:"budget-figures",children:[e.jsxs("strong",{children:[M," f-coins"]}),e.jsxs("span",{children:[F," minute session"]}),e.jsxs("small",{className:"subtle",children:[U.toFixed(0),"% of balance"]})]})]}),e.jsxs("div",{className:"impact-bars",children:[e.jsxs("div",{children:[e.jsx("div",{className:"impact-label",children:"Wallet impact"}),e.jsx("div",{className:"impact-meter",children:e.jsx("span",{style:{width:`${U}%`}})}),e.jsxs("small",{className:"subtle",children:["Leaves ",b," f-coins"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"impact-label",children:"Day share"}),e.jsx("div",{className:"impact-meter day",children:e.jsx("span",{style:{width:`${X}%`}})}),e.jsxs("small",{className:"subtle",children:[X,"% of your day if you stay that long"]})]})]})]}),e.jsxs("div",{className:"budget-controls",children:[e.jsx("div",{className:"eyebrow",children:"Session length"}),e.jsx("p",{className:"subtle",children:"Choose how long you want to access this site."}),e.jsx("input",{id:"focus-budget",type:"range",min:h.min,max:h.max,step:h.step,value:F,onChange:A=>g(Number(A.target.value))}),e.jsxs("div",{className:"budget-scale",children:[e.jsxs("span",{children:[h.min," min"]}),e.jsxs("span",{children:[S," min"]}),e.jsxs("span",{children:[h.max,"+ min"]})]}),e.jsx("div",{className:"projection-grid",children:K.map(A=>e.jsxs("div",{className:"projection-card",children:[e.jsxs("div",{className:"projection-minutes",children:[A.minutes,"m"]}),e.jsx("div",{className:"projection-label",children:A.label}),e.jsxs("div",{className:"projection-cost",children:[A.cost," coins"]}),e.jsx("div",{className:"projection-bar",children:e.jsx("span",{style:{width:`${Math.min(100,A.cost/Math.max(n.balance,A.cost)*100)}%`}})})]},A.label))}),e.jsxs("button",{className:"primary",disabled:w||!Y,onClick:()=>R(F),children:["Unlock for ",M," f-coins"]}),!Y&&e.jsxs("p",{className:"warning subtle",children:["Need ",M-n.balance," more f-coins."]})]})]}),e.jsxs("section",{className:"paywall-section",children:[e.jsx("div",{className:"eyebrow",children:"Other unlocks"}),e.jsxs("div",{className:"option-grid",children:[e.jsxs("button",{className:"option-card",disabled:w,onClick:k,children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Pay as you go"}),e.jsx("p",{className:"subtle",children:"Only pay while the tab is active."})]}),e.jsx("div",{className:"option-meter",children:e.jsx("span",{style:{width:`${I*100}%`}})}),e.jsxs("small",{className:"chip",children:[x," f-coins/min"]})]}),E?.packs.map(A=>{const _=n.balance>0?Math.min(1,A.price/n.balance):1;return e.jsxs("button",{className:"option-card",disabled:w||n.balance<A.price,onClick:()=>R(A.minutes),children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[A.minutes," minute session"]}),e.jsx("p",{className:"subtle",children:"Fixed time â€” pause anytime."})]}),e.jsx("div",{className:"option-meter",children:e.jsx("span",{style:{width:`${_*100}%`}})}),e.jsxs("small",{className:"chip",children:[A.price," f-coins"]})]},A.minutes)})]})]}),e.jsxs("section",{className:"paywall-section challenge-section",children:[e.jsx("div",{className:"eyebrow",children:"Free unlock (game gate)"}),e.jsx(it,{puzzleKey:a.domain,title:"Hard Sudoku checkpoint",subtitle:`Solve ${Zs} correct squares to earn a ${vs}-minute free pass.`,requiredCorrect:Zs,unlockLabel:`Claim ${vs}-minute free pass`,onUnlock:({correctSquares:A})=>y(A),disabled:w})]}),typeof a.remainingSeconds=="number"&&a.remainingSeconds>0&&e.jsxs("p",{className:"subtle",children:["Remaining: ",Math.round(a.remainingSeconds/60)," min"]})]})})}const qe=[{value:"replace",label:"Replace",hint:"Shown in â€œTry this insteadâ€ when you hit a paywall."},{value:"productive",label:"Productive",hint:"Counts as productive time and appears in your productive shelf."},{value:"allow",label:"Allow",hint:"Good stuff you want nearby. Optional one-time unlock pricing."},{value:"temptation",label:"Temptation",hint:"Things you enjoy, but want contained and intentional."}];function Kt(s){return qe.find(a=>a.value===s)?.label??s}function Yt(s){return s==="replace"||s==="productive"?"productive":s==="temptation"?"frivolity":"neutral"}function qt(s){let a=s.trim();if(!a)return null;!a.startsWith("http://")&&!a.startsWith("https://")&&(a=`https://${a}`);try{return new URL(a),a}catch{return null}}function Xs(s){const a=Number(s);return!Number.isFinite(a)||!Number.isInteger(a)||a<1?null:a}function ys(s){return new Date(s).toLocaleDateString()}function Vt(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Zt(s){return new Date(`${s}T00:00:00`).toLocaleDateString([],{month:"short",day:"numeric"})}function Xt(s){const a=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0");return`${a}-${n}-${l}`}function Jt(s){return s&&s.charAt(0).toUpperCase()+s.slice(1)}function Qt(s){let a=0;for(let n=0;n<s.length;n+=1)a=(a<<5)-a+s.charCodeAt(n),a|=0;return Math.abs(a)}function Ns(s){try{return new URL(s).hostname.replace(/^www\./,"")}catch{return s}}function ea(s){const a=Ns(s);return`https://www.google.com/s2/favicons?domain=${encodeURIComponent(a)}&sz=64`}function sa(s){return`https://image.thum.io/get/width/640/${encodeURIComponent(s)}`}function ta({api:s}){const[a,n]=t.useState([]),[l,j]=t.useState(!0),[m,u]=t.useState("replace"),[w,p]=t.useState(!1),[N,f]=t.useState("library"),[F,g]=t.useState(()=>Xt(new Date)),[E,h]=t.useState([]),[k,R]=t.useState([]),[y,D]=t.useState(!1),[i,x]=t.useState(null),[T,M]=t.useState(!1),[r,b]=t.useState(""),[C,L]=t.useState("replace"),[G,Y]=t.useState(!1),[S,I]=t.useState(12),[q,U]=t.useState(""),[X,K]=t.useState(""),[A,_]=t.useState(!1),[H,Se]=t.useState(null),[ie,O]=t.useState(null),[Q,le]=t.useState("replace"),[te,oe]=t.useState(!1),[fe,be]=t.useState(12),[je,ke]=t.useState(""),[P,B]=t.useState(""),[ee,V]=t.useState(!1),[he,ve]=t.useState(null),[W,me]=t.useState(!1),ue=t.useCallback(async()=>{try{const o=await s.library.list();n(o),ie&&!o.some(z=>z.id===ie)&&O(null)}catch(o){console.error("Failed to load library items:",o)}finally{j(!1)}},[s.library,ie]),v=t.useCallback(async o=>{D(!0),x(null);try{const[z,xe]=await Promise.all([s.history.list(o),s.history.days(30)]);h(z),R(xe)}catch(z){console.error("Failed to load consumption history:",z),x(z.message||"Failed to load history")}finally{D(!1)}},[s.history]);t.useEffect(()=>{ue()},[ue]),t.useEffect(()=>{N==="history"&&v(F)},[F,v,N]),t.useEffect(()=>{const o=s.events.on("library:changed",()=>ue());return()=>o()},[s,ue]),t.useEffect(()=>{N==="history"&&M(!1)},[N]);const J=t.useMemo(()=>{let o=m==="all"?a:a.filter(z=>z.purpose===m);return w&&(o=o.filter(z=>typeof z.price=="number")),o},[m,a,w]),ce=()=>{b(""),L("replace"),Y(!1),I(12),U(""),K(""),_(!1),Se(null)},de=async o=>{o.preventDefault(),Se(null);const z=qt(r);if(!z)return Se("Enter a valid URL (e.g. https://example.com).");let xe=null;if(C==="allow"&&G){const Ce=Xs(S);if(!Ce)return Se("Unlock price must be a whole number of at least 1.");xe=Ce}me(!0);try{await s.library.add({kind:"url",url:z,title:q.trim()||void 0,note:X.trim()||void 0,purpose:C,price:xe,isPublic:A}),M(!1),ce(),await ue()}catch(Ce){Se(Ce.message||"Failed to add item")}finally{me(!1)}},Ne=o=>{O(o.id),le(o.purpose),oe(typeof o.price=="number"),be(typeof o.price=="number"?o.price:12),ke(o.title??""),B(o.note??""),V(!!o.isPublic),ve(null)},pe=()=>{O(null),ve(null)},we=async o=>{if(o.preventDefault(),!ie)return;ve(null);let z=null;if(Q==="allow"&&te){const xe=Xs(fe);if(!xe)return ve("Unlock price must be a whole number of at least 1.");z=xe}me(!0);try{const xe=je.trim(),Ce=P.trim();await s.library.update(ie,{title:xe||null,note:Ce||null,purpose:Q,price:z,isPublic:ee}),O(null),await ue()}catch(xe){ve(xe.message||"Failed to update item")}finally{me(!1)}},ne=async o=>{if(confirm("Remove this item from your library?"))try{await s.library.remove(o),await ue()}catch(z){console.error("Failed to remove library item:",z)}},Pe=async o=>{me(!0);try{const z=o.consumedAt?null:new Date().toISOString();await s.library.update(o.id,{consumedAt:z}),await ue()}catch(z){console.error("Failed to update consumed status:",z)}finally{me(!1)}};return l?e.jsx("div",{className:"panel",children:"Loading library..."}):e.jsxs("section",{className:"page store-page",children:[e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Library"}),e.jsx("p",{className:"subtle",children:N==="history"?"Review what you consumed by day â€” productive items and frivolous sessions.":"A calm, curated pool of â€œwhat I meant to doâ€. Replace is what the paywall offers you first."}),e.jsxs("div",{className:"library-tabs",children:[e.jsx("button",{type:"button",className:`library-tab ${N==="library"?"active":""}`,onClick:()=>f("library"),children:"Library"}),e.jsx("button",{type:"button",className:`library-tab ${N==="history"?"active":""}`,onClick:()=>f("history"),children:"History"})]})]}),N==="library"&&e.jsx("button",{className:"primary",onClick:()=>M(!0),children:"+ Add Link"})]}),N==="library"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",gap:14},children:[e.jsxs("label",{children:["View",e.jsxs("select",{value:m,onChange:o=>u(o.target.value),disabled:W,children:[e.jsx("option",{value:"replace",children:"Replace"}),e.jsx("option",{value:"productive",children:"Productive"}),e.jsx("option",{value:"allow",children:"Allow"}),e.jsx("option",{value:"temptation",children:"Temptation"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center",marginTop:22},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:o=>p(o.target.checked),disabled:W}),e.jsx("span",{className:"subtle",children:"Priced only"})]})]}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:m==="all"?"All library items.":qe.find(o=>o.value===m)?.hint})]}),T&&e.jsxs("div",{className:"card add-item-form",children:[e.jsx("h3",{children:"Add to Library"}),e.jsxs("form",{onSubmit:de,children:[H&&e.jsx("p",{className:"error-text",children:H}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"URL"}),e.jsx("input",{type:"text",placeholder:"https://â€¦",value:r,onChange:o=>b(o.target.value),disabled:W})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Purpose"}),e.jsx("select",{value:C,onChange:o=>{const z=o.target.value;L(z),z!=="allow"&&Y(!1)},disabled:W,children:qe.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:qe.find(o=>o.value===C)?.hint})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:G,disabled:W||C!=="allow",onChange:o=>Y(o.target.checked)}),"One-time unlock price (optional)"]}),e.jsx("input",{type:"number",min:1,max:500,step:1,value:S,disabled:W||C!=="allow"||!G,onChange:o=>{const z=Number.parseInt(o.target.value,10);I(Number.isNaN(z)?1:z)}}),e.jsxs("p",{className:"subtle",style:{marginTop:8},children:["Pricing only applies to ",e.jsx("strong",{children:"Allow"})," items. It appears under â€œProceed anywayâ€ when you land on that exact URL."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Title (optional)"}),e.jsx("input",{type:"text",value:q,onChange:o=>U(o.target.value),disabled:W})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Note (optional)"}),e.jsx("textarea",{value:X,onChange:o=>K(o.target.value),disabled:W})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:A,disabled:W,onChange:o=>_(o.target.checked)}),"Share with friends (public)"]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Only friends will see this in their feeds."})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{M(!1),ce()},disabled:W,children:"Cancel"}),e.jsx("button",{type:"submit",className:"primary",disabled:W,children:"Add"})]})]})]}),J.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No items here yet."}),e.jsx("p",{className:"subtle",children:"Tip: right-click a page or link and â€œSave to TimeWellSpentâ€."})]}):e.jsx("div",{className:"library-grid",children:J.map(o=>{const z=o.title||o.domain||o.app||"Saved item",xe=o.note||(o.url?Ns(o.url):o.app||o.domain||""),Ce=o.url?Ns(o.url):"",Ee=o.url?ea(o.url):null,De=o.url?sa(o.url):null,Re=o.domain??o.app??z,He={"--cover-hue":`${Qt(Re)%360}`},We=z.trim().charAt(0).toUpperCase()||"T",_e=ie===o.id,Ue=o.consumedAt?"Unmark done":"Mark done";return e.jsxs("article",{className:`card library-card ${o.consumedAt?"is-done":""}`,children:[e.jsxs("div",{className:`library-thumb ${o.kind==="app"?"app":""}`,style:He,children:[De&&o.kind==="url"&&e.jsx("img",{src:De,alt:"",loading:"lazy",onError:ge=>{ge.currentTarget.style.display="none"}}),e.jsxs("div",{className:"library-thumb-fallback",children:[e.jsx("span",{children:We}),o.kind==="app"&&e.jsx("small",{children:"App"})]}),Ee?e.jsx("img",{className:"library-favicon",src:Ee,alt:"",loading:"lazy"}):e.jsx("div",{className:"library-favicon library-favicon-placeholder","aria-hidden":"true"}),o.consumedAt&&e.jsx("div",{className:"library-done-badge",title:"Completed",children:"âœ“"})]}),e.jsxs("div",{className:"library-body",children:[e.jsxs("div",{className:"library-title-row",children:[e.jsxs("div",{children:[e.jsx("h3",{children:z}),e.jsx("p",{className:"subtle",children:xe})]}),e.jsx("span",{className:`pill ${Yt(o.purpose)}`,children:Kt(o.purpose)})]}),e.jsxs("div",{className:"library-meta",children:[e.jsx("span",{children:Ce||o.app||"Saved item"}),typeof o.price=="number"&&e.jsxs("span",{children:[o.price," f-coins unlock"]}),o.isPublic&&e.jsx("span",{children:"Public to friends"}),o.kind==="app"&&e.jsx("span",{children:"Desktop app"})]}),e.jsxs("div",{className:"library-dates",children:[e.jsxs("span",{children:["Added ",ys(o.createdAt)]}),o.consumedAt?e.jsxs("span",{children:["Done ",ys(o.consumedAt)]}):o.lastUsedAt?e.jsxs("span",{children:["Last used ",ys(o.lastUsedAt)]}):e.jsx("span",{children:"Not used yet"})]}),e.jsxs("div",{className:"library-actions",children:[o.url?e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"icon-button",title:"Open link","aria-label":"Open link",children:e.jsx(Js,{})}):e.jsx("button",{className:"icon-button",type:"button",disabled:!0,title:"Open link","aria-label":"Open link",children:e.jsx(Js,{})}),e.jsx("button",{className:"icon-button",type:"button",onClick:()=>Pe(o),disabled:W,title:Ue,"aria-label":Ue,children:e.jsx(aa,{})}),_e?e.jsx("button",{className:"icon-button",onClick:pe,disabled:W,title:"Cancel edit","aria-label":"Cancel edit",children:"X"}):e.jsx("button",{className:"icon-button",onClick:()=>Ne(o),disabled:W,title:"Edit","aria-label":"Edit",children:e.jsx(na,{})}),e.jsx("button",{className:"icon-button danger",onClick:()=>ne(o.id),disabled:W,title:"Remove","aria-label":"Remove",children:e.jsx(ia,{})})]}),_e&&e.jsxs("form",{className:"library-edit",onSubmit:we,children:[he&&e.jsx("p",{className:"error-text",children:he}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Purpose"}),e.jsx("select",{value:Q,onChange:ge=>{const Be=ge.target.value;le(Be),Be!=="allow"&&oe(!1)},disabled:W,children:qe.map(ge=>e.jsx("option",{value:ge.value,children:ge.label},ge.value))}),e.jsx("p",{className:"subtle",style:{margin:0},children:qe.find(ge=>ge.value===Q)?.hint})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:te,disabled:W||Q!=="allow",onChange:ge=>oe(ge.target.checked)}),"One-time unlock price (optional)"]}),e.jsx("input",{type:"number",min:1,max:500,step:1,value:fe,disabled:W||Q!=="allow"||!te,onChange:ge=>{const Be=Number.parseInt(ge.target.value,10);be(Number.isNaN(Be)?1:Be)}})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Title"}),e.jsx("input",{type:"text",value:je,onChange:ge=>ke(ge.target.value),disabled:W})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsx("label",{children:"Note"}),e.jsx("textarea",{value:P,onChange:ge=>B(ge.target.value),disabled:W})]}),e.jsxs("div",{className:"form-group",style:{marginBottom:0},children:[e.jsxs("label",{style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:ee,disabled:W||o.kind==="app",onChange:ge=>V(ge.target.checked)}),"Share with friends (public)"]}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Only friends will see this in their feeds."})]}),e.jsx("div",{className:"form-actions",style:{justifyContent:"flex-end"},children:e.jsx("button",{type:"submit",className:"primary",disabled:W,children:"Save"})})]})]})]},o.id)})})]}),N==="history"&&e.jsxs("div",{className:"card history-card",children:[e.jsxs("div",{className:"history-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Consumption log"}),e.jsx("p",{className:"subtle",children:"Productive items and frivolous sessions you opened each day."})]}),e.jsxs("label",{className:"history-picker",children:["Day",e.jsx("input",{type:"date",value:F,onChange:o=>g(o.target.value)})]})]}),k.length>0&&e.jsx("div",{className:"history-days",children:k.map(o=>e.jsxs("button",{type:"button",className:`history-day ${o.day===F?"active":""}`,onClick:()=>g(o.day),children:[e.jsx("span",{children:Zt(o.day)}),e.jsx("span",{className:"history-day-count",children:o.count})]},o.day))}),y?e.jsx("div",{className:"subtle",children:"Loading historyâ€¦"}):i?e.jsx("div",{className:"error-text",children:i}):E.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No entries for this day yet."}),e.jsx("p",{className:"subtle",children:"Mark items as consumed or open a session to see them here."})]}):e.jsx("ul",{className:"history-list",children:E.map(o=>{const z=o.kind==="frivolous-session",xe=typeof o.meta?.purpose=="string"?o.meta.purpose:null,Ee=z?"pill frivolity":`pill ${xe==="temptation"?"frivolity":xe==="productive"||xe==="replace"?"productive":"neutral"}`,De=o.title??o.domain??"Untitled",Re=z?`Mode ${o.meta?.mode??"session"}`:o.url??o.domain??"Library item",Le=typeof o.meta?.mode=="string"?o.meta.mode:null,He=z?Le==="store"?"Store unlock":"Frivolous session":xe?`${Jt(xe)} item`:"Library item";return e.jsxs("li",{className:"history-item",children:[e.jsx("div",{className:"history-time",children:Vt(o.occurredAt)}),e.jsxs("div",{className:"history-main",children:[e.jsx("strong",{children:De}),e.jsx("span",{className:"subtle",children:Re})]}),e.jsxs("div",{className:"history-actions",children:[e.jsx("span",{className:Ee,children:He}),o.url&&e.jsx("a",{className:"ghost",href:o.url,target:"_blank",rel:"noopener noreferrer",children:"Open"})]})]},o.id)})})]})]})}function Js(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M14 4h6v6M10 14l10-10M20 14v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"})})}function aa(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M5 13l4 4L19 7"})})}function na(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M4 20h4l10-10-4-4L4 16v4zM14 6l4 4"})})}function ia(){return e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:e.jsx("path",{d:"M6 7h12M9 7V5h6v2M8 7l1 12h6l1-12"})})}function fs(s){return s.trim().replace(/^@/,"").toLowerCase()}function Qe(s){const a=s/3600;return a>=10?`${a.toFixed(0)}h`:`${a.toFixed(1)}h`}function ds(s){return`${Math.max(0,Math.min(100,Math.round(s)))}%`}function bs(s){return`${Math.round(s/60)}m`}function Qs(s){return typeof s!="number"?"â€”":String(s)}function et(s,a){const n=s?.categoryBreakdown.productive??0,l=a?.categoryBreakdown.productive??0,j=n+l;return j===0?50:Math.round(n/j*100)}function la({api:s}){const[a,n]=t.useState(null),[l,j]=t.useState([]),[m,u]=t.useState({incoming:[],outgoing:[]}),[w,p]=t.useState({}),[N,f]=t.useState(null),[F,g]=t.useState(null),[E,h]=t.useState(null),[k,R]=t.useState(null),[y,D]=t.useState([]),[i,x]=t.useState(!1),[T,M]=t.useState([]),[r,b]=t.useState(""),[C,L]=t.useState(""),[G,Y]=t.useState(null),[S,I]=t.useState(!1),[q,U]=t.useState(null),[X,K]=t.useState(!1),[A,_]=t.useState(!1);async function H(){U(null);try{const P=await s.sync.status(),B=P.configured&&P.authenticated;if(K(B),!B)return;const[ee,V,he,ve,W,me,ue]=await Promise.all([s.friends.profile(),s.friends.list(),s.friends.requests(),s.friends.summaries(24),s.friends.meSummary(24),s.trophies.list(),s.settings.competitiveOptIn()]);n(ee),g(ee),b(ee?.handle??""),j(V),u(he),p(ve),f(W),M(me),_(ue)}catch(P){console.error(P),U(P.message)}}t.useEffect(()=>{H()},[]);const Se=t.useMemo(()=>l.map(P=>{const B=w[P.userId],ee=B?.categoryBreakdown??null,V=B?.totalActiveSeconds??0,he=ee?.draining??0,ve=V>0?ee.productive/V*100:0,W=V>0?ee.neutral/V*100:0,me=V>0?ee.frivolity/V*100:0,ue=V>0?he/V*100:0;return{friend:P,summary:B,totals:ee,productivePct:ve,neutralPct:W,frivolityPct:me,drainingPct:ue}}),[l,w]),ie=t.useMemo(()=>{const P=new Map;return T.forEach(B=>P.set(B.id,B)),P},[T]);async function O(){U(null),I(!0);try{const P=await s.friends.updateProfile({handle:fs(r)});n(P),b(P.handle??"")}catch(P){U(P.message)}finally{I(!1)}}async function Q(){Y(null);const P=fs(C);if(P)try{const B=await s.friends.findByHandle(P);Y(B)}catch{Y(null)}}async function le(){U(null),I(!0);try{await s.friends.request(fs(C)),L(""),Y(null),await H()}catch(P){U(P.message)}finally{I(!1)}}async function te(P){I(!0),U(null);try{await s.friends.accept(P),await H()}catch(B){U(B.message)}finally{I(!1)}}async function oe(P){I(!0),U(null);try{await s.friends.decline(P),await H()}catch(B){U(B.message)}finally{I(!1)}}async function fe(P){I(!0),U(null);try{await s.friends.cancel(P),await H()}catch(B){U(B.message)}finally{I(!1)}}async function be(P){if(confirm("Remove this friend?")){I(!0),U(null);try{await s.friends.remove(P),await H()}catch(B){U(B.message)}finally{I(!1)}}}async function je(P){h(P),R(null),D([]),x(!0);try{const[B,ee]=await Promise.all([s.friends.timeline(P.userId,24),s.friends.publicLibrary(P.userId,168)]);R(B),D(ee??[])}catch(B){console.error("Failed to load friend detail",B)}}async function ke(P){_(P);try{await s.settings.updateCompetitiveOptIn(P)}catch(B){U(B.message||"Failed to update preference"),_(!P)}}return X?e.jsxs("section",{className:"page store-page",children:[e.jsxs("header",{className:"page-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Friends"}),e.jsx("p",{className:"subtle",children:"A low-key feed of daily focus â€” aggregates only (no URLs)."})]}),e.jsx("div",{style:{display:"flex",gap:10},children:e.jsx("button",{className:"ghost",disabled:S,onClick:H,children:"Refresh"})})]}),q&&e.jsx("p",{className:"error-text",children:q}),e.jsxs("div",{className:"card settings-section",style:{marginBottom:16},children:[e.jsxs("div",{className:"settings-section-header",children:[e.jsx("h3",{children:"Competitive view"}),e.jsx("p",{className:"subtle",style:{margin:0},children:"Opt in to show winners/losers and head-to-head bars."})]}),e.jsx("div",{className:"settings-row",children:e.jsxs("label",{className:"settings-inline",style:{alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:A,onChange:P=>ke(P.target.checked)}),e.jsx("span",{className:"subtle",children:A?"Enabled":"Disabled"})]})})]}),e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Your handle"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Handle",e.jsx("input",{value:r,onChange:P=>b(P.target.value),placeholder:"e.g. timewell"})]}),e.jsx("button",{className:"primary",disabled:S,onClick:O,children:"Update"})]}),e.jsx("p",{className:"subtle",style:{marginTop:8},children:"Handles are lowercase letters, numbers, and underscores (3-20)."})]}),e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Add friend"}),e.jsxs("div",{className:"settings-grid",style:{gridTemplateColumns:"1fr auto",alignItems:"end"},children:[e.jsxs("label",{children:["Friend handle",e.jsx("input",{value:C,onChange:P=>L(P.target.value),onBlur:Q,placeholder:"@friend"})]}),e.jsx("button",{className:"primary",disabled:S||!C.trim(),onClick:le,children:"Send request"})]}),G&&e.jsxs("p",{className:"subtle",style:{marginTop:8},children:["Found ",G.displayName??G.handle??"friend","."]})]}),(m.incoming.length>0||m.outgoing.length>0)&&e.jsxs("div",{className:"card",style:{marginBottom:16},children:[e.jsx("h3",{children:"Requests"}),m.incoming.map(P=>e.jsxs("div",{className:"device-row",style:{marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:P.displayName??P.handle??"Friend"}),e.jsx("span",{className:"subtle",children:"Incoming"})]}),e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{className:"primary",disabled:S,onClick:()=>te(P.id),children:"Accept"}),e.jsx("button",{className:"ghost",disabled:S,onClick:()=>oe(P.id),children:"Decline"})]})]},P.id)),m.outgoing.map(P=>e.jsxs("div",{className:"device-row",style:{marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:P.displayName??P.handle??"Friend"}),e.jsx("span",{className:"subtle",children:"Pending"})]}),e.jsx("div",{className:"settings-actions",children:e.jsx("button",{className:"ghost",disabled:S,onClick:()=>fe(P.id),children:"Cancel"})})]},P.id))]}),e.jsx("div",{className:"store-grid",children:l.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No friends yet."}),e.jsx("p",{className:"subtle",children:"Add a handle to start a tiny, supportive feed."})]}):Se.map(({friend:P,summary:B,totals:ee,productivePct:V,neutralPct:he,frivolityPct:ve,drainingPct:W})=>{const me=(P.pinnedTrophies??[]).map(ue=>ie.get(ue)).filter(ue=>!!ue);return e.jsxs("div",{className:"card store-item",children:[e.jsxs("div",{className:"store-item-headline",children:[e.jsxs("div",{children:[e.jsx("p",{className:"store-item-domain",children:P.displayName??P.handle??"Friend"}),e.jsx("h3",{className:"store-item-title",children:B?`${B.productivityScore}% productive`:"No data yet"})]}),e.jsxs("div",{className:"store-item-price-pill",children:[e.jsx("strong",{children:B?Qe(B.totalActiveSeconds):"â€”"}),e.jsx("span",{children:"active"})]}),B&&e.jsxs("div",{className:"pill deepwork",style:{marginLeft:"auto"},children:[bs(B.deepWorkSeconds)," deep work"]})]}),A?e.jsx("div",{className:"head-to-head",children:B?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"head-to-head-row",children:[e.jsx("span",{children:"You"}),e.jsx("span",{children:B?P.displayName??P.handle??"Friend":"Friend"})]}),e.jsxs("div",{className:"head-to-head-bar fancy",children:[e.jsx("span",{className:"head-to-head-left",style:{width:`${et(N,B)}%`,background:F?.color??"var(--accent)"}}),e.jsx("span",{className:"head-to-head-right",style:{width:`${100-et(N,B)}%`,background:P.color??"rgba(255, 255, 255, 0.3)"}}),e.jsx("div",{className:"head-to-head-glow"})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[bs(N?.categoryBreakdown.productive??0)," productive"]}),e.jsxs("span",{children:[bs(B?.categoryBreakdown.productive??0)," productive"]})]}),e.jsxs("div",{className:"head-to-head-row subtle",children:[e.jsxs("span",{children:[Qs(N?.emergencySessions)," emergency"]}),e.jsxs("span",{children:[Qs(B?.emergencySessions)," emergency"]})]})]}):e.jsx("p",{className:"subtle",style:{marginTop:6},children:"Waiting for shared activity data."})}):e.jsx("p",{className:"subtle",style:{marginTop:10},children:"Competitive view is off."}),me.length>0&&e.jsx("div",{className:"friends-trophies",children:me.slice(0,3).map(ue=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:ue.emoji}),ue.name]},ue.id))}),B&&ee&&e.jsxs("div",{style:{marginTop:10},children:[e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Productive"}),e.jsxs("span",{children:[Qe(ee.productive)," (",ds(V),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${V}%`,background:"var(--cat-productive)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Neutral"}),e.jsxs("span",{children:[Qe(ee.neutral)," (",ds(he),")"]})]}),e.jsx("div",{className:"impact-meter day",style:{marginTop:6},children:e.jsx("span",{style:{width:`${he}%`,background:"var(--cat-neutral)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Frivolity"}),e.jsxs("span",{children:[Qe(ee.frivolity)," (",ds(ve),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${ve}%`,background:"var(--cat-frivolity)"}})}),e.jsxs("div",{className:"subtle",style:{display:"flex",justifyContent:"space-between",marginTop:10},children:[e.jsx("span",{children:"Draining"}),e.jsxs("span",{children:[Qe(ee.draining??0)," (",ds(W),")"]})]}),e.jsx("div",{className:"impact-meter",style:{marginTop:6},children:e.jsx("span",{style:{width:`${W}%`,background:"var(--cat-draining)"}})})]}),e.jsxs("div",{className:"store-item-meta",children:[e.jsxs("span",{children:["Last update ",B?new Date(B.updatedAt).toLocaleString():"â€”"]}),e.jsxs("span",{children:["@",P.handle??"no-handle"]})]}),e.jsxs("div",{className:"store-item-actions",children:[e.jsx("button",{className:"ghost",disabled:S,onClick:()=>je(P),children:"Details"}),e.jsx("button",{className:"ghost danger",disabled:S,onClick:()=>be(P.id),children:"Remove"})]})]},P.id)})}),e.jsx(nt,{open:i,friend:E,summary:E?w[E.userId]??null:null,timeline:k,publicLibraryItems:y,trophies:T,onClose:()=>x(!1)})]}):e.jsxs("section",{className:"page store-page",children:[e.jsx("header",{className:"page-header",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Friends"}),e.jsx("p",{className:"subtle",children:"Add a friend by handle once you are signed in."})]})}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Connect Sync"}),e.jsx("p",{className:"subtle",children:"Friends require Supabase auth. Go to Settings â†’ Cloud sync and connect."})]})]})}const ra={attention:"Attention Control",recovery:"Recovery & Resilience",streaks:"Anti-Frivolity Streaks",economy:"Economy & Discipline",library:"Library & Intentionality",time:"Time-of-Day",stability:"Stability & Dynamics",fun:"Fun Flavor",social:"Social & Friends",secret:"Secret"},st=6;function ca(s){return`${Math.round(s)}m`}function oa(s){return s>=10?`${s.toFixed(0)}h`:`${s.toFixed(1)}h`}function da({api:s}){const[a,n]=t.useState(null),[l,j]=t.useState([]),[m,u]=t.useState(!1),[w,p]=t.useState(!1),N=async()=>{const[i,x]=await Promise.all([s.trophies.profile(),s.trophies.list()]);n(i),j(x)};t.useEffect(()=>{N()},[]);const f=t.useMemo(()=>a?.pinnedTrophies?.length?a.pinnedTrophies:l.filter(i=>i.pinned).map(i=>i.id),[a,l]),F=t.useMemo(()=>{const i=new Map;return l.forEach(x=>i.set(x.id,x)),i},[l]),g=f.map(i=>F.get(i)).filter(i=>!!i),E=t.useMemo(()=>l.filter(i=>i.progress.state==="locked").sort((i,x)=>x.progress.ratio-i.progress.ratio).slice(0,4),[l]),h=t.useMemo(()=>{const i=new Map;return l.forEach(x=>{const T=x.category;i.has(T)||i.set(T,[]),i.get(T).push(x)}),i},[l]),k=async i=>{if(!w){p(!0);try{const x=f.includes(i)?f.filter(M=>M!==i):[...f,i].slice(0,st),T=await s.trophies.pin(x);n(M=>M&&{...M,pinnedTrophies:T}),j(M=>M.map(r=>({...r,pinned:T.includes(r.id)})))}finally{p(!1)}}},R=a?.profile?.displayName??a?.profile?.handle??"You",y=a?.profile?.handle?`@${a.profile.handle}`:"Not synced yet",D=a?.profile?.color??"var(--accent)";return e.jsxs("section",{className:"panel",children:[e.jsxs("header",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Profile"}),e.jsx("h1",{children:"Trophy case"}),e.jsx("p",{className:"subtle",children:"Your public card, progression, and achievements."})]}),e.jsx("button",{type:"button",className:`pill ghost ${m?"active":""}`,onClick:()=>u(i=>!i),children:m?"Hide preview":"Public preview"})]}),e.jsxs("div",{className:"profile-grid",children:[e.jsxs("div",{className:"card profile-card",children:[e.jsxs("div",{className:"profile-card-header",children:[e.jsx("div",{className:"profile-avatar",style:{background:D},children:R.trim().slice(0,2).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h2",{children:R}),e.jsx("span",{className:"subtle",children:y})]})]}),e.jsxs("div",{className:"profile-stats",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Weekly productive"}),e.jsx("strong",{children:a?ca(a.stats.weeklyProductiveMinutes):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Best run"}),e.jsx("strong",{children:a?oa(a.stats.bestRunMinutes/60):"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Recovery median"}),e.jsx("strong",{children:a?.stats.recoveryMedianMinutes!=null?`${Math.round(a.stats.recoveryMedianMinutes)}m`:"--"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Frivolity streak"}),e.jsx("strong",{children:a?`${a.stats.currentFrivolityStreakHours}h`:"--"})]})]}),e.jsxs("div",{className:"profile-pinned",children:[e.jsxs("div",{className:"profile-pinned-header",children:[e.jsx("span",{className:"label",children:"Pinned trophies"}),e.jsxs("span",{className:"subtle",children:[g.length,"/",st]})]}),g.length===0?e.jsx("p",{className:"subtle",style:{margin:0},children:"Pin a few trophies so friends can see them."}):e.jsx("div",{className:"profile-badges",children:g.map(i=>e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:i.emoji}),e.jsx("span",{children:i.name})]},i.id))})]})]}),e.jsxs("div",{className:"card profile-next",children:[e.jsx("div",{className:"card-header-row",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Next up"}),e.jsx("h2",{children:"Close to unlocking"})]})}),E.length===0?e.jsx("p",{className:"subtle",children:"No tracked trophies yet. Keep logging activity."}):e.jsx("div",{className:"next-list",children:E.map(i=>e.jsxs("div",{className:"next-item",children:[e.jsxs("div",{className:"next-item-header",children:[e.jsx("span",{className:"emoji",children:i.emoji}),e.jsxs("div",{children:[e.jsx("strong",{children:i.name}),e.jsx("span",{className:"subtle",children:i.description})]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(i.progress.ratio*100)}%`}})}),e.jsx("span",{className:"subtle",children:i.progress.label??`${i.progress.current}/${i.progress.target}`})]},i.id))}),a?.earnedToday?.length?e.jsxs("div",{className:"earned-today",children:[e.jsx("span",{className:"label",children:"Earned today"}),e.jsx("div",{className:"profile-badges",children:a.earnedToday.map(i=>{const x=F.get(i);return x?e.jsxs("div",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:x.emoji}),e.jsx("span",{children:x.name})]},i):null})})]}):null]})]}),m&&e.jsxs("div",{className:"card profile-preview",children:[e.jsx("div",{className:"card-header-row",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Public preview"}),e.jsx("h2",{children:"What friends see"})]})}),e.jsxs("div",{className:"profile-preview-card",children:[e.jsx("div",{className:"profile-avatar",style:{background:D},children:R.trim().slice(0,2).toUpperCase()}),e.jsxs("div",{children:[e.jsx("strong",{children:R}),e.jsx("span",{className:"subtle",children:y})]}),e.jsx("div",{className:"profile-preview-badges",children:g.length===0?e.jsx("span",{className:"subtle",children:"No pinned trophies yet."}):g.map(i=>e.jsxs("span",{className:"trophy-badge",children:[e.jsx("span",{className:"emoji",children:i.emoji}),i.name]},i.id))})]})]}),e.jsxs("div",{className:"card trophy-case",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Trophy case"}),e.jsx("h2",{children:"Full collection"})]}),e.jsx("span",{className:"subtle",children:"Pin trophies to feature them on your card."})]}),Array.from(h.entries()).map(([i,x])=>e.jsxs("div",{className:"trophy-group",children:[e.jsx("h3",{children:ra[i]}),e.jsx("div",{className:"trophy-grid",children:x.map(T=>{const M=!T.earnedAt,r=T.secret&&M;return e.jsxs("div",{className:`trophy-card ${M?"locked":"earned"}`,children:[e.jsxs("div",{className:"trophy-card-header",children:[e.jsx("span",{className:"emoji",children:r?"â“":T.emoji}),e.jsx("button",{type:"button",className:`pill ghost ${T.pinned?"active":""}`,onClick:()=>k(T.id),disabled:w||!T.earnedAt,title:T.earnedAt?"Pin to profile":"Earn to pin",children:T.pinned?"Pinned":"Pin"})]}),e.jsx("strong",{children:r?"Classified":T.name}),e.jsx("p",{className:"subtle",children:r?"Keep going to reveal this trophy.":T.description}),T.progress.state==="untracked"?e.jsx("span",{className:"subtle",children:T.progress.label}):e.jsx("div",{className:"progress-bar",children:e.jsx("span",{style:{width:`${Math.round(T.progress.ratio*100)}%`}})}),T.earnedAt&&e.jsxs("span",{className:"subtle",children:["Earned ",new Date(T.earnedAt).toLocaleDateString()]})]},T.id)})})]},i))]})]})}const ha=[{name:"The Crossword",hint:"Full daily crossword.",url:"https://www.nytimes.com/crosswords/game/daily"},{name:"The Mini",hint:"Quick 5-minute crossword.",url:"https://www.nytimes.com/crosswords/game/mini"},{name:"Connections",hint:"Find the four hidden groups.",url:"https://www.nytimes.com/games/connections"},{name:"Wordle",hint:"One word, six tries.",url:"https://www.nytimes.com/games/wordle/index.html"},{name:"Spelling Bee",hint:"Build words from seven letters.",url:"https://www.nytimes.com/puzzles/spelling-bee"},{name:"Strands",hint:"Find the themed word web.",url:"https://www.nytimes.com/games/strands"}];function ua({wallet:s}){return e.jsxs("section",{className:"games-view panel",children:[e.jsxs("header",{className:"games-hero",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Games"}),e.jsx("p",{className:"subtle",children:"Intentional time burners: quick fun, finite sessions, less doom-scroll."})]}),e.jsxs("div",{className:"games-wallet-pill",children:[e.jsx("span",{children:"Wallet"}),e.jsxs("strong",{children:[s.balance," f-coins"]})]})]}),e.jsxs("section",{className:"games-links-section",children:[e.jsxs("div",{className:"section-header-row",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"NYT quick launch"}),e.jsx("p",{className:"subtle",children:"If you want to burn a little time, do it on purpose."})]}),e.jsx("a",{href:"https://www.nytimes.com/crosswords",target:"_blank",rel:"noopener noreferrer",className:"ghost button-link",children:"Open NYT games hub"})]}),e.jsx("div",{className:"games-links-grid",children:ha.map(a=>e.jsxs("a",{className:"nyt-link-card",href:a.url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx("div",{className:"nyt-link-title",children:a.name}),e.jsx("p",{className:"subtle",children:a.hint}),e.jsx("span",{className:"chip",children:"Open"})]},a.name))})]}),e.jsxs("section",{className:"games-sudoku-section",children:[e.jsx("div",{className:"section-header-row",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Paywall Sudoku drill"}),e.jsx("p",{className:"subtle",children:"Practice the same challenge used in the paywall free-pass flow."})]})}),e.jsx(it,{title:"Hard Sudoku practice",subtitle:"Solve any 9 blank squares correctly.",requiredCorrect:9})]})]})}const lt=window.twsp,ma=160,pa=120,xa=4e3;function rt(s){return new Promise(a=>window.setTimeout(a,s))}async function ga(s){const a=Date.now();for(;Date.now()-a<xa;){const n=s.videoWidth,l=s.videoHeight;if(s.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&n>=ma&&l>=pa)return{width:n,height:l};await rt(80)}throw new Error(`Camera stream resolution unusable (${s.videoWidth}x${s.videoHeight})`)}function tt(s,a,n){const l=Math.max(1,Math.min(48,a)),j=Math.max(1,Math.min(48,n)),{data:m}=s.getImageData(0,0,l,j);let u=0;for(let w=0;w<m.length;w+=16){const p=m[w]??0,N=m[w+1]??0,f=m[w+2]??0;.2126*p+.7152*N+.0722*f>10&&(u+=1)}return u<=1}async function ja(s){let a=null;try{a=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:!1});const n=document.createElement("video");n.srcObject=a,n.playsInline=!0,n.muted=!0,await n.play();const{width:l,height:j}=await ga(n),u=Math.min(1,640/l),w=Math.round(l*u),p=Math.round(j*u),N=document.createElement("canvas");N.width=w,N.height=p;const f=N.getContext("2d");if(!f)throw new Error("Unable to capture camera frame");if(f.drawImage(n,0,0,w,p),tt(f,w,p)&&(await rt(180),f.drawImage(n,0,0,w,p),tt(f,w,p)))throw new Error("Captured frame appears blank");const F=N.toDataURL("image/jpeg",.82);await lt.camera.storePhoto({dataUrl:F,subject:s.subject??null,domain:s.domain??null})}finally{a&&a.getTracks().forEach(n=>n.stop())}}function va(){const s=t.useRef(!1);return t.useEffect(()=>{const a=lt.events.on("camera:capture",async n=>{if(!s.current){s.current=!0;try{await ja(n??{})}catch(l){console.warn("Camera capture failed",l)}finally{s.current=!1}}});return()=>{a()}},[]),null}const ya=["Hello beautiful.","Good morning, bright mind.","Hey superstar.","Hello again, steady heart.","Welcome back, focus machine."],fa=["Set the tone. The day follows.","Small levers, huge outcomes.","One clear choice beats a thousand edits.","Pick your rules before the feed does.","Today is made in small agreements."];function ba(s){let a=0;for(let n=0;n<s.length;n+=1)a=(a<<5)-a+s.charCodeAt(n),a|=0;return Math.abs(a)}function at(s,a){if(!s.length)return"";const n=ba(a)%s.length;return s[n]}function Na({open:s,dayKey:a,initial:n,saving:l,error:j,onSave:m,onSkip:u}){const[w,p]=t.useState(n.goalHours),[N,f]=t.useState(n.idleThreshold),[F,g]=t.useState(n.continuityWindowSeconds),[E,h]=t.useState(n.emergencyPolicy),[k,R]=t.useState(n.note);t.useEffect(()=>{s&&(p(n.goalHours),f(n.idleThreshold),g(n.continuityWindowSeconds),h(n.emergencyPolicy),R(n.note))},[s,n]);const y=t.useMemo(()=>at(ya,a),[a]),D=t.useMemo(()=>at(fa,a+"tag"),[a]);return s?e.jsx("div",{className:"daily-onboarding-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"daily-onboarding-card",children:[e.jsxs("div",{className:"daily-onboarding-header",children:[e.jsxs("div",{className:"daily-onboarding-hero",children:[e.jsx("div",{className:"daily-onboarding-orb","aria-hidden":!0}),e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Daily landing"}),e.jsx("h2",{children:y}),e.jsx("p",{className:"subtle",children:D})]})]}),e.jsxs("div",{className:"daily-onboarding-meta",children:[e.jsx("span",{className:"pill ghost",children:"Morning tuning"}),e.jsx("span",{className:"pill ghost",children:"One screen"})]})]}),e.jsxs("div",{className:"daily-onboarding-panels",children:[e.jsxs("div",{className:"daily-onboarding-panel",children:[e.jsx("h3",{children:"Set your day"}),e.jsxs("div",{className:"daily-onboarding-grid",children:[e.jsxs("label",{children:["Productivity goal (hours)",e.jsx("input",{type:"number",min:"0.5",max:"12",step:"0.1",value:w,onChange:i=>p(Number(i.target.value))})]}),e.jsxs("label",{children:["Idle threshold (seconds)",e.jsx("input",{type:"number",min:"5",max:"300",value:N,onChange:i=>f(Number(i.target.value))})]}),e.jsxs("label",{children:["Continuity window (seconds)",e.jsx("input",{type:"number",min:"0",max:"900",value:F,onChange:i=>g(Number(i.target.value))})]}),e.jsxs("label",{children:["Emergency policy",e.jsxs("select",{value:E,onChange:i=>h(i.target.value),children:[e.jsx("option",{value:"off",children:"Off"}),e.jsx("option",{value:"gentle",children:"Gentle"}),e.jsx("option",{value:"balanced",children:"Balanced"}),e.jsx("option",{value:"strict",children:"Strict"})]})]})]})]}),e.jsxs("div",{className:"daily-onboarding-panel",children:[e.jsx("h3",{children:"Note for end-of-day you"}),e.jsx("label",{className:"daily-onboarding-note",children:e.jsx("textarea",{rows:4,value:k,onChange:i=>R(i.target.value),placeholder:"Write something kind, firm, or honest. We'll bring it back later."})})]})]}),j&&e.jsx("p",{className:"error-text",children:j}),e.jsxs("div",{className:"daily-onboarding-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>u({note:k}),disabled:l,children:"Not now"}),e.jsx("button",{type:"button",className:"primary",onClick:()=>m({goalHours:w,idleThreshold:N,continuityWindowSeconds:F,emergencyPolicy:E,note:k}),disabled:l,children:l?"Saving...":"Set my day"})]})]})}):null}function wa({open:s,note:a,onClose:n}){return s?e.jsx("div",{className:"daily-onboarding-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"daily-onboarding-card daily-note-card",children:[e.jsxs("div",{className:"daily-onboarding-header",children:[e.jsx("p",{className:"eyebrow",children:"End-of-day note"}),e.jsx("h2",{children:"For you, from you."})]}),e.jsx("div",{className:"daily-note-body",children:e.jsx("p",{children:a})}),e.jsx("div",{className:"daily-onboarding-actions",children:e.jsx("button",{type:"button",className:"primary",onClick:n,children:"Got it"})})]})}):null}const se=window.twsp,Sa=["dashboard","library","games","analytics","settings","friends","profile"],ka=s=>Sa.includes(s),Ca=4,Ma=17;function es(s){const a=new Date(s);a.getHours()<Ca&&a.setDate(a.getDate()-1);const n=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),j=String(a.getDate()).padStart(2,"0");return`${n}-${l}-${j}`}function Pa(){const[s,a]=t.useState("dashboard"),[n,l]=t.useState({balance:0}),[j,m]=t.useState([]),[u,w]=t.useState(null),[p,N]=t.useState(()=>{try{return localStorage.getItem("tws-theme")==="olive"?"olive":"lavender"}catch{return"lavender"}}),[f,F]=t.useState({connected:!0,lastSeen:null}),[g,E]=t.useState(null),[h,k]=t.useState(null),[R,y]=t.useState(!1),[D,i]=t.useState(!1),[x,T]=t.useState(null),[M,r]=t.useState(2),[b,C]=t.useState(15),[L,G]=t.useState(120),[Y,S]=t.useState("balanced"),[I,q]=t.useState(""),[U,X]=t.useState(!1),[K,A]=t.useState(Date.now());t.useEffect(()=>{se.wallet.get().then(l),se.market.list().then(m),se.economy.state().then(w)},[]),t.useEffect(()=>{const O=window.setInterval(()=>A(Date.now()),6e4);return()=>window.clearInterval(O)},[]),t.useEffect(()=>{let O=!0;return(async()=>{const le=es(new Date),[te,oe,fe,be,je]=await Promise.all([se.settings.dailyOnboardingState(),se.settings.productivityGoalHours(),se.settings.idleThreshold(),se.settings.continuityWindowSeconds(),se.settings.emergencyPolicy()]);if(O&&(k(te),r(oe),C(fe),G(be),S(je),q(te.note?.day===le?te.note.message:""),te.completedDay!==le&&te.lastPromptedDay!==le)){const ke=await se.settings.updateDailyOnboardingState({lastPromptedDay:le});if(!O)return;k(ke),y(!0)}})().catch(()=>{}),()=>{O=!1}},[]),t.useEffect(()=>{if(!h?.note)return;const O=h.note,Q=es(new Date(K));if(O.acknowledged||O.day&&O.day>Q)return;const le=new Date(K);if(!(O.day===Q&&le.getHours()<Ma)&&!U&&(X(!0),!O.deliveredAt)){const oe={...O,deliveredAt:new Date().toISOString()};se.settings.updateDailyOnboardingState({note:oe}).then(k).catch(()=>{})}},[h,U,K]),t.useEffect(()=>{const O=document.body;O.classList.remove("theme-olive"),p==="olive"&&O.classList.add("theme-olive");try{localStorage.setItem("tws-theme",p)}catch{}},[p]),t.useEffect(()=>{const O=se.events.on("ui:navigate",Q=>{const le=Q?.view;typeof le=="string"&&ka(le)&&a(le)});return()=>{O()}},[]);const _=t.useRef(f);t.useEffect(()=>{_.current=f},[f]),t.useEffect(()=>{const O=se.events.on("wallet:update",l),Q=se.events.on("economy:activity",w),le=se.events.on("market:update",()=>{se.market.list().then(m)}),te=se.events.on("paywall:required",je=>{if(_.current.connected&&["Google Chrome","Chrome","Brave Browser","Brave","Microsoft Edge","Edge","Arc","Firefox","Safari"].some(P=>je.appName.includes(P))){console.log("Ignoring desktop paywall for browser activity (extension active):",je);return}E({...je,reason:"blocked"})}),oe=se.events.on("paywall:session-started",()=>{E(null)}),fe=se.events.on("extension:status",je=>{F(je)}),be=se.events.on("paywall:session-ended",je=>{je.reason==="insufficient-funds"&&E({domain:je.domain,appName:"",reason:je.reason})});return()=>{O(),Q(),le(),te(),oe(),be(),fe()}},[]);const H=async O=>{if(D)return;i(!0),T(null);const Q=es(new Date);try{await se.settings.updateProductivityGoalHours(O.goalHours),await se.settings.updateIdleThreshold(O.idleThreshold),await se.settings.updateContinuityWindowSeconds(O.continuityWindowSeconds),await se.settings.updateEmergencyPolicy(O.emergencyPolicy),r(O.goalHours),C(O.idleThreshold),G(O.continuityWindowSeconds),S(O.emergencyPolicy);const le=O.note.trim(),te={completedDay:Q,lastPromptedDay:Q,lastSkippedDay:null,note:le?{day:Q,message:le,deliveredAt:null,acknowledged:!1}:null},oe=await se.settings.updateDailyOnboardingState(te);k(oe),y(!1)}catch{T("Failed to save your settings. Try again.")}finally{i(!1)}},Se=async O=>{if(D)return;i(!0),T(null);const Q=es(new Date);try{const le=O.note.trim(),te={lastPromptedDay:Q,lastSkippedDay:Q,note:le?{day:Q,message:le,deliveredAt:null,acknowledged:!1}:null},oe=await se.settings.updateDailyOnboardingState(te);k(oe),y(!1)}catch{T("Failed to save your note. Try again.")}finally{i(!1)}},ie=async()=>{if(!h?.note){X(!1);return}const O={...h.note,acknowledged:!0};try{const Q=await se.settings.updateDailyOnboardingState({note:O});k(Q)}catch{}finally{X(!1)}};return e.jsxs("div",{className:"app-shell",children:[e.jsx(va,{}),!f.connected&&e.jsxs("div",{className:"extension-banner",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Browser extension offline"}),e.jsx("span",{className:"subtle",children:" Install or enable the TimeWellSpent extension to enforce in-browser paywalls."})]}),e.jsx("button",{className:"primary",onClick:()=>window.open("https://chromewebstore.google.com","_blank","noopener"),children:"Get extension"})]}),e.jsxs("div",{className:"window-chrome",children:[e.jsxs("div",{className:"window-chrome-title","aria-hidden":!0,children:[e.jsx("div",{className:"title-dot"}),e.jsx("span",{children:"TimeWellSpent"})]}),e.jsx("div",{className:"window-chrome-meta",children:e.jsxs("span",{className:"pill ghost big",children:[n?.balance??0," f-coins"]})})]}),e.jsxs("aside",{className:"sidebar",children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"logo",children:"â³"}),e.jsx("span",{children:"TimeWellSpent"})]}),e.jsxs("nav",{className:"nav-menu",children:[e.jsx("button",{className:s==="dashboard"?"active":"",onClick:()=>a("dashboard"),children:"Dashboard"}),e.jsx("button",{className:s==="library"?"active":"",onClick:()=>a("library"),children:"Library"}),e.jsx("button",{className:s==="games"?"active":"",onClick:()=>a("games"),children:"Games"}),e.jsx("button",{className:s==="settings"?"active":"",onClick:()=>a("settings"),children:"Settings"}),e.jsx("button",{className:s==="analytics"?"active":"",onClick:()=>a("analytics"),children:"Analytics"}),e.jsx("button",{className:s==="friends"?"active":"",onClick:()=>a("friends"),children:"Friends"}),e.jsx("button",{className:s==="profile"?"active":"",onClick:()=>a("profile"),children:"Profile"})]}),e.jsxs("div",{className:"wallet-summary",children:[e.jsxs("div",{className:"balance",children:[e.jsx("span",{className:"coin",children:"ðŸª™"}),e.jsx("span",{className:"amount",children:n?.balance??0})]}),e.jsx("div",{className:"rate",children:u?.activeCategory==="productive"?"+5/min":u?.activeCategory==="neutral"?"+3/min":"0/min"})]})]}),e.jsxs("main",{className:"content",children:[s==="dashboard"&&e.jsx(It,{api:se,wallet:n,economy:u,productivityGoalHoursOverride:M}),s==="analytics"&&e.jsx(zt,{api:se}),s==="settings"&&e.jsx(Ut,{api:se,theme:p,onThemeChange:O=>N(O)}),s==="library"&&e.jsx(ta,{api:se}),s==="games"&&e.jsx(ua,{wallet:n}),s==="friends"&&e.jsx(la,{api:se}),s==="profile"&&e.jsx(da,{api:se})]}),e.jsx(Na,{open:R,dayKey:es(new Date),saving:D,error:x,initial:{goalHours:M,idleThreshold:b,continuityWindowSeconds:L,emergencyPolicy:Y,note:I},onSave:H,onSkip:Se}),e.jsx(wa,{open:U,note:h?.note?.message??"",onClose:ie}),g&&e.jsx(Gt,{open:!!g,state:{domain:g.domain||g.appName,mode:g.mode??"pack",reason:g.reason},wallet:n,api:se,marketRates:j,onWallet:l,onClose:()=>E(null)})]})}vt.createRoot(document.getElementById("root")).render(e.jsx(yt.StrictMode,{children:e.jsx(Pa,{})}));
//# sourceMappingURL=app-pp1ZKoQF.js.map
