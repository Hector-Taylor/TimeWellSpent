const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-ByLEz7Df.js","./client-D_dPGLb3.js","./client-BA0QjbLq.css"])))=>i.map(i=>d[i]);
import{j as e,r as n,c as Ft,R as Bt}from"./client-D_dPGLb3.js";const Kt="modulepreload",zt=function(r,o){return new URL(r,o).href},ft={},kt=function(o,l,i){let c=Promise.resolve();if(l&&l.length>0){const y=document.getElementsByTagName("link"),f=document.querySelector("meta[property=csp-nonce]"),E=f?.nonce||f?.getAttribute("nonce");c=Promise.allSettled(l.map(x=>{if(x=zt(x,i),x in ft)return;ft[x]=!0;const L=x.endsWith(".css"),D=L?'[rel="stylesheet"]':"";if(!!i)for(let B=y.length-1;B>=0;B--){const b=y[B];if(b.href===x&&(!L||b.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${x}"]${D}`))return;const S=document.createElement("link");if(S.rel=L?"stylesheet":Kt,L||(S.as="script"),S.crossOrigin="",S.href=x,E&&S.setAttribute("nonce",E),document.head.appendChild(S),L)return new Promise((B,b)=>{S.addEventListener("load",B),S.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${x}`)))})}))}function N(y){const f=new Event("vite:preloadError",{cancelable:!0});if(f.payload=y,window.dispatchEvent(f),!f.defaultPrevented)throw y}return c.then(y=>{for(const f of y||[])f.status==="rejected"&&N(f.reason);return o().catch(N)})};let bt=!1;async function Ht(){const r=await kt(()=>import("./pdf-CZPOwZZ3.js"),[],import.meta.url);return!bt&&r?.GlobalWorkerOptions&&(r.GlobalWorkerOptions.workerSrc=new URL(""+new URL("pdf.worker.min-wgc6bjNh.mjs",import.meta.url).href,import.meta.url).toString(),bt=!0),r}async function Jt(){const r=await kt(()=>import("./index-ByLEz7Df.js"),__vite__mapDeps([0,1,2]),import.meta.url);return r?.default??r}function Tt(r){return r.match(/[A-Za-z0-9]+(?:['’-][A-Za-z0-9]+)*/g)?.length??0}function Gt(r){return typeof r=="string"?r:""}function Ct(r){return{currentPage:r.currentPage??null,totalPages:r.totalPages??null,progress:r.progress??null,activeSecondsTotal:r.activeSecondsTotal??0,focusedSecondsTotal:r.focusedSecondsTotal??0,pagesReadTotal:r.pagesReadTotal??0,wordsReadTotal:r.wordsReadTotal??0,estimatedTotalWords:r.estimatedTotalWords??null,locationLabel:r.locationLabel??null}}function qt({format:r}){return e.jsx("div",{className:"embedded-reader-fallback",children:e.jsxs("p",{children:[r.toUpperCase()," preview is not supported in the embedded reader yet."]})})}function Vt({src:r,title:o,onSnapshotChange:l}){const i=n.useRef(null),c=n.useRef(null),[N,y]=n.useState(null),[f,E]=n.useState(!0),[x,L]=n.useState(1),[D,se]=n.useState(null),[S,B]=n.useState(1),[b,V]=n.useState(0),[h,q]=n.useState(0),[M,K]=n.useState(0),[ne,k]=n.useState(0),[X,R]=n.useState(null),ee=n.useRef(null),A=n.useRef(0),z=n.useRef(new Set),I=n.useRef(new Map),J=z.current.size,te=Array.from(I.current.entries()).filter(([g])=>z.current.has(g)).reduce((g,[,p])=>g+p,0),ie=n.useMemo(()=>{if(!D||I.current.size===0)return null;const g=I.current.size,T=Array.from(I.current.values()).reduce((m,$)=>m+$,0)/Math.max(1,g);return Math.round(T*D)},[D,h]),W=D?Math.max(0,Math.min(1,x/Math.max(1,D))):null;return n.useEffect(()=>{l?.(Ct({currentPage:x,totalPages:D,progress:W,activeSecondsTotal:M,focusedSecondsTotal:ne,pagesReadTotal:J,wordsReadTotal:te,estimatedTotalWords:ie,locationLabel:X}))},[M,ie,ne,X,l,D,x,J,W,te]),n.useEffect(()=>{let g=!1;return E(!0),y(null),z.current=new Set,I.current=new Map,L(1),R(null),K(0),k(0),V(0),q(0),(async()=>{try{const p=await Ht();if(g)return;const m=await p.getDocument(r).promise;if(g){await m.destroy();return}ee.current=m,se(m.numPages??null),L(1)}catch(p){g||y(p.message||"Unable to open PDF")}finally{g||E(!1)}})(),()=>{g=!0;const p=ee.current;ee.current=null,p?.destroy&&p.destroy()}},[r]),n.useEffect(()=>{const g=window.setInterval(()=>{const p=document.visibilityState==="visible";p&&K(T=>T+1),p&&document.hasFocus()&&k(T=>T+1)},1e3);return()=>window.clearInterval(g)},[]),n.useEffect(()=>{let g=!1;return(async()=>{const T=ee.current,m=i.current,$=c.current;if(!T||!m||!$||!x)return;const Z=++A.current;try{const H=await T.getPage(x);if(g||Z!==A.current)return;const ae=H.getViewport({scale:1}),U=Math.max(280,$.clientWidth-12)/Math.max(1,ae.width)*S,O=H.getViewport({scale:U}),u=window.devicePixelRatio||1,t=m.getContext("2d");if(!t)throw new Error("Canvas rendering unavailable");if(m.width=Math.floor(O.width*u),m.height=Math.floor(O.height*u),m.style.width=`${Math.floor(O.width)}px`,m.style.height=`${Math.floor(O.height)}px`,t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,m.width,m.height),await H.render({canvasContext:t,viewport:O,transform:u!==1?[u,0,0,u,0,0]:void 0}).promise,g||Z!==A.current)return;R(`Page ${x}${D?` of ${D}`:""}`);const w=z.current.size;if(z.current.add(x),!I.current.has(x)){const F=((await H.getTextContent()).items??[]).map(Y=>Gt(Y?.str)).join(" ");I.current.set(x,Tt(F))}(z.current.size!==w||I.current.has(x))&&q(j=>j+1)}catch(H){g||y(H.message||"Unable to render PDF page")}})(),()=>{g=!0}},[D,x,S,b]),n.useEffect(()=>{const g=()=>{A.current+=1,V(p=>p+1)};return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]),e.jsxs("div",{className:"embedded-reader-shell",children:[e.jsxs("div",{className:"embedded-reader-toolbar",children:[e.jsxs("div",{className:"embedded-reader-toolbarGroup",children:[e.jsx("strong",{children:o}),e.jsx("span",{className:"embedded-reader-metaText",children:X??"PDF"})]}),e.jsxs("div",{className:"embedded-reader-toolbarGroup actions",children:[e.jsx("button",{type:"button",onClick:()=>L(g=>Math.max(1,g-1)),disabled:x<=1,children:"Prev"}),e.jsx("span",{className:"embedded-reader-metaText",children:D?`${x}/${D}`:x}),e.jsx("button",{type:"button",onClick:()=>L(g=>D?Math.min(D,g+1):g+1),disabled:D!=null&&x>=D,children:"Next"}),e.jsx("button",{type:"button",onClick:()=>B(g=>Math.max(.6,Math.round((g-.1)*10)/10)),children:"A-"}),e.jsx("button",{type:"button",onClick:()=>B(g=>Math.min(2.4,Math.round((g+.1)*10)/10)),children:"A+"})]})]}),N?e.jsx("p",{className:"embedded-reader-error",children:N}):null,e.jsxs("div",{className:"embedded-reader-stage",ref:c,children:[f?e.jsx("div",{className:"embedded-reader-loading",children:"Loading PDF…"}):null,e.jsx("canvas",{ref:i,className:f?"hidden-canvas":""})]})]})}function Zt({src:r,title:o,onSnapshotChange:l}){const i=n.useRef(null),c=n.useRef(null),N=n.useRef(null),y=n.useRef(new Map),f=n.useRef(new Set),[E,x]=n.useState(null),[L,D]=n.useState(!0),[se,S]=n.useState(null),[B,b]=n.useState(null),[V,h]=n.useState(null),[q,M]=n.useState(null),[K,ne]=n.useState(0),[k,X]=n.useState(0),[R,ee]=n.useState(0),[A,z]=n.useState(null),[I,J]=n.useState(""),te=f.current.size;n.useEffect(()=>{l?.(Ct({currentPage:se,totalPages:B,progress:V,activeSecondsTotal:K,focusedSecondsTotal:k,pagesReadTotal:te,wordsReadTotal:R,estimatedTotalWords:A,locationLabel:q}))},[K,se,A,k,q,l,te,V,B,R]),n.useEffect(()=>{const p=window.setInterval(()=>{const T=document.visibilityState==="visible";T&&ne(m=>m+1),T&&document.hasFocus()&&X(m=>m+1)},1e3);return()=>window.clearInterval(p)},[]),n.useEffect(()=>{let p=!1;D(!0),x(null),S(null),b(null),h(null),M(null),ne(0),X(0),ee(0),z(null),J(""),y.current=new Map,f.current=new Set;const T=i.current;if(!T)return;T.innerHTML="";let m=null,$=null;const Z=()=>{const C=Array.from(y.current.entries()).filter(([O])=>f.current.has(O)).reduce((O,[,u])=>O+u,0);ee(C);const U=y.current.size;if(U>0){const O=Array.from(y.current.values()).reduce((t,a)=>t+a,0),u=Array.isArray(m.spine?.spineItems)?m.spine.spineItems.length:U;z(Math.round(O/U*Math.max(U,u)))}},H=async(C,U)=>{const O=C||`section-${U??0}`;if(!y.current.has(O))try{const u=U!=null?m.section(U):null,t=u?await Promise.resolve(u.load(m.load?.bind(m))):null,a=t&&typeof t.documentElement?.textContent=="string"?t.documentElement.textContent:"";y.current.set(O,Tt(a)),Z()}catch{}},ae=C=>{if(p)return;const U=Number.isFinite(C?.start?.displayed?.page)?Number(C.start.displayed.page):null,O=Number.isFinite(C?.start?.displayed?.total)?Number(C.start.displayed.total):null,u=typeof C?.start?.href=="string"?C.start.href:"",t=Number.isFinite(C?.start?.index)?Number(C.start.index):void 0,a=typeof C?.start?.percentage=="number"?C.start.percentage:typeof C?.end?.percentage=="number"?C.end.percentage:null;u?f.current.add(u):t!=null&&f.current.add(`section-${t}`),Z(),(u||t!=null)&&H(u,t);const w=(()=>{try{const Y=m.locations;return typeof Y?.length=="function"?Number(Y.length()):typeof Y?.total=="number"?Number(Y.total):null}catch{return null}})(),j=U??C?.start?.location??null,F=O??w;S(j),b(F),h(a!=null?Math.max(0,Math.min(1,a)):null),M(u||(j!=null?`Location ${j}`:"EPUB")),J(j!=null?String(j):"")};return(async()=>{try{const C=await Jt();if(p)return;m=C(r),$=m.renderTo(T,{width:"100%",height:"100%",spread:"none"}),c.current=m,N.current=$,$.on("relocated",ae),await m.ready;try{await m.locations.generate(1024)}catch{}await $.display()}catch(C){p||x(C.message||"Unable to open EPUB")}finally{p||D(!1)}})(),()=>{p=!0;try{$?.off("relocated",ae)}catch{}try{$?.destroy()}catch{}try{m?.destroy()}catch{}c.current=null,N.current=null}},[r]);const ie=async()=>{try{await N.current?.prev()}catch(p){x(p.message||"Unable to move to previous page")}},W=async()=>{try{await N.current?.next()}catch(p){x(p.message||"Unable to move to next page")}},g=async()=>{const p=Number(I);if(!Number.isFinite(p)||p<=0)return;const T=c.current,m=N.current;if(!(!T||!m))try{const $=T.locations;let Z=null;$&&typeof $.cfiFromLocation=="function"&&(Z=$.cfiFromLocation(Math.round(p))),Z&&await m.display(Z)}catch($){x($.message||"Unable to jump to location")}};return e.jsxs("div",{className:"embedded-reader-shell",children:[e.jsxs("div",{className:"embedded-reader-toolbar",children:[e.jsxs("div",{className:"embedded-reader-toolbarGroup",children:[e.jsx("strong",{children:o}),e.jsx("span",{className:"embedded-reader-metaText",children:q??"EPUB"})]}),e.jsxs("div",{className:"embedded-reader-toolbarGroup actions",children:[e.jsx("button",{type:"button",onClick:ie,children:"Prev"}),e.jsx("input",{type:"text",value:I,inputMode:"numeric",className:"embedded-reader-locationInput",onChange:p=>J(p.target.value),onKeyDown:p=>{p.key==="Enter"&&(p.preventDefault(),g())},"aria-label":"EPUB location"}),e.jsx("span",{className:"embedded-reader-metaText",children:B?`/ ${B}`:""}),e.jsx("button",{type:"button",onClick:()=>void g(),children:"Go"}),e.jsx("button",{type:"button",onClick:W,children:"Next"})]})]}),E?e.jsx("p",{className:"embedded-reader-error",children:E}):null,e.jsxs("div",{className:"embedded-reader-stage",children:[L?e.jsx("div",{className:"embedded-reader-loading",children:"Loading EPUB…"}):null,e.jsx("div",{ref:i,className:`embedded-reader-epubMount ${L?"is-loading":""}`})]})]})}function Yt({src:r,format:o,title:l,onSnapshotChange:i,className:c}){return o==="pdf"?e.jsx(Vt,{src:r,title:l,onSnapshotChange:i}):o==="epub"?e.jsx(Zt,{src:r,title:l,onSnapshotChange:i}):e.jsx("div",{className:c,children:e.jsx(qt,{format:o})})}function Qt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`writing-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}function $e(r){return r.match(/[A-Za-z0-9]+(?:['’-][A-Za-z0-9]+)*/g)?.length??0}function Xt(r){return r.endsWith("/")?r.slice(0,-1):r}function es(){return globalThis.chrome?.runtime??null}async function pe(r,o,l){const i=await fetch(`${Xt(r)}${o}`,{...l,cache:"no-store",headers:{"Content-Type":"application/json",...l?.headers??{}}});if(!i.ok){const c=await i.json().catch(()=>null);throw new Error(c?.error??`Request failed (${i.status})`)}return i.json()}function je(r){const o=Math.max(0,Math.round(r/60)),l=Math.floor(o/60),i=o%60;return l>0?`${l}h ${i}m`:`${i}m`}function ts(r){if(!r)return"New";const o=Date.parse(r);if(!Number.isFinite(o))return"Recently";const l=Date.now()-o,i=Math.round(l/6e4);if(i<1)return"Just now";if(i<60)return`${i}m ago`;const c=Math.round(i/60);return c<48?`${c}h ago`:`${Math.round(c/24)}d ago`}function Le(r){switch(r){case"tws-doc":return"TWS Draft";case"google-doc":return"Google Docs";case"tana-node":return"Tana";case"external-link":return"External";default:return"Target"}}function ge(r){switch(r){case"journal":return"Journal";case"paper":return"Paper";case"substack":return"Substack";case"fiction":return"Fiction";case"essay":return"Essay";case"notes":return"Notes";default:return"Writing"}}function xt(r,o){const l={journal:178,paper:214,substack:26,fiction:332,essay:280,notes:120,other:260};let i=0;for(let f=0;f<o.length;f+=1)i=i*31+o.charCodeAt(f)|0;const c=Math.abs(i)%28,N=(l[r]+c)%360,y=(N+42)%360;return`linear-gradient(160deg, hsl(${N} 78% 58% / 0.95), hsl(${y} 85% 44% / 0.9))`}function ss(r){const o=Number(r);return!Number.isFinite(o)||o<=0?null:Math.round(o)}function rs(r){const o=Number(r);return!Number.isFinite(o)||o<=0?10:Math.max(1,Math.min(120,Math.round(o)))}function ns(r){switch(r){case"journal":case"paper":case"substack":case"fiction":case"essay":case"notes":case"other":return r;default:return"journal"}}function as(){if(typeof window>"u")return null;const r=new URLSearchParams(window.location.search),o=(r.get("tws_write_action")??"").trim();if(!o)return null;const l=rs(r.get("tws_write_sprint"));if(o==="resume"){const i=Number(r.get("tws_write_project_id"));return!Number.isFinite(i)||i<=0?null:{action:"resume",projectId:Math.round(i),sprintMinutes:l}}if(o==="create"){const i=r.get("tws_write_title"),c=r.get("tws_write_prompt");return{action:"create",kind:ns(r.get("tws_write_kind")),sprintMinutes:l,title:i?.trim()?i.trim():null,promptText:c?.trim()?c.trim():null}}return null}function os(){if(typeof window>"u")return;const r=new URL(window.location.href),o=[...r.searchParams.keys()];let l=!1;for(const c of o)c.startsWith("tws_write_")&&(r.searchParams.delete(c),l=!0);if(!l)return;const i=`${r.pathname}${r.search}${r.hash}`;window.history.replaceState(null,"",i)}const wt={title:"",kind:"journal",targetKind:"tws-doc",targetUrl:"",targetId:"",wordTarget:""};function is(r){return r.metaKey||r.ctrlKey||r.altKey?!1:r.key.length===1?!0:r.key==="Backspace"||r.key==="Delete"||r.key==="Enter"||r.key==="Tab"}function ls({apiBase:r,surface:o,variant:l="web"}){const[i,c]=n.useState(null),[N,y]=n.useState(!0),[f,E]=n.useState(null),[x,L]=n.useState(null),[D,se]=n.useState(!1),[S,B]=n.useState(!1),[b,V]=n.useState(wt),[h,q]=n.useState(null),[M,K]=n.useState(!1),[ne,k]=n.useState(null),X=n.useRef(null),R=n.useRef(l==="extension"?as():null),ee=n.useRef(!1);n.useEffect(()=>{X.current=h},[h]);const A=n.useCallback(async(t=!1)=>{t||y(!0),E(null);try{const a=await pe(r,"/writing/dashboard?days=14&limit=12");c(a)}catch(a){E(a.message??"Unable to load Writing Studio.")}finally{t||y(!1)}},[r]);n.useEffect(()=>{A()},[A]),n.useEffect(()=>{const t=window.setInterval(()=>{A(!0)},6e4);return()=>window.clearInterval(t)},[A]);const z=n.useMemo(()=>i?.prompts.find(t=>t.id===ne)??i?.prompts[0]??null,[i?.prompts,ne]),I=n.useMemo(()=>(i?.projects??[]).reduce((a,w)=>(a.total+=1,w.status==="active"&&(a.active+=1),w.kind==="journal"&&(a.journal+=1),w.targetKind==="tws-doc"&&(a.tws+=1),a),{total:0,active:0,journal:0,tws:0}),[i?.projects]),J=n.useCallback(async t=>{B(!0);try{const a=await pe(r,"/writing/projects",{method:"POST",body:JSON.stringify(t)});return L(`Created “${a.title}”.`),se(!1),V(wt),await A(!0),a}catch(a){return E(a.message??"Unable to create project."),null}finally{B(!1)}},[r,A]),te=n.useCallback(async(t,a)=>pe(r,`/writing/projects/${t}`,{method:"PATCH",body:JSON.stringify(a)}),[r]),ie=n.useCallback(async t=>{try{await pe(r,`/writing/projects/${t}/touch`,{method:"POST"})}catch{}},[r]),W=n.useCallback(async t=>{if(!t.targetUrl){L(t.targetKind==="tana-node"?"Add a Tana URL/deeplink to this project to open it directly.":"No target link saved yet.");return}await ie(t.id),window.open(t.targetUrl,"_blank","noopener,noreferrer"),L(`Opened target for “${t.title}”.`),A(!0)},[A,ie]),g=n.useCallback(async(t,a)=>{const w=es();if(l!=="extension"||!w?.sendMessage){await W(t);return}if(!t.targetUrl){L(t.targetKind==="tana-node"?"Add a Tana URL/deeplink to this project to track it in-browser.":"No target link saved yet.");return}K(!0);try{const j=await w.sendMessage({type:"OPEN_WRITING_TARGET",payload:{projectId:t.id,projectTitle:t.title,projectKind:t.kind,targetKind:t.targetKind,targetUrl:t.targetUrl,targetId:t.targetId??null,currentWordCount:t.currentWordCount,sprintMinutes:a,sourceSurface:"extension-newtab",replaceCurrent:!0}});if(!j?.success)throw new Error(j?.error??"Unable to open tracked writing target.");L(`Opened “${t.title}” with live writing HUD tracking.`)}catch(j){E(j.message??"Unable to open tracked writing target.")}finally{K(!1)}},[W,l]),p=n.useCallback(async(t,a)=>{if(!M){K(!0);try{const w=Qt();await pe(r,"/analytics/writing/sessions/start",{method:"POST",body:JSON.stringify({sessionId:w,projectId:t.id,sourceSurface:o,sprintMinutes:a})}),q({sessionId:w,project:t,sprintMinutes:a,startedAtMs:Date.now(),draftText:t.bodyText??"",reentryNoteDraft:t.reentryNote??"",baselineWordCount:t.currentWordCount??$e(t.bodyText??""),currentWordCount:t.currentWordCount??$e(t.bodyText??""),activeSecondsTotal:0,focusedSecondsTotal:0,keystrokesTotal:0,wordsAddedTotal:0,wordsDeletedTotal:0,netWordsTotal:0,bodyTextLength:(t.bodyText??"").length,sprintCompleted:!1,locationLabel:"Writing Studio Editor"}),L(`Started ${a?`${a}m`:""} writing session for “${t.title}”.`.trim())}catch(w){E(w.message??"Unable to start writing session.")}finally{K(!1)}}},[r,M,o]),T=n.useCallback(async(t,a)=>{if(l==="extension"&&t.targetKind!=="tws-doc"&&!!t.targetUrl){await g(t,a);return}await p(t,a)},[g,p,l]),m=n.useCallback(async t=>{const a=X.current;if(a)try{await pe(r,`/analytics/writing/sessions/${a.sessionId}/${t}`,{method:"POST",body:JSON.stringify({occurredAt:new Date().toISOString(),activeSecondsTotal:a.activeSecondsTotal,focusedSecondsTotal:a.focusedSecondsTotal,keystrokesTotal:a.keystrokesTotal,wordsAddedTotal:a.wordsAddedTotal,wordsDeletedTotal:a.wordsDeletedTotal,netWordsTotal:a.netWordsTotal,currentWordCount:a.currentWordCount,bodyTextLength:a.bodyTextLength,locationLabel:a.locationLabel})})}catch{}},[r]),$=n.useCallback(async(t=!0)=>{const a=X.current;if(!(!a||M)){K(!0);try{await m("end"),t&&await te(a.project.id,{bodyText:a.draftText,currentWordCount:a.currentWordCount,reentryNote:a.reentryNoteDraft,lastTouchedAt:new Date().toISOString()}),q(null),L(`Saved session for “${a.project.title}” (${a.netWordsTotal>=0?"+":""}${a.netWordsTotal} words).`),await A(!0)}catch(w){E(w.message??"Unable to end writing session.")}finally{K(!1)}}},[A,te,m,M]);n.useEffect(()=>{if(!h)return;const t=a=>{a.key==="Escape"&&$(!0)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[h,$]),n.useEffect(()=>{if(!h)return;const t=window.setInterval(()=>{q(a=>{if(!a)return a;const w=document.visibilityState==="visible",j=w?a.activeSecondsTotal+1:a.activeSecondsTotal,F=w&&document.hasFocus()?a.focusedSecondsTotal+1:a.focusedSecondsTotal,Y=!a.sprintCompleted&&a.sprintMinutes!=null&&j>=a.sprintMinutes*60?!0:a.sprintCompleted;return{...a,activeSecondsTotal:j,focusedSecondsTotal:F,sprintCompleted:Y}})},1e3);return()=>window.clearInterval(t)},[h]),n.useEffect(()=>{if(!h)return;const t=window.setInterval(()=>{m("progress")},5e3);return()=>window.clearInterval(t)},[h,m]),n.useEffect(()=>()=>{m("end")},[m]);const Z=n.useCallback(t=>{q(a=>{if(!a)return a;const w=a.currentWordCount,j=$e(t),F=j-w;return{...a,draftText:t,currentWordCount:j,bodyTextLength:t.length,wordsAddedTotal:a.wordsAddedTotal+(F>0?F:0),wordsDeletedTotal:a.wordsDeletedTotal+(F<0?Math.abs(F):0),netWordsTotal:j-a.baselineWordCount}})},[]),H=n.useCallback(t=>{is(t)&&q(a=>a&&{...a,keystrokesTotal:a.keystrokesTotal+1})},[]),ae=n.useMemo(()=>h?.sprintMinutes?Math.max(0,h.sprintMinutes*60-h.activeSecondsTotal):null,[h]),C=n.useCallback(async(t,a="journal")=>{const w=a==="journal"?"Journal":ge(a),j=new Date().toLocaleDateString([],{month:"short",day:"numeric"}),F=`Prompt: ${t.text}

`;await J({title:`${w} — ${j}`,kind:a,targetKind:"tws-doc",bodyText:F,promptText:t.text,reentryNote:"Write one paragraph before editing."})},[J]),U=n.useCallback(async t=>{const a=new Date().toLocaleDateString([],{month:"short",day:"numeric"}),w=i?.prompts.find(F=>F.kind===t||F.kind==="any")??null,j=t==="journal"?`Journal — ${a}`:t==="paper"?"Paper Draft":t==="substack"?"Substack Post":t==="fiction"?"Fiction Scene":`${ge(t)} Draft`;await J({title:j,kind:t,targetKind:"tws-doc",bodyText:w?`Prompt: ${w.text}

`:"",promptText:w?.text??null,reentryNote:t==="journal"?"Write one honest paragraph before deciding what it means.":"Write the next small paragraph only."})},[J,i?.prompts]),O=n.useCallback(async t=>{t.preventDefault();const a=b.title.trim();if(!a){E("Give the writing project a title.");return}if(b.targetKind!=="tws-doc"&&!b.targetUrl.trim()&&!b.targetId.trim()){E("Add a target link or target ID for non-TWS projects.");return}await J({title:a,kind:b.kind,targetKind:b.targetKind,targetUrl:b.targetUrl.trim()||null,targetId:b.targetId.trim()||null,wordTarget:ss(b.wordTarget),bodyText:b.targetKind==="tws-doc"?"":null,reentryNote:null,promptText:z?.text??null})},[b,J,z]);n.useEffect(()=>{if(l!=="extension")return;const t=R.current;if(!t||ee.current||N||!i||S||M||h)return;let a=!1;return(async()=>{ee.current=!0;try{if(t.action==="resume"){let ce=i.projects.find(we=>we.id===t.projectId)??null;if(ce||(ce=(await pe(r,"/writing/projects?limit=50&includeArchived=false")).items.find(me=>me.id===t.projectId)??null),!ce){a||E("The writing project for this redirect could not be found.");return}a||await T(ce,t.sprintMinutes);return}const j=t.kind,F=new Date().toLocaleDateString([],{month:"short",day:"numeric"}),Y=j==="journal"?`Journal — ${F}`:j==="paper"?"Paper Draft":j==="substack"?"Substack Post":j==="fiction"?"Fiction Scene":`${ge(j)} — ${F}`,ue=t.promptText?.trim()?t.promptText.trim():null,le=await J({title:t.title?.trim()||Y,kind:j,targetKind:"tws-doc",bodyText:ue?`Prompt: ${ue}

`:"",promptText:ue,reentryNote:j==="journal"?"Write one honest paragraph before deciding what it means.":"Write the next small paragraph only."});if(!le||a)return;await p(le,t.sprintMinutes)}catch(j){a||E(j.message??"Unable to start redirected writing sprint.")}finally{R.current=null,a||os()}})(),()=>{a=!0}},[h,r,J,i,N,S,M,T,p,l]);const u=l==="web"?"card web-full-width writing-studio":"newtab-card tall writing-studio writing-studio--extension";return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:u,children:[e.jsxs("div",{className:"writing-studio__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:l==="web"?"eyebrow":"newtab-eyebrow",children:"Writing Studio"}),e.jsx("h2",{children:"Projects, prompts, and tracked writing sprints"}),e.jsx("p",{className:"writing-studio__subtle",children:"Surface the right draft, start a timed sprint, and keep writing in a productive loop with re-entry notes."})]}),e.jsxs("div",{className:"writing-studio__headerActions",children:[e.jsx("button",{type:"button",onClick:()=>void A(),children:N?"Loading…":"Refresh"}),e.jsx("button",{type:"button",className:"primary",onClick:()=>se(t=>!t),children:D?"Close Composer":"New Project"})]})]}),f?e.jsx("p",{className:"writing-studio__notice error",children:f}):null,x?e.jsx("p",{className:"writing-studio__notice",children:x}):null,e.jsxs("div",{className:"writing-studio__topline",children:[e.jsxs("span",{className:"pill ghost",children:[I.total," projects"]}),e.jsxs("span",{className:"pill ghost",children:[I.active," active"]}),e.jsxs("span",{className:"pill ghost",children:[I.tws," TWS drafts"]}),e.jsxs("span",{className:"pill ghost",children:["Today ",i?`${i.overview.today.netWords>=0?"+":""}${i.overview.today.netWords} words`:"--"]}),e.jsxs("span",{className:"pill ghost",children:["Pace ",i?`${i.overview.pace.wordsPerMinute.toFixed(1)} w/m`:"--"]})]}),e.jsxs("div",{className:"writing-studio__templates",children:[e.jsx("button",{type:"button",onClick:()=>void U("journal"),disabled:S,children:"Journal Sprint"}),e.jsx("button",{type:"button",onClick:()=>void U("paper"),disabled:S,children:"Paper Draft"}),e.jsx("button",{type:"button",onClick:()=>void U("substack"),disabled:S,children:"Substack Draft"}),e.jsx("button",{type:"button",onClick:()=>void U("fiction"),disabled:S,children:"Fiction Scene"})]}),i?.suggestions?.length?e.jsx("div",{className:"writing-studio__suggestions",children:i.suggestions.map(t=>e.jsxs("article",{className:"writing-suggestion-card",children:[e.jsxs("div",{className:"writing-suggestion-card__cover",style:{background:xt(t.project.kind,t.project.title)},children:[e.jsx("span",{className:"writing-suggestion-card__badge",children:ge(t.project.kind)}),e.jsx("strong",{children:t.project.title}),e.jsx("small",{children:Le(t.project.targetKind)})]}),e.jsxs("div",{className:"writing-suggestion-card__body",children:[e.jsx("p",{className:"writing-studio__subtle",children:t.reason}),e.jsx("p",{className:"writing-suggestion-card__nextStep",children:t.smallNextStep}),e.jsxs("div",{className:"writing-studio__rowActions",children:[e.jsx("button",{type:"button",onClick:()=>void T(t.project,10),disabled:M,children:"Write 10m"}),e.jsx("button",{type:"button",onClick:()=>void T(t.project,25),disabled:M,children:"Write 25m"}),t.project.targetUrl?e.jsx("button",{type:"button",onClick:()=>void(l==="extension"&&t.project.targetKind!=="tws-doc"?g(t.project,12):W(t.project)),children:l==="extension"&&t.project.targetKind!=="tws-doc"?"Open + Track":"Open Target"}):null]})]})]},`suggestion-${t.project.id}`))}):null,i?.prompts?.length?e.jsxs("div",{className:"writing-studio__prompts",children:[e.jsxs("div",{className:"writing-studio__promptsHeader",children:[e.jsx("strong",{children:"Prompt Capsule"}),e.jsx("span",{className:"writing-studio__subtle",children:"Use these to reduce start friction."})]}),e.jsx("div",{className:"writing-studio__promptList",children:i.prompts.map(t=>e.jsxs("button",{type:"button",className:`writing-prompt-chip ${z?.id===t.id?"active":""}`,onClick:()=>k(t.id),children:[e.jsx("span",{children:t.kind==="any"?"Any":ge(t.kind)}),e.jsx("small",{children:t.text})]},t.id))}),z?e.jsxs("div",{className:"writing-studio__promptActions",children:[e.jsx("button",{type:"button",onClick:()=>void C(z,"journal"),disabled:S,children:"Journal From Prompt"}),e.jsx("button",{type:"button",onClick:()=>void C(z,"essay"),disabled:S,children:"Essay Draft From Prompt"})]}):null]}):null,D?e.jsxs("form",{className:"writing-studio__composer",onSubmit:O,children:[e.jsxs("div",{className:"writing-studio__composerGrid",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Title"}),e.jsx("input",{value:b.title,onChange:t=>V(a=>({...a,title:t.target.value})),placeholder:"Project title"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Kind"}),e.jsxs("select",{value:b.kind,onChange:t=>V(a=>({...a,kind:t.target.value})),children:[e.jsx("option",{value:"journal",children:"Journal"}),e.jsx("option",{value:"paper",children:"Paper"}),e.jsx("option",{value:"substack",children:"Substack"}),e.jsx("option",{value:"fiction",children:"Fiction"}),e.jsx("option",{value:"essay",children:"Essay"}),e.jsx("option",{value:"notes",children:"Notes"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Target"}),e.jsxs("select",{value:b.targetKind,onChange:t=>V(a=>({...a,targetKind:t.target.value})),children:[e.jsx("option",{value:"tws-doc",children:"TWS Draft"}),e.jsx("option",{value:"google-doc",children:"Google Doc"}),e.jsx("option",{value:"tana-node",children:"Tana Node"}),e.jsx("option",{value:"external-link",children:"External Link"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Word Target (optional)"}),e.jsx("input",{inputMode:"numeric",value:b.wordTarget,onChange:t=>V(a=>({...a,wordTarget:t.target.value})),placeholder:"e.g. 1200"})]})]}),b.targetKind!=="tws-doc"?e.jsxs("div",{className:"writing-studio__composerGrid",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Target URL / Deeplink"}),e.jsx("input",{value:b.targetUrl,onChange:t=>V(a=>({...a,targetUrl:t.target.value})),placeholder:"https://docs.google.com/... or tana://..."})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Target ID (optional)"}),e.jsx("input",{value:b.targetId,onChange:t=>V(a=>({...a,targetId:t.target.value})),placeholder:"Tana node id / doc id"})]})]}):null,e.jsxs("div",{className:"writing-studio__rowActions",children:[e.jsx("button",{className:"primary",type:"submit",disabled:S,children:S?"Creating…":"Create Writing Project"}),z?e.jsx("span",{className:"pill ghost",children:"Prompt ready"}):null]})]}):null,e.jsx("div",{className:"writing-studio__projects",children:i?.projects?.length?i.projects.map(t=>{const a=t.wordTarget&&t.wordTarget>0?Math.max(0,Math.min(100,Math.round(t.currentWordCount/t.wordTarget*100))):null;return e.jsxs("article",{className:`writing-project-card status-${t.status}`,children:[e.jsx("button",{type:"button",className:"writing-project-card__coverButton",onClick:()=>void T(t,10),disabled:M,"aria-label":`Start writing on ${t.title}`,children:e.jsxs("span",{className:"writing-project-card__cover",style:{background:xt(t.kind,t.title)},children:[e.jsx("span",{className:"writing-project-card__badge",children:ge(t.kind)}),e.jsx("span",{className:"writing-project-card__title",children:t.title}),e.jsx("span",{className:"writing-project-card__meta",children:Le(t.targetKind)})]})}),e.jsxs("div",{className:"writing-project-card__body",children:[e.jsxs("div",{className:"writing-project-card__titleRow",children:[e.jsx("strong",{children:t.title}),e.jsx("span",{className:`pill ghost ${t.status==="done"?"success":""}`,children:t.status})]}),e.jsxs("div",{className:"writing-project-card__stats",children:[e.jsxs("span",{children:[t.currentWordCount.toLocaleString()," words"]}),e.jsxs("span",{children:[t.sessionCount," sessions"]}),e.jsx("span",{children:ts(t.lastTouchedAt??t.updatedAt)})]}),t.reentryNote?e.jsx("p",{className:"writing-project-card__reentry",children:t.reentryNote}):null,a!=null?e.jsxs("div",{className:"writing-project-card__progress",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Goal"}),e.jsxs("span",{children:[t.currentWordCount,"/",t.wordTarget]})]}),e.jsx("div",{className:"writing-project-card__progressBar",children:e.jsx("span",{style:{width:`${a}%`}})})]}):null,e.jsxs("div",{className:"writing-studio__rowActions",children:[e.jsx("button",{type:"button",onClick:()=>void T(t,10),disabled:M,children:"Write 10m"}),e.jsx("button",{type:"button",onClick:()=>void T(t,25),disabled:M,children:"Write 25m"}),t.targetUrl?e.jsx("button",{type:"button",onClick:()=>void(l==="extension"&&t.targetKind!=="tws-doc"?g(t,12):W(t)),children:l==="extension"&&t.targetKind!=="tws-doc"?"Open + Track":"Open Target"}):null,e.jsx("button",{type:"button",onClick:async()=>{try{await te(t.id,{status:t.status==="done"?"active":"done",lastTouchedAt:new Date().toISOString()}),await A(!0)}catch(w){E(w.message??"Unable to update project status.")}},children:t.status==="done"?"Reopen":"Done"})]})]})]},t.id)}):N?e.jsx("p",{className:"writing-studio__subtle",children:"Loading writing projects…"}):e.jsx("p",{className:"writing-studio__subtle",children:"No writing projects yet. Create a journal, paper, Substack, or fiction project and start a timed sprint."})}),i?.overview?e.jsxs("div",{className:"writing-studio__metrics",children:[e.jsxs("div",{className:"writing-studio__metric",children:[e.jsx("span",{children:"Writing Time Today"}),e.jsx("strong",{children:je(i.overview.today.activeSeconds)})]}),e.jsxs("div",{className:"writing-studio__metric",children:[e.jsx("span",{children:"Net Words Today"}),e.jsxs("strong",{children:[i.overview.today.netWords>=0?"+":"",i.overview.today.netWords]})]}),e.jsxs("div",{className:"writing-studio__metric",children:[e.jsx("span",{children:"Keys / Min"}),e.jsx("strong",{children:i.overview.pace.keystrokesPerMinute.toFixed(1)})]}),e.jsxs("div",{className:"writing-studio__metric",children:[e.jsx("span",{children:"Projects Touched"}),e.jsx("strong",{children:i.overview.today.projects})]})]}):null,i?.overview?.insights?.length?e.jsx("ul",{className:"writing-studio__insights",children:i.overview.insights.map(t=>e.jsx("li",{children:t},t))}):null]}),h?e.jsxs("div",{className:"writing-overlay",role:"dialog","aria-modal":"true","aria-label":`Writing ${h.project.title}`,children:[e.jsxs("div",{className:"writing-overlay__panel",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"writing-overlay__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:l==="web"?"eyebrow":"newtab-eyebrow",children:"Writing Sprint"}),e.jsx("h2",{children:h.project.title}),e.jsxs("p",{className:"writing-studio__subtle",children:[ge(h.project.kind)," · ",Le(h.project.targetKind)," · Started"," ",new Date(h.startedAtMs).toLocaleTimeString([],{timeStyle:"short"})]})]}),e.jsxs("div",{className:"writing-studio__rowActions",children:[h.project.targetUrl?e.jsx("button",{type:"button",onClick:()=>void W(h.project),children:"Open Target"}):null,e.jsx("button",{type:"button",onClick:()=>void $(!0),disabled:M,children:M?"Saving…":"Save & End"})]})]}),e.jsxs("div",{className:"writing-overlay__body",children:[e.jsxs("div",{className:"writing-overlay__editorWrap",children:[e.jsxs("div",{className:"writing-overlay__toolbar",children:[e.jsx("span",{className:"pill ghost",children:h.sprintMinutes?`${h.sprintMinutes}m sprint`:"Open session"}),ae!=null?e.jsx("span",{className:`pill ghost ${h.sprintCompleted?"success":""}`,children:h.sprintCompleted?"Sprint complete":`${je(ae)} left`}):null,e.jsxs("span",{className:"pill ghost",children:[h.currentWordCount.toLocaleString()," words"]}),e.jsxs("span",{className:"pill ghost",children:["Net ",h.netWordsTotal>=0?"+":"",h.netWordsTotal]}),e.jsxs("span",{className:"pill ghost",children:[h.keystrokesTotal.toLocaleString()," keys"]}),e.jsxs("span",{className:"pill ghost",children:[je(h.focusedSecondsTotal)," focused"]})]}),e.jsx("textarea",{className:"writing-overlay__editor",value:h.draftText,onChange:t=>Z(t.target.value),onKeyDown:H,placeholder:h.project.promptText?`Prompt: ${h.project.promptText}

Start with one paragraph.`:"Write the next small paragraph. Keep moving.",autoFocus:!0})]}),e.jsxs("aside",{className:"writing-overlay__side",children:[e.jsxs("div",{className:"writing-overlay__sideCard",children:[e.jsx("h3",{children:"Re-entry Note"}),e.jsx("p",{className:"writing-studio__subtle",children:"What should future-you do first next time?"}),e.jsx("textarea",{rows:4,value:h.reentryNoteDraft,onChange:t=>q(a=>a&&{...a,reentryNoteDraft:t.target.value}),placeholder:"Start with the hook. Then add one concrete example…"})]}),h.project.promptText?e.jsxs("div",{className:"writing-overlay__sideCard",children:[e.jsx("h3",{children:"Prompt"}),e.jsx("p",{children:h.project.promptText})]}):null,e.jsxs("div",{className:"writing-overlay__sideCard",children:[e.jsx("h3",{children:"Session Metrics"}),e.jsxs("ul",{className:"writing-overlay__metricList",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Active"}),e.jsx("strong",{children:je(h.activeSecondsTotal)})]}),e.jsxs("li",{children:[e.jsx("span",{children:"Focused"}),e.jsx("strong",{children:je(h.focusedSecondsTotal)})]}),e.jsxs("li",{children:[e.jsx("span",{children:"Keystrokes"}),e.jsx("strong",{children:h.keystrokesTotal.toLocaleString()})]}),e.jsxs("li",{children:[e.jsx("span",{children:"Words Added"}),e.jsx("strong",{children:h.wordsAddedTotal.toLocaleString()})]}),e.jsxs("li",{children:[e.jsx("span",{children:"Words Deleted"}),e.jsx("strong",{children:h.wordsDeletedTotal.toLocaleString()})]}),e.jsxs("li",{children:[e.jsx("span",{children:"Net Words"}),e.jsxs("strong",{children:[h.netWordsTotal>=0?"+":"",h.netWordsTotal]})]})]})]})]})]})]}),e.jsx("button",{className:"writing-overlay__backdropClose",type:"button","aria-label":"Close writing session",onClick:()=>void $(!0)})]}):null]})}const cs="tws-local-reader",ds=1,oe="books";let Ae=null;function Pt(r){return new Promise((o,l)=>{r.onsuccess=()=>o(r.result),r.onerror=()=>l(r.error??new Error("IndexedDB request failed"))})}function ve(r){return new Promise((o,l)=>{r.oncomplete=()=>o(),r.onerror=()=>l(r.error??new Error("IndexedDB transaction failed")),r.onabort=()=>l(r.error??new Error("IndexedDB transaction aborted"))})}function Ce(){return Ae||(Ae=new Promise((r,o)=>{const l=window.indexedDB.open(cs,ds);l.onupgradeneeded=()=>{const i=l.result;if(!i.objectStoreNames.contains(oe)){const c=i.createObjectStore(oe,{keyPath:"id"});c.createIndex("updatedAt","updatedAt",{unique:!1}),c.createIndex("lastOpenedAt","lastOpenedAt",{unique:!1})}},l.onsuccess=()=>r(l.result),l.onerror=()=>o(l.error??new Error("Unable to open local reader storage"))})),Ae}function Oe(r,o){const l=r.toLowerCase(),i=(o??"").toLowerCase();return l.endsWith(".pdf")||i==="application/pdf"?"pdf":l.endsWith(".epub")||i==="application/epub+zip"||i==="application/x-zip-compressed"?"epub":"unknown"}function us(r){return r.replace(/\.[^.]+$/,"").replace(/[_]+/g," ").replace(/\s{2,}/g," ").replace(/\s*-\s*/g," - ").trim()||r}function Fe(r){const{blob:o,...l}=r;return l}function hs(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`book-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}function Rt(r){return Oe(r.name,r.type)!=="unknown"}async function ms(){const o=(await Ce()).transaction(oe,"readonly"),i=o.objectStore(oe).getAll(),c=await Pt(i);return await ve(o),c.map(Fe).sort((N,y)=>{const f=N.lastOpenedAt??N.updatedAt??N.createdAt;return(y.lastOpenedAt??y.updatedAt??y.createdAt)-f})}async function ps(r){const o=r.filter(Rt);if(!o.length)return[];const l=Date.now(),c=(await Ce()).transaction(oe,"readwrite"),N=c.objectStore(oe),y=[];for(const f of o){const E={id:hs(),title:us(f.name),fileName:f.name,mimeType:f.type||(Oe(f.name)==="epub"?"application/epub+zip":"application/pdf"),format:Oe(f.name,f.type),sizeBytes:f.size,createdAt:l,updatedAt:l,lastOpenedAt:null,blob:f};N.put(E),y.push(Fe(E))}return await ve(c),y}async function gs(r){const l=(await Ce()).transaction(oe,"readwrite"),i=l.objectStore(oe),c=await Pt(i.get(r));if(!c)return await ve(l),null;const N={...c,lastOpenedAt:Date.now(),updatedAt:Date.now()};return i.put(N),await ve(l),{book:Fe(N),blob:N.blob}}async function fs(r){const l=(await Ce()).transaction(oe,"readwrite");l.objectStore(oe).delete(r),await ve(l)}const Te="http://127.0.0.1:17600",bs=4;function _t(r){const o=r.trim();return o?o.endsWith("/")?o.slice(0,-1):o:Te}function jt(){try{return _t(window.localStorage.getItem("tws-web-api-base")??Te)}catch{return Te}}function Ue(r){const o=r/3600;return o>=10?`${Math.round(o)}h`:`${o.toFixed(1)}h`}function ke(r){const o=Math.max(0,Math.round(r/60)),l=Math.floor(o/60),i=o%60;return l>0?`${l}h ${i}m`:`${i}m`}function yt(r){return new Date(`${r}T00:00:00`).toLocaleDateString([],{weekday:"short",month:"short",day:"numeric"})}function xs(r){const o=new Date(r);o.getHours()<bs&&o.setDate(o.getDate()-1);const l=o.getFullYear(),i=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0");return`${l}-${i}-${c}`}function vt(r){switch(r){case"replace":return"Replace";case"productive":return"Productive";case"allow":return"Allow";case"temptation":return"Temptation";default:return r}}function Nt(r){if(!r)return 0;const o=Date.parse(r);return Number.isFinite(o)?o:0}async function G(r,o,l){const i=await fetch(`${r}${o}`,{...l,cache:"no-store",headers:{"Content-Type":"application/json",...l?.headers??{}}});if(!i.ok){const c=await i.json().catch(()=>null),N=c&&typeof c=="object"&&"error"in c&&typeof c.error=="string"?c.error:`Request failed (${i.status})`;throw new Error(N)}return i.json()}function ws(r){const o=r.trim();return o?o.startsWith("http://")||o.startsWith("https://")?o:`https://${o}`:null}function We(r,o){return!Number.isFinite(o)||o<=0?0:Math.max(0,Math.min(100,Math.round(r/o*100)))}function ye(r){if(!Number.isFinite(r)||r<=0)return"0 B";const o=["B","KB","MB","GB"];let l=r,i=0;for(;l>=1024&&i<o.length-1;)l/=1024,i+=1;const c=l>=100||i===0?0:1;return`${l.toFixed(c)} ${o[i]}`}function Me(r){return r.format==="pdf"?"PDF":r.format==="epub"?"EPUB":"Document"}function St(r){let o=0;for(let c=0;c<r.length;c+=1)o=o*31+r.charCodeAt(c)|0;const l=Math.abs(o)%360,i=(l+54)%360;return`linear-gradient(160deg, hsl(${l} 72% 58% / 0.95), hsl(${i} 80% 44% / 0.88))`}function js(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`reader-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}function Ie(r){return`local:${r.format}:${r.fileName}:${r.sizeBytes}`}function ys(){const[r,o]=n.useState("home"),[l,i]=n.useState(jt),[c,N]=n.useState(jt),[y,f]=n.useState(!0),[E,x]=n.useState(!1),[L,D]=n.useState(!1),[se,S]=n.useState(null),[B,b]=n.useState(null),[V,h]=n.useState(Date.now()),[q,M]=n.useState({balance:0}),[K,ne]=n.useState(null),[k,X]=n.useState(null),[R,ee]=n.useState(null),[A,z]=n.useState([]),[I,J]=n.useState([]),[te,ie]=n.useState([]),[W,g]=n.useState([]),[p,T]=n.useState(!0),[m,$]=n.useState(!1),[Z,H]=n.useState(null),[ae,C]=n.useState(!1),[U,O]=n.useState(null),[u,t]=n.useState(null),[a,w]=n.useState([]),[j,F]=n.useState(!1),[Y,ue]=n.useState(""),[le,ce]=n.useState(!1),we=n.useRef(null),me=n.useRef(null),fe=n.useRef(null),[Be,Ke]=n.useState(null),[ze,He]=n.useState(""),[Je,Ge]=n.useState(""),[qe,Ve]=n.useState(""),[Ze,Ye]=n.useState("replace"),[Qe,Xe]=n.useState(!1),[et,Pe]=n.useState(null),[tt,Re]=n.useState(""),[st,rt]=n.useState(!1),[nt,Dt]=n.useState(null),Q=n.useCallback(async(s=!1)=>{s||f(!0),x(!0),S(null);try{await G(c,"/health");const[d,P,_,v,Se,It,Ot,gt]=await Promise.all([G(c,"/wallet"),G(c,"/activities/summary?windowHours=24"),G(c,"/analytics/overview?days=7"),G(c,"/analytics/literary/overview?days=14"),G(c,"/analytics/time-of-day?days=7"),G(c,"/library"),G(c,"/integrations/reading?limit=8"),G(c,"/settings/daily-onboarding")]);M(d),ne(P),X(_),ee(v),z(Se),J(It),ie(Ot.items??[]),Ke(gt),Re(gt.note?.message??""),D(!0)}catch(d){D(!1),S(d.message||"Failed to load homepage data.")}finally{f(!1),x(!1)}},[c]),be=n.useCallback(async()=>{try{if(!navigator.storage?.estimate)return;const s=await navigator.storage.estimate();O({quota:s.quota,usage:s.usage})}catch{}},[]),de=n.useCallback(async(s=!1)=>{s&&T(!0);try{const d=await ms();g(d)}catch(d){H(d.message||"Unable to load local reader shelf.")}finally{s&&T(!1)}},[]),Ne=n.useCallback(()=>{t(s=>(s&&URL.revokeObjectURL(s.objectUrl),null))},[]),he=n.useCallback(async s=>{H(null);try{const d=await gs(s.id);if(!d){H("That file is no longer available in local storage."),await de();return}const P=URL.createObjectURL(d.blob);t(_=>(_&&URL.revokeObjectURL(_.objectUrl),{book:d.book,objectUrl:P})),await de(),b(`Opened “${d.book.title}” in the browser reader.`)}catch(d){H(d.message||"Unable to open file.")}},[de]),at=n.useCallback(async s=>{const d=s.filter(_=>Rt(_)),P=s.length-d.length;if(!d.length){H("Upload a PDF or EPUB file.");return}$(!0),H(null);try{const _=await ps(d);await Promise.all([de(),be()]),_.length>0&&(b(P>0?`Saved ${_.length} book${_.length===1?"":"s"} (${P} skipped).`:`Saved ${_.length} book${_.length===1?"":"s"} to your local reader shelf.`),_.length===1&&await he(_[0]))}catch(_){H(_.message||"Unable to save uploaded books.")}finally{$(!1)}},[he,de,be]),ot=n.useCallback(async s=>{if(window.confirm(`Remove "${s.title}" from your local browser shelf?`))try{await fs(s.id),t(P=>P?.book.id===s.id?(URL.revokeObjectURL(P.objectUrl),null):P),await Promise.all([de(),be()]),b(`Removed “${s.title}” from your local reader shelf.`)}catch(P){H(P.message||"Unable to remove book.")}},[de,be]),it=n.useCallback(async()=>{if(!W.length){b("Upload a PDF or EPUB to start your local reader shelf.");return}const s=W[Math.floor(Math.random()*W.length)];await he(s)},[W,he]),_e=n.useCallback(async s=>{if(!u||!fe.current)return;const d=me.current;if(d)try{await G(c,`/analytics/literary/sessions/${fe.current.sessionId}/${s}`,{method:"POST",body:JSON.stringify({occurredAt:new Date().toISOString(),currentPage:d.currentPage,totalPages:d.totalPages,progress:d.progress,activeSecondsTotal:d.activeSecondsTotal,focusedSecondsTotal:d.focusedSecondsTotal,pagesReadTotal:d.pagesReadTotal,wordsReadTotal:d.wordsReadTotal,estimatedTotalWords:d.estimatedTotalWords,locationLabel:d.locationLabel})})}catch{}},[c,u]),Et=n.useCallback(s=>{me.current=s},[]),xe=n.useCallback(async s=>{F(!0);try{const d=await G(c,`/analytics/literary/annotations?docKey=${encodeURIComponent(s)}&limit=200`);w(Array.isArray(d.items)?d.items:[])}catch{w([])}finally{F(!1)}},[c]),lt=n.useCallback(async s=>{if(!u)return;const d=me.current;if(!d){b("Open or navigate the reader before adding annotations.");return}const P=Ie(u.book),_=Y.trim();if(s==="note"&&!_){b("Write a note first.");return}ce(!0);try{await G(c,"/analytics/literary/annotations",{method:"POST",body:JSON.stringify({docKey:P,title:u.book.title,kind:s,sessionId:fe.current?.sessionId??null,currentPage:d.currentPage,totalPages:d.totalPages,progress:d.progress,locationLabel:d.locationLabel,selectedText:null,noteText:s==="note"?_:null})}),s==="note"&&ue(""),await Promise.all([xe(P),Q(!0)]),b(s==="note"?"Note saved.":"Highlight saved.")}catch(v){b(v.message||"Unable to save annotation.")}finally{ce(!1)}},[Y,c,Q,xe,u]),$t=n.useCallback(async s=>{if(u){ce(!0);try{await G(c,`/analytics/literary/annotations/${s}`,{method:"DELETE"}),await Promise.all([xe(Ie(u.book)),Q(!0)]),b("Annotation removed.")}catch(d){b(d.message||"Unable to delete annotation.")}finally{ce(!1)}}},[c,Q,xe,u]);n.useEffect(()=>{Q()},[Q]),n.useEffect(()=>{de(!0),be()},[de,be]),n.useEffect(()=>{const s=window.setInterval(()=>h(Date.now()),6e4);return()=>window.clearInterval(s)},[]),n.useEffect(()=>{const s=window.setInterval(()=>Q(!0),45e3);return()=>window.clearInterval(s)},[Q]),n.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&Q(!0)};return window.addEventListener("focus",s),document.addEventListener("visibilitychange",s),()=>{window.removeEventListener("focus",s),document.removeEventListener("visibilitychange",s)}},[Q]),n.useEffect(()=>{try{window.localStorage.setItem("tws-web-api-base",c)}catch{}},[c]),n.useEffect(()=>{if(!u)return;const s=d=>{d.key==="Escape"&&Ne()};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Ne,u]),n.useEffect(()=>()=>{u&&URL.revokeObjectURL(u.objectUrl)},[u]),n.useEffect(()=>{if(!u){fe.current=null,me.current=null,w([]),ue("");return}const s=js(),d=Ie(u.book);fe.current={sessionId:s,docKey:d},me.current=null,ue(""),xe(d),(async()=>{try{await G(c,"/analytics/literary/sessions/start",{method:"POST",body:JSON.stringify({sessionId:s,docKey:d,title:u.book.title,fileName:u.book.fileName,format:u.book.format,sourceSurface:"web-homepage"})})}catch{}})();const P=window.setInterval(()=>{_e("progress")},5e3);return()=>{window.clearInterval(P),_e("end"),Q(!0),fe.current=null}},[c,Q,xe,_e,u]);const ct=n.useMemo(()=>K?.topContexts?.slice(0,6)??[],[K]),De=n.useMemo(()=>{const s=k?.categoryBreakdown;return s?s.productive+s.neutral+s.frivolity+s.draining+s.idle:0},[k]),dt=n.useMemo(()=>A.length?[...A].sort((s,d)=>d.productive-s.productive)[0]??null:null,[A]),ut=n.useMemo(()=>{const s=I.filter(v=>v.kind==="url"&&!v.consumedAt).sort((v,Se)=>Nt(v.lastUsedAt??v.createdAt)-Nt(Se.lastUsedAt??Se.createdAt)).slice(0,6).map(v=>({id:`library-${v.id}`,type:"library",title:v.title??v.domain,subtitle:v.note??v.url??v.domain,url:v.url,purpose:v.purpose,libraryId:v.id})),d=te.slice(0,6).map(v=>({id:`reading-${v.id}`,type:"reading",title:v.title,subtitle:v.subtitle??v.source.toUpperCase(),url:v.action.kind==="deeplink"?v.action.url:void 0,source:v.source,progress:v.progress})),P=[],_=Math.max(s.length,d.length);for(let v=0;v<_;v+=1)s[v]&&P.push(s[v]),d[v]&&P.push(d[v]);return P.slice(0,8)},[I,te]),re=n.useMemo(()=>W[0]??null,[W]),ht=n.useMemo(()=>W.slice(0,8),[W]),mt=n.useMemo(()=>a.reduce((s,d)=>(d.kind==="highlight"&&(s.highlights+=1),d.kind==="note"&&(s.notes+=1),s),{highlights:0,notes:0}),[a]),Ee=n.useMemo(()=>W.reduce((s,d)=>(d.format==="pdf"&&(s.pdf+=1),d.format==="epub"&&(s.epub+=1),d.lastOpenedAt&&(s.opened+=1),s),{pdf:0,epub:0,opened:0}),[W]),Lt=U?.usage?`${ye(U.usage)} used${U.quota?` · ${ye(U.quota)} quota`:""}`:"Stored locally in this browser profile",At=()=>{N(_t(l))},Ut=async s=>{s.preventDefault(),Pe(null);const d=ws(ze);if(!d){Pe("Enter a valid URL.");return}Xe(!0);try{await G(c,"/library",{method:"POST",body:JSON.stringify({kind:"url",url:d,title:Je.trim()||void 0,note:qe.trim()||void 0,purpose:Ze})}),He(""),Ge(""),Ve(""),Ye("replace"),await Q(!0),o("library")}catch(P){Pe(P.message||"Unable to save.")}finally{Xe(!1)}},Wt=async s=>{if(!(!s.id||s.consumedAt))try{const d=await G(c,`/library/${s.id}`,{method:"PATCH",body:JSON.stringify({consumedAt:new Date().toISOString()})});J(P=>P.map(_=>_.id===d.id?d:_))}catch(d){S(d.message||"Unable to mark item complete.")}},Mt=async s=>{s.preventDefault(),rt(!0);try{const d=xs(new Date),P=tt.trim(),_=await G(c,"/settings/daily-onboarding",{method:"POST",body:JSON.stringify({lastPromptedDay:d,note:P?{day:d,message:P,deliveredAt:null,acknowledged:!1}:null})});Ke(_),Re(_.note?.message??""),Dt(Date.now())}catch(d){S(d.message||"Unable to save note.")}finally{rt(!1)}},pt=Be?.note?.day?yt(Be.note.day):null;return e.jsxs("div",{className:"app-shell web-home-shell",children:[e.jsxs("div",{className:"window-chrome",children:[e.jsxs("div",{className:"window-chrome-title","aria-hidden":!0,children:[e.jsx("div",{className:"title-dot"}),e.jsx("span",{children:"TimeWellSpent Web Home"})]}),e.jsxs("div",{className:"window-chrome-meta",children:[e.jsx("span",{className:`pill ${L?"success":"danger"}`,children:L?"API connected":"API offline"}),e.jsxs("span",{className:"pill ghost big",children:[q.balance," f-coins"]})]})]}),e.jsxs("aside",{className:"sidebar",children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"logo",children:"⏳"}),e.jsx("span",{children:"Homepage"})]}),e.jsxs("nav",{className:"nav-menu",children:[e.jsx("button",{className:r==="home"?"active":"",onClick:()=>o("home"),children:"Home"}),e.jsx("button",{className:r==="library"?"active":"",onClick:()=>o("library"),children:"Library"}),e.jsx("button",{className:r==="capture"?"active":"",onClick:()=>o("capture"),children:"Capture"})]}),e.jsxs("div",{className:"wallet-summary",children:[e.jsxs("div",{className:"balance",children:[e.jsx("span",{className:"coin",children:"🪙"}),e.jsx("span",{className:"amount",children:q.balance})]}),e.jsx("div",{className:"rate",children:k?`${k.productivityScore} focus score`:"Focus score unavailable"})]}),e.jsxs("div",{className:"web-api-config",children:[e.jsx("label",{htmlFor:"api-base",children:"Local API"}),e.jsx("input",{id:"api-base",value:l,onChange:s=>i(s.target.value),placeholder:Te}),e.jsx("button",{className:"primary",type:"button",onClick:At,children:"Connect"})]})]}),e.jsx("main",{className:"content web-home-main",children:e.jsxs("section",{className:"panel",children:[e.jsxs("header",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Safe Landing"}),e.jsx("p",{className:"subtle",children:"Orient, choose your next move, and keep the day intentional."})]}),e.jsxs("div",{className:"web-header-actions",children:[e.jsx("span",{className:"pill ghost",children:new Date(V).toLocaleString([],{dateStyle:"medium",timeStyle:"short"})}),e.jsx("button",{type:"button",onClick:()=>Q(),children:E?"Refreshing...":"Refresh"})]})]}),se&&e.jsx("div",{className:"card web-inline-error",children:se}),B&&e.jsx("div",{className:"card web-inline-notice",children:B}),y?e.jsx("div",{className:"card",children:"Loading homepage..."}):null,!y&&r==="home"&&e.jsxs("div",{className:"panel-body web-home-grid",children:[e.jsxs("article",{className:`card web-full-width web-reader-stage ${ae?"drag-active":""}`,onDragEnter:s=>{s.preventDefault(),C(!0)},onDragOver:s=>{s.preventDefault(),ae||C(!0)},onDragLeave:s=>{s.preventDefault(),!s.currentTarget.contains(s.relatedTarget)&&C(!1)},onDrop:s=>{s.preventDefault(),C(!1),at(Array.from(s.dataTransfer.files??[]))},children:[e.jsxs("div",{className:"web-reader-stage-grid",children:[e.jsxs("div",{className:"web-reader-stage-copy",children:[e.jsx("p",{className:"eyebrow",children:"Reading Room"}),e.jsx("h2",{children:"Put books and papers directly into TimeWellSpent"}),e.jsx("p",{className:"subtle",children:"Local-first browser shelf for PDF/EPUB reading. Open the homepage, click a cover, and continue where your attention already is."}),e.jsxs("div",{className:"web-reader-chip-row",children:[e.jsxs("span",{className:"pill ghost big",children:[W.length," books"]}),e.jsxs("span",{className:"pill ghost",children:[Ee.pdf," PDFs"]}),e.jsxs("span",{className:"pill ghost",children:[Ee.epub," EPUBs"]}),e.jsxs("span",{className:"pill ghost",children:[Ee.opened," opened"]})]}),e.jsxs("div",{className:"web-reader-actions",children:[e.jsx("button",{className:"primary",type:"button",onClick:()=>we.current?.click(),disabled:m,children:m?"Uploading...":"Upload PDF / EPUB"}),e.jsx("button",{type:"button",onClick:()=>void it(),children:"Open Random Local Book"})]}),e.jsx("p",{className:"subtle web-reader-footnote",children:Lt}),e.jsx("input",{ref:we,type:"file",accept:".pdf,.epub,application/pdf,application/epub+zip",multiple:!0,hidden:!0,onChange:s=>{const d=Array.from(s.target.files??[]);s.target.value="",at(d)}}),Z?e.jsx("p",{className:"subtle web-reader-error",children:Z}):null]}),e.jsx("div",{className:"web-reader-stage-spotlight",children:p?e.jsx("div",{className:"web-reader-empty",children:e.jsx("strong",{children:"Loading your local shelf…"})}):re?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"web-reader-cover-button",onClick:()=>void he(re),"aria-label":`Open ${re.title}`,children:e.jsxs("span",{className:"web-reader-cover",style:{background:St(re.title)},"aria-hidden":"true",children:[e.jsx("span",{className:"web-reader-cover-badge",children:Me(re)}),e.jsx("span",{className:"web-reader-cover-title",children:re.title}),e.jsx("span",{className:"web-reader-cover-meta",children:ye(re.sizeBytes)})]})}),e.jsxs("div",{className:"web-reader-spotlight-copy",children:[e.jsx("span",{className:"pill ghost",children:"Featured on shelf"}),e.jsx("strong",{children:re.title}),e.jsx("span",{className:"subtle",children:re.fileName}),e.jsxs("div",{className:"web-item-actions",children:[e.jsx("button",{type:"button",onClick:()=>void he(re),children:"Read"}),e.jsx("button",{type:"button",onClick:()=>void ot(re),children:"Remove"})]})]})]}):e.jsxs("div",{className:"web-reader-empty",children:[e.jsx("strong",{children:"Drag files here to build your shelf"}),e.jsx("p",{className:"subtle",children:"PDF and EPUB uploads are stored locally in this browser profile for fast access."})]})})]}),ht.length?e.jsx("div",{className:"web-reader-shelf-grid",children:ht.map(s=>e.jsxs("article",{className:`web-reader-shelf-card ${u?.book.id===s.id?"active":""}`,children:[e.jsx("button",{type:"button",className:"web-reader-shelf-card-coverButton",onClick:()=>void he(s),"aria-label":`Open ${s.title}`,children:e.jsxs("span",{className:"web-reader-shelf-card-cover",style:{background:St(s.title)},"aria-hidden":"true",children:[e.jsx("span",{className:"web-reader-shelf-card-format",children:Me(s)}),e.jsx("span",{className:"web-reader-shelf-card-title",children:s.title})]})}),e.jsxs("div",{className:"web-reader-shelf-card-body",children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.title}),e.jsx("span",{className:"subtle",children:s.fileName}),e.jsx("span",{className:"subtle",children:ye(s.sizeBytes)})]}),e.jsxs("div",{className:"web-item-actions",children:[e.jsx("button",{type:"button",onClick:()=>void he(s),children:"Open"}),e.jsx("button",{type:"button",onClick:()=>void ot(s),children:"Delete"})]})]})]},s.id))}):null]}),e.jsx(ls,{apiBase:c,surface:"web-homepage",variant:"web"}),e.jsxs("article",{className:"card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Literary Stats"}),e.jsx("span",{className:"pill ghost",children:R?`${R.periodDays}d window`:"No data yet"})]}),e.jsxs("div",{className:"web-stat-grid",children:[e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Today Pages"}),e.jsx("strong",{children:R?.today.pagesRead??0})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Today Words"}),e.jsx("strong",{children:(R?.today.wordsRead??0).toLocaleString()})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Reading Time"}),e.jsx("strong",{children:ke(R?.today.activeSeconds??0)})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Pages / Hour"}),e.jsx("strong",{children:R?.pace.pagesPerHour?.toFixed(1)??"0.0"})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Annotations Today"}),e.jsx("strong",{children:R?.annotations.todayTotal??0})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Total Annotations"}),e.jsx("strong",{children:R?.annotations.total??0})]})]}),R?.currentBook?e.jsxs("div",{className:"web-reader-currentBook",children:[e.jsx("strong",{children:R.currentBook.title}),e.jsxs("span",{className:"subtle",children:[R.currentBook.totalPages?`${R.currentBook.currentPage??0}/${R.currentBook.totalPages} · `:"",R.currentBook.progress!=null?`${Math.round(R.currentBook.progress*100)}% complete`:"In progress"]})]}):e.jsx("p",{className:"subtle",children:"Open a local book to start literary session tracking."})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{children:"Literary Trend"}),R?.daily?.length?e.jsx("div",{className:"web-literary-bars",children:R.daily.map(s=>{const d=Math.max(1,...R.daily.map(_=>_.wordsRead)),P=Math.round(s.wordsRead/d*100);return e.jsxs("div",{className:"web-literary-barRow",children:[e.jsxs("div",{className:"web-literary-barMeta",children:[e.jsx("span",{children:yt(s.day)}),e.jsxs("span",{children:[s.pagesRead,"p · ",s.wordsRead.toLocaleString(),"w"]})]}),e.jsx("div",{className:"web-category-bar web-literary-bar",children:e.jsx("span",{style:{width:`${Math.max(s.wordsRead>0?4:0,P)}%`}})})]},s.day)})}):e.jsx("p",{className:"subtle",children:"No literary activity tracked yet."}),R?.insights?.length?e.jsx("ul",{className:"web-insight-list",children:R.insights.map(s=>e.jsx("li",{children:s},s))}):null]}),e.jsxs("article",{className:"card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Today Compass"}),e.jsx("span",{className:"pill ghost",children:k?`${k.periodDays}d lens`:"Local view"})]}),e.jsxs("div",{className:"web-stat-grid",children:[e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Active"}),e.jsx("strong",{children:K?ke(K.totalSeconds):"0m"})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Deep Work"}),e.jsx("strong",{children:K?ke(K.deepWorkSeconds):"0m"})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Focus Score"}),e.jsx("strong",{children:k?k.productivityScore:0})]}),e.jsxs("div",{className:"web-stat",children:[e.jsx("span",{className:"subtle",children:"Sessions"}),e.jsx("strong",{children:k?k.totalSessions:0})]})]}),e.jsxs("div",{className:"web-pill-row",children:[e.jsxs("span",{className:"pill success",children:["Peak ",k?`${k.peakProductiveHour}:00`:"--"]}),e.jsxs("span",{className:"pill warning",children:["Risk ",k?`${k.riskHour}:00`:"--"]}),e.jsx("span",{className:"pill ghost",children:dt?`Best block ${dt.hour}:00`:"No block yet"})]})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{children:"Attention Mix"}),e.jsxs("div",{className:"web-category-list",children:[e.jsxs("div",{className:"web-category-row",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Productive"}),e.jsx("strong",{children:Ue(k?.categoryBreakdown.productive??0)})]}),e.jsx("div",{className:"web-category-bar",children:e.jsx("span",{style:{width:`${We(k?.categoryBreakdown.productive??0,De)}%`}})})]}),e.jsxs("div",{className:"web-category-row",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Neutral"}),e.jsx("strong",{children:Ue(k?.categoryBreakdown.neutral??0)})]}),e.jsx("div",{className:"web-category-bar neutral",children:e.jsx("span",{style:{width:`${We(k?.categoryBreakdown.neutral??0,De)}%`}})})]}),e.jsxs("div",{className:"web-category-row",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Frivolity"}),e.jsx("strong",{children:Ue(k?.categoryBreakdown.frivolity??0)})]}),e.jsx("div",{className:"web-category-bar frivolity",children:e.jsx("span",{style:{width:`${We(k?.categoryBreakdown.frivolity??0,De)}%`}})})]})]})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{children:"Top Contexts"}),ct.length?e.jsx("ul",{className:"web-list",children:ct.map(s=>e.jsxs("li",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.label}),e.jsx("span",{className:"subtle",children:s.category??"uncategorized"})]}),e.jsx("span",{children:ke(s.seconds)})]},`${s.label}-${s.seconds}`))}):e.jsx("p",{className:"subtle",children:"No context data yet."})]}),e.jsxs("article",{className:"card",children:[e.jsx("h2",{children:"Refresh Shelf"}),ut.length?e.jsx("ul",{className:"web-list",children:ut.map(s=>e.jsxs("li",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.title}),e.jsx("span",{className:"subtle",children:s.subtitle})]}),e.jsxs("div",{className:"web-item-actions",children:[s.type==="library"?e.jsx("span",{className:"pill ghost",children:vt(s.purpose)}):null,s.type==="reading"&&typeof s.progress=="number"?e.jsxs("span",{className:"pill ghost",children:[Math.round(s.progress*100),"%"]}):null,s.url?e.jsx("a",{href:s.url,target:"_blank",rel:"noreferrer",children:"Open"}):e.jsx("span",{className:"subtle",children:"Desktop only"})]})]},s.id))}):e.jsx("p",{className:"subtle",children:"No items in your shelf yet."})]}),e.jsxs("article",{className:"card web-full-width",children:[e.jsx("h2",{children:"Current Insight Feed"}),k?.insights?.length?e.jsx("ul",{className:"web-insight-list",children:k.insights.map(s=>e.jsx("li",{children:s},s))}):e.jsx("p",{className:"subtle",children:"Insights will appear once enough activity is collected."})]})]}),!y&&r==="library"&&e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header-row",children:[e.jsx("h2",{children:"Library"}),e.jsxs("div",{className:"web-item-actions",children:[e.jsxs("span",{className:"pill ghost",children:[I.length," items"]}),e.jsx("button",{type:"button",onClick:()=>void it(),children:"Random Local Book"})]})]}),I.length?e.jsx("ul",{className:"web-list",children:I.slice(0,40).map(s=>e.jsxs("li",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.title??s.domain}),e.jsxs("span",{className:"subtle",children:[vt(s.purpose),s.consumedAt?` • done ${new Date(s.consumedAt).toLocaleDateString()}`:""]})]}),e.jsxs("div",{className:"web-item-actions",children:[s.url?e.jsx("a",{href:s.url,target:"_blank",rel:"noreferrer",children:"Open"}):null,s.consumedAt?null:e.jsx("button",{type:"button",onClick:()=>Wt(s),children:"Done"})]})]},s.id))}):e.jsx("p",{className:"subtle",children:"Your library is empty. Capture a few URLs to start."})]}),!y&&r==="capture"&&e.jsxs("div",{className:"web-capture-grid",children:[e.jsxs("form",{className:"card",onSubmit:Ut,children:[e.jsx("h2",{children:"Quick Capture"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"capture-url",children:"URL"}),e.jsx("input",{id:"capture-url",value:ze,onChange:s=>He(s.target.value),placeholder:"https://..."})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"capture-title",children:"Title (optional)"}),e.jsx("input",{id:"capture-title",value:Je,onChange:s=>Ge(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"capture-purpose",children:"Purpose"}),e.jsxs("select",{id:"capture-purpose",value:Ze,onChange:s=>Ye(s.target.value),children:[e.jsx("option",{value:"replace",children:"Replace"}),e.jsx("option",{value:"productive",children:"Productive"}),e.jsx("option",{value:"allow",children:"Allow"}),e.jsx("option",{value:"temptation",children:"Temptation"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"capture-note",children:"Note (optional)"}),e.jsx("textarea",{id:"capture-note",rows:4,value:qe,onChange:s=>Ve(s.target.value)})]}),et?e.jsx("p",{className:"subtle",children:et}):null,e.jsx("div",{className:"form-actions",children:e.jsx("button",{className:"primary",type:"submit",disabled:Qe,children:Qe?"Saving...":"Save to Library"})})]}),e.jsxs("form",{className:"card",onSubmit:Mt,children:[e.jsx("h2",{children:"Daily Orientation Note"}),e.jsx("p",{className:"subtle",children:pt?`Current note for ${pt}.`:"Set the note you want to see later today."}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"daily-note",children:"Note"}),e.jsx("textarea",{id:"daily-note",rows:8,value:tt,onChange:s=>Re(s.target.value)})]}),e.jsxs("div",{className:"form-actions",children:[nt?e.jsxs("span",{className:"pill success",children:["Saved ",new Date(nt).toLocaleTimeString()]}):null,e.jsx("button",{className:"primary",type:"submit",disabled:st,children:st?"Saving...":"Save Note"})]})]})]})]})}),u?e.jsx("div",{className:"web-reader-overlay",role:"dialog","aria-modal":"true","aria-label":`Reading ${u.book.title}`,onClick:Ne,children:e.jsxs("div",{className:"web-reader-overlay-panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("header",{className:"web-reader-overlay-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Browser Reader"}),e.jsx("h2",{children:u.book.title}),e.jsxs("p",{className:"subtle",children:[u.book.fileName," · ",Me(u.book)," · ",ye(u.book.sizeBytes)]})]}),e.jsxs("div",{className:"web-item-actions",children:[e.jsx("button",{type:"button",onClick:()=>window.open(u.objectUrl,"_blank","noopener,noreferrer"),children:"Open in Tab"}),e.jsx("a",{href:u.objectUrl,download:u.book.fileName,children:"Download"}),e.jsx("button",{type:"button",onClick:Ne,children:"Close"})]})]}),e.jsx("div",{className:"web-reader-overlay-frameWrap",children:e.jsxs("div",{className:"web-reader-overlay-readingGrid",children:[e.jsx("div",{className:"web-reader-overlay-readerPane",children:e.jsx(Yt,{src:u.objectUrl,format:u.book.format,title:u.book.title,onSnapshotChange:Et})}),e.jsxs("aside",{className:"web-reader-annotations","aria-label":"Reader annotations",children:[e.jsxs("div",{className:"web-reader-annotations-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Annotations"}),e.jsx("h3",{children:"Highlights & Notes"})]}),e.jsxs("div",{className:"web-reader-chip-row",children:[e.jsxs("span",{className:"pill ghost",children:[a.length," total"]}),e.jsxs("span",{className:"pill ghost",children:[mt.highlights," highlights"]}),e.jsxs("span",{className:"pill ghost",children:[mt.notes," notes"]})]})]}),e.jsxs("div",{className:"web-reader-annotations-composer",children:[e.jsx("label",{htmlFor:"web-reader-note",className:"subtle",children:"Quick note at current location"}),e.jsx("textarea",{id:"web-reader-note",rows:4,value:Y,onChange:s=>ue(s.target.value),placeholder:"Capture a thought, quote, or synthesis...",disabled:le}),e.jsxs("div",{className:"web-item-actions",children:[e.jsx("button",{type:"button",onClick:()=>void lt("highlight"),disabled:le,children:le?"Saving...":"Highlight Spot"}),e.jsx("button",{type:"button",onClick:()=>void lt("note"),disabled:le,children:le?"Saving...":"Save Note"})]})]}),e.jsx("div",{className:"web-reader-annotations-listWrap",children:j?e.jsx("p",{className:"subtle",children:"Loading annotations..."}):a.length?e.jsx("ul",{className:"web-reader-annotations-list",children:a.map(s=>e.jsxs("li",{className:`web-reader-annotation-card kind-${s.kind}`,children:[e.jsxs("div",{className:"web-reader-annotation-card-header",children:[e.jsx("span",{className:`pill ghost ${s.kind==="note"?"success":""}`,children:s.kind==="note"?"Note":"Highlight"}),e.jsx("span",{className:"subtle",children:new Date(s.createdAt).toLocaleString([],{dateStyle:"short",timeStyle:"short"})})]}),e.jsxs("div",{className:"web-reader-annotation-card-meta",children:[e.jsx("strong",{children:s.locationLabel??"Current location"}),s.currentPage!=null?e.jsx("span",{className:"subtle",children:s.totalPages?`Page ${s.currentPage}/${s.totalPages}`:`Page ${s.currentPage}`}):null]}),s.selectedText?e.jsx("blockquote",{className:"web-reader-annotation-quote",children:s.selectedText}):null,s.noteText?e.jsx("p",{className:"web-reader-annotation-note",children:s.noteText}):null,e.jsx("div",{className:"web-item-actions",children:e.jsx("button",{type:"button",onClick:()=>void $t(s.id),disabled:le,children:"Delete"})})]},s.id))}):e.jsx("p",{className:"subtle",children:"Save location-based highlights or notes while you read. This feeds Literary Analytics and productive totals."})})]})]})}),u.book.format==="epub"?e.jsx("p",{className:"subtle web-reader-overlay-hint",children:"EPUB rendering depends on browser support. If this file doesn’t render inline, use “Open in Tab”."}):null]})}):null]})}Ft.createRoot(document.getElementById("root")).render(e.jsx(Bt.StrictMode,{children:e.jsx(ys,{})}));
//# sourceMappingURL=home-BL_c-Mxg.js.map
