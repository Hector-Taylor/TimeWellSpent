import{r as a,j as e,c as Z}from"../assets/client.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))d(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&d(u)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function d(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();function ee(){const[r,i]=a.useState(null),[t,d]=a.useState(null),[n,o]=a.useState(null),[u,$]=a.useState(null),[U,_]=a.useState(!0),[p,f]=a.useState(!1),[N,c]=a.useState(null),[D,W]=a.useState(Date.now()),[g,L]=a.useState("replace"),[b,F]=a.useState("frivolous"),[C,T]=a.useState(""),[I,G]=a.useState(!1),[P,O]=a.useState(""),[S,j]=a.useState(!1),[R,k]=a.useState(12),y=a.useCallback(async()=>{const s=await se();d(s);const m=await chrome.runtime.sendMessage({type:"GET_CONNECTION"});if(i(m),s){const h=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:{domain:s.domain,url:s.url}});o(h)}else o(null)},[]);a.useEffect(()=>{y().finally(()=>_(!1))},[y]),a.useEffect(()=>{const s=window.setInterval(()=>W(Date.now()),1e3);return()=>window.clearInterval(s)},[]),a.useEffect(()=>{const s=window.setInterval(()=>{y()},5e3);return()=>window.clearInterval(s)},[y]),a.useEffect(()=>{if(!t?.url){$(null);return}chrome.runtime.sendMessage({type:"GET_LINK_PREVIEWS",payload:{urls:[t.url]}}).then(s=>{if(!s?.success||!s.previews)return;const m=M(t.url),h=s.previews[m]??null;$(h)}).catch(()=>{})},[t?.url]),a.useEffect(()=>{c(null)},[t?.url]),a.useEffect(()=>{if(!t)return;const s=n?.library?.items?.find(h=>!h||h.kind!=="url"||!h.url?!1:M(h.url)===M(t.url))??null,m=s?.purpose??"replace";L(m),m==="allow"&&typeof s?.price=="number"?(j(!0),k(s.price)):(j(!1),k(12)),I||T(s?.title??t.title),O(s?.note??"")},[t,n?.library?.items,I]);const l=a.useMemo(()=>!t?.domain||!r?null:r.sessions[t.domain]??null,[t?.domain,r]),E=l?.paused||n?.session?.paused,q=l?.remainingSeconds??n?.session?.remainingSeconds??0,A=l?.mode==="pack"&&l.purchasePrice&&l.purchasedSeconds&&l.purchasedSeconds>0?Math.round(l.remainingSeconds/l.purchasedSeconds*l.purchasePrice):null,x=r?.lastFrivolityAt??null,w=x?Math.max(0,D-x):null,z=4320*60*1e3,v=w?Math.min(1,w/z):0,B=Math.round(20+30*v),K=Math.round(48+18*v),Y=w?`hsl(${B} 70% ${K}%)`:"rgba(200, 149, 108, 0.7)",H=r?x===null?"No frivolity logged":ae(w??0):"Loading...";async function Q(){if(t){f(!0),c(null);try{const s=await chrome.runtime.sendMessage({type:"UPSERT_LIBRARY_ITEM",payload:{url:t.url,purpose:g,price:g==="allow"&&S?R:null,title:C.trim()||t.title,note:P.trim()||null}});if(!s?.success)throw new Error(s?.error??"Could not save to library.");const m=s.action==="updated"?"Updated":"Saved",h=s.synced?"Synced to desktop.":"Will sync when desktop is running.";c({kind:"success",text:`${m} in Library. ${h}`})}catch(s){c({kind:"error",text:s.message})}finally{f(!1)}}}async function V(){if(t){f(!0),c(null);try{const s=await chrome.runtime.sendMessage({type:"SET_DOMAIN_CATEGORY",payload:{domain:t.domain,category:b}});if(!s?.success)throw new Error(s?.error??"Could not update domain.");const m=s.synced?"Synced to desktop.":"Will sync when desktop is running.";c({kind:"success",text:`Marked ${t.domain} as ${b}. ${m}`})}catch(s){c({kind:"error",text:s.message})}finally{f(!1)}}}async function J(){if(t?.domain){f(!0);try{E?await chrome.runtime.sendMessage({type:"RESUME_SESSION",payload:{domain:t.domain}}):await chrome.runtime.sendMessage({type:"PAUSE_SESSION",payload:{domain:t.domain}}),await y()}finally{f(!1)}}}async function X(){if(t?.domain){f(!0);try{const s=await chrome.runtime.sendMessage({type:"END_SESSION",payload:{domain:t.domain}});await y(),s?.success?s?.refund&&s.refund>0?c({kind:"success",text:`Session ended. Refunded ${s.refund} coins.`}):c({kind:"success",text:"Session ended and blocked."}):c({kind:"error",text:s?.error??"Could not end session."})}catch(s){c({kind:"error",text:s.message})}finally{f(!1)}}}return U?e.jsx("div",{className:"panel",children:"Loading..."}):e.jsxs("div",{className:"panel",children:[e.jsxs("header",{className:"popup-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"TimeWellSpent"}),e.jsx("h1",{children:"Quick actions"})]}),e.jsx("div",{className:`status-pill ${r?.desktopConnected?"on":"off"}`,children:r?.desktopConnected?"Desktop linked":"Offline"})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill",children:[n?.balance??0," f-coins"]}),e.jsxs("span",{className:"pill ghost",children:["Last sync ",r?.lastSync?te(r.lastSync):"never"]})]}),e.jsxs("section",{className:`card streak-card ${v>=1?"streak-max":""}`,style:{"--streak-color":Y,"--streak-progress":`${Math.round(v*100)}%`},children:[e.jsxs("div",{className:"streak-header",children:[e.jsx("span",{className:"eyebrow",children:"Recovery timer"}),e.jsx("span",{className:"pill ghost",children:"Goal: 3 days"})]}),e.jsx("h2",{children:"Time since last frivolity"}),e.jsx("div",{className:"streak-time",children:H}),e.jsx("div",{className:"streak-meta",children:e.jsx("span",{className:"hint",children:x?`Last spend ${new Date(x).toLocaleString()}`:"No paid sessions yet."})}),e.jsx("div",{className:"streak-bar","aria-hidden":!0,children:e.jsx("span",{})})]}),t?e.jsxs("section",{className:"card preview-card",children:[e.jsxs("div",{className:"preview-thumb",children:[u?.imageUrl?e.jsx("img",{src:u.imageUrl,alt:""}):e.jsx("div",{className:"preview-placeholder","aria-hidden":"true"}),u?.iconUrl&&e.jsx("img",{className:"preview-favicon",src:u.iconUrl,alt:""})]}),e.jsxs("div",{className:"preview-meta",children:[e.jsx("strong",{children:u?.title??t.title}),e.jsx("span",{children:u?.description??t.url}),e.jsx("small",{children:t.domain})]})]}):e.jsxs("section",{className:"card",children:[e.jsx("strong",{children:"No active page"}),e.jsx("span",{children:"Open a web page to save it to your Library."})]}),N&&e.jsx("div",{className:`notice ${N.kind}`,children:N.text}),t&&e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Save this page"}),e.jsx("div",{className:"chip-row",children:["replace","productive","allow","temptation"].map(s=>e.jsx("button",{type:"button",className:`chip ${g===s?"active":""}`,onClick:()=>{L(s),s!=="allow"&&j(!1)},disabled:p,children:s},s))}),g==="allow"&&e.jsx("div",{className:"inline-row",children:e.jsxs("label",{className:"field compact",children:[e.jsxs("span",{style:{display:"flex",gap:8,alignItems:"center",justifyContent:"space-between"},children:[e.jsx("span",{children:"One-time unlock"}),e.jsx("input",{type:"checkbox",checked:S,onChange:s=>j(s.target.checked),disabled:p})]}),e.jsx("input",{type:"number",min:"1",value:R,onChange:s=>k(Number(s.target.value)),disabled:p||!S})]})}),e.jsxs("label",{className:"field",children:["Title",e.jsx("input",{type:"text",value:C,onChange:s=>{T(s.target.value),G(!0)},placeholder:t.title})]}),e.jsxs("label",{className:"field",children:["Note (optional)",e.jsx("textarea",{value:P,onChange:s=>O(s.target.value),placeholder:"Why do you want to see this later?",rows:2})]}),e.jsx("button",{className:"primary",disabled:p,onClick:Q,children:"Add to Library"}),e.jsx("small",{className:"hint",children:"Replace shows up in “Try this instead”. Productive items count as productive time. Priced Allow items appear under “Proceed anyway” when you land on that exact URL."})]}),t&&e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Label this domain"}),e.jsx("div",{className:"chip-row",children:["productive","neutral","frivolous"].map(s=>e.jsx("button",{type:"button",className:`chip ${b===s?"active":""}`,onClick:()=>F(s),disabled:p,children:s},s))}),e.jsx("button",{className:"secondary",disabled:p,onClick:V,children:"Apply label"})]}),t&&e.jsxs("details",{className:"card collapse",children:[e.jsx("summary",{children:"Session controls"}),l?e.jsxs("div",{className:"session-body",children:[e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Mode"}),e.jsx("span",{className:"pill ghost",children:l.mode})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Status"}),e.jsx("span",{children:E?"Paused":l.mode==="emergency"?"Emergency":"Spending"})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Remaining"}),e.jsx("span",{children:l.mode==="metered"||l.mode==="emergency"?"∞":ne(q)})]}),e.jsx("small",{className:"hint",children:l.mode==="metered"?"Ending stops spend immediately and re-blocks this tab.":l.mode==="emergency"?`Free access - ${l.justification||"emergency override"}`:`Ending early refunds unused time${A?` (~${A} coins)`:""}.`}),e.jsxs("div",{className:"button-stack",children:[e.jsx("button",{className:"danger",disabled:p,onClick:X,children:"End session"}),e.jsx("button",{className:"secondary",disabled:p,onClick:J,children:E?"Resume spending":"Pause spending"})]})]}):e.jsx("span",{className:"hint",children:"No session for this tab."})]})]})}async function se(){const r=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r.length||!r[0].url)return null;const i=r[0],t=i.url;if(!t)return null;try{const d=new URL(t);if(!d.protocol.startsWith("http"))return null;const n=d.hostname.replace(/^www\./,"");return{url:t,title:i.title??n,domain:n}}catch{return null}}function M(r){try{const i=new URL(r);return i.hash="",i.toString()}catch{return r}}function te(r){const i=Math.floor((Date.now()-r)/1e3);return i<60?"just now":i<3600?`${Math.floor(i/60)}m ago`:i<86400?`${Math.floor(i/3600)}h ago`:`${Math.floor(i/86400)}d ago`}function ne(r){return`${Math.max(1,Math.round(r/60))} min`}function ae(r){const i=Math.max(0,Math.floor(r/6e4)),t=Math.floor(i/1440),d=Math.floor(i%1440/60),n=i%60;return t>0?`${t}d ${d}h ${n}m`:`${d}h ${n}m`}Z.createRoot(document.getElementById("root")).render(e.jsx(a.StrictMode,{children:e.jsx(ee,{})}));
