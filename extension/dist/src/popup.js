import{r as c,j as e,c as M}from"../assets/client.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))m(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&m(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function m(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();function v(){const[n,o]=c.useState(null),[t,m]=c.useState(null),[s,a]=c.useState(null),[l,j]=c.useState(!0),[g,d]=c.useState(null),[S,f]=c.useState(!1);c.useEffect(()=>{async function i(){const u=await O();m(u);const p=await chrome.runtime.sendMessage({type:"GET_CONNECTION"});if(o(p),u){const b=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:{domain:u}});a(b)}j(!1)}i()},[]);const y=async i=>{const u=await chrome.runtime.sendMessage({type:"GET_CONNECTION"});if(o(u),i){const p=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:{domain:i}});a(p)}},r=c.useMemo(()=>!t||!n?null:n.sessions[t]??null,[t,n]),h=r?.paused||s?.session?.paused,N=r?.remainingSeconds??s?.session?.remainingSeconds??0;c.useEffect(()=>{d(null)},[t]);const x=r?.mode==="pack"&&r.purchasePrice&&r.purchasedSeconds&&r.purchasedSeconds>0?Math.round(r.remainingSeconds/r.purchasedSeconds*r.purchasePrice):null;c.useEffect(()=>{r&&d(null)},[r?.mode]);async function E(){if(t){f(!0),d(null);try{h?await chrome.runtime.sendMessage({type:"RESUME_SESSION",payload:{domain:t}}):await chrome.runtime.sendMessage({type:"PAUSE_SESSION",payload:{domain:t}}),await y(t)}catch{d("Could not update the session state.")}finally{f(!1)}}}async function w(){if(t){f(!0),d(null);try{const i=await chrome.runtime.sendMessage({type:"END_SESSION",payload:{domain:t}});await y(t),i?.success?i?.refund&&i.refund>0?d(`Session ended. Refunded ${i.refund} coins.`):d("Session ended and blocked."):d(i?.error??"Could not end this session.")}catch{d("Could not end this session.")}finally{f(!1)}}}return l?e.jsx("div",{className:"panel",children:"Loadingâ€¦"}):e.jsxs("div",{className:"panel",children:[e.jsxs("div",{className:"banner",children:[e.jsx("span",{className:`badge ${n?.desktopConnected?"on":"off"}`,children:n?.desktopConnected?"Desktop linked":"Offline"}),e.jsxs("div",{children:[e.jsx("strong",{children:"TimeWellSpent Companion"}),e.jsx("br",{}),e.jsxs("small",{children:["Last sync ",n?.lastSync?T(n.lastSync):"never"]})]})]}),t&&e.jsxs("div",{className:"session-card",children:[e.jsxs("div",{className:"row",children:[e.jsx("strong",{children:t}),e.jsx("span",{className:"badge",children:r?.mode??"blocked"})]}),r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Status"}),e.jsx("span",{children:h?"Paused":"Spending"})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Remaining"}),e.jsx("span",{children:r.mode==="metered"?"Metered":C(N)})]}),e.jsx("small",{className:"note",children:r.mode==="metered"?"Ending stops spend immediately and re-blocks this tab.":`Ending early refunds unused time${x?` (~${x} coins)`:""}.`}),e.jsxs("div",{className:"button-stack",children:[e.jsx("button",{className:"danger",disabled:S,onClick:w,children:"End session"}),e.jsx("button",{className:"secondary",disabled:S,onClick:E,children:h?"Resume spending":"Pause spending"})]})]}):e.jsx("div",{className:"row",children:e.jsx("span",{children:"No session for this tab."})}),g&&e.jsx("div",{className:"session-note",children:g})]})]})}async function O(){const n=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n.length||!n[0].url)return null;try{return new URL(n[0].url).hostname.replace(/^www\./,"")}catch{return null}}function T(n){const o=Math.floor((Date.now()-n)/1e3);return o<60?"just now":o<3600?`${Math.floor(o/60)}m ago`:o<86400?`${Math.floor(o/3600)}h ago`:`${Math.floor(o/86400)}d ago`}function C(n){return`${Math.max(1,Math.round(n/60))} min`}M.createRoot(document.getElementById("root")).render(e.jsx(c.StrictMode,{children:e.jsx(v,{})}));
