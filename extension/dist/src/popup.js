import{r,j as e,c as z}from"../assets/client.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))f(t);new MutationObserver(t=>{for(const c of t)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&f(d)}).observe(document,{childList:!0,subtree:!0});function n(t){const c={};return t.integrity&&(c.integrity=t.integrity),t.referrerPolicy&&(c.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?c.credentials="include":t.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function f(t){if(t.ep)return;t.ep=!0;const c=n(t);fetch(t.href,c)}})();function B(){const[a,i]=r.useState(null),[n,f]=r.useState(null),[t,c]=r.useState(null),[d,E]=r.useState(null),[O,R]=r.useState(!0),[p,h]=r.useState(!1),[j,o]=r.useState(null),[x,k]=r.useState("replace"),[w,U]=r.useState("frivolous"),[M,C]=r.useState(""),[T,A]=r.useState(!1),[I,P]=r.useState(""),[b,g]=r.useState(!1),[L,v]=r.useState(12),y=r.useCallback(async()=>{const s=await F();f(s);const u=await chrome.runtime.sendMessage({type:"GET_CONNECTION"});if(i(u),s){const m=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:{domain:s.domain,url:s.url}});c(m)}else c(null)},[]);r.useEffect(()=>{y().finally(()=>R(!1))},[y]),r.useEffect(()=>{const s=window.setInterval(()=>{y()},5e3);return()=>window.clearInterval(s)},[y]),r.useEffect(()=>{if(!n?.url){E(null);return}chrome.runtime.sendMessage({type:"GET_LINK_PREVIEWS",payload:{urls:[n.url]}}).then(s=>{if(!s?.success||!s.previews)return;const u=S(n.url),m=s.previews[u]??null;E(m)}).catch(()=>{})},[n?.url]),r.useEffect(()=>{o(null)},[n?.url]),r.useEffect(()=>{if(!n)return;const s=t?.library?.items?.find(m=>!m||m.kind!=="url"||!m.url?!1:S(m.url)===S(n.url))??null,u=s?.purpose??"replace";k(u),u==="allow"&&typeof s?.price=="number"?(g(!0),v(s.price)):(g(!1),v(12)),T||C(s?.title??n.title),P(s?.note??"")},[n,t?.library?.items,T]);const l=r.useMemo(()=>!n?.domain||!a?null:a.sessions[n.domain]??null,[n?.domain,a]),N=l?.paused||t?.session?.paused,_=l?.remainingSeconds??t?.session?.remainingSeconds??0,$=l?.mode==="pack"&&l.purchasePrice&&l.purchasedSeconds&&l.purchasedSeconds>0?Math.round(l.remainingSeconds/l.purchasedSeconds*l.purchasePrice):null;async function W(){if(n){h(!0),o(null);try{const s=await chrome.runtime.sendMessage({type:"UPSERT_LIBRARY_ITEM",payload:{url:n.url,purpose:x,price:x==="allow"&&b?L:null,title:M.trim()||n.title,note:I.trim()||null}});if(!s?.success)throw new Error(s?.error??"Could not save to library.");const u=s.action==="updated"?"Updated":"Saved",m=s.synced?"Synced to desktop.":"Will sync when desktop is running.";o({kind:"success",text:`${u} in Library. ${m}`})}catch(s){o({kind:"error",text:s.message})}finally{h(!1)}}}async function D(){if(n){h(!0),o(null);try{const s=await chrome.runtime.sendMessage({type:"SET_DOMAIN_CATEGORY",payload:{domain:n.domain,category:w}});if(!s?.success)throw new Error(s?.error??"Could not update domain.");const u=s.synced?"Synced to desktop.":"Will sync when desktop is running.";o({kind:"success",text:`Marked ${n.domain} as ${w}. ${u}`})}catch(s){o({kind:"error",text:s.message})}finally{h(!1)}}}async function G(){if(n?.domain){h(!0);try{N?await chrome.runtime.sendMessage({type:"RESUME_SESSION",payload:{domain:n.domain}}):await chrome.runtime.sendMessage({type:"PAUSE_SESSION",payload:{domain:n.domain}}),await y()}finally{h(!1)}}}async function q(){if(n?.domain){h(!0);try{const s=await chrome.runtime.sendMessage({type:"END_SESSION",payload:{domain:n.domain}});await y(),s?.success?s?.refund&&s.refund>0?o({kind:"success",text:`Session ended. Refunded ${s.refund} coins.`}):o({kind:"success",text:"Session ended and blocked."}):o({kind:"error",text:s?.error??"Could not end session."})}catch(s){o({kind:"error",text:s.message})}finally{h(!1)}}}return O?e.jsx("div",{className:"panel",children:"Loading..."}):e.jsxs("div",{className:"panel",children:[e.jsxs("header",{className:"popup-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"TimeWellSpent"}),e.jsx("h1",{children:"Quick actions"})]}),e.jsx("div",{className:`status-pill ${a?.desktopConnected?"on":"off"}`,children:a?.desktopConnected?"Desktop linked":"Offline"})]}),e.jsxs("div",{className:"pill-row",children:[e.jsxs("span",{className:"pill",children:[t?.balance??0," f-coins"]}),e.jsxs("span",{className:"pill ghost",children:["Last sync ",a?.lastSync?K(a.lastSync):"never"]})]}),n?e.jsxs("section",{className:"card preview-card",children:[e.jsxs("div",{className:"preview-thumb",children:[d?.imageUrl?e.jsx("img",{src:d.imageUrl,alt:""}):e.jsx("div",{className:"preview-placeholder","aria-hidden":"true"}),d?.iconUrl&&e.jsx("img",{className:"preview-favicon",src:d.iconUrl,alt:""})]}),e.jsxs("div",{className:"preview-meta",children:[e.jsx("strong",{children:d?.title??n.title}),e.jsx("span",{children:d?.description??n.url}),e.jsx("small",{children:n.domain})]})]}):e.jsxs("section",{className:"card",children:[e.jsx("strong",{children:"No active page"}),e.jsx("span",{children:"Open a web page to save it to your Library."})]}),j&&e.jsx("div",{className:`notice ${j.kind}`,children:j.text}),n&&e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Save this page"}),e.jsx("div",{className:"chip-row",children:["replace","productive","allow","temptation"].map(s=>e.jsx("button",{type:"button",className:`chip ${x===s?"active":""}`,onClick:()=>{k(s),s!=="allow"&&g(!1)},disabled:p,children:s},s))}),x==="allow"&&e.jsx("div",{className:"inline-row",children:e.jsxs("label",{className:"field compact",children:[e.jsxs("span",{style:{display:"flex",gap:8,alignItems:"center",justifyContent:"space-between"},children:[e.jsx("span",{children:"One-time unlock"}),e.jsx("input",{type:"checkbox",checked:b,onChange:s=>g(s.target.checked),disabled:p})]}),e.jsx("input",{type:"number",min:"1",value:L,onChange:s=>v(Number(s.target.value)),disabled:p||!b})]})}),e.jsxs("label",{className:"field",children:["Title",e.jsx("input",{type:"text",value:M,onChange:s=>{C(s.target.value),A(!0)},placeholder:n.title})]}),e.jsxs("label",{className:"field",children:["Note (optional)",e.jsx("textarea",{value:I,onChange:s=>P(s.target.value),placeholder:"Why do you want to see this later?",rows:2})]}),e.jsx("button",{className:"primary",disabled:p,onClick:W,children:"Add to Library"}),e.jsx("small",{className:"hint",children:"Replace shows up in “Try this instead”. Productive items count as productive time. Priced Allow items appear under “Proceed anyway” when you land on that exact URL."})]}),n&&e.jsxs("section",{className:"card",children:[e.jsx("h2",{children:"Label this domain"}),e.jsx("div",{className:"chip-row",children:["productive","neutral","frivolous"].map(s=>e.jsx("button",{type:"button",className:`chip ${w===s?"active":""}`,onClick:()=>U(s),disabled:p,children:s},s))}),e.jsx("button",{className:"secondary",disabled:p,onClick:D,children:"Apply label"})]}),n&&e.jsxs("details",{className:"card collapse",children:[e.jsx("summary",{children:"Session controls"}),l?e.jsxs("div",{className:"session-body",children:[e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Mode"}),e.jsx("span",{className:"pill ghost",children:l.mode})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Status"}),e.jsx("span",{children:N?"Paused":l.mode==="emergency"?"Emergency":"Spending"})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Remaining"}),e.jsx("span",{children:l.mode==="metered"||l.mode==="emergency"?"∞":Y(_)})]}),e.jsx("small",{className:"hint",children:l.mode==="metered"?"Ending stops spend immediately and re-blocks this tab.":l.mode==="emergency"?`Free access - ${l.justification||"emergency override"}`:`Ending early refunds unused time${$?` (~${$} coins)`:""}.`}),e.jsxs("div",{className:"button-stack",children:[e.jsx("button",{className:"danger",disabled:p,onClick:q,children:"End session"}),e.jsx("button",{className:"secondary",disabled:p,onClick:G,children:N?"Resume spending":"Pause spending"})]})]}):e.jsx("span",{className:"hint",children:"No session for this tab."})]})]})}async function F(){const a=await chrome.tabs.query({active:!0,currentWindow:!0});if(!a.length||!a[0].url)return null;const i=a[0],n=i.url;if(!n)return null;try{const f=new URL(n);if(!f.protocol.startsWith("http"))return null;const t=f.hostname.replace(/^www\./,"");return{url:n,title:i.title??t,domain:t}}catch{return null}}function S(a){try{const i=new URL(a);return i.hash="",i.toString()}catch{return a}}function K(a){const i=Math.floor((Date.now()-a)/1e3);return i<60?"just now":i<3600?`${Math.floor(i/60)}m ago`:i<86400?`${Math.floor(i/3600)}h ago`:`${Math.floor(i/86400)}d ago`}function Y(a){return`${Math.max(1,Math.round(a/60))} min`}z.createRoot(document.getElementById("root")).render(e.jsx(r.StrictMode,{children:e.jsx(B,{})}));
