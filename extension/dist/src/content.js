import{r as d,j as e,c as Pe}from"../assets/client.js";function ze(i){return Number.isInteger(i)?i.toString():i.toFixed(2).replace(/\.?0+$/,"")}function De(i,s,p){if(!i.length||s<=0)return[];const u=i.slice();let l=(p+1)*1103515245;const f=()=>(l=l*1103515245+12345>>>0,l/4294967295);for(let b=u.length-1;b>0;b-=1){const o=Math.floor(f()*(b+1));[u[b],u[o]]=[u[o],u[b]]}return u.slice(0,Math.min(s,u.length))}function Re(i){const s=Math.max(0,Math.floor(i)),p=Math.floor(s/60),u=s%60;return`${p}:${u.toString().padStart(2,"0")}`}function Te(){try{const i=window.AudioContext||window.webkitAudioContext;if(!i)return;const s=new i,p=s.currentTime,u=s.createGain();u.gain.setValueAtTime(1e-4,p),u.gain.exponentialRampToValueAtTime(.18,p+.02),u.gain.exponentialRampToValueAtTime(1e-4,p+1.2),u.connect(s.destination);const l=s.createOscillator();l.type="sine",l.frequency.setValueAtTime(528,p),l.connect(u);const f=s.createOscillator();f.type="sine",f.frequency.setValueAtTime(792,p),f.connect(u),l.start(p),f.start(p),l.stop(p+1.2),f.stop(p+1.2),s.close().catch(()=>{})}catch{}}const Ae=120;function Ue({domain:i,status:s,reason:p,peek:u,onClose:l}){const[f,b]=d.useState(15),[o,m]=d.useState(!1),[Q,ee]=d.useState(!1),[C,me]=d.useState(""),[E,w]=d.useState(null),[he,te]=d.useState(!1),[re,P]=d.useState(0),[se,xe]=d.useState(p==="insufficient-funds"),[we,be]=d.useState({}),[ae,z]=d.useState(null),[D,ge]=d.useState({}),[N,Y]=d.useState(null),[ye,G]=d.useState(0),[R,I]=d.useState(!1),[V,T]=d.useState(!1),[g,A]=d.useState(!1),[U,O]=d.useState(null),ne=s.rate?.ratePerMin??s.session?.ratePerMin??1,W=s.emergencyPolicy??"balanced",_=!!u?.allowed,v=d.useMemo(()=>{switch(W){case"off":return{id:"off",label:"Off",minutes:0,tokensPerDay:0,cooldownMinutes:0,urlLocked:!0,debtCoins:0};case"gentle":return{id:"gentle",label:"Gentle",minutes:5,tokensPerDay:null,cooldownMinutes:0,urlLocked:!0,debtCoins:0};case"strict":return{id:"strict",label:"Strict",minutes:2,tokensPerDay:1,cooldownMinutes:60,urlLocked:!0,debtCoins:15};case"balanced":default:return{id:"balanced",label:"Balanced",minutes:3,tokensPerDay:2,cooldownMinutes:30,urlLocked:!0,debtCoins:8}}},[W]),H=t=>`chrome://favicon2/?size=64&url=${encodeURIComponent(t)}`,$=t=>{try{const r=new URL(t);return r.hash="",we[r.toString()]??null}catch{return null}};d.useEffect(()=>{!_&&g&&(A(!1),O(null))},[_,g]),d.useEffect(()=>{if(!g||!U)return;const t=r=>{const n=r.clientX-U.x,c=r.clientY-U.y;Math.hypot(n,c)>=Ae&&(A(!1),O(null))};return window.addEventListener("mousemove",t),()=>window.removeEventListener("mousemove",t)},[g,U]);const ve=t=>{if(_){if(g){A(!1),O(null);return}O({x:t.clientX,y:t.clientY}),A(!0)}},Z=_?e.jsxs("div",{className:"tws-peek-controls",children:[e.jsx("button",{type:"button",className:`tws-peek-toggle ${g?"active":""}`,onClick:ve,"aria-pressed":g,children:g?"Hide peek":"Peek"}),g&&e.jsx("div",{className:"tws-peek-hint",children:"Move mouse to return"})]}):null,ie=d.useMemo(()=>{const t=[],r=s.library?.replaceItems??[];for(const a of r)if(a)if(a.kind==="url"){if(!a.url||a.domain===i)continue;t.push({type:"url",id:`lib:${a.id}`,libraryId:a.id,title:a.title??a.domain,subtitle:a.note?a.note:"your replace pool",url:a.url})}else t.push({type:"app",id:`lib:${a.id}`,title:a.title??a.app??"Open app",subtitle:a.note?a.note:"your replace pool",app:a.app??"",requiresDesktop:!0});const n=s.library?.productiveItems??[];for(const a of n)if(a&&a.kind==="url"){if(!a.url||a.domain===i)continue;t.push({type:"url",id:`productive:${a.id}`,libraryId:a.id,title:a.title??a.domain,subtitle:a.note?a.note:"productive library",url:a.url})}const c=s.library?.readingItems??[];for(const a of c)!a||!a.id||!a.action||t.push({type:"desktop",id:`reading:${a.id}`,source:a.source,readingId:a.id,title:a.title??(a.source==="zotero"?"Zotero":"Books"),subtitle:a.subtitle?a.subtitle:a.source==="zotero"?"Zotero • curated reading":"Books • recent",action:a.action,thumbDataUrl:a.thumbDataUrl,iconDataUrl:a.iconDataUrl,progress:a.progress,requiresDesktop:!0});const x=s.library?.productiveDomains??[];for(const a of x){const S=(a??"").trim();!S||!S.includes(".")||S===i||t.push({type:"url",id:`prod:${S}`,title:S,subtitle:"productive",url:`https://${S}`})}t.push({type:"app",id:"app:Books",title:"Open Books",subtitle:"read something long-form",app:"Books",requiresDesktop:!0}),t.push({type:"app",id:"app:Zotero",title:"Open Zotero",subtitle:"pick a paper instead",app:"Zotero",requiresDesktop:!0}),t.push({type:"ritual",id:"ritual:meditation",ritual:"meditation",title:"Meditation",subtitle:"3-minute reset",minutes:3});const k=s.journal?.url??null,K=s.journal?.minutes??10;k&&t.push({type:"ritual",id:"ritual:journal",ritual:"journal",title:`${K}m journal`,subtitle:"write a few lines instead",minutes:K,url:k});const ue=new Set;return t.filter(a=>!(ue.has(a.id)||(ue.add(a.id),D[a.id])))},[D,i,s.library?.productiveDomains,s.library?.productiveItems,s.library?.replaceItems,s.library?.readingItems]),B=d.useMemo(()=>De(ie,3,re),[ie,re]);d.useEffect(()=>{const t=B.filter(c=>c.type==="url").map(c=>c.url),r=s.matchedPricedItem?.kind==="url"?s.matchedPricedItem.url:void 0;r&&t.push(r);const n=[...new Set(t)];n.length&&chrome.runtime.sendMessage({type:"GET_LINK_PREVIEWS",payload:{urls:n}}).then(c=>{!c?.success||!c.previews||be(x=>({...x,...c.previews}))}).catch(()=>{})},[B,s.matchedPricedItem?.url]);const j=async t=>{if(!(!t||o)){z(null),m(!0),w(null);try{if(t.type==="ritual"){if(t.ritual==="meditation"){Y({kind:"meditation",minutes:t.minutes}),G(t.minutes*60),I(!1),T(!1);return}if(t.ritual==="journal"&&t.url){const n=await chrome.runtime.sendMessage({type:"OPEN_URL",payload:{url:t.url,roulette:{title:t.title}}});if(!n?.success)throw new Error(n?.error?String(n.error):"Failed to open journal");l();return}return}if(t.type==="url"){const c=$(t.url)?.title??t.title,x=await chrome.runtime.sendMessage({type:"OPEN_URL",payload:{url:t.url,roulette:{title:c,libraryId:t.libraryId}}});if(!x?.success)throw new Error(x?.error?String(x.error):"Failed to open URL");l();return}if(t.type==="desktop"){if(t.requiresDesktop&&!s.desktopConnected)throw new Error("Desktop app required for this action");const n=await chrome.runtime.sendMessage({type:"OPEN_DESKTOP_ACTION",payload:t.action});if(!n?.success)throw new Error(n?.error?String(n.error):"Failed to open in desktop app");l();return}if(t.requiresDesktop&&!s.desktopConnected)throw new Error("Desktop app required for this action");const r=await chrome.runtime.sendMessage({type:"OPEN_APP",payload:{app:t.app}});if(!r?.success)throw new Error(r?.error?String(r.error):"Failed to open app");l()}catch(r){w(r.message)}finally{m(!1)}}},X=async t=>{if(!o){m(!0),w(null);try{if(t.type==="url"&&typeof t.libraryId=="number"){const r=await chrome.runtime.sendMessage({type:"MARK_LIBRARY_CONSUMED",payload:{id:t.libraryId,consumed:!0}});if(!r?.success)throw new Error(r?.error?String(r.error):"Failed to mark consumed")}else if(t.type==="desktop"&&t.readingId){const r=await chrome.runtime.sendMessage({type:"MARK_READING_CONSUMED",payload:{id:t.readingId,consumed:!0}});if(!r?.success)throw new Error(r?.error?String(r.error):"Failed to mark consumed")}else return;ge(r=>({...r,[t.id]:!0})),z(null),P(r=>r+1)}catch(r){w(r.message)}finally{m(!1)}}},y=d.useMemo(()=>[...s.rate?.packs??[]].sort((t,r)=>t.minutes-r.minutes),[s.rate?.packs]),M=d.useMemo(()=>y.length?{min:y[0].minutes,max:y[y.length-1].minutes,step:1}:{min:5,max:120,step:5},[y]);d.useEffect(()=>{y.length?b(y[0].minutes):b(15)},[i,y]);const ke=t=>y.length?y.reduce((r,n)=>{const c=Math.abs(n.minutes-t),x=Math.abs(r-t);return c<x?n.minutes:r},y[0].minutes):t,oe=y.find(t=>t.minutes===f),F=oe?oe.price:Math.max(1,Math.round(f*ne)),le=s.balance>=F,je=async()=>{if(!o){m(!0),w(null);try{const t=await chrome.runtime.sendMessage({type:"BUY_PACK",payload:{domain:i,minutes:f}});if(!t?.success)throw new Error(t?.error?String(t.error):"Failed to start session");l()}catch(t){w(t.message)}finally{m(!1)}}},Ne=async()=>{if(!o){m(!0),w(null);try{const t=await chrome.runtime.sendMessage({type:"START_METERED",payload:{domain:i}});if(!t?.success)throw new Error(t?.error?String(t.error):"Failed to start metered");l()}catch(t){w(t.message)}finally{m(!1)}}},Ee=async()=>{const t=s.matchedPricedItem;if(!(o||!t||typeof t.price!="number")){m(!0),w(null);try{const r=await chrome.runtime.sendMessage({type:"START_STORE_SESSION",payload:{domain:i,price:t.price,url:window.location.href}});if(!r?.success)throw new Error(r?.error?String(r.error):"Failed to unlock");l()}catch(r){w(r.message)}finally{m(!1)}}},Se=async()=>{if(!(o||!C.trim())){m(!0),w(null);try{const t=await chrome.runtime.sendMessage({type:"START_EMERGENCY",payload:{domain:i,justification:C,url:window.location.href}});if(!t?.success)throw new Error(t?.error?String(t.error):"Failed to start emergency");l()}catch(t){w(t.message)}finally{m(!1)}}},ce=async t=>{if(!o){m(!0),w(null);try{const r=await chrome.runtime.sendMessage({type:"EMERGENCY_REVIEW",payload:{outcome:t,domain:i}});if(!r?.success)throw new Error(r?.error?String(r.error):"Failed to record review");te(!0)}catch(r){w(r.message)}finally{m(!1)}}},Ie=p==="url-locked"?"This pass is locked to a specific page":p==="insufficient-funds"?"Insufficient f-coins":s.session?.paused?"Session paused":"Choose what this tab becomes";if(d.useEffect(()=>{if(!N||!R)return;const t=window.setInterval(()=>{G(r=>r<=1?(window.clearInterval(t),I(!1),T(!0),Te(),0):r-1)},1e3);return()=>window.clearInterval(t)},[N,R]),N)return e.jsxs("div",{className:`tws-paywall-overlay ${g?"tws-peek-active":""}`,children:[Z,e.jsxs("div",{className:"tws-paywall-modal",children:[e.jsxs("header",{className:"tws-paywall-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"tws-eyebrow",children:"TimeWellSpent"}),e.jsx("h2",{children:N.kind==="meditation"?"Meditation":"Ritual"}),e.jsx("p",{className:"tws-subtle",children:"A small reset helps you exit the attractor. Keep it simple: breathe, notice, return."})]}),e.jsxs("div",{className:"tws-wallet-badge",children:[e.jsx("span",{children:"Balance"}),e.jsxs("strong",{children:[s.balance," f-coins"]})]})]}),e.jsxs("div",{className:"tws-paywall-body",children:[E&&e.jsx("p",{className:"tws-error-text",children:E}),e.jsxs("section",{className:"tws-paywall-option",children:[e.jsxs("div",{className:"tws-option-header",children:[e.jsx("h3",{children:N.kind==="meditation"?`${N.minutes} minute timer`:"Timer"}),e.jsx("p",{className:"tws-subtle",style:{margin:0},children:V?"Complete.":R?"In progress.":"Ready when you are."})]}),e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("div",{className:"tws-ritual-timer",children:Re(ye)}),e.jsxs("div",{className:"tws-emergency-actions",children:[e.jsx("button",{className:"tws-secondary",onClick:()=>{Y(null),I(!1),T(!1),P(t=>t+1)},disabled:o,children:"Back"}),V?e.jsx("button",{className:"tws-primary",onClick:()=>{Y(null),P(t=>t+1)},disabled:o,children:"Pick next"}):e.jsx("button",{className:"tws-primary",onClick:()=>I(t=>!t),disabled:o,children:R?"Pause":"Start"}),!V&&e.jsx("button",{className:"tws-secondary",onClick:()=>{I(!1),G(N.minutes*60),T(!1)},disabled:o,children:"Reset"})]})]})]})]})]})]});if(Q)return e.jsxs("div",{className:`tws-paywall-overlay ${g?"tws-peek-active":""}`,children:[Z,e.jsxs("div",{className:"tws-paywall-modal",children:[e.jsxs("header",{className:"tws-paywall-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"tws-eyebrow",children:"TimeWellSpent"}),e.jsx("h2",{children:"I need it"}),e.jsx("p",{className:"tws-subtle",children:"Emergency access is a safety hatch. Use it when you have a real purpose — not when you want a dopamine hit."})]}),e.jsxs("div",{className:"tws-wallet-badge",children:[e.jsx("span",{children:"Balance"}),e.jsxs("strong",{children:[s.balance," f-coins"]})]})]}),e.jsxs("div",{className:"tws-paywall-body",children:[E&&e.jsx("p",{className:"tws-error-text",children:E}),e.jsxs("div",{className:"tws-emergency-form",children:[e.jsxs("p",{className:"tws-subtle",style:{marginTop:0},children:["Policy: ",e.jsx("strong",{children:v.label}),v.id!=="off"&&e.jsxs(e.Fragment,{children:[" ","• ",v.minutes,"m window",typeof v.tokensPerDay=="number"?` • ${v.tokensPerDay}/day`:" • unlimited/day",v.cooldownMinutes>0?` • ${v.cooldownMinutes}m cooldown`:"",v.debtCoins>0?` • ${v.debtCoins} coin debt`:""]})]}),e.jsx("textarea",{placeholder:"I need to…",value:C,onChange:t=>me(t.target.value),autoFocus:!0}),e.jsxs("div",{className:"tws-emergency-actions",children:[e.jsx("button",{className:"tws-secondary",onClick:()=>ee(!1),disabled:o,children:"Back"}),e.jsxs("button",{className:"tws-primary",onClick:Se,disabled:!C.trim()||o,children:["Start emergency (",v.minutes,"m)"]})]})]})]})]})]});const h=s.matchedPricedItem&&typeof s.matchedPricedItem.price=="number"?s.matchedPricedItem:null,L=h?.kind==="url"&&h.url?$(h.url):null,de=L?.imageUrl??null,pe=h?.kind==="url"&&h.url?L?.iconUrl??H(h.url):null,q=d.useMemo(()=>(s.library?.productiveItems??[]).filter(r=>!r||r.kind!=="url"||!r.url?!1:!D[`productive:${r.id}`]),[D,s.library?.productiveItems]),Me=t=>{!t||t.kind!=="url"||!t.url||j({type:"url",id:`productive:${t.id}`,title:t.title??t.domain,subtitle:t.note??void 0,url:t.url,libraryId:t.id})},Ce=t=>{!t||t.kind!=="url"||!t.url||X({type:"url",id:`productive:${t.id}`,title:t.title??t.domain,subtitle:t.note??void 0,url:t.url,libraryId:t.id})};return e.jsxs("div",{className:`tws-paywall-overlay ${g?"tws-peek-active":""}`,children:[Z,e.jsxs("div",{className:"tws-paywall-modal",children:[e.jsxs("header",{className:"tws-paywall-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"tws-eyebrow",children:"TimeWellSpent"}),e.jsx("h2",{children:i}),e.jsx("p",{className:"tws-subtle",children:Ie})]}),e.jsxs("div",{className:"tws-wallet-badge",children:[e.jsx("span",{children:"Balance"}),e.jsxs("strong",{children:[s.balance," f-coins"]})]})]}),e.jsxs("div",{className:"tws-paywall-body",children:[E&&e.jsx("p",{className:"tws-error-text",style:{marginBottom:0},children:E}),p==="emergency-expired"&&!he&&e.jsxs("section",{className:"tws-paywall-option",style:{borderColor:"#d07f00"},children:[e.jsxs("div",{className:"tws-option-header",children:[e.jsx("h3",{children:"Emergency ended"}),e.jsxs("p",{className:"tws-subtle",children:["Quick check-in: did you do the thing you came for?",s.emergency?.lastEnded?.domain===i&&s.emergency.lastEnded.justification?` (“${s.emergency.lastEnded.justification}”)`:""]})]}),e.jsxs("div",{className:"tws-option-action",children:[e.jsx("button",{className:"tws-secondary",disabled:o,onClick:()=>ce("not-kept"),children:"Not really"}),e.jsx("button",{className:"tws-primary",disabled:o,onClick:()=>ce("kept"),children:"Yes"})]})]}),e.jsxs("section",{className:"tws-paywall-option tws-attractors",children:[e.jsxs("div",{className:"tws-option-header tws-attractors-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Try this instead"}),e.jsx("p",{className:"tws-subtle",children:"You’re not here because this site is irresistible. You’re here because something else mattered — pick it."})]}),e.jsx("button",{className:"tws-link",type:"button",disabled:o,onClick:()=>P(t=>t+1),children:"Spin"})]}),B.length===0?e.jsx("p",{className:"tws-subtle",style:{margin:0},children:"Your Replace pool is empty. Save a few links with right-click → “Save to TimeWellSpent” → “Replace”."}):e.jsx("div",{className:"tws-attractors-grid",children:B.map(t=>{const r=o||t.type==="desktop"&&t.requiresDesktop&&!s.desktopConnected||t.type==="app"&&t.requiresDesktop&&!s.desktopConnected;if(t.type==="url"){const n=$(t.url),c=n?.imageUrl??null,x=n?.iconUrl??H(t.url);return e.jsxs("div",{className:"tws-attractor-card",onClick:()=>{r||j(t)},role:"button",tabIndex:r?-1:0,"aria-disabled":r,onKeyDown:k=>{r||(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),j(t))},children:[e.jsxs("div",{className:"tws-attractor-thumb",children:[c?e.jsx("img",{className:"tws-attractor-thumb-img",src:c,alt:"",loading:"lazy"}):e.jsx("div",{className:"tws-attractor-thumb-placeholder","aria-hidden":"true"}),typeof t.libraryId=="number"&&e.jsx("button",{type:"button",className:"tws-card-menu-trigger","aria-label":"More",disabled:o,onClick:k=>{k.stopPropagation(),z(K=>K===t.id?null:t.id)},children:"⋯"}),ae===t.id&&typeof t.libraryId=="number"&&e.jsx("div",{className:"tws-card-menu",role:"menu",onClick:k=>k.stopPropagation(),children:e.jsx("button",{type:"button",className:"tws-card-menu-item",disabled:o,onClick:()=>X(t),children:"Already consumed"})}),e.jsx("img",{className:"tws-attractor-favicon",src:x,alt:"",loading:"lazy"})]}),e.jsxs("div",{className:"tws-attractor-meta",children:[e.jsx("strong",{children:n?.title??t.title}),e.jsx("span",{children:n?.description??t.subtitle??"saved in your replace pool"}),e.jsx("small",{children:new URL(t.url).hostname.replace(/^www\\./,"")})]})]},t.id)}if(t.type==="desktop"){const n=t.source==="zotero"&&typeof t.progress=="number"?Math.round(Math.max(0,Math.min(1,t.progress))*100):null;return e.jsxs("div",{className:"tws-attractor-card",onClick:()=>{r||j(t)},title:t.requiresDesktop&&!s.desktopConnected?"Requires desktop app":void 0,role:"button",tabIndex:r?-1:0,"aria-disabled":r,onKeyDown:c=>{r||(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),j(t))},children:[e.jsxs("div",{className:"tws-attractor-thumb",children:[t.thumbDataUrl?e.jsx("img",{className:"tws-attractor-thumb-img",src:t.thumbDataUrl,alt:"",loading:"lazy"}):e.jsx("div",{className:"tws-attractor-thumb-placeholder","aria-hidden":"true"}),n!==null&&e.jsx("div",{className:"tws-progress-bar","aria-hidden":"true",children:e.jsx("div",{className:"tws-progress-fill",style:{width:`${n}%`}})}),e.jsx("button",{type:"button",className:"tws-card-menu-trigger","aria-label":"More",disabled:o,onClick:c=>{c.stopPropagation(),z(x=>x===t.id?null:t.id)},children:"⋯"}),ae===t.id&&e.jsx("div",{className:"tws-card-menu",role:"menu",onClick:c=>c.stopPropagation(),children:e.jsx("button",{type:"button",className:"tws-card-menu-item",disabled:o,onClick:()=>X(t),children:"Already consumed"})}),t.iconDataUrl?e.jsx("img",{className:"tws-attractor-favicon",src:t.iconDataUrl,alt:"",loading:"lazy"}):e.jsx("div",{className:"tws-attractor-favicon","aria-hidden":"true"})]}),e.jsxs("div",{className:"tws-attractor-meta",children:[e.jsx("strong",{children:t.title}),e.jsx("span",{children:t.subtitle??"reading suggestion"}),e.jsx("small",{children:"desktop"})]})]},t.id)}return t.type==="ritual"?e.jsxs("div",{className:"tws-attractor-card",onClick:()=>{r||j(t)},role:"button",tabIndex:r?-1:0,"aria-disabled":r,onKeyDown:n=>{r||(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),j(t))},children:[e.jsxs("div",{className:"tws-attractor-thumb tws-attractor-thumb-ritual",children:[e.jsx("div",{className:"tws-attractor-thumb-placeholder","aria-hidden":"true"}),e.jsx("div",{className:"tws-attractor-app-badge",children:"Ritual"})]}),e.jsxs("div",{className:"tws-attractor-meta",children:[e.jsx("strong",{children:t.title}),e.jsx("span",{children:t.subtitle??"a small reset"}),e.jsx("small",{children:t.ritual==="meditation"?`${t.minutes}m`:"journal"})]})]},t.id):e.jsxs("div",{className:"tws-attractor-card",onClick:()=>{r||j(t)},title:t.requiresDesktop&&!s.desktopConnected?"Requires desktop app":void 0,role:"button",tabIndex:r?-1:0,"aria-disabled":r,onKeyDown:n=>{r||(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),j(t))},children:[e.jsxs("div",{className:"tws-attractor-thumb tws-attractor-thumb-app",children:[e.jsx("div",{className:"tws-attractor-thumb-placeholder","aria-hidden":"true"}),e.jsx("div",{className:"tws-attractor-app-badge",children:"App"})]}),e.jsxs("div",{className:"tws-attractor-meta",children:[e.jsx("strong",{children:t.title}),e.jsx("span",{children:t.subtitle??"open an app"}),e.jsx("small",{children:"desktop"})]})]},t.id)})})]}),e.jsxs("section",{className:"tws-paywall-option tws-library-shelf",children:[e.jsx("div",{className:"tws-option-header",children:e.jsxs("div",{children:[e.jsxs("h3",{children:["Productive library"," ",q.length>0&&e.jsxs("span",{className:"tws-subtle",children:["(",q.length,")"]})]}),e.jsx("p",{className:"tws-subtle",children:"Open something you already tagged as productive."})]})}),q.length===0?e.jsx("p",{className:"tws-subtle",style:{margin:0},children:"No productive items yet. Right-click a page and choose “Productive” to add it."}):e.jsx("div",{className:"tws-library-scroll",children:q.map(t=>{const r=$(t.url??""),n=r?.title??t.title??t.domain,c=r?.description??t.note??t.domain,x=t.url?r?.iconUrl??H(t.url):null;return e.jsxs("div",{className:"tws-library-item",children:[e.jsxs("div",{className:"tws-library-info",children:[x?e.jsx("img",{className:"tws-library-favicon",src:x,alt:"",loading:"lazy"}):e.jsx("div",{className:"tws-library-favicon tws-library-favicon-placeholder","aria-hidden":"true"}),e.jsxs("div",{className:"tws-library-meta",children:[e.jsx("strong",{children:n}),e.jsx("span",{children:c})]})]}),e.jsxs("div",{className:"tws-library-actions",children:[e.jsx("button",{className:"tws-secondary",type:"button",disabled:o,onClick:()=>Me(t),children:"Open"}),e.jsx("button",{className:"tws-link",type:"button",disabled:o,onClick:()=>Ce(t),children:"Done"})]})]},t.id)})})]}),e.jsxs("details",{className:"tws-details",open:se,onToggle:t=>xe(t.target.open),children:[e.jsxs("summary",{children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx("strong",{children:"Proceed anyway"}),e.jsx("span",{children:"Timebox recommended • metered and emergency are intentionally harder."})]}),e.jsx("span",{children:se?"−":"+"})]}),e.jsxs("div",{className:"tws-details-body",children:[h&&e.jsxs("section",{className:"tws-paywall-option",style:{margin:0},children:[e.jsxs("div",{className:"tws-option-header",children:[e.jsx("h3",{children:"Unlock your saved item"}),e.jsx("p",{className:"tws-subtle",children:"Pay once for this exact page, then leave when you’re done."})]}),h.url&&e.jsx("div",{className:"tws-attractors-grid",style:{gridTemplateColumns:"1fr",marginBottom:12},children:e.jsxs("button",{type:"button",className:"tws-attractor-card",disabled:!0,style:{cursor:"default"},children:[e.jsxs("div",{className:"tws-attractor-thumb",children:[de?e.jsx("img",{className:"tws-attractor-thumb-img",src:de,alt:"",loading:"lazy"}):e.jsx("div",{className:"tws-attractor-thumb-placeholder","aria-hidden":"true"}),pe&&e.jsx("img",{className:"tws-attractor-favicon",src:pe,alt:"",loading:"lazy"}),e.jsxs("div",{className:"tws-price-pill",children:[h.price,e.jsx("span",{children:"f-coins"})]})]}),e.jsxs("div",{className:"tws-attractor-meta",children:[e.jsx("strong",{children:L?.title??h.title??h.domain}),e.jsx("span",{children:L?.description??"Saved one-time unlock"}),e.jsx("small",{children:h.domain})]})]})}),e.jsxs("div",{className:"tws-option-action",children:[e.jsxs("div",{className:"tws-price-tag",children:[e.jsx("strong",{children:h.price}),e.jsx("small",{children:"f-coins"})]}),e.jsx("button",{className:"tws-primary",onClick:Ee,disabled:o||s.balance<h.price,children:"Unlock now"})]}),s.balance<h.price&&e.jsxs("p",{className:"tws-error-text",style:{marginTop:8},children:["Need ",h.price-s.balance," more f-coins"]})]}),e.jsxs("section",{className:"tws-paywall-option",style:{margin:0},children:[e.jsxs("div",{className:"tws-option-header",children:[e.jsx("h3",{children:"Timeboxed session (recommended)"}),e.jsx("p",{className:"tws-subtle",children:"Commit to a fixed time and leave when it ends."})]}),e.jsxs("div",{className:"tws-slider-container",children:[e.jsxs("div",{className:"tws-slider-labels",children:[e.jsxs("span",{children:[f," minutes"]}),e.jsx("span",{className:"tws-subtle-info",children:"timebox"}),e.jsxs("strong",{children:[F," f-coins"]})]}),e.jsx("input",{type:"range",min:M.min,max:M.max,step:M.step,value:f,onChange:t=>b(ke(Number(t.target.value)))}),e.jsxs("div",{className:"tws-slider-scale",children:[e.jsxs("small",{children:[M.min,"m"]}),e.jsxs("small",{children:[M.max,"m"]})]})]}),e.jsxs("div",{className:"tws-option-action",children:[e.jsxs("button",{className:"tws-primary",onClick:je,disabled:!le||o,children:["Proceed for ",F," f-coins"]}),!le&&e.jsxs("p",{className:"tws-error-text",children:["Need ",F-s.balance," more f-coins"]})]})]}),e.jsxs("section",{className:"tws-paywall-option",style:{margin:0},children:[e.jsxs("div",{className:"tws-option-header",children:[e.jsx("h3",{children:"Metered"}),e.jsx("p",{className:"tws-subtle",children:"Charges continuously while you stay. Use only if you trust yourself."})]}),e.jsxs("div",{className:"tws-option-action",children:[e.jsxs("div",{className:"tws-price-tag",children:[e.jsx("strong",{children:ze(ne)}),e.jsx("small",{children:"f-coins / min"})]}),e.jsx("button",{className:"tws-secondary",onClick:Ne,disabled:s.balance<1||o,children:"Proceed metered"})]})]}),e.jsx("div",{className:"tws-emergency-link",children:W==="off"?e.jsx("button",{disabled:!0,title:"Emergency access is disabled in Settings.",children:"Emergency disabled"}):e.jsx("button",{onClick:()=>{te(!1),ee(!0)},children:"I need it (Emergency)"})})]})]})]})]})]})}const Oe=':host{all:initial;font-family:Inter,-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,sans-serif}.tws-paywall-overlay{--bg-base: #0a0a0b;--bg-raised: #111113;--bg-elevated: #1f1f23;--fg: #e8e4df;--fg-muted: #8a8680;--fg-subtle: #5c5955;--accent: #c8956c;--accent-soft: rgba(200, 149, 108, .15);--danger: #c77171;--border: rgba(255, 255, 255, .06);--border-strong: rgba(255, 255, 255, .12);position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(200,149,108,.08),transparent),var(--bg-base);display:block;z-index:2147483647;color:var(--fg);line-height:1.5;overflow-y:auto;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}.tws-paywall-overlay.tws-peek-active{background:transparent}.tws-paywall-overlay.tws-peek-active:before{opacity:0}.tws-paywall-overlay.tws-peek-active .tws-paywall-modal{opacity:0;pointer-events:none}.tws-peek-controls{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;align-items:flex-end;gap:6px;z-index:1}.tws-peek-toggle{border-radius:999px;border:1px solid var(--border-strong);background:#111113eb;color:var(--fg);padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer}.tws-peek-toggle:hover{border-color:#c8956c66}.tws-peek-toggle.active{background:#c8956c2e;border-color:#c8956c73}.tws-peek-hint{font-size:11px;color:var(--fg-muted);background:#08080ab3;padding:4px 8px;border-radius:999px}.tws-paywall-overlay *{box-sizing:border-box}.tws-paywall-overlay:before{content:"";position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:60px 60px;z-index:-1}h1,h2,h3,h4,h5,h6,p,span,div,a,button,input{color:inherit;font-family:inherit}.tws-paywall-modal{width:min(860px,100%);margin:0 auto;min-height:100vh;padding:26px 18px 44px;border-radius:0;background:transparent;box-shadow:none;display:flex;flex-direction:column;gap:16px;position:relative;overflow:visible}.tws-paywall-header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:18px;border-radius:18px;background:linear-gradient(140deg,#111113eb,#111113d1);box-shadow:inset 0 0 0 1px var(--border)}.tws-eyebrow{letter-spacing:.12em;text-transform:uppercase;color:var(--fg-muted);font-size:12px;margin:0 0 6px;font-weight:600}.tws-paywall-header h2{margin:0;font-size:24px;font-weight:700;color:var(--fg)}.tws-subtle{color:var(--fg-muted);margin:4px 0;font-size:14px;line-height:1.4}.tws-wallet-badge{display:flex;flex-direction:column;align-items:flex-end;background:var(--accent-soft);padding:8px 12px;border-radius:12px;border:1px solid rgba(200,149,108,.2)}.tws-wallet-badge span{font-size:11px;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em}.tws-wallet-badge strong{color:var(--accent);font-size:16px}.tws-paywall-body{display:flex;flex-direction:column;gap:14px}.tws-paywall-option{background:#ffffff09;border:1px solid var(--border);border-radius:16px;padding:16px;transition:transform .2s ease,border-color .2s ease}.tws-paywall-option:hover{border-color:var(--border-strong)}.tws-option-header{margin-bottom:16px}.tws-option-header h3{margin:0 0 4px;font-size:18px;font-weight:600;color:var(--fg)}.tws-option-action{display:flex;align-items:center;justify-content:space-between;gap:16px}.tws-price-tag{display:flex;flex-direction:column}.tws-price-tag strong{font-size:24px;color:var(--accent);line-height:1}.tws-price-tag small{color:var(--fg-muted);font-size:12px}.tws-divider{display:flex;align-items:center;justify-content:center;position:relative;height:20px}.tws-divider:before{content:"";position:absolute;left:0;right:0;height:1px;background:#ffffff1a}.tws-divider span{background:var(--bg-base);padding:0 12px;color:var(--fg-muted);font-size:12px;font-weight:600;z-index:1;text-transform:uppercase}.tws-slider-container{margin-bottom:16px}.tws-slider-labels{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:14px}.tws-subtle-info{color:var(--fg-muted);font-size:12px;font-weight:500}.tws-slider-labels strong{color:var(--accent)}input[type=range]{width:100%;height:6px;background:#ffffff1a;border-radius:3px;outline:none;-webkit-appearance:none;appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 10px #89f3d266;transition:transform .1s}input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.1)}.tws-slider-scale{display:flex;justify-content:space-between;margin-top:8px;color:var(--fg-muted);font-size:11px}button{padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;font-size:14px;transition:all .2s;white-space:normal}.tws-primary{background:var(--accent);color:#0a0a0b;width:100%}.tws-primary:hover:not(:disabled){background:#daa06d}.tws-secondary{background:#ffffff14;color:var(--fg);border:1px solid rgba(255,255,255,.08)}.tws-secondary:hover:not(:disabled){background:#ffffff1c}button:disabled{opacity:.5;cursor:not-allowed;transform:none}.tws-error-text{color:var(--danger);font-size:12px;margin-top:8px;text-align:center}.tws-emergency-link{margin-top:16px;text-align:center}.tws-emergency-link button{background:none;border:none;color:var(--fg-muted);font-size:12px;text-decoration:underline;cursor:pointer;padding:4px;opacity:.6}.tws-emergency-link button:hover{opacity:1;color:var(--fg)}.tws-emergency-form{display:flex;flex-direction:column;gap:16px}.tws-emergency-form textarea{background:#0000004d;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;color:var(--fg);font-family:inherit;font-size:14px;resize:vertical;min-height:80px}.tws-emergency-form textarea:focus{outline:none;border-color:var(--accent)}.tws-emergency-actions{display:flex;gap:12px}.tws-emergency-actions button{flex:1}.tws-attractors-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}.tws-link{background:none;border:none;color:var(--fg-muted);font-size:12px;text-decoration:underline;cursor:pointer;padding:4px;opacity:.85}.tws-link:hover:not(:disabled){opacity:1;color:var(--fg)}.tws-attractors-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}.tws-attractor-card{text-align:left;padding:0;border-radius:14px;background:#ffffff08;border:1px solid var(--border);display:flex;flex-direction:column;gap:10px;overflow:hidden;cursor:pointer}.tws-attractor-card:hover:not(:disabled):not([aria-disabled=true]){border-color:var(--border-strong)}.tws-attractor-card:disabled,.tws-attractor-card[aria-disabled=true]{opacity:.6;cursor:not-allowed}.tws-attractor-card:focus-visible{outline:2px solid rgba(200,149,108,.55);outline-offset:2px}.tws-attractors{border-color:#c8956c38;background:linear-gradient(180deg,#c8956c14,#ffffff08)}.tws-library-shelf{border-color:#7eb88c47;background:linear-gradient(180deg,#7eb88c14,#ffffff08)}.tws-library-scroll{display:flex;flex-direction:column;gap:10px;max-height:240px;overflow-y:auto;padding-right:6px}.tws-library-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#ffffff08}.tws-library-info{display:flex;align-items:center;gap:10px;min-width:0}.tws-library-favicon{width:32px;height:32px;border-radius:8px;object-fit:cover;background:#ffffff0f;flex-shrink:0}.tws-library-favicon-placeholder{background:#ffffff14}.tws-library-meta{display:flex;flex-direction:column;gap:2px;min-width:0}.tws-library-meta strong{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tws-library-meta span{font-size:12px;color:var(--fg-muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.tws-library-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap}.tws-library-actions .tws-secondary{padding:6px 10px;font-size:12px}.tws-library-actions .tws-link{font-size:12px}.tws-details{border-radius:16px;border:1px solid var(--border);background:#ffffff05;overflow:hidden}.tws-details summary{list-style:none;cursor:pointer;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;background:#ffffff08}.tws-details summary::-webkit-details-marker{display:none}.tws-details summary strong{font-size:14px}.tws-details summary span{font-size:12px;color:var(--fg-muted)}.tws-details-body{padding:14px 16px 16px;display:flex;flex-direction:column;gap:14px}.tws-attractor-card strong{font-size:14px;font-weight:700}.tws-attractor-card span{font-size:12px;color:var(--fg-muted)}.tws-attractor-thumb{position:relative;width:100%;aspect-ratio:16 / 9;background:#ffffff05}.tws-card-menu-trigger{position:absolute;top:10px;right:10px;width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0a0a0b94;color:#ffffffd1;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;line-height:1;box-shadow:0 10px 22px #00000059,inset 0 0 0 1px #ffffff0d}.tws-card-menu-trigger:disabled{opacity:.6;cursor:not-allowed}.tws-card-menu{position:absolute;top:48px;right:10px;min-width:170px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#101012eb;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 18px 36px #00000073;padding:6px;z-index:2}.tws-card-menu-item{width:100%;text-align:left;border:none;background:transparent;color:var(--fg);padding:10px;border-radius:10px;cursor:pointer;font-size:13px}.tws-card-menu-item:hover:not(:disabled){background:#ffffff0f}.tws-card-menu-item:disabled{opacity:.6;cursor:not-allowed}.tws-attractor-thumb-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(.95) contrast(.98) brightness(.92)}.tws-progress-bar{position:absolute;left:0;right:0;bottom:0;height:8px;background:#0a0a0b99;box-shadow:inset 0 1px #ffffff14;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}.tws-progress-fill{height:100%;width:0;background:linear-gradient(90deg,#c8956ceb,#f4d0aae0);box-shadow:0 0 16px #c8956c40;transition:width .22s ease}.tws-attractor-thumb-placeholder{position:absolute;inset:0;background:radial-gradient(120px 80px at 20% 30%,rgba(200,149,108,.22),transparent 55%),radial-gradient(140px 90px at 80% 35%,rgba(200,149,108,.12),transparent 60%),linear-gradient(160deg,#ffffff0d,#0000)}.tws-attractor-thumb-app{background:radial-gradient(120px 80px at 20% 30%,rgba(200,149,108,.16),transparent 55%),radial-gradient(140px 90px at 80% 35%,rgba(255,255,255,.06),transparent 60%),linear-gradient(160deg,#ffffff0d,#0000)}.tws-attractor-thumb-ritual{background:radial-gradient(120px 80px at 20% 30%,rgba(106,169,255,.12),transparent 55%),radial-gradient(140px 90px at 80% 35%,rgba(200,149,108,.14),transparent 60%),linear-gradient(160deg,#ffffff0d,#0000)}.tws-attractor-favicon{position:absolute;left:10px;bottom:10px;width:28px;height:28px;border-radius:8px;background:#0a0a0bc7;box-shadow:0 8px 18px #00000059,inset 0 0 0 1px #ffffff14;padding:6px}.tws-attractor-app-badge{position:absolute;left:10px;bottom:10px;display:inline-flex;align-items:center;justify-content:center;padding:7px 10px;border-radius:999px;background:#0a0a0bb8;box-shadow:0 8px 18px #00000059,inset 0 0 0 1px #ffffff14;font-size:12px;font-weight:600;color:var(--fg)}.tws-attractor-meta{padding:12px 12px 14px;display:flex;flex-direction:column;gap:6px}.tws-attractor-meta strong{font-size:14px;font-weight:700;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.tws-attractor-meta span{font-size:12px;color:var(--fg-muted);line-height:1.3;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}.tws-attractor-meta small{font-size:11px;color:#ffffff6b;letter-spacing:.02em;text-transform:none}.tws-ritual-timer{font-variant-numeric:tabular-nums;font-size:52px;font-weight:700;text-align:center;padding:16px 10px;border-radius:14px;background:#ffffff06;border:1px solid rgba(255,255,255,.06);box-shadow:inset 0 1px #ffffff0a}.tws-price-pill{position:absolute;right:10px;bottom:10px;display:inline-flex;align-items:baseline;gap:4px;padding:6px 10px;border-radius:999px;background:#0a0a0bb8;box-shadow:0 8px 18px #00000059,inset 0 0 0 1px #ffffff14;font-size:13px;font-weight:700;color:var(--accent)}.tws-price-pill span{font-size:10px;color:var(--fg-muted);font-weight:500}@media(max-width:520px){.tws-paywall-modal{padding:18px 14px 36px}.tws-paywall-header{padding:16px 14px}.tws-option-action{flex-direction:column;align-items:stretch}.tws-price-tag{align-items:flex-start}.tws-attractors-grid{grid-template-columns:1fr}}',_e=1e4;let fe=null;function J(){document.visibilityState==="visible"&&document.hasFocus()&&chrome.runtime.sendMessage({type:"PAGE_HEARTBEAT",payload:{url:window.location.href,title:document.title}}).catch(()=>{})}function $e(){fe==null&&(fe=window.setInterval(J,_e),J())}$e();document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&J()});chrome.runtime.onMessage.addListener((i,s,p)=>{if(i.type==="TWS_PING"){p?.({ok:!0});return}return i.type==="BLOCK_SCREEN"&&Be(i.payload.domain,i.payload.reason,i.payload.peek),!0});async function Be(i,s,p){const u=document.getElementById("tws-shadow-host");u&&u.remove();const l=document.createElement("div");l.id="tws-shadow-host",l.style.position="fixed",l.style.zIndex="2147483647",l.style.inset="0",l.style.width="100%",l.style.height="100%",document.body.appendChild(l);const f=l.attachShadow({mode:"open"}),b=document.createElement("style");b.textContent=Oe,f.appendChild(b);const o=document.createElement("div");o.id="tws-mount-point",f.appendChild(o),document.body.style.overflow="hidden";const m=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:{domain:i,url:window.location.href}});Pe.createRoot(o).render(e.jsx(Ue,{domain:i,status:m,reason:s,peek:p,onClose:()=>{l.remove(),document.body.style.overflow=""}}))}
