const x={wallet:{balance:100,lastSynced:Date.now()},marketRates:{"twitter.com":{domain:"twitter.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"x.com":{domain:"x.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"reddit.com":{domain:"reddit.com",ratePerMin:2,packs:[{minutes:10,price:18},{minutes:30,price:50}],hourlyModifiers:Array(24).fill(1)},"youtube.com":{domain:"youtube.com",ratePerMin:2.5,packs:[{minutes:10,price:23},{minutes:30,price:65}],hourlyModifiers:Array(24).fill(1)}},settings:{frivolityDomains:["twitter.com","x.com","reddit.com","youtube.com","facebook.com","instagram.com","tiktok.com"],productiveDomains:["github.com","stackoverflow.com"],neutralDomains:["gmail.com","calendar.google.com"],idleThreshold:15,emergencyPolicy:"balanced",economyExchangeRate:1.6666666666666667,journal:{url:null,minutes:10},peekEnabled:!0,peekAllowNewPages:!1},pendingCategorisation:null,sessions:{},libraryItems:[],pendingLibrarySync:{},nextLibraryTempId:-1,lastDesktopSync:0,consumedReading:{},emergency:{usage:{day:new Date().toISOString().slice(0,10),tokensUsed:0,cooldownUntil:null},lastEnded:null,reviewStats:{total:0,kept:0,notKept:0}}};class de{state=null;ensureStateDefaults(){if(!this.state)return;if(this.state.pendingLibrarySync||(this.state.pendingLibrarySync={}),typeof this.state.nextLibraryTempId!="number"&&(this.state.nextLibraryTempId=-1),this.state.emergency||(this.state.emergency=x.emergency),this.state.settings||(this.state.settings=x.settings),this.state.settings.emergencyPolicy||(this.state.settings.emergencyPolicy="balanced"),typeof this.state.settings.economyExchangeRate!="number"&&(this.state.settings.economyExchangeRate=5/3),typeof this.state.settings.peekEnabled!="boolean"&&(this.state.settings.peekEnabled=!0),typeof this.state.settings.peekAllowNewPages!="boolean"&&(this.state.settings.peekAllowNewPages=!1),!this.state.settings.journal||typeof this.state.settings.journal!="object")this.state.settings.journal={url:null,minutes:10};else{const n=this.state.settings.journal,r=typeof n.url=="string"?n.url.trim():"",i=typeof n.minutes=="number"&&Number.isFinite(n.minutes)?Math.max(1,Math.min(180,Math.round(n.minutes))):10;this.state.settings.journal={url:r||null,minutes:i}}this.state.consumedReading||(this.state.consumedReading={}),this.state.pendingCategorisation===void 0&&(this.state.pendingCategorisation=null);const t=this.state;if(Array.isArray(t.storeItems)&&t.storeItems.length){const n=Array.isArray(t.libraryItems)?t.libraryItems:[],r=new Map;for(const i of n)i?.kind==="url"&&typeof i.url=="string"&&r.set(i.url,i);for(const i of t.storeItems){const a=typeof i?.url=="string"?i.url:"";if(!a)continue;const s=r.get(a);s?(typeof s.price!="number"&&typeof i.price=="number"&&(s.price=i.price),!s.title&&i.title&&(s.title=i.title)):n.unshift({id:typeof i.id=="number"?i.id:this.state.nextLibraryTempId--,kind:"url",url:a,domain:i.domain??this.toStoreDomain(a),title:i.title??void 0,note:void 0,purpose:"allow",price:typeof i.price=="number"?i.price:void 0,createdAt:i.createdAt??new Date().toISOString(),lastUsedAt:i.lastUsedAt??void 0})}t.libraryItems=n,delete t.storeItems}if(Array.isArray(t.libraryItems)&&(t.libraryItems=t.libraryItems.filter(n=>n&&(n.kind==="url"||n.kind==="app")).map(n=>{const r=n.bucket,i=n.purpose==="replace"||n.purpose==="allow"||n.purpose==="temptation"||n.purpose==="productive"?n.purpose:r==="attractor"?"replace":r==="frivolous"?"temptation":"allow",a={id:n.id,kind:n.kind,url:n.url,app:n.app,domain:n.domain??(n.kind==="url"?this.toStoreDomain(n.url):String(n.app??"")),title:n.title,note:n.note,purpose:i,price:n.price,createdAt:n.createdAt,lastUsedAt:n.lastUsedAt,consumedAt:n.consumedAt};return delete a.bucket,a})),t.pendingStoreSync&&typeof t.pendingStoreSync=="object"){const n=t.pendingStoreSync;for(const r of Object.values(n)){const i=typeof r?.url=="string"?r.url:"";if(!i)continue;const a=typeof r?.updatedAt=="number"?r.updatedAt:Date.now(),s=this.state.pendingLibrarySync[i];s&&s.updatedAt>a||(this.state.pendingLibrarySync[i]={url:i,purpose:"allow",price:typeof r?.price=="number"?r.price:null,title:r?.title??null,note:null,updatedAt:a})}delete t.pendingStoreSync}delete t.nextStoreTempId,this.state.libraryItems||(this.state.libraryItems=[])}async init(){const t=await chrome.storage.local.get("state");t.state?(this.state=t.state,this.ensureStateDefaults()):(this.state=x,await this.save())}async save(){this.state&&await chrome.storage.local.set({state:this.state})}async getWallet(){return this.state||await this.init(),this.state.wallet}async getBalance(){return(await this.getWallet()).balance}async spendCoins(t){if(this.state||await this.init(),this.state.wallet.balance<t)throw new Error("Insufficient funds");return this.state.wallet.balance-=t,await this.save(),this.state.wallet.balance}async earnCoins(t){return this.state||await this.init(),this.state.wallet.balance+=t,await this.save(),this.state.wallet.balance}async getMarketRate(t){this.state||await this.init();const n=this.state.marketRates[t];return n||(t==="x.com"?this.state.marketRates["twitter.com"]??null:null)}async setMarketRate(t){this.state||await this.init(),this.state.marketRates[t.domain]=t,await this.save()}async isFrivolous(t){this.state||await this.init();const n=[t];return t==="x.com"&&n.push("twitter.com"),this.state.settings.frivolityDomains.some(r=>n.some(i=>i.includes(r)||r.includes(i)))}async getIdleThreshold(){return this.state||await this.init(),this.state.settings.idleThreshold??15}async getSession(t){return this.state||await this.init(),this.state.sessions[t]||null}async setSession(t,n){this.state||await this.init(),this.state.sessions[t]=n,await this.save()}async clearSession(t){this.state||await this.init(),delete this.state.sessions[t],await this.save()}async getAllSessions(){return this.state||await this.init(),this.state.sessions}async getState(){return this.state||await this.init(),this.state}toStoreDomain(t){try{return new URL(t).hostname.replace(/^www\./,"")}catch{return t}}mergeLibraryItemsWithPending(t){if(!this.state)return t;const n=Object.values(this.state.pendingLibrarySync??{});if(!n.length)return t;const r=[...t];for(const i of n){const a=r.findIndex(s=>s.kind==="url"&&s.url===i.url);if(a>=0){const s=r[a];r[a]={...s,purpose:i.purpose,price:i.price===void 0?s.price:typeof i.price=="number"?i.price:void 0,title:i.title??s.title,note:i.note??s.note,consumedAt:i.consumedAt===void 0?s.consumedAt:i.consumedAt??void 0}}else{const s=this.state.nextLibraryTempId--;r.unshift({id:s,kind:"url",url:i.url,domain:this.toStoreDomain(i.url),title:i.title??void 0,note:i.note??void 0,purpose:i.purpose,price:typeof i.price=="number"?i.price:void 0,createdAt:new Date().toISOString(),consumedAt:i.consumedAt??void 0})}}return r}async updateFromDesktop(t){if(this.state||await this.init(),t.wallet&&(this.state.wallet=t.wallet),t.marketRates&&(this.state.marketRates=t.marketRates),t.settings&&(this.state.settings=t.settings),t.sessions&&(this.state.sessions=t.sessions),t.libraryItems){const n=t.libraryItems??[];this.state.libraryItems=this.mergeLibraryItemsWithPending(n)}this.ensureStateDefaults(),this.state.pendingCategorisation&&(this.state.settings={...this.state.settings,productiveDomains:this.state.pendingCategorisation.productiveDomains,neutralDomains:this.state.pendingCategorisation.neutralDomains,frivolityDomains:this.state.pendingCategorisation.frivolityDomains}),this.state.lastDesktopSync=Date.now(),await this.save()}async queueCategorisationUpdate(t){this.state||await this.init(),this.state.settings={...this.state.settings,productiveDomains:t.productiveDomains,neutralDomains:t.neutralDomains,frivolityDomains:t.frivolityDomains},this.state.pendingCategorisation={...t,updatedAt:Date.now()},await this.save()}async getPendingCategorisationUpdate(){return this.state||await this.init(),this.state.pendingCategorisation??null}async clearPendingCategorisationUpdate(){this.state||await this.init(),this.state.pendingCategorisation=null,await this.save()}async recordEmergencyEnded(t){this.state||await this.init(),this.state.emergency.lastEnded=t,await this.save()}async recordEmergencyReview(t){return this.state||await this.init(),this.state.emergency.reviewStats.total+=1,t==="kept"?this.state.emergency.reviewStats.kept+=1:this.state.emergency.reviewStats.notKept+=1,await this.save(),this.state.emergency.reviewStats}async getEmergencyUsage(){return this.state||await this.init(),this.state.emergency.usage}async setEmergencyUsage(t){this.state||await this.init(),this.state.emergency.usage=t,await this.save()}async getLastSyncTime(){return this.state||await this.init(),this.state.lastDesktopSync}async getLibraryItems(){return this.state||await this.init(),this.state.libraryItems??[]}async setLibraryItemConsumed(t,n){this.state||await this.init();const r=this.state.libraryItems??[],i=r.findIndex(s=>s.id===t);if(i<0)return;const a=r[i];r[i]={...a,consumedAt:n??void 0},this.state.libraryItems=r,await this.save()}async markReadingConsumed(t,n){this.state||await this.init();const r=(t??"").trim();r&&(this.state.consumedReading||(this.state.consumedReading={}),n?this.state.consumedReading[r]=Date.now():delete this.state.consumedReading[r],await this.save())}async queueLibrarySync(t){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");this.state.pendingLibrarySync[t.url]={url:t.url,purpose:t.purpose,price:t.price,title:t.title??null,note:t.note??null,consumedAt:t.consumedAt,updatedAt:Date.now()},await this.save()}async getPendingLibrarySync(){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");return this.state.pendingLibrarySync}async clearPendingLibrarySync(t){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");delete this.state.pendingLibrarySync[t],await this.save()}}const o=new de,w="http://127.0.0.1:17600",fe="ws://127.0.0.1:17600/events",pe=12,H=chrome.runtime.getURL("assets/notification.png"),u={rootSave:"tws-save",rootDomain:"tws-domain",saveReplace:"save-to-library-replace",saveProductive:"save-to-library-productive",saveAllow:"save-to-library-allow",saveTemptation:"save-to-library-temptation",savePriced:"save-to-library-priced",domainProductive:"label-domain-productive",domainNeutral:"label-domain-neutral",domainFrivolous:"label-domain-frivolous"};let d=null,I=null,q=null,R="active",L=Date.now();const me=2e4,he=2400,A=[],P=new Map,T=new Map,N=new Map,Y=5e3;function ye(e){switch(e){case"off":return{id:e,durationSeconds:0,tokensPerDay:0,cooldownSeconds:0,urlLocked:!0};case"gentle":return{id:e,durationSeconds:300,tokensPerDay:null,cooldownSeconds:0,urlLocked:!0};case"strict":return{id:e,durationSeconds:120,tokensPerDay:1,cooldownSeconds:3600,urlLocked:!0};case"balanced":default:return{id:"balanced",durationSeconds:180,tokensPerDay:2,cooldownSeconds:1800,urlLocked:!0}}}function X(e){let t=N.get(e);return t||(t={createdAt:Date.now(),lastNavigationAt:null,lastUrl:null},N.set(e,t)),t}function Q(e,t){const n=X(e);n.lastNavigationAt=Date.now(),n.lastUrl=t??null}function we(e,t){if(!t)return!1;const n=t.split(":")[0];if(n==="webNavigation"||n==="onUpdated")return!0;if(n==="onActivated"){const r=N.get(e);if(!r)return!1;const i=Date.now(),a=r.lastNavigationAt?i-r.lastNavigationAt<Y:!1,s=r.createdAt?i-r.createdAt<Y:!1;return a||s}return!1}function E(e){try{const t=new URL(e);return`${t.origin}${t.pathname}`}catch{return null}}function ge(e){if(e.mode!=="pack"||!e.purchasePrice||!e.purchasedSeconds)return 0;const n=Math.max(0,Math.min(e.purchasedSeconds,e.remainingSeconds))/e.purchasedSeconds;return Math.round(e.purchasePrice*n)}o.init().then(()=>{console.log("TimeWellSpent: Storage initialized"),ke(),be(),_()});chrome.tabs.onRemoved.addListener(e=>{N.delete(e);const t=P.get(e);!t||(P.delete(e),Date.now()-t.openedAt<me)||Ge(t).catch(()=>{})});chrome.notifications?.onButtonClicked?.addListener((e,t)=>{const n=T.get(e);if(n){if(T.delete(e),t===0){typeof n.libraryId=="number"&&oe({id:n.libraryId,consumed:!0}).catch(()=>{}),n.readingId&&o.markReadingConsumed(n.readingId,!0).catch(()=>{});return}t===1&&chrome.tabs.create({url:n.url,active:!0}).then(r=>{r?.id!=null&&P.set(r.id,{...n,openedAt:Date.now()})}).catch(()=>{})}});chrome.notifications?.onClosed?.addListener(e=>{T.delete(e)});function _(){d||(console.log("Attempting to connect to desktop app..."),d=new WebSocket(fe),d.onopen=async()=>{console.log("‚úÖ Connected to desktop app"),I&&(clearTimeout(I),I=null),await b(),await K(),await se(),De()},d.onclose=()=>{console.log("‚ùå Disconnected from desktop app (extension will work offline)"),d=null,Se()},d.onerror=e=>{console.error("Desktop connection error:",e),d=null},d.onmessage=e=>{try{const t=JSON.parse(e.data);ve(t)}catch(t){console.error("Failed to parse desktop message",t)}})}function Se(){I||(I=setTimeout(()=>{I=null,_()},3e4))}async function b(){try{const e=await fetch(`${w}/extension/state`);if(e.ok){const t=await e.json();await o.updateFromDesktop(t),console.log("‚úÖ Synced state from desktop app")}}catch{console.log("Desktop app not available for sync")}}function ve(e){if(e.type==="wallet")o.updateFromDesktop({wallet:e.payload});else if(e.type==="market-update")o.updateFromDesktop({marketRates:e.payload});else if(e.type==="library-sync"){const t=Array.isArray(e.payload?.items)?e.payload.items:e.payload;Array.isArray(t)&&o.updateFromDesktop({libraryItems:t})}else if(e.type==="paywall-session-started"){const t=e.payload;t?.domain&&o.setSession(t.domain,{domain:t.domain,mode:t.mode,ratePerMin:t.ratePerMin,remainingSeconds:t.remainingSeconds??1/0,startedAt:Date.now(),paused:t.paused??!1,spendRemainder:t.spendRemainder??0,purchasePrice:t.purchasePrice,purchasedSeconds:t.purchasedSeconds,justification:t.justification,lastReminder:t.lastReminder,allowedUrl:t.allowedUrl})}else if(e.type==="paywall-session-ended"){if(e.payload?.domain){const{domain:t,reason:n}=e.payload;o.getSession(t).then(r=>{r?.mode==="emergency"&&n==="emergency-expired"&&o.recordEmergencyEnded({domain:t,justification:r.justification,endedAt:Date.now()}),o.clearSession(t)}),console.log(`üõë Session ended for ${t} (${n})`),M().then(async r=>{r&&r.url&&r.id&&new URL(r.url).hostname.replace(/^www\./,"")===t&&(console.log(`üö´ Immediately blocking ${t} due to session end`),await S(r.id,t,n,"session-ended"))})}}else if(e.type==="paywall-session-paused"){if(e.payload?.domain){const t=e.payload.domain;o.getSession(t).then(n=>{n&&o.setSession(t,{...n,paused:!0})}),M().then(async n=>{n&&n.url&&n.id&&new URL(n.url).hostname.replace(/^www\./,"")===t&&(console.log(`üö´ Immediately blocking ${t} due to pause`),await S(n.id,t,"paused","session-paused"))})}}else if(e.type==="paywall-session-resumed"){if(e.payload?.domain){const t=e.payload.domain;o.getSession(t).then(n=>{n&&o.setSession(t,{...n,paused:!1})})}}else if(e.type==="paywall-reminder"&&e.payload?.domain){const{domain:t,justification:n}=e.payload;chrome.notifications?.create(`tws-reminder-${t}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${t}${n?` ‚Äî Reason: ${n}`:""}.`})}}chrome.tabs.onCreated.addListener(e=>{typeof e.id=="number"&&X(e.id)});chrome.tabs.onActivated.addListener(async e=>{const t=await chrome.tabs.get(e.tabId);t.url&&await F(t.id,t.url,"onActivated"),await W("tab-activated")});chrome.tabs.onUpdated.addListener(async(e,t,n)=>{t.status==="loading"&&n.url&&n.url.startsWith("http")&&Q(e,n.url),(t.status==="loading"||t.status==="complete")&&n.url&&await F(e,n.url,`onUpdated:${t.status}`),t.status==="complete"&&n.active&&await W("tab-updated")});chrome.webNavigation.onCommitted.addListener(async e=>{e.frameId===0&&(Q(e.tabId,e.url),await F(e.tabId,e.url,"webNavigation:onCommitted"))});chrome.windows.onFocusChanged.addListener(async()=>{await W("window-focus")});async function F(e,t,n){if(!(!t||!t.startsWith("http")))try{const i=new URL(t).hostname.replace(/^www\./,"");if(await o.isFrivolous(i)){const s=await o.getSession(i);if(s&&!s.paused)if(s.allowedUrl){const l=E(t);if(!(!l||l!==s.allowedUrl)){if(s.mode==="metered")return;if(s.remainingSeconds>0)return}}else{if(s.mode==="metered")return;if(s.remainingSeconds>0)return}const c=s?.allowedUrl?"url-locked":void 0;console.log(`üö´ Blocking ${i} (source: ${n})`),await S(e,i,c,n)}}catch(r){console.error("Error checking URL:",r)}}function ke(){q||(q=setInterval(async()=>{await Z()},15e3))}async function Z(){const e=Date.now();if(d&&d.readyState===WebSocket.OPEN)return;const t=await o.getAllSessions(),n=await chrome.tabs.query({active:!0,currentWindow:!0}),r=async()=>{await Promise.all(Object.entries(t).map(([l,f])=>o.setSession(l,{...f,paused:!0})))};if(n.length===0){await r();return}const i=n[0];if(!i.url||!i.url.startsWith("http")){await r();return}const s=new URL(i.url).hostname.replace(/^www\./,""),c=t[s];if(Object.entries(t).forEach(async([l,f])=>{l!==s&&!f.paused?await o.setSession(l,{...f,paused:!0}):l===s&&f.paused&&await o.setSession(l,{...f,paused:!1})}),!!c){if(c.mode!=="emergency"&&c.allowedUrl){const l=E(i.url);if(!l||l!==c.allowedUrl){c.paused||await o.setSession(s,{...c,paused:!0}),i.id&&await S(i.id,s,"url-locked","session-url-locked");return}}if(c.mode==="emergency"){if(c.allowedUrl){const h=E(i.url);if(!h||h!==c.allowedUrl){c.paused||await o.setSession(s,{...c,paused:!0}),i.id&&await S(i.id,s,"url-locked","session-url-locked");return}}const l=300*1e3,f=c.lastReminder??c.startedAt;Date.now()-f>l&&(c.lastReminder=Date.now(),await o.setSession(s,c),chrome.notifications?.create(`tws-reminder-${s}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${s}${c.justification?` ‚Äî Reason: ${c.justification}`:""}.`}));const p=c.lastTick??c.startedAt,m=Math.max(0,Math.round((e-p)/1e3));c.remainingSeconds-=m,c.lastTick=e,c.remainingSeconds<=0?(await o.recordEmergencyEnded({domain:s,justification:c.justification,endedAt:e}),await o.clearSession(s),i.id&&await S(i.id,s,"emergency-expired","session-expired")):await o.setSession(s,c);return}else if(c.mode==="metered"){const l=(await o.getMarketRate(s))?.ratePerMin??c.ratePerMin,f=c.lastTick??c.startedAt,p=Math.max(0,Math.round((e-f)/1e3)),m=l/60*p+(c.spendRemainder??0),h=Math.floor(m),y=m-h;try{h>0&&await o.spendCoins(h),c.ratePerMin=l,c.spendRemainder=y,c.lastTick=e,await o.setSession(s,c)}catch{console.log(`‚ùå Insufficient funds for ${s}`),await o.clearSession(s),i.id&&await S(i.id,s,"insufficient-funds","session-insufficient-funds")}}else{const l=c.lastTick??c.startedAt,f=Math.max(0,Math.round((e-l)/1e3));c.remainingSeconds-=f,c.lastTick=e,c.remainingSeconds<=0?(console.log(`‚è∞ Time's up for ${s}`),await o.clearSession(s),i.id&&await S(i.id,s,"time-expired","session-expired")):await o.setSession(s,c)}}}async function be(){const e=await o.getIdleThreshold();chrome.idle.setDetectionInterval(e),chrome.idle.queryState(e,t=>{R=t,t==="active"&&(L=Date.now())}),chrome.idle.onStateChanged.addListener(t=>{R=t,t==="active"&&(L=Date.now())}),chrome.storage.onChanged.addListener(t=>{if(t.state&&t.state.newValue){const n=t.state.newValue,r=t.state.oldValue,i=n.settings?.idleThreshold,a=r?.settings?.idleThreshold;i&&i!==a&&(console.log("Updating idle threshold to",i),chrome.idle.setDetectionInterval(i))}})}async function W(e){const t=await M();if(!t||!t.url)return;const n=new URL(t.url).hostname.replace(/^www\./,""),r=R==="active"?0:Math.floor((Date.now()-L)/1e3),i={type:"activity",reason:e,payload:{timestamp:Date.now(),source:"url",appName:te(),windowTitle:t.title??n,url:t.url,domain:n,idleSeconds:r}};ee(i)}async function M(){const e=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(e.length===0)return null;const t=e[0];return!t.url||!t.url.startsWith("http")?null:t}function ee(e){d&&d.readyState===WebSocket.OPEN?d.send(JSON.stringify(e)):(A.push(e),A.length>he&&A.shift())}function De(){if(!(!d||d.readyState!==WebSocket.OPEN))for(;A.length>0;){const e=A.shift();e&&d.send(JSON.stringify(e))}}function te(){const e=navigator.userAgent.toLowerCase();return e.includes("brave")?"Brave":e.includes("edg/")?"Edge":e.includes("arc")?"Arc":e.includes("firefox")?"Firefox":"Chrome"}async function Ie(e){try{await chrome.scripting.executeScript({target:{tabId:e},files:["content-loader.js"]})}catch{}}async function Ae(e,t){const n=await o.getState(),r=n.settings?.peekEnabled!==!1,i=!!n.settings?.peekAllowNewPages,a=we(e,t);return{allowed:r&&(i||!a),isNewPage:a}}async function S(e,t,n,r){await Ie(e);try{await chrome.tabs.sendMessage(e,{type:"TWS_PING"})}catch{await new Promise(i=>setTimeout(i,150))}try{const i=await Ae(e,r);await chrome.tabs.sendMessage(e,{type:"BLOCK_SCREEN",payload:{domain:t,reason:n,peek:i}}),console.log(`üîí Block screen message sent to tab ${e} for ${t}`)}catch(i){console.warn("Failed to send block message",i)}}async function ne(e,t){try{const n=await fetch(`${w}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!n.ok)throw new Error("desktop unreachable");const r=await n.json();return await o.updateFromDesktop({sessions:{[r.domain]:{...r,startedAt:Date.now(),paused:!1,spendRemainder:r.spendRemainder??0}}}),await b(),{ok:!0,session:r}}catch(n){return console.log("Desktop purchase failed, falling back to local",n),{ok:!1,error:n.message}}}async function Pe(e){try{const t=await fetch(`${w}/paywall/emergency`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});if(!t.ok){const r=await t.json().catch(()=>null);return{ok:!1,error:r?.error?String(r.error):"Desktop rejected request",canFallback:!1}}const n=await t.json();return await o.updateFromDesktop({sessions:{[n.domain]:{...n,startedAt:Date.now(),paused:!1,spendRemainder:n.spendRemainder??0}}}),await b(),{ok:!0,session:n}}catch(t){return console.log("Desktop emergency start failed, falling back to local",t),{ok:!1,error:t.message,canFallback:!0}}}async function Te(e){try{if(!(await fetch(`${w}/paywall/end`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:e}),cache:"no-store"})).ok)throw new Error("desktop unreachable");return await b(),{ok:!0}}catch(t){return console.log("Desktop end-session failed, falling back to local",t),{ok:!1,error:t.message}}}chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type==="GET_STATUS")return Ze(e.payload).then(n),!0;if(e.type==="GET_CONNECTION")return tt().then(n),!0;if(e.type==="PAGE_HEARTBEAT")return Ue(e.payload,t).then(n),!0;if(e.type==="GET_LINK_PREVIEWS")return Be(e.payload).then(n),!0;if(e.type==="OPEN_URL")return nt(e.payload,t).then(n),!0;if(e.type==="OPEN_APP")return it(e.payload).then(n),!0;if(e.type==="OPEN_DESKTOP_ACTION")return Re(e.payload).then(n),!0;if(e.type==="UPSERT_LIBRARY_ITEM")return Xe(e.payload).then(n),!0;if(e.type==="SET_DOMAIN_CATEGORY")return ae(e.payload).then(n),!0;if(e.type==="BUY_PACK")return st(e.payload).then(n),!0;if(e.type==="START_METERED")return at(e.payload).then(n),!0;if(e.type==="PAUSE_SESSION")return ot(e.payload).then(n),!0;if(e.type==="RESUME_SESSION")return ct(e.payload).then(n),!0;if(e.type==="END_SESSION")return lt(e.payload).then(n),!0;if(e.type==="START_EMERGENCY")return ut(e.payload).then(n),!0;if(e.type==="START_STORE_SESSION")return et(e.payload).then(n),!0;if(e.type==="EMERGENCY_REVIEW")return dt(e.payload).then(n),!0;if(e.type==="MARK_LIBRARY_CONSUMED")return oe(e.payload).then(n),!0;if(e.type==="MARK_READING_CONSUMED")return rt(e.payload).then(n),!0});function Ee(e,t){const n=String(e.url??"");if(!n||!/^https?:/i.test(n))return;let r;try{r=new URL(n).hostname.replace(/^www\./,"")}catch{return}const i=R==="active"?0:Math.floor((Date.now()-L)/1e3);ee({type:"activity",reason:t,payload:{timestamp:Date.now(),source:"url",appName:te(),windowTitle:e.title??r,url:n,domain:r,idleSeconds:i}})}async function Ue(e,t){try{if(t.tab&&t.tab.active===!1)return{ok:!0};const n=typeof e?.url=="string"?e.url:t.tab?.url;return n?(Ee({url:n,title:typeof e?.title=="string"?e.title:t.tab?.title??void 0},"content-heartbeat"),await Z(),{ok:!0}):{ok:!0}}catch{return{ok:!0}}}async function Re(e){if(!e||e.kind!=="deeplink"&&e.kind!=="file")return{success:!1,error:"Invalid action"};try{const t=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});return t.ok?{success:!0}:{success:!1,error:(await t.json().catch(()=>null))?.error??"Failed to open in desktop app"}}catch(t){return{success:!1,error:t.message}}}const Le=10080*60*1e3,Ne=250;function ie(e){try{const t=new URL(e);return t.hash="",t.toString()}catch{return null}}function O(e){return`chrome://favicon2/?size=64&url=${encodeURIComponent(e)}`}function C(e,t,n){const r=new RegExp(`<meta\\s+[^>]*${t}=["']${$e(n)}["'][^>]*content=["']([^"']+)["'][^>]*>`,"i"),i=e.match(r);if(i?.[1])return B(i[1]).trim()}function Me(e){const t=C(e,"property","og:title");if(t)return t;const n=e.match(/<title[^>]*>([^<]{1,200})<\/title>/i);if(n?.[1])return B(n[1]).trim()}function Ce(e){return C(e,"property","og:description")??C(e,"name","description")}function xe(e){return C(e,"property","og:image")}function Oe(e){const t=e.match(/<link\s+[^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*href=["']([^"']+)["'][^>]*>/i)??e.match(/<link\s+[^>]*href=["']([^"']+)["'][^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*>/i);if(t?.[1])return B(t[1]).trim()}function z(e,t){if(e)try{return new URL(e,t).toString()}catch{return}}function $e(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function B(e){return e.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function je(e){const t=e.hostname.replace(/^www\./,"");if(t==="youtu.be"){const n=e.pathname.split("/").filter(Boolean)[0];return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}if(t.endsWith("youtube.com")){const n=e.searchParams.get("v");return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}return null}async function _e(e){const t=ie(e);if(!t)return null;try{const n=new URL(t),r=je(n),i=new AbortController,a=setTimeout(()=>i.abort(),4500),s=await fetch(t,{method:"GET",redirect:"follow",cache:"no-store",signal:i.signal}).finally(()=>clearTimeout(a));if(!s.ok)throw new Error(`HTTP ${s.status}`);if(!(s.headers.get("content-type")??"").includes("text/html"))return{url:t,title:void 0,description:void 0,imageUrl:r??void 0,iconUrl:O(t)};const l=await s.text(),f=Me(l),p=Ce(l),m=r??z(xe(l),t),h=z(Oe(l),t)??O(t);return{url:t,title:f,description:p,imageUrl:m,iconUrl:h}}catch{return{url:t,iconUrl:O(t)}}}async function Fe(){const t=(await chrome.storage.local.get("linkPreviewCache")).linkPreviewCache;return!t||typeof t!="object"?{}:t}async function We(e){const t=Object.entries(e).filter(([,r])=>r&&typeof r.url=="string").sort((r,i)=>(i[1].updatedAt??0)-(r[1].updatedAt??0)),n={};for(const[r,i]of t.slice(0,Ne))n[r]=i;await chrome.storage.local.set({linkPreviewCache:n})}async function Be(e){const n=(Array.isArray(e?.urls)?e.urls:[]).map(c=>ie(String(c))).filter(c=>!!c);if(!n.length)return{success:!0,previews:{}};const r=Date.now(),i=await Fe(),a={};let s=!1;for(const c of n){const l=i[c];if(l&&r-l.updatedAt<Le){a[c]=l;continue}const f=await _e(c);if(!f){a[c]=null;continue}const p={...f,updatedAt:r};i[c]=p,a[c]=p,s=!0}return s&&await We(i),{success:!0,previews:a}}function J(){chrome.contextMenus?.create&&chrome.contextMenus.removeAll(()=>{const e=chrome.runtime.lastError;e&&console.warn("Failed to clear context menus",e),chrome.contextMenus.create({id:u.rootSave,title:"Save to TimeWellSpent",contexts:["page","link"]}),chrome.contextMenus.create({id:u.saveReplace,parentId:u.rootSave,title:"Replace (Try this instead)",contexts:["page","link"]}),chrome.contextMenus.create({id:u.saveProductive,parentId:u.rootSave,title:"Productive (counts as productive time)",contexts:["page","link"]}),chrome.contextMenus.create({id:u.saveAllow,parentId:u.rootSave,title:"Allow (good link)",contexts:["page","link"]}),chrome.contextMenus.create({id:u.saveTemptation,parentId:u.rootSave,title:"Temptation (keep contained)",contexts:["page","link"]}),chrome.contextMenus.create({id:u.savePriced,parentId:u.rootSave,title:"Allow (priced)‚Ä¶",contexts:["page","link"]}),chrome.contextMenus.create({id:u.rootDomain,title:"Label this domain",contexts:["page"]}),chrome.contextMenus.create({id:u.domainProductive,parentId:u.rootDomain,title:"Productive",contexts:["page"]}),chrome.contextMenus.create({id:u.domainNeutral,parentId:u.rootDomain,title:"Neutral",contexts:["page"]}),chrome.contextMenus.create({id:u.domainFrivolous,parentId:u.rootDomain,title:"Frivolous",contexts:["page"]})})}function Je(e){if(!e)return null;let t=e.trim();if(!t||t.startsWith("chrome://")||t.startsWith("about:"))return null;/^https?:/i.test(t)||(t=`https://${t}`);try{return new URL(t).toString()}catch{return null}}function U(e){if(!e)return;const t=e.trim();if(t)return t.slice(0,80)}function V(e,t,n,r){const i=U(t)??U(n)??U(r);if(i)return i;try{return new URL(e).hostname}catch{return e}}function Ke(e,t){const n=e.find(r=>r.kind==="url"&&r.url===t&&typeof r.price=="number");if(n)return n;try{const r=new URL(t),i=`${r.origin}${r.pathname}`;return e.find(a=>a.kind==="url"&&a.url===i&&typeof a.price=="number")??null}catch{return null}}async function k(e,t){if(chrome.notifications)try{await chrome.notifications.create("",{type:"basic",iconUrl:H,title:"TimeWellSpent",message:e,priority:0});return}catch(n){console.warn("Notification failed",n)}if(t)try{await chrome.scripting.executeScript({target:{tabId:t},func:n=>alert(n),args:[e]});return}catch(n){console.warn("Failed to show in-tab alert",n)}console.log(e)}async function Ge(e){const t=(e.title??"").trim(),n=(()=>{try{return new URL(e.url).hostname.replace(/^www\./,"")}catch{return"this tab"}})(),r=t||n;if(chrome.notifications){const i=`tws-roulette-${Date.now()}-${Math.random().toString(16).slice(2)}`;T.set(i,e);try{await chrome.notifications.create(i,{type:"basic",iconUrl:H,title:"TimeWellSpent",message:`Done with ‚Äú${r}‚Äù?`,buttons:[{title:"Done"},{title:"Keep open"}],priority:0});return}catch(a){T.delete(i),console.warn("Failed to show roulette completion notification",a)}}}async function re(e){const n=((await o.getState()).libraryItems||[]).find(r=>r.kind==="url"&&r.url===e)??null;if(n)return n;try{const r=await fetch(`${w}/library/check?url=${encodeURIComponent(e)}`,{cache:"no-store"});if(r.ok)return(await r.json())?.item??null}catch{}return null}async function qe(e){try{const t=await fetch(`${w}/library/check?url=${encodeURIComponent(e)}`,{cache:"no-store"});return t.ok?(await t.json())?.item??null:null}catch{return null}}async function Ye(e){const t=await fetch(`${w}/library`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"url",url:e.url,purpose:e.purpose,price:e.price===void 0?void 0:e.price,title:e.title??void 0,note:e.note??void 0,consumedAt:e.consumedAt}),cache:"no-store"});if(!t.ok){let n="Failed to save to desktop app. Is it running?";try{const r=await t.json();r?.error&&(n=r.error)}catch{}throw new Error(n)}}async function ze(e,t){const n=await fetch(`${w}/library/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({purpose:t.purpose,price:t.price===void 0?void 0:t.price,title:t.title??void 0,note:t.note??void 0,consumedAt:t.consumedAt}),cache:"no-store"});if(!n.ok){let r="Failed to update the library item. Is the desktop app running?";try{const i=await n.json();i?.error&&(r=i.error)}catch{}throw new Error(r)}}async function Ve(e){const t=await qe(e.url);return t?(await ze(t.id,e),{action:"updated"}):(await Ye(e),{action:"added"})}async function K(e){const t=await o.getPendingLibrarySync(),n=Object.values(t).filter(i=>!e||e.includes(i.url)).sort((i,a)=>i.updatedAt-a.updatedAt);if(!n.length)return{attempted:0,succeeded:0};let r=0;for(const i of n)try{await Ve(i),await o.clearPendingLibrarySync(i.url),r+=1}catch(a){console.warn("Failed to sync library item to desktop",a)}return r>0&&await b(),{attempted:n.length,succeeded:r}}async function j(e){const n=await re(e.url)?"updated":"added";await o.queueLibrarySync(e);const r=await K([e.url]);return{action:n,synced:r.succeeded>0}}function D(e){const t=(e??"").trim().toLowerCase();if(!t)return null;if(t.startsWith("http://")||t.startsWith("https://"))try{return new URL(t).hostname.replace(/^www\./,"")}catch{return null}return t.split("/")[0].replace(/^www\./,"")||null}function $(e){const t=new Set,n=[];for(const r of e){const i=D(r);!i||t.has(i)||(t.add(i),n.push(i))}return n}async function He(e){const t=await fetch(`${w}/settings/categorisation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productive:e.productiveDomains,neutral:e.neutralDomains,frivolity:e.frivolityDomains}),cache:"no-store"});if(!t.ok){let n="Failed to update categorisation on desktop app.";try{const r=await t.json();r?.error&&(n=r.error)}catch{}throw new Error(n)}}async function se(){const e=await o.getPendingCategorisationUpdate();if(!e)return{attempted:0,succeeded:0};try{return await He(e),await o.clearPendingCategorisationUpdate(),await b(),{attempted:1,succeeded:1}}catch(t){return console.warn("Failed to sync categorisation update to desktop",t),{attempted:1,succeeded:0}}}async function Xe(e){const t=typeof e?.url=="string"?e.url.trim():"",n=e?.purpose;if(!t)return{success:!1,error:"Missing URL"};if(n!=="replace"&&n!=="allow"&&n!=="temptation"&&n!=="productive")return{success:!1,error:"Invalid purpose"};if(n!=="allow"&&typeof e.price=="number")return{success:!1,error:"Only Allow items can be priced"};if(e.price!==void 0&&e.price!==null){const r=Number(e.price);if(!Number.isFinite(r)||!Number.isInteger(r)||r<1)return{success:!1,error:"Invalid price"}}try{return{success:!0,...await j({url:t,purpose:n,price:e.price,title:e?.title??null,note:e?.note??null})}}catch(r){return{success:!1,error:r.message}}}async function ae(e){const t=e?.category,n=D(e?.domain??"");if(!n)return{success:!1,error:"Invalid domain"};if(t!=="productive"&&t!=="neutral"&&t!=="frivolous")return{success:!1,error:"Invalid category"};const r=await o.getState(),i=$((r.settings?.productiveDomains??[]).filter(f=>D(f)!==n)),a=$((r.settings?.neutralDomains??[]).filter(f=>D(f)!==n)),s=$((r.settings?.frivolityDomains??[]).filter(f=>D(f)!==n));t==="productive"&&i.unshift(n),t==="neutral"&&a.unshift(n),t==="frivolous"&&s.unshift(n);const c={productiveDomains:i,neutralDomains:a,frivolityDomains:s};return await o.queueCategorisationUpdate(c),{success:!0,synced:(await se()).succeeded>0}}async function Qe(e,t){const r=(await chrome.scripting.executeScript({target:{tabId:e},func:i=>{const a=prompt(`Save a one-time unlock

Price (f-coins) for:
${i.url}`,String(i.price));if(a===null)return null;const s=a.trim();if(!s)return{error:"Price is required"};const c=parseInt(s,10);if(isNaN(c)||c<1)return{error:"Invalid price"};const l=prompt(`Optional title:
${i.url}`,i.title??"");if(l===null)return null;const f=l.trim();return{url:i.url,price:c,title:f||null}},args:[t]}))[0]?.result;if(!r)return null;if(r.error)throw new Error(r.error??"Invalid input");return r}async function Ze(e){await b().catch(()=>{});const t=await o.getBalance(),n=await o.getMarketRate(e.domain),r=await o.getSession(e.domain),i=await o.getLastSyncTime(),a=await o.getState(),s=a.libraryItems??[],c=e.url?Ke(s,e.url):null;let l=[];try{const p=await fetch(`${w}/integrations/reading?limit=12`,{cache:"no-store"});if(p.ok){const m=await p.json();Array.isArray(m.items)&&(l=m.items)}}catch{}const f=a.consumedReading??{};return l=l.filter(p=>p?.id&&!f[String(p.id)]),{balance:t,rate:n,session:r,matchedPricedItem:c,lastSync:i,desktopConnected:d?.readyState===WebSocket.OPEN,emergencyPolicy:a.settings.emergencyPolicy??"balanced",emergency:a.emergency,journal:a.settings.journal??{url:null,minutes:10},library:{items:s,replaceItems:s.filter(p=>p.purpose==="replace"&&!p.consumedAt),productiveItems:s.filter(p=>p.purpose==="productive"&&!p.consumedAt),productiveDomains:a.settings.productiveDomains??[],readingItems:l}}}async function et(e){if(d&&d.readyState===WebSocket.OPEN)return d.send(JSON.stringify({type:"paywall:start-store",payload:e})),{success:!0};try{await o.spendCoins(e.price);const t={domain:e.domain,mode:"store",ratePerMin:0,remainingSeconds:1/0,startedAt:Date.now(),lastTick:Date.now(),paused:!1,purchasePrice:e.price,spendRemainder:0,allowedUrl:e.url?E(e.url)??void 0:void 0};return await o.setSession(e.domain,t),fetch(`${w}/paywall/start-store-fallback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(()=>{}),{success:!0,session:t}}catch(t){return{success:!1,error:t.message}}}async function tt(){const e=await o.getLastSyncTime(),t=await o.getAllSessions();return{desktopConnected:d?.readyState===WebSocket.OPEN,lastSync:e,sessions:t}}async function nt(e,t){const n=typeof e?.url=="string"?e.url.trim():"";if(!n)return{success:!1,error:"Missing URL"};if(!/^https?:/i.test(n))return{success:!1,error:"Only http(s) URLs are supported"};try{const r=t.tab?.id;if(typeof r=="number")return await chrome.tabs.update(r,{url:n}),e.roulette&&P.set(r,{openedAt:Date.now(),url:n,title:typeof e.roulette.title=="string"?e.roulette.title:void 0,libraryId:typeof e.roulette.libraryId=="number"?e.roulette.libraryId:void 0,readingId:typeof e.roulette.readingId=="string"?e.roulette.readingId:void 0}),{success:!0};const i=await chrome.tabs.create({url:n,active:!0});return e.roulette&&i?.id!=null&&P.set(i.id,{openedAt:Date.now(),url:n,title:typeof e.roulette.title=="string"?e.roulette.title:void 0,libraryId:typeof e.roulette.libraryId=="number"?e.roulette.libraryId:void 0,readingId:typeof e.roulette.readingId=="string"?e.roulette.readingId:void 0}),{success:!0}}catch(r){return{success:!1,error:r.message}}}async function it(e){const t=typeof e?.app=="string"?e.app.trim():"";if(!t)return{success:!1,error:"Missing app name"};try{const n=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"app",app:t}),cache:"no-store"});if(!n.ok){const r=await n.json().catch(()=>null);return{success:!1,error:r?.error?String(r.error):"Failed to open app"}}return{success:!0}}catch(n){return{success:!1,error:n.message}}}async function oe(e){const t=typeof e?.id=="number"&&Number.isFinite(e.id)?e.id:null;if(t==null)return{success:!1,error:"Missing library item id"};const r=e?.consumed!==!1?new Date().toISOString():null,a=((await o.getState()).libraryItems??[]).find(c=>c?.id===t)??null;return a?a.kind!=="url"||!a.url?{success:!1,error:"Only URL items can be marked as consumed"}:(await o.setLibraryItemConsumed(t,r),await o.queueLibrarySync({url:a.url,purpose:a.purpose,price:typeof a.price=="number"?a.price:void 0,title:a.title??null,note:a.note??null,consumedAt:r}),{success:!0,synced:(await K([a.url])).succeeded>0}):{success:!1,error:"Library item not found"}}async function rt(e){const t=typeof e?.id=="string"?e.id.trim():"";if(!t)return{success:!1,error:"Missing reading id"};const n=e?.consumed!==!1;return await o.markReadingConsumed(t,n),{success:!0}}async function st(e){const t=await ne("/paywall/packs",{domain:e.domain,minutes:e.minutes});if(t.ok)return{success:!0,session:t.session};const n=await o.getMarketRate(e.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const r=n.packs.find(i=>i.minutes===e.minutes);if(!r)return{success:!1,error:"Pack not found"};try{await o.spendCoins(r.price);const i={domain:e.domain,mode:"pack",ratePerMin:n.ratePerMin,remainingSeconds:r.minutes*60,startedAt:Date.now(),spendRemainder:0,purchasePrice:r.price,purchasedSeconds:r.minutes*60};return await o.setSession(e.domain,i),console.log(`‚úÖ Purchased ${r.minutes} minutes for ${e.domain} (offline mode)`),{success:!0,session:i}}catch(i){return{success:!1,error:i.message}}}async function at(e){const t=await ne("/paywall/metered",{domain:e.domain});if(t.ok)return{success:!0,session:t.session};const n=await o.getMarketRate(e.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const r={domain:e.domain,mode:"metered",ratePerMin:n.ratePerMin,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0};return await o.setSession(e.domain,r),console.log(`‚úÖ Started metered session for ${e.domain} (offline mode)`),{success:!0,session:r}}async function ot(e){d&&d.readyState===WebSocket.OPEN&&d.send(JSON.stringify({type:"paywall:pause",payload:e}));const t=await o.getSession(e.domain);return t?(t.paused=!0,await o.setSession(e.domain,t),{success:!0}):{success:!1,error:"No session found"}}async function ct(e){d&&d.readyState===WebSocket.OPEN&&d.send(JSON.stringify({type:"paywall:resume",payload:e}));const t=await o.getSession(e.domain);return t?(t.paused=!1,await o.setSession(e.domain,t),{success:!0}):{success:!1,error:"No session found"}}async function lt(e){const t=await o.getSession(e.domain);if(!t)return{success:!1,error:"No session found"};const n=ge(t),r=d&&d.readyState===WebSocket.OPEN;r&&d&&d.send(JSON.stringify({type:"paywall:end",payload:{domain:e.domain}})),(r?{ok:!0}:await Te(e.domain)).ok||n>0&&await o.earnCoins(n),await o.clearSession(e.domain);const a=await M();return a&&a.url&&a.id&&new URL(a.url).hostname.replace(/^www\./,"")===e.domain&&await S(a.id,e.domain,"ended","session-ended"),{success:!0,refund:n}}async function ut(e){const t=await Pe(e);if(t.ok)return{success:!0,session:t.session};if(!t.canFallback)return{success:!1,error:t.error};const r=(await o.getState()).settings.emergencyPolicy??"balanced",i=ye(r);if(i.id==="off")return{success:!1,error:"Emergency access is disabled in Settings."};const a=Date.now(),s=new Date(a).toISOString().slice(0,10),c=await o.getEmergencyUsage(),l=c.day===s?c:{day:s,tokensUsed:0,cooldownUntil:null};if(l.cooldownUntil&&a<l.cooldownUntil)return{success:!1,error:`Emergency cooldown active (${Math.max(1,Math.ceil((l.cooldownUntil-a)/6e4))}m remaining).`};if(typeof i.tokensPerDay=="number"&&l.tokensUsed>=i.tokensPerDay)return{success:!1,error:`No emergency uses left today (${i.tokensPerDay}/day).`};const f={...l,tokensUsed:l.tokensUsed+(typeof i.tokensPerDay=="number"?1:0),cooldownUntil:i.cooldownSeconds>0?a+i.cooldownSeconds*1e3:null};await o.setEmergencyUsage(f);const p=i.urlLocked&&e.url?E(e.url):null,m={domain:e.domain,mode:"emergency",ratePerMin:0,remainingSeconds:i.durationSeconds,startedAt:a,lastTick:a,paused:!1,spendRemainder:0,justification:e.justification,lastReminder:a,allowedUrl:p??void 0};return await o.setSession(e.domain,m),console.log(`‚úÖ Started emergency session for ${e.domain} (offline mode)`),{success:!0,session:m}}async function dt(e){const t=e?.outcome;if(t!=="kept"&&t!=="not-kept")return{success:!1,error:"Invalid outcome"};const n=await o.recordEmergencyReview(t);if(d&&d.readyState===WebSocket.OPEN)return d.send(JSON.stringify({type:"paywall:emergency-review",payload:{outcome:t,domain:e.domain}})),{success:!0,stats:n};try{await fetch(`${w}/paywall/emergency-review`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({outcome:t}),cache:"no-store"})}catch{}return{success:!0,stats:n}}chrome.runtime.onStartup.addListener(()=>{o.init(),_(),J()});chrome.runtime.onInstalled.addListener(()=>{J()});J();chrome.contextMenus.onClicked.addListener(async(e,t)=>{const n=e.tabId??t?.id,r=e.linkUrl||e.pageUrl,i=Je(r),a=e.linkText??null,s=typeof e.selectionText=="string"?e.selectionText:null,c=t?.title??null,l=String(e.menuItemId),f=l===u.saveReplace||l===u.saveProductive||l===u.saveAllow||l===u.saveTemptation||l===u.savePriced,p=m=>m===u.saveReplace?"replace":m===u.saveProductive?"productive":m===u.saveAllow?"allow":m===u.saveTemptation?"temptation":m===u.savePriced?"allow":null;if(f){if(!i){await k("Unable to capture that link.",n);return}const m=p(l);if(!m)return;if(l===u.savePriced){if(!n)return;try{const y=await re(i),v={url:i,price:typeof y?.price=="number"?y.price:pe,title:y?.title??V(i,a,s,c)},g=await Qe(n,v);if(!g)return;const ce=U(g.title??null)??null,G=await j({url:g.url,purpose:"allow",price:g.price,title:ce,note:null}),le=G.action==="updated"?"Updated":"Saved",ue=G.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${le} priced unlock (${g.price} f-coins). ${ue}`,n)}catch(y){await k(y.message||"Failed to save priced unlock",n)}return}const h=V(i,a,s,c);try{const y=await j({url:i,purpose:m,title:h,note:null}),v=y.action==="updated"?"Updated":"Saved",g=y.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${v} to Library (${m}). ${g}`,n)}catch(y){await k(y.message||"Failed to save to library",n)}return}if(l===u.domainProductive||l===u.domainNeutral||l===u.domainFrivolous){const m=typeof e.pageUrl=="string"?e.pageUrl:typeof t?.url=="string"?t.url:"",h=D(m);if(!h){await k("Unable to detect a domain for this page.",n);return}const y=l===u.domainProductive?"productive":l===u.domainNeutral?"neutral":"frivolous",v=await ae({domain:h,category:y});if(!v.success){await k(v.error??"Failed to label domain",n);return}const g=v.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`Marked ${h} as ${y}. ${g}`,n)}});
