const x={wallet:{balance:100,lastSynced:Date.now()},marketRates:{"twitter.com":{domain:"twitter.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"x.com":{domain:"x.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"reddit.com":{domain:"reddit.com",ratePerMin:2,packs:[{minutes:10,price:18},{minutes:30,price:50}],hourlyModifiers:Array(24).fill(1)},"youtube.com":{domain:"youtube.com",ratePerMin:2.5,packs:[{minutes:10,price:23},{minutes:30,price:65}],hourlyModifiers:Array(24).fill(1)}},settings:{frivolityDomains:["twitter.com","x.com","reddit.com","youtube.com","facebook.com","instagram.com","tiktok.com"],productiveDomains:["github.com","stackoverflow.com"],neutralDomains:["gmail.com","calendar.google.com"],idleThreshold:15,emergencyPolicy:"balanced",economyExchangeRate:1.6666666666666667,journal:{url:null,minutes:10}},pendingCategorisation:null,sessions:{},libraryItems:[],pendingLibrarySync:{},nextLibraryTempId:-1,lastDesktopSync:0,consumedReading:{},emergency:{usage:{day:new Date().toISOString().slice(0,10),tokensUsed:0,cooldownUntil:null},lastEnded:null,reviewStats:{total:0,kept:0,notKept:0}}};class oe{state=null;ensureStateDefaults(){if(!this.state)return;if(this.state.pendingLibrarySync||(this.state.pendingLibrarySync={}),typeof this.state.nextLibraryTempId!="number"&&(this.state.nextLibraryTempId=-1),this.state.emergency||(this.state.emergency=x.emergency),this.state.settings||(this.state.settings=x.settings),this.state.settings.emergencyPolicy||(this.state.settings.emergencyPolicy="balanced"),typeof this.state.settings.economyExchangeRate!="number"&&(this.state.settings.economyExchangeRate=5/3),!this.state.settings.journal||typeof this.state.settings.journal!="object")this.state.settings.journal={url:null,minutes:10};else{const n=this.state.settings.journal,i=typeof n.url=="string"?n.url.trim():"",r=typeof n.minutes=="number"&&Number.isFinite(n.minutes)?Math.max(1,Math.min(180,Math.round(n.minutes))):10;this.state.settings.journal={url:i||null,minutes:r}}this.state.consumedReading||(this.state.consumedReading={}),this.state.pendingCategorisation===void 0&&(this.state.pendingCategorisation=null);const e=this.state;if(Array.isArray(e.storeItems)&&e.storeItems.length){const n=Array.isArray(e.libraryItems)?e.libraryItems:[],i=new Map;for(const r of n)r?.kind==="url"&&typeof r.url=="string"&&i.set(r.url,r);for(const r of e.storeItems){const a=typeof r?.url=="string"?r.url:"";if(!a)continue;const s=i.get(a);s?(typeof s.price!="number"&&typeof r.price=="number"&&(s.price=r.price),!s.title&&r.title&&(s.title=r.title)):n.unshift({id:typeof r.id=="number"?r.id:this.state.nextLibraryTempId--,kind:"url",url:a,domain:r.domain??this.toStoreDomain(a),title:r.title??void 0,note:void 0,purpose:"allow",price:typeof r.price=="number"?r.price:void 0,createdAt:r.createdAt??new Date().toISOString(),lastUsedAt:r.lastUsedAt??void 0})}e.libraryItems=n,delete e.storeItems}if(Array.isArray(e.libraryItems)&&(e.libraryItems=e.libraryItems.filter(n=>n&&(n.kind==="url"||n.kind==="app")).map(n=>{const i=n.bucket,r=n.purpose==="replace"||n.purpose==="allow"||n.purpose==="temptation"?n.purpose:i==="attractor"?"replace":i==="frivolous"?"temptation":"allow",a={id:n.id,kind:n.kind,url:n.url,app:n.app,domain:n.domain??(n.kind==="url"?this.toStoreDomain(n.url):String(n.app??"")),title:n.title,note:n.note,purpose:r,price:n.price,createdAt:n.createdAt,lastUsedAt:n.lastUsedAt,consumedAt:n.consumedAt};return delete a.bucket,a})),e.pendingStoreSync&&typeof e.pendingStoreSync=="object"){const n=e.pendingStoreSync;for(const i of Object.values(n)){const r=typeof i?.url=="string"?i.url:"";if(!r)continue;const a=typeof i?.updatedAt=="number"?i.updatedAt:Date.now(),s=this.state.pendingLibrarySync[r];s&&s.updatedAt>a||(this.state.pendingLibrarySync[r]={url:r,purpose:"allow",price:typeof i?.price=="number"?i.price:null,title:i?.title??null,note:null,updatedAt:a})}delete e.pendingStoreSync}delete e.nextStoreTempId,this.state.libraryItems||(this.state.libraryItems=[])}async init(){const e=await chrome.storage.local.get("state");e.state?(this.state=e.state,this.ensureStateDefaults()):(this.state=x,await this.save())}async save(){this.state&&await chrome.storage.local.set({state:this.state})}async getWallet(){return this.state||await this.init(),this.state.wallet}async getBalance(){return(await this.getWallet()).balance}async spendCoins(e){if(this.state||await this.init(),this.state.wallet.balance<e)throw new Error("Insufficient funds");return this.state.wallet.balance-=e,await this.save(),this.state.wallet.balance}async earnCoins(e){return this.state||await this.init(),this.state.wallet.balance+=e,await this.save(),this.state.wallet.balance}async getMarketRate(e){this.state||await this.init();const n=this.state.marketRates[e];return n||(e==="x.com"?this.state.marketRates["twitter.com"]??null:null)}async setMarketRate(e){this.state||await this.init(),this.state.marketRates[e.domain]=e,await this.save()}async isFrivolous(e){this.state||await this.init();const n=[e];return e==="x.com"&&n.push("twitter.com"),this.state.settings.frivolityDomains.some(i=>n.some(r=>r.includes(i)||i.includes(r)))}async getIdleThreshold(){return this.state||await this.init(),this.state.settings.idleThreshold??15}async getSession(e){return this.state||await this.init(),this.state.sessions[e]||null}async setSession(e,n){this.state||await this.init(),this.state.sessions[e]=n,await this.save()}async clearSession(e){this.state||await this.init(),delete this.state.sessions[e],await this.save()}async getAllSessions(){return this.state||await this.init(),this.state.sessions}async getState(){return this.state||await this.init(),this.state}toStoreDomain(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return e}}mergeLibraryItemsWithPending(e){if(!this.state)return e;const n=Object.values(this.state.pendingLibrarySync??{});if(!n.length)return e;const i=[...e];for(const r of n){const a=i.findIndex(s=>s.kind==="url"&&s.url===r.url);if(a>=0){const s=i[a];i[a]={...s,purpose:r.purpose,price:r.price===void 0?s.price:typeof r.price=="number"?r.price:void 0,title:r.title??s.title,note:r.note??s.note,consumedAt:r.consumedAt===void 0?s.consumedAt:r.consumedAt??void 0}}else{const s=this.state.nextLibraryTempId--;i.unshift({id:s,kind:"url",url:r.url,domain:this.toStoreDomain(r.url),title:r.title??void 0,note:r.note??void 0,purpose:r.purpose,price:typeof r.price=="number"?r.price:void 0,createdAt:new Date().toISOString(),consumedAt:r.consumedAt??void 0})}}return i}async updateFromDesktop(e){if(this.state||await this.init(),e.wallet&&(this.state.wallet=e.wallet),e.marketRates&&(this.state.marketRates=e.marketRates),e.settings&&(this.state.settings=e.settings),e.sessions&&(this.state.sessions=e.sessions),e.libraryItems){const n=e.libraryItems??[];this.state.libraryItems=this.mergeLibraryItemsWithPending(n)}this.ensureStateDefaults(),this.state.pendingCategorisation&&(this.state.settings={...this.state.settings,productiveDomains:this.state.pendingCategorisation.productiveDomains,neutralDomains:this.state.pendingCategorisation.neutralDomains,frivolityDomains:this.state.pendingCategorisation.frivolityDomains}),this.state.lastDesktopSync=Date.now(),await this.save()}async queueCategorisationUpdate(e){this.state||await this.init(),this.state.settings={...this.state.settings,productiveDomains:e.productiveDomains,neutralDomains:e.neutralDomains,frivolityDomains:e.frivolityDomains},this.state.pendingCategorisation={...e,updatedAt:Date.now()},await this.save()}async getPendingCategorisationUpdate(){return this.state||await this.init(),this.state.pendingCategorisation??null}async clearPendingCategorisationUpdate(){this.state||await this.init(),this.state.pendingCategorisation=null,await this.save()}async recordEmergencyEnded(e){this.state||await this.init(),this.state.emergency.lastEnded=e,await this.save()}async recordEmergencyReview(e){return this.state||await this.init(),this.state.emergency.reviewStats.total+=1,e==="kept"?this.state.emergency.reviewStats.kept+=1:this.state.emergency.reviewStats.notKept+=1,await this.save(),this.state.emergency.reviewStats}async getEmergencyUsage(){return this.state||await this.init(),this.state.emergency.usage}async setEmergencyUsage(e){this.state||await this.init(),this.state.emergency.usage=e,await this.save()}async getLastSyncTime(){return this.state||await this.init(),this.state.lastDesktopSync}async getLibraryItems(){return this.state||await this.init(),this.state.libraryItems??[]}async setLibraryItemConsumed(e,n){this.state||await this.init();const i=this.state.libraryItems??[],r=i.findIndex(s=>s.id===e);if(r<0)return;const a=i[r];i[r]={...a,consumedAt:n??void 0},this.state.libraryItems=i,await this.save()}async markReadingConsumed(e,n){this.state||await this.init();const i=(e??"").trim();i&&(this.state.consumedReading||(this.state.consumedReading={}),n?this.state.consumedReading[i]=Date.now():delete this.state.consumedReading[i],await this.save())}async queueLibrarySync(e){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");this.state.pendingLibrarySync[e.url]={url:e.url,purpose:e.purpose,price:e.price,title:e.title??null,note:e.note??null,consumedAt:e.consumedAt,updatedAt:Date.now()},await this.save()}async getPendingLibrarySync(){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");return this.state.pendingLibrarySync}async clearPendingLibrarySync(e){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");delete this.state.pendingLibrarySync[e],await this.save()}}const o=new oe,w="http://127.0.0.1:17600",ce="ws://127.0.0.1:17600/events",le=12,z=chrome.runtime.getURL("assets/notification.png"),f={rootSave:"tws-save",rootDomain:"tws-domain",saveReplace:"save-to-library-replace",saveAllow:"save-to-library-allow",saveTemptation:"save-to-library-temptation",savePriced:"save-to-library-priced",domainProductive:"label-domain-productive",domainNeutral:"label-domain-neutral",domainFrivolous:"label-domain-frivolous"};let u=null,D=null,q=null,R="active",L=Date.now();const ue=2e4,de=2400,T=[],A=new Map,P=new Map;function fe(t){switch(t){case"off":return{id:t,durationSeconds:0,tokensPerDay:0,cooldownSeconds:0,urlLocked:!0};case"gentle":return{id:t,durationSeconds:300,tokensPerDay:null,cooldownSeconds:0,urlLocked:!0};case"strict":return{id:t,durationSeconds:120,tokensPerDay:1,cooldownSeconds:3600,urlLocked:!0};case"balanced":default:return{id:"balanced",durationSeconds:180,tokensPerDay:2,cooldownSeconds:1800,urlLocked:!0}}}function E(t){try{const e=new URL(t);return`${e.origin}${e.pathname}`}catch{return null}}function me(t){if(t.mode!=="pack"||!t.purchasePrice||!t.purchasedSeconds)return 0;const n=Math.max(0,Math.min(t.purchasedSeconds,t.remainingSeconds))/t.purchasedSeconds;return Math.round(t.purchasePrice*n)}o.init().then(()=>{console.log("TimeWellSpent: Storage initialized"),ye(),we(),j()});chrome.tabs.onRemoved.addListener(t=>{const e=A.get(t);!e||(A.delete(t),Date.now()-e.openedAt<ue)||Fe(e).catch(()=>{})});chrome.notifications?.onButtonClicked?.addListener((t,e)=>{const n=P.get(t);if(n){if(P.delete(t),e===0){typeof n.libraryId=="number"&&ie({id:n.libraryId,consumed:!0}).catch(()=>{}),n.readingId&&o.markReadingConsumed(n.readingId,!0).catch(()=>{});return}e===1&&chrome.tabs.create({url:n.url,active:!0}).then(i=>{i?.id!=null&&A.set(i.id,{...n,openedAt:Date.now()})}).catch(()=>{})}});chrome.notifications?.onClosed?.addListener(t=>{P.delete(t)});function j(){u||(console.log("Attempting to connect to desktop app..."),u=new WebSocket(ce),u.onopen=async()=>{console.log("‚úÖ Connected to desktop app"),D&&(clearTimeout(D),D=null),await v(),await J(),await te(),ge()},u.onclose=()=>{console.log("‚ùå Disconnected from desktop app (extension will work offline)"),u=null,pe()},u.onerror=t=>{console.error("Desktop connection error:",t),u=null},u.onmessage=t=>{try{const e=JSON.parse(t.data);he(e)}catch(e){console.error("Failed to parse desktop message",e)}})}function pe(){D||(D=setTimeout(()=>{D=null,j()},3e4))}async function v(){try{const t=await fetch(`${w}/extension/state`);if(t.ok){const e=await t.json();await o.updateFromDesktop(e),console.log("‚úÖ Synced state from desktop app")}}catch{console.log("Desktop app not available for sync")}}function he(t){if(t.type==="wallet")o.updateFromDesktop({wallet:t.payload});else if(t.type==="market-update")o.updateFromDesktop({marketRates:t.payload});else if(t.type==="library-sync"){const e=Array.isArray(t.payload?.items)?t.payload.items:t.payload;Array.isArray(e)&&o.updateFromDesktop({libraryItems:e})}else if(t.type==="paywall-session-started"){const e=t.payload;e?.domain&&o.setSession(e.domain,{domain:e.domain,mode:e.mode,ratePerMin:e.ratePerMin,remainingSeconds:e.remainingSeconds??1/0,startedAt:Date.now(),paused:e.paused??!1,spendRemainder:e.spendRemainder??0,purchasePrice:e.purchasePrice,purchasedSeconds:e.purchasedSeconds,justification:e.justification,lastReminder:e.lastReminder,allowedUrl:e.allowedUrl})}else if(t.type==="paywall-session-ended"){if(t.payload?.domain){const{domain:e,reason:n}=t.payload;o.getSession(e).then(i=>{i?.mode==="emergency"&&n==="emergency-expired"&&o.recordEmergencyEnded({domain:e,justification:i.justification,endedAt:Date.now()}),o.clearSession(e)}),console.log(`üõë Session ended for ${e} (${n})`),M().then(async i=>{i&&i.url&&i.id&&new URL(i.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to session end`),await S(i.id,e,n))})}}else if(t.type==="paywall-session-paused"){if(t.payload?.domain){const e=t.payload.domain;o.getSession(e).then(n=>{n&&o.setSession(e,{...n,paused:!0})}),M().then(async n=>{n&&n.url&&n.id&&new URL(n.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to pause`),await S(n.id,e,"paused"))})}}else if(t.type==="paywall-session-resumed"){if(t.payload?.domain){const e=t.payload.domain;o.getSession(e).then(n=>{n&&o.setSession(e,{...n,paused:!1})})}}else if(t.type==="paywall-reminder"&&t.payload?.domain){const{domain:e,justification:n}=t.payload;chrome.notifications?.create(`tws-reminder-${e}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${e}${n?` ‚Äî Reason: ${n}`:""}.`})}}chrome.tabs.onActivated.addListener(async t=>{const e=await chrome.tabs.get(t.tabId);e.url&&await F(e.id,e.url,"onActivated"),await _("tab-activated")});chrome.tabs.onUpdated.addListener(async(t,e,n)=>{(e.status==="loading"||e.status==="complete")&&n.url&&await F(t,n.url,`onUpdated:${e.status}`),e.status==="complete"&&n.active&&await _("tab-updated")});chrome.webNavigation.onCommitted.addListener(async t=>{t.frameId===0&&await F(t.tabId,t.url,"webNavigation:onCommitted")});chrome.windows.onFocusChanged.addListener(async()=>{await _("window-focus")});async function F(t,e,n){if(!(!e||!e.startsWith("http")))try{const r=new URL(e).hostname.replace(/^www\./,"");if(await o.isFrivolous(r)){const s=await o.getSession(r);if(s&&!s.paused)if(s.allowedUrl){const l=E(e);if(!(!l||l!==s.allowedUrl)){if(s.mode==="metered")return;if(s.remainingSeconds>0)return}}else{if(s.mode==="metered")return;if(s.remainingSeconds>0)return}const c=s?.allowedUrl?"url-locked":void 0;console.log(`üö´ Blocking ${r} (source: ${n})`),await S(t,r,c)}}catch(i){console.error("Error checking URL:",i)}}function ye(){q||(q=setInterval(async()=>{await V()},15e3))}async function V(){const t=Date.now();if(u&&u.readyState===WebSocket.OPEN)return;const e=await o.getAllSessions(),n=await chrome.tabs.query({active:!0,currentWindow:!0}),i=async()=>{await Promise.all(Object.entries(e).map(([l,d])=>o.setSession(l,{...d,paused:!0})))};if(n.length===0){await i();return}const r=n[0];if(!r.url||!r.url.startsWith("http")){await i();return}const s=new URL(r.url).hostname.replace(/^www\./,""),c=e[s];if(Object.entries(e).forEach(async([l,d])=>{l!==s&&!d.paused?await o.setSession(l,{...d,paused:!0}):l===s&&d.paused&&await o.setSession(l,{...d,paused:!1})}),!!c){if(c.mode!=="emergency"&&c.allowedUrl){const l=E(r.url);if(!l||l!==c.allowedUrl){c.paused||await o.setSession(s,{...c,paused:!0}),r.id&&await S(r.id,s,"url-locked");return}}if(c.mode==="emergency"){if(c.allowedUrl){const h=E(r.url);if(!h||h!==c.allowedUrl){c.paused||await o.setSession(s,{...c,paused:!0}),r.id&&await S(r.id,s,"url-locked");return}}const l=300*1e3,d=c.lastReminder??c.startedAt;Date.now()-d>l&&(c.lastReminder=Date.now(),await o.setSession(s,c),chrome.notifications?.create(`tws-reminder-${s}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${s}${c.justification?` ‚Äî Reason: ${c.justification}`:""}.`}));const p=c.lastTick??c.startedAt,m=Math.max(0,Math.round((t-p)/1e3));c.remainingSeconds-=m,c.lastTick=t,c.remainingSeconds<=0?(await o.recordEmergencyEnded({domain:s,justification:c.justification,endedAt:t}),await o.clearSession(s),r.id&&await S(r.id,s,"emergency-expired")):await o.setSession(s,c);return}else if(c.mode==="metered"){const l=(await o.getMarketRate(s))?.ratePerMin??c.ratePerMin,d=c.lastTick??c.startedAt,p=Math.max(0,Math.round((t-d)/1e3)),m=l/60*p+(c.spendRemainder??0),h=Math.floor(m),y=m-h;try{h>0&&await o.spendCoins(h),c.ratePerMin=l,c.spendRemainder=y,c.lastTick=t,await o.setSession(s,c)}catch{console.log(`‚ùå Insufficient funds for ${s}`),await o.clearSession(s),r.id&&await S(r.id,s,"insufficient-funds")}}else{const l=c.lastTick??c.startedAt,d=Math.max(0,Math.round((t-l)/1e3));c.remainingSeconds-=d,c.lastTick=t,c.remainingSeconds<=0?(console.log(`‚è∞ Time's up for ${s}`),await o.clearSession(s),r.id&&await S(r.id,s,"time-expired")):await o.setSession(s,c)}}}async function we(){const t=await o.getIdleThreshold();chrome.idle.setDetectionInterval(t),chrome.idle.queryState(t,e=>{R=e,e==="active"&&(L=Date.now())}),chrome.idle.onStateChanged.addListener(e=>{R=e,e==="active"&&(L=Date.now())}),chrome.storage.onChanged.addListener(e=>{if(e.state&&e.state.newValue){const n=e.state.newValue,i=e.state.oldValue,r=n.settings?.idleThreshold,a=i?.settings?.idleThreshold;r&&r!==a&&(console.log("Updating idle threshold to",r),chrome.idle.setDetectionInterval(r))}})}async function _(t){const e=await M();if(!e||!e.url)return;const n=new URL(e.url).hostname.replace(/^www\./,""),i=R==="active"?0:Math.floor((Date.now()-L)/1e3),r={type:"activity",reason:t,payload:{timestamp:Date.now(),source:"url",appName:X(),windowTitle:e.title??n,url:e.url,domain:n,idleSeconds:i}};H(r)}async function M(){const t=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t.length===0)return null;const e=t[0];return!e.url||!e.url.startsWith("http")?null:e}function H(t){u&&u.readyState===WebSocket.OPEN?u.send(JSON.stringify(t)):(T.push(t),T.length>de&&T.shift())}function ge(){if(!(!u||u.readyState!==WebSocket.OPEN))for(;T.length>0;){const t=T.shift();t&&u.send(JSON.stringify(t))}}function X(){const t=navigator.userAgent.toLowerCase();return t.includes("brave")?"Brave":t.includes("edg/")?"Edge":t.includes("arc")?"Arc":t.includes("firefox")?"Firefox":"Chrome"}async function Se(t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content-loader.js"]})}catch{}}async function S(t,e,n){await Se(t);try{await chrome.tabs.sendMessage(t,{type:"TWS_PING"})}catch{await new Promise(i=>setTimeout(i,150))}try{await chrome.tabs.sendMessage(t,{type:"BLOCK_SCREEN",payload:{domain:e,reason:n}}),console.log(`üîí Block screen message sent to tab ${t} for ${e}`)}catch(i){console.warn("Failed to send block message",i)}}async function Q(t,e){try{const n=await fetch(`${w}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});if(!n.ok)throw new Error("desktop unreachable");const i=await n.json();return await o.updateFromDesktop({sessions:{[i.domain]:{...i,startedAt:Date.now(),paused:!1,spendRemainder:i.spendRemainder??0}}}),await v(),{ok:!0,session:i}}catch(n){return console.log("Desktop purchase failed, falling back to local",n),{ok:!1,error:n.message}}}async function be(t){try{const e=await fetch(`${w}/paywall/emergency`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!e.ok){const i=await e.json().catch(()=>null);return{ok:!1,error:i?.error?String(i.error):"Desktop rejected request",canFallback:!1}}const n=await e.json();return await o.updateFromDesktop({sessions:{[n.domain]:{...n,startedAt:Date.now(),paused:!1,spendRemainder:n.spendRemainder??0}}}),await v(),{ok:!0,session:n}}catch(e){return console.log("Desktop emergency start failed, falling back to local",e),{ok:!1,error:e.message,canFallback:!0}}}async function ke(t){try{if(!(await fetch(`${w}/paywall/end`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:t}),cache:"no-store"})).ok)throw new Error("desktop unreachable");return await v(),{ok:!0}}catch(e){return console.log("Desktop end-session failed, falling back to local",e),{ok:!1,error:e.message}}}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="GET_STATUS")return Ye(t.payload).then(n),!0;if(t.type==="GET_CONNECTION")return Ve().then(n),!0;if(t.type==="PAGE_HEARTBEAT")return Ie(t.payload,e).then(n),!0;if(t.type==="GET_LINK_PREVIEWS")return Ne(t.payload).then(n),!0;if(t.type==="OPEN_URL")return He(t.payload,e).then(n),!0;if(t.type==="OPEN_APP")return Xe(t.payload).then(n),!0;if(t.type==="OPEN_DESKTOP_ACTION")return De(t.payload).then(n),!0;if(t.type==="UPSERT_LIBRARY_ITEM")return qe(t.payload).then(n),!0;if(t.type==="SET_DOMAIN_CATEGORY")return ne(t.payload).then(n),!0;if(t.type==="BUY_PACK")return Ze(t.payload).then(n),!0;if(t.type==="START_METERED")return et(t.payload).then(n),!0;if(t.type==="PAUSE_SESSION")return tt(t.payload).then(n),!0;if(t.type==="RESUME_SESSION")return nt(t.payload).then(n),!0;if(t.type==="END_SESSION")return it(t.payload).then(n),!0;if(t.type==="START_EMERGENCY")return rt(t.payload).then(n),!0;if(t.type==="START_STORE_SESSION")return ze(t.payload).then(n),!0;if(t.type==="EMERGENCY_REVIEW")return st(t.payload).then(n),!0;if(t.type==="MARK_LIBRARY_CONSUMED")return ie(t.payload).then(n),!0;if(t.type==="MARK_READING_CONSUMED")return Qe(t.payload).then(n),!0});function ve(t,e){const n=String(t.url??"");if(!n||!/^https?:/i.test(n))return;let i;try{i=new URL(n).hostname.replace(/^www\./,"")}catch{return}const r=R==="active"?0:Math.floor((Date.now()-L)/1e3);H({type:"activity",reason:e,payload:{timestamp:Date.now(),source:"url",appName:X(),windowTitle:t.title??i,url:n,domain:i,idleSeconds:r}})}async function Ie(t,e){try{if(e.tab&&e.tab.active===!1)return{ok:!0};const n=typeof t?.url=="string"?t.url:e.tab?.url;return n?(ve({url:n,title:typeof t?.title=="string"?t.title:e.tab?.title??void 0},"content-heartbeat"),await V(),{ok:!0}):{ok:!0}}catch{return{ok:!0}}}async function De(t){if(!t||t.kind!=="deeplink"&&t.kind!=="file")return{success:!1,error:"Invalid action"};try{const e=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});return e.ok?{success:!0}:{success:!1,error:(await e.json().catch(()=>null))?.error??"Failed to open in desktop app"}}catch(e){return{success:!1,error:e.message}}}const Te=10080*60*1e3,Ae=250;function Z(t){try{const e=new URL(t);return e.hash="",e.toString()}catch{return null}}function O(t){return`chrome://favicon2/?size=64&url=${encodeURIComponent(t)}`}function C(t,e,n){const i=new RegExp(`<meta\\s+[^>]*${e}=["']${Le(n)}["'][^>]*content=["']([^"']+)["'][^>]*>`,"i"),r=t.match(i);if(r?.[1])return W(r[1]).trim()}function Pe(t){const e=C(t,"property","og:title");if(e)return e;const n=t.match(/<title[^>]*>([^<]{1,200})<\/title>/i);if(n?.[1])return W(n[1]).trim()}function Ee(t){return C(t,"property","og:description")??C(t,"name","description")}function Ue(t){return C(t,"property","og:image")}function Re(t){const e=t.match(/<link\s+[^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*href=["']([^"']+)["'][^>]*>/i)??t.match(/<link\s+[^>]*href=["']([^"']+)["'][^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*>/i);if(e?.[1])return W(e[1]).trim()}function G(t,e){if(t)try{return new URL(t,e).toString()}catch{return}}function Le(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function W(t){return t.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Me(t){const e=t.hostname.replace(/^www\./,"");if(e==="youtu.be"){const n=t.pathname.split("/").filter(Boolean)[0];return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}if(e.endsWith("youtube.com")){const n=t.searchParams.get("v");return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}return null}async function Ce(t){const e=Z(t);if(!e)return null;try{const n=new URL(e),i=Me(n),r=new AbortController,a=setTimeout(()=>r.abort(),4500),s=await fetch(e,{method:"GET",redirect:"follow",cache:"no-store",signal:r.signal}).finally(()=>clearTimeout(a));if(!s.ok)throw new Error(`HTTP ${s.status}`);if(!(s.headers.get("content-type")??"").includes("text/html"))return{url:e,title:void 0,description:void 0,imageUrl:i??void 0,iconUrl:O(e)};const l=await s.text(),d=Pe(l),p=Ee(l),m=i??G(Ue(l),e),h=G(Re(l),e)??O(e);return{url:e,title:d,description:p,imageUrl:m,iconUrl:h}}catch{return{url:e,iconUrl:O(e)}}}async function xe(){const e=(await chrome.storage.local.get("linkPreviewCache")).linkPreviewCache;return!e||typeof e!="object"?{}:e}async function Oe(t){const e=Object.entries(t).filter(([,i])=>i&&typeof i.url=="string").sort((i,r)=>(r[1].updatedAt??0)-(i[1].updatedAt??0)),n={};for(const[i,r]of e.slice(0,Ae))n[i]=r;await chrome.storage.local.set({linkPreviewCache:n})}async function Ne(t){const n=(Array.isArray(t?.urls)?t.urls:[]).map(c=>Z(String(c))).filter(c=>!!c);if(!n.length)return{success:!0,previews:{}};const i=Date.now(),r=await xe(),a={};let s=!1;for(const c of n){const l=r[c];if(l&&i-l.updatedAt<Te){a[c]=l;continue}const d=await Ce(c);if(!d){a[c]=null;continue}const p={...d,updatedAt:i};r[c]=p,a[c]=p,s=!0}return s&&await Oe(r),{success:!0,previews:a}}function B(){chrome.contextMenus?.create&&chrome.contextMenus.removeAll(()=>{const t=chrome.runtime.lastError;t&&console.warn("Failed to clear context menus",t),chrome.contextMenus.create({id:f.rootSave,title:"Save to TimeWellSpent",contexts:["page","link"]}),chrome.contextMenus.create({id:f.saveReplace,parentId:f.rootSave,title:"Replace (Try this instead)",contexts:["page","link"]}),chrome.contextMenus.create({id:f.saveAllow,parentId:f.rootSave,title:"Allow (good link)",contexts:["page","link"]}),chrome.contextMenus.create({id:f.saveTemptation,parentId:f.rootSave,title:"Temptation (keep contained)",contexts:["page","link"]}),chrome.contextMenus.create({id:f.savePriced,parentId:f.rootSave,title:"Allow (priced)‚Ä¶",contexts:["page","link"]}),chrome.contextMenus.create({id:f.rootDomain,title:"Label this domain",contexts:["page"]}),chrome.contextMenus.create({id:f.domainProductive,parentId:f.rootDomain,title:"Productive",contexts:["page"]}),chrome.contextMenus.create({id:f.domainNeutral,parentId:f.rootDomain,title:"Neutral",contexts:["page"]}),chrome.contextMenus.create({id:f.domainFrivolous,parentId:f.rootDomain,title:"Frivolous",contexts:["page"]})})}function $e(t){if(!t)return null;let e=t.trim();if(!e||e.startsWith("chrome://")||e.startsWith("about:"))return null;/^https?:/i.test(e)||(e=`https://${e}`);try{return new URL(e).toString()}catch{return null}}function U(t){if(!t)return;const e=t.trim();if(e)return e.slice(0,80)}function Y(t,e,n,i){const r=U(e)??U(n)??U(i);if(r)return r;try{return new URL(t).hostname}catch{return t}}function je(t,e){const n=t.find(i=>i.kind==="url"&&i.url===e&&typeof i.price=="number");if(n)return n;try{const i=new URL(e),r=`${i.origin}${i.pathname}`;return t.find(a=>a.kind==="url"&&a.url===r&&typeof a.price=="number")??null}catch{return null}}async function k(t,e){if(chrome.notifications)try{await chrome.notifications.create("",{type:"basic",iconUrl:z,title:"TimeWellSpent",message:t,priority:0});return}catch(n){console.warn("Notification failed",n)}if(e)try{await chrome.scripting.executeScript({target:{tabId:e},func:n=>alert(n),args:[t]});return}catch(n){console.warn("Failed to show in-tab alert",n)}console.log(t)}async function Fe(t){const e=(t.title??"").trim(),n=(()=>{try{return new URL(t.url).hostname.replace(/^www\./,"")}catch{return"this tab"}})(),i=e||n;if(chrome.notifications){const r=`tws-roulette-${Date.now()}-${Math.random().toString(16).slice(2)}`;P.set(r,t);try{await chrome.notifications.create(r,{type:"basic",iconUrl:z,title:"TimeWellSpent",message:`Done with ‚Äú${i}‚Äù?`,buttons:[{title:"Done"},{title:"Keep open"}],priority:0});return}catch(a){P.delete(r),console.warn("Failed to show roulette completion notification",a)}}}async function ee(t){const n=((await o.getState()).libraryItems||[]).find(i=>i.kind==="url"&&i.url===t)??null;if(n)return n;try{const i=await fetch(`${w}/library/check?url=${encodeURIComponent(t)}`,{cache:"no-store"});if(i.ok)return(await i.json())?.item??null}catch{}return null}async function _e(t){try{const e=await fetch(`${w}/library/check?url=${encodeURIComponent(t)}`,{cache:"no-store"});return e.ok?(await e.json())?.item??null:null}catch{return null}}async function We(t){const e=await fetch(`${w}/library`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"url",url:t.url,purpose:t.purpose,price:t.price===void 0?void 0:t.price,title:t.title??void 0,note:t.note??void 0,consumedAt:t.consumedAt}),cache:"no-store"});if(!e.ok){let n="Failed to save to desktop app. Is it running?";try{const i=await e.json();i?.error&&(n=i.error)}catch{}throw new Error(n)}}async function Be(t,e){const n=await fetch(`${w}/library/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({purpose:e.purpose,price:e.price===void 0?void 0:e.price,title:e.title??void 0,note:e.note??void 0,consumedAt:e.consumedAt}),cache:"no-store"});if(!n.ok){let i="Failed to update the library item. Is the desktop app running?";try{const r=await n.json();r?.error&&(i=r.error)}catch{}throw new Error(i)}}async function Je(t){const e=await _e(t.url);return e?(await Be(e.id,t),{action:"updated"}):(await We(t),{action:"added"})}async function J(t){const e=await o.getPendingLibrarySync(),n=Object.values(e).filter(r=>!t||t.includes(r.url)).sort((r,a)=>r.updatedAt-a.updatedAt);if(!n.length)return{attempted:0,succeeded:0};let i=0;for(const r of n)try{await Je(r),await o.clearPendingLibrarySync(r.url),i+=1}catch(a){console.warn("Failed to sync library item to desktop",a)}return i>0&&await v(),{attempted:n.length,succeeded:i}}async function $(t){const n=await ee(t.url)?"updated":"added";await o.queueLibrarySync(t);const i=await J([t.url]);return{action:n,synced:i.succeeded>0}}function I(t){const e=(t??"").trim().toLowerCase();if(!e)return null;if(e.startsWith("http://")||e.startsWith("https://"))try{return new URL(e).hostname.replace(/^www\./,"")}catch{return null}return e.split("/")[0].replace(/^www\./,"")||null}function N(t){const e=new Set,n=[];for(const i of t){const r=I(i);!r||e.has(r)||(e.add(r),n.push(r))}return n}async function Ke(t){const e=await fetch(`${w}/settings/categorisation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productive:t.productiveDomains,neutral:t.neutralDomains,frivolity:t.frivolityDomains}),cache:"no-store"});if(!e.ok){let n="Failed to update categorisation on desktop app.";try{const i=await e.json();i?.error&&(n=i.error)}catch{}throw new Error(n)}}async function te(){const t=await o.getPendingCategorisationUpdate();if(!t)return{attempted:0,succeeded:0};try{return await Ke(t),await o.clearPendingCategorisationUpdate(),await v(),{attempted:1,succeeded:1}}catch(e){return console.warn("Failed to sync categorisation update to desktop",e),{attempted:1,succeeded:0}}}async function qe(t){const e=typeof t?.url=="string"?t.url.trim():"",n=t?.purpose;if(!e)return{success:!1,error:"Missing URL"};if(n!=="replace"&&n!=="allow"&&n!=="temptation")return{success:!1,error:"Invalid purpose"};if(n!=="allow"&&typeof t.price=="number")return{success:!1,error:"Only Allow items can be priced"};if(t.price!==void 0&&t.price!==null){const i=Number(t.price);if(!Number.isFinite(i)||!Number.isInteger(i)||i<1)return{success:!1,error:"Invalid price"}}try{return{success:!0,...await $({url:e,purpose:n,price:t.price,title:t?.title??null,note:t?.note??null})}}catch(i){return{success:!1,error:i.message}}}async function ne(t){const e=t?.category,n=I(t?.domain??"");if(!n)return{success:!1,error:"Invalid domain"};if(e!=="productive"&&e!=="neutral"&&e!=="frivolous")return{success:!1,error:"Invalid category"};const i=await o.getState(),r=N((i.settings?.productiveDomains??[]).filter(d=>I(d)!==n)),a=N((i.settings?.neutralDomains??[]).filter(d=>I(d)!==n)),s=N((i.settings?.frivolityDomains??[]).filter(d=>I(d)!==n));e==="productive"&&r.unshift(n),e==="neutral"&&a.unshift(n),e==="frivolous"&&s.unshift(n);const c={productiveDomains:r,neutralDomains:a,frivolityDomains:s};return await o.queueCategorisationUpdate(c),{success:!0,synced:(await te()).succeeded>0}}async function Ge(t,e){const i=(await chrome.scripting.executeScript({target:{tabId:t},func:r=>{const a=prompt(`Save a one-time unlock

Price (f-coins) for:
${r.url}`,String(r.price));if(a===null)return null;const s=a.trim();if(!s)return{error:"Price is required"};const c=parseInt(s,10);if(isNaN(c)||c<1)return{error:"Invalid price"};const l=prompt(`Optional title:
${r.url}`,r.title??"");if(l===null)return null;const d=l.trim();return{url:r.url,price:c,title:d||null}},args:[e]}))[0]?.result;if(!i)return null;if(i.error)throw new Error(i.error??"Invalid input");return i}async function Ye(t){await v().catch(()=>{});const e=await o.getBalance(),n=await o.getMarketRate(t.domain),i=await o.getSession(t.domain),r=await o.getLastSyncTime(),a=await o.getState(),s=a.libraryItems??[],c=t.url?je(s,t.url):null;let l=[];try{const p=await fetch(`${w}/integrations/reading?limit=12`,{cache:"no-store"});if(p.ok){const m=await p.json();Array.isArray(m.items)&&(l=m.items)}}catch{}const d=a.consumedReading??{};return l=l.filter(p=>p?.id&&!d[String(p.id)]),{balance:e,rate:n,session:i,matchedPricedItem:c,lastSync:r,desktopConnected:u?.readyState===WebSocket.OPEN,emergencyPolicy:a.settings.emergencyPolicy??"balanced",emergency:a.emergency,journal:a.settings.journal??{url:null,minutes:10},library:{items:s,replaceItems:s.filter(p=>p.purpose==="replace"&&!p.consumedAt),productiveDomains:a.settings.productiveDomains??[],readingItems:l}}}async function ze(t){if(u&&u.readyState===WebSocket.OPEN)return u.send(JSON.stringify({type:"paywall:start-store",payload:t})),{success:!0};try{await o.spendCoins(t.price);const e={domain:t.domain,mode:"store",ratePerMin:0,remainingSeconds:1/0,startedAt:Date.now(),lastTick:Date.now(),paused:!1,purchasePrice:t.price,spendRemainder:0,allowedUrl:t.url?E(t.url)??void 0:void 0};return await o.setSession(t.domain,e),fetch(`${w}/paywall/start-store-fallback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(()=>{}),{success:!0,session:e}}catch(e){return{success:!1,error:e.message}}}async function Ve(){const t=await o.getLastSyncTime(),e=await o.getAllSessions();return{desktopConnected:u?.readyState===WebSocket.OPEN,lastSync:t,sessions:e}}async function He(t,e){const n=typeof t?.url=="string"?t.url.trim():"";if(!n)return{success:!1,error:"Missing URL"};if(!/^https?:/i.test(n))return{success:!1,error:"Only http(s) URLs are supported"};try{const i=e.tab?.id;if(typeof i=="number")return await chrome.tabs.update(i,{url:n}),t.roulette&&A.set(i,{openedAt:Date.now(),url:n,title:typeof t.roulette.title=="string"?t.roulette.title:void 0,libraryId:typeof t.roulette.libraryId=="number"?t.roulette.libraryId:void 0,readingId:typeof t.roulette.readingId=="string"?t.roulette.readingId:void 0}),{success:!0};const r=await chrome.tabs.create({url:n,active:!0});return t.roulette&&r?.id!=null&&A.set(r.id,{openedAt:Date.now(),url:n,title:typeof t.roulette.title=="string"?t.roulette.title:void 0,libraryId:typeof t.roulette.libraryId=="number"?t.roulette.libraryId:void 0,readingId:typeof t.roulette.readingId=="string"?t.roulette.readingId:void 0}),{success:!0}}catch(i){return{success:!1,error:i.message}}}async function Xe(t){const e=typeof t?.app=="string"?t.app.trim():"";if(!e)return{success:!1,error:"Missing app name"};try{const n=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"app",app:e}),cache:"no-store"});if(!n.ok){const i=await n.json().catch(()=>null);return{success:!1,error:i?.error?String(i.error):"Failed to open app"}}return{success:!0}}catch(n){return{success:!1,error:n.message}}}async function ie(t){const e=typeof t?.id=="number"&&Number.isFinite(t.id)?t.id:null;if(e==null)return{success:!1,error:"Missing library item id"};const i=t?.consumed!==!1?new Date().toISOString():null,a=((await o.getState()).libraryItems??[]).find(c=>c?.id===e)??null;return a?a.kind!=="url"||!a.url?{success:!1,error:"Only URL items can be marked as consumed"}:(await o.setLibraryItemConsumed(e,i),await o.queueLibrarySync({url:a.url,purpose:a.purpose,price:typeof a.price=="number"?a.price:void 0,title:a.title??null,note:a.note??null,consumedAt:i}),{success:!0,synced:(await J([a.url])).succeeded>0}):{success:!1,error:"Library item not found"}}async function Qe(t){const e=typeof t?.id=="string"?t.id.trim():"";if(!e)return{success:!1,error:"Missing reading id"};const n=t?.consumed!==!1;return await o.markReadingConsumed(e,n),{success:!0}}async function Ze(t){const e=await Q("/paywall/packs",{domain:t.domain,minutes:t.minutes});if(e.ok)return{success:!0,session:e.session};const n=await o.getMarketRate(t.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const i=n.packs.find(r=>r.minutes===t.minutes);if(!i)return{success:!1,error:"Pack not found"};try{await o.spendCoins(i.price);const r={domain:t.domain,mode:"pack",ratePerMin:n.ratePerMin,remainingSeconds:i.minutes*60,startedAt:Date.now(),spendRemainder:0,purchasePrice:i.price,purchasedSeconds:i.minutes*60};return await o.setSession(t.domain,r),console.log(`‚úÖ Purchased ${i.minutes} minutes for ${t.domain} (offline mode)`),{success:!0,session:r}}catch(r){return{success:!1,error:r.message}}}async function et(t){const e=await Q("/paywall/metered",{domain:t.domain});if(e.ok)return{success:!0,session:e.session};const n=await o.getMarketRate(t.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const i={domain:t.domain,mode:"metered",ratePerMin:n.ratePerMin,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0};return await o.setSession(t.domain,i),console.log(`‚úÖ Started metered session for ${t.domain} (offline mode)`),{success:!0,session:i}}async function tt(t){u&&u.readyState===WebSocket.OPEN&&u.send(JSON.stringify({type:"paywall:pause",payload:t}));const e=await o.getSession(t.domain);return e?(e.paused=!0,await o.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function nt(t){u&&u.readyState===WebSocket.OPEN&&u.send(JSON.stringify({type:"paywall:resume",payload:t}));const e=await o.getSession(t.domain);return e?(e.paused=!1,await o.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function it(t){const e=await o.getSession(t.domain);if(!e)return{success:!1,error:"No session found"};const n=me(e),i=u&&u.readyState===WebSocket.OPEN;i&&u&&u.send(JSON.stringify({type:"paywall:end",payload:{domain:t.domain}})),(i?{ok:!0}:await ke(t.domain)).ok||n>0&&await o.earnCoins(n),await o.clearSession(t.domain);const a=await M();return a&&a.url&&a.id&&new URL(a.url).hostname.replace(/^www\./,"")===t.domain&&await S(a.id,t.domain,"ended"),{success:!0,refund:n}}async function rt(t){const e=await be(t);if(e.ok)return{success:!0,session:e.session};if(!e.canFallback)return{success:!1,error:e.error};const i=(await o.getState()).settings.emergencyPolicy??"balanced",r=fe(i);if(r.id==="off")return{success:!1,error:"Emergency access is disabled in Settings."};const a=Date.now(),s=new Date(a).toISOString().slice(0,10),c=await o.getEmergencyUsage(),l=c.day===s?c:{day:s,tokensUsed:0,cooldownUntil:null};if(l.cooldownUntil&&a<l.cooldownUntil)return{success:!1,error:`Emergency cooldown active (${Math.max(1,Math.ceil((l.cooldownUntil-a)/6e4))}m remaining).`};if(typeof r.tokensPerDay=="number"&&l.tokensUsed>=r.tokensPerDay)return{success:!1,error:`No emergency uses left today (${r.tokensPerDay}/day).`};const d={...l,tokensUsed:l.tokensUsed+(typeof r.tokensPerDay=="number"?1:0),cooldownUntil:r.cooldownSeconds>0?a+r.cooldownSeconds*1e3:null};await o.setEmergencyUsage(d);const p=r.urlLocked&&t.url?E(t.url):null,m={domain:t.domain,mode:"emergency",ratePerMin:0,remainingSeconds:r.durationSeconds,startedAt:a,lastTick:a,paused:!1,spendRemainder:0,justification:t.justification,lastReminder:a,allowedUrl:p??void 0};return await o.setSession(t.domain,m),console.log(`‚úÖ Started emergency session for ${t.domain} (offline mode)`),{success:!0,session:m}}async function st(t){const e=t?.outcome;if(e!=="kept"&&e!=="not-kept")return{success:!1,error:"Invalid outcome"};const n=await o.recordEmergencyReview(e);if(u&&u.readyState===WebSocket.OPEN)return u.send(JSON.stringify({type:"paywall:emergency-review",payload:{outcome:e,domain:t.domain}})),{success:!0,stats:n};try{await fetch(`${w}/paywall/emergency-review`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({outcome:e}),cache:"no-store"})}catch{}return{success:!0,stats:n}}chrome.runtime.onStartup.addListener(()=>{o.init(),j(),B()});chrome.runtime.onInstalled.addListener(()=>{B()});B();chrome.contextMenus.onClicked.addListener(async(t,e)=>{const n=t.tabId??e?.id,i=t.linkUrl||t.pageUrl,r=$e(i),a=t.linkText??null,s=typeof t.selectionText=="string"?t.selectionText:null,c=e?.title??null,l=String(t.menuItemId),d=l===f.saveReplace||l===f.saveAllow||l===f.saveTemptation||l===f.savePriced,p=m=>m===f.saveReplace?"replace":m===f.saveAllow?"allow":m===f.saveTemptation?"temptation":m===f.savePriced?"allow":null;if(d){if(!r){await k("Unable to capture that link.",n);return}const m=p(l);if(!m)return;if(l===f.savePriced){if(!n)return;try{const y=await ee(r),b={url:r,price:typeof y?.price=="number"?y.price:le,title:y?.title??Y(r,a,s,c)},g=await Ge(n,b);if(!g)return;const re=U(g.title??null)??null,K=await $({url:g.url,purpose:"allow",price:g.price,title:re,note:null}),se=K.action==="updated"?"Updated":"Saved",ae=K.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${se} priced unlock (${g.price} f-coins). ${ae}`,n)}catch(y){await k(y.message||"Failed to save priced unlock",n)}return}const h=Y(r,a,s,c);try{const y=await $({url:r,purpose:m,title:h,note:null}),b=y.action==="updated"?"Updated":"Saved",g=y.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${b} to Library (${m}). ${g}`,n)}catch(y){await k(y.message||"Failed to save to library",n)}return}if(l===f.domainProductive||l===f.domainNeutral||l===f.domainFrivolous){const m=typeof t.pageUrl=="string"?t.pageUrl:typeof e?.url=="string"?e.url:"",h=I(m);if(!h){await k("Unable to detect a domain for this page.",n);return}const y=l===f.domainProductive?"productive":l===f.domainNeutral?"neutral":"frivolous",b=await ne({domain:h,category:y});if(!b.success){await k(b.error??"Failed to label domain",n);return}const g=b.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`Marked ${h} as ${y}. ${g}`,n)}});
