const R={wallet:{balance:100,lastSynced:Date.now()},marketRates:{"twitter.com":{domain:"twitter.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}]},"x.com":{domain:"x.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}]},"reddit.com":{domain:"reddit.com",ratePerMin:2,packs:[{minutes:10,price:18},{minutes:30,price:50}]},"youtube.com":{domain:"youtube.com",ratePerMin:2.5,packs:[{minutes:10,price:23},{minutes:30,price:65}]}},settings:{frivolityDomains:["twitter.com","x.com","reddit.com","youtube.com","facebook.com","instagram.com","tiktok.com"],productiveDomains:["github.com","stackoverflow.com"],neutralDomains:["gmail.com","calendar.google.com"],idleThreshold:15},sessions:{},lastDesktopSync:0};class N{state=null;async init(){const e=await chrome.storage.local.get("state");e.state?this.state=e.state:(this.state=R,await this.save())}async save(){this.state&&await chrome.storage.local.set({state:this.state})}async getWallet(){return this.state||await this.init(),this.state.wallet}async getBalance(){return(await this.getWallet()).balance}async spendCoins(e){if(this.state||await this.init(),this.state.wallet.balance<e)throw new Error("Insufficient funds");return this.state.wallet.balance-=e,await this.save(),this.state.wallet.balance}async earnCoins(e){return this.state||await this.init(),this.state.wallet.balance+=e,await this.save(),this.state.wallet.balance}async getMarketRate(e){this.state||await this.init();const s=this.state.marketRates[e];return s||(e==="x.com"?this.state.marketRates["twitter.com"]??null:null)}async setMarketRate(e){this.state||await this.init(),this.state.marketRates[e.domain]=e,await this.save()}async isFrivolous(e){this.state||await this.init();const s=[e];return e==="x.com"&&s.push("twitter.com"),this.state.settings.frivolityDomains.some(n=>s.some(i=>i.includes(n)||n.includes(i)))}async getIdleThreshold(){return this.state||await this.init(),this.state.settings.idleThreshold??15}async getSession(e){return this.state||await this.init(),this.state.sessions[e]||null}async setSession(e,s){this.state||await this.init(),this.state.sessions[e]=s,await this.save()}async clearSession(e){this.state||await this.init(),delete this.state.sessions[e],await this.save()}async getAllSessions(){return this.state||await this.init(),this.state.sessions}async getState(){return this.state||await this.init(),this.state}async updateFromDesktop(e){this.state||await this.init(),e.wallet&&(this.state.wallet=e.wallet),e.marketRates&&(this.state.marketRates=e.marketRates),e.settings&&(this.state.settings=e.settings),e.sessions&&(this.state.sessions=e.sessions),this.state.lastDesktopSync=Date.now(),await this.save()}async getLastSyncTime(){return this.state||await this.init(),this.state.lastDesktopSync}}const a=new N,g="http://127.0.0.1:17600",M="ws://127.0.0.1:17600/events";let o=null,d=null,D=null,T=null,y="active",S=Date.now();const m=[];function O(t){if(t.mode!=="pack"||!t.purchasePrice||!t.purchasedSeconds)return 0;const s=Math.max(0,Math.min(t.purchasedSeconds,t.remainingSeconds))/t.purchasedSeconds;return Math.round(t.purchasePrice*s)}a.init().then(()=>{console.log("TimeWellSpent: Storage initialized"),L(),W(),U(),k()});function k(){o||(console.log("Attempting to connect to desktop app..."),o=new WebSocket(M),o.onopen=async()=>{console.log("‚úÖ Connected to desktop app"),d&&(clearTimeout(d),d=null),await b(),I()},o.onclose=()=>{console.log("‚ùå Disconnected from desktop app (extension will work offline)"),o=null,C()},o.onerror=t=>{console.error("Desktop connection error:",t),o=null},o.onmessage=t=>{try{const e=JSON.parse(t.data);A(e)}catch(e){console.error("Failed to parse desktop message",e)}})}function C(){d||(d=setTimeout(()=>{d=null,k()},3e4))}async function b(){try{const t=await fetch(`${g}/extension/state`);if(t.ok){const e=await t.json();await a.updateFromDesktop(e),console.log("‚úÖ Synced state from desktop app")}}catch{console.log("Desktop app not available for sync")}}function A(t){if(console.log("Received from desktop:",t.type),t.type==="wallet")a.updateFromDesktop({wallet:t.payload});else if(t.type==="market-update")a.updateFromDesktop({marketRates:t.payload});else if(t.type==="paywall-session-started"){const e=t.payload;e?.domain&&a.setSession(e.domain,{domain:e.domain,mode:e.mode,ratePerMin:e.ratePerMin,remainingSeconds:e.remainingSeconds??1/0,startedAt:Date.now(),paused:e.paused??!1,spendRemainder:e.spendRemainder??0,purchasePrice:e.purchasePrice,purchasedSeconds:e.purchasedSeconds})}else if(t.type==="paywall-session-ended"){if(t.payload?.domain){const{domain:e,reason:s}=t.payload;a.clearSession(e),console.log(`üõë Session ended for ${e} (${s})`),p().then(async n=>{n&&n.url&&n.id&&new URL(n.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to session end`),await f(n.id,e,s))})}}else if(t.type==="paywall-session-paused"){if(t.payload?.domain){const e=t.payload.domain;a.getSession(e).then(s=>{s&&a.setSession(e,{...s,paused:!0})}),p().then(async s=>{s&&s.url&&s.id&&new URL(s.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to pause`),await f(s.id,e,"paused"))})}}else if(t.type==="paywall-session-resumed"&&t.payload?.domain){const e=t.payload.domain;a.getSession(e).then(s=>{s&&a.setSession(e,{...s,paused:!1})})}}chrome.tabs.onActivated.addListener(async t=>{const e=await chrome.tabs.get(t.tabId);e.url&&await v(e.id,e.url,"onActivated"),await h("tab-activated")});chrome.tabs.onUpdated.addListener(async(t,e,s)=>{(e.status==="loading"||e.status==="complete")&&s.url&&await v(t,s.url,`onUpdated:${e.status}`),e.status==="complete"&&s.active&&await h("tab-updated")});chrome.webNavigation.onCommitted.addListener(async t=>{t.frameId===0&&await v(t.tabId,t.url,"webNavigation:onCommitted")});chrome.windows.onFocusChanged.addListener(async()=>{await h("window-focus")});async function v(t,e,s){if(!(!e||!e.startsWith("http")))try{const i=new URL(e).hostname.replace(/^www\./,"");if(console.log(`üîç Checking ${i} (source: ${s})`),await a.isFrivolous(i)){const c=await a.getSession(i);if(c&&(c.mode==="metered"||c.remainingSeconds>0)){console.log(`‚úÖ ${i} - allowed (active session)`);return}console.log(`üö´ Blocking ${i} (source: ${s})`),await f(t,i)}}catch(n){console.error("Error checking URL:",n)}}function L(){D||(D=setInterval(async()=>{await $(),await h("heartbeat")},15e3))}async function $(){if(o&&o.readyState===WebSocket.OPEN)return;const t=await a.getAllSessions(),e=await chrome.tabs.query({active:!0,currentWindow:!0}),s=async()=>{await Promise.all(Object.entries(t).map(([l,u])=>a.setSession(l,{...u,paused:!0})))};if(e.length===0){await s();return}const n=e[0];if(!n.url||!n.url.startsWith("http")){await s();return}const r=new URL(n.url).hostname.replace(/^www\./,""),c=t[r];if(Object.entries(t).forEach(async([l,u])=>{l!==r&&!u.paused?await a.setSession(l,{...u,paused:!0}):l===r&&u.paused&&await a.setSession(l,{...u,paused:!1})}),!!c)if(c.mode==="metered"){const l=(await a.getMarketRate(r))?.ratePerMin??c.ratePerMin,u=l/60*15+(c.spendRemainder??0),w=Math.floor(u),E=u-w;try{w>0&&(await a.spendCoins(w),console.log(`üí∞ Spent ${w} coins on ${r}`)),c.ratePerMin=l,c.spendRemainder=E,await a.setSession(r,c)}catch{console.log(`‚ùå Insufficient funds for ${r}`),await a.clearSession(r),n.id&&await f(n.id,r,"insufficient-funds")}}else c.remainingSeconds-=15,c.remainingSeconds<=0?(console.log(`‚è∞ Time's up for ${r}`),await a.clearSession(r),n.id&&await f(n.id,r,"time-expired")):await a.setSession(r,c)}function W(){T||(T=setInterval(async()=>{await h("background")},1e4))}async function U(){const t=await a.getIdleThreshold();chrome.idle.setDetectionInterval(t),chrome.idle.queryState(t,e=>{y=e,e==="active"&&(S=Date.now())}),chrome.idle.onStateChanged.addListener(e=>{y=e,e==="active"&&(S=Date.now())}),chrome.storage.onChanged.addListener(e=>{if(e.state&&e.state.newValue){const s=e.state.newValue,n=e.state.oldValue,i=s.settings?.idleThreshold,r=n?.settings?.idleThreshold;i&&i!==r&&(console.log("Updating idle threshold to",i),chrome.idle.setDetectionInterval(i))}})}async function h(t){const e=await p();if(!e||!e.url)return;const s=new URL(e.url).hostname.replace(/^www\./,""),n=y==="active"?0:Math.floor((Date.now()-S)/1e3),i={type:"activity",reason:t,payload:{timestamp:Date.now(),source:"url",appName:_(),windowTitle:e.title??s,url:e.url,domain:s,idleSeconds:n}};F(i)}async function p(){const t=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t.length===0)return null;const e=t[0];return!e.url||!e.url.startsWith("http")?null:e}function F(t){o&&o.readyState===WebSocket.OPEN?o.send(JSON.stringify(t)):(m.push(t),m.length>50&&m.shift())}function I(){if(!(!o||o.readyState!==WebSocket.OPEN))for(;m.length>0;){const t=m.shift();t&&o.send(JSON.stringify(t))}}function _(){const t=navigator.userAgent.toLowerCase();return t.includes("brave")?"Brave":t.includes("edg/")?"Edge":t.includes("arc")?"Arc":t.includes("firefox")?"Firefox":"Chrome"}async function x(t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content-loader.js"]})}catch{}}async function f(t,e,s){await x(t);try{await chrome.tabs.sendMessage(t,{type:"TWS_PING"})}catch{await new Promise(n=>setTimeout(n,150))}try{await chrome.tabs.sendMessage(t,{type:"BLOCK_SCREEN",payload:{domain:e,reason:s}}),console.log(`üîí Block screen message sent to tab ${t} for ${e}`)}catch(n){console.warn("Failed to send block message",n)}}async function P(t,e){try{const s=await fetch(`${g}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});if(!s.ok)throw new Error("desktop unreachable");const n=await s.json();return await a.updateFromDesktop({sessions:{[n.domain]:{...n,startedAt:Date.now(),paused:!1,spendRemainder:n.spendRemainder??0}}}),await b(),{ok:!0,session:n}}catch(s){return console.log("Desktop purchase failed, falling back to local",s),{ok:!1,error:s.message}}}async function B(t){try{if(!(await fetch(`${g}/paywall/end`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:t}),cache:"no-store"})).ok)throw new Error("desktop unreachable");return await b(),{ok:!0}}catch(e){return console.log("Desktop end-session failed, falling back to local",e),{ok:!1,error:e.message}}}chrome.runtime.onMessage.addListener((t,e,s)=>{if(t.type==="GET_STATUS")return J(t.payload).then(s),!0;if(t.type==="GET_CONNECTION")return j().then(s),!0;if(t.type==="BUY_PACK")return G(t.payload).then(s),!0;if(t.type==="START_METERED")return K(t.payload).then(s),!0;if(t.type==="PAUSE_SESSION")return q(t.payload).then(s),!0;if(t.type==="RESUME_SESSION")return V(t.payload).then(s),!0;if(t.type==="END_SESSION")return z(t.payload).then(s),!0});async function J(t){const e=await a.getBalance(),s=await a.getMarketRate(t.domain),n=await a.getSession(t.domain),i=await a.getLastSyncTime();return{balance:e,rate:s,session:n,lastSync:i,desktopConnected:o?.readyState===WebSocket.OPEN}}async function j(){const t=await a.getLastSyncTime(),e=await a.getAllSessions();return{desktopConnected:o?.readyState===WebSocket.OPEN,lastSync:t,sessions:e}}async function G(t){const e=await P("/paywall/packs",{domain:t.domain,minutes:t.minutes});if(e.ok)return{success:!0,session:e.session};const s=await a.getMarketRate(t.domain);if(!s)return{success:!1,error:"No rate configured for this domain"};const n=s.packs.find(i=>i.minutes===t.minutes);if(!n)return{success:!1,error:"Pack not found"};try{await a.spendCoins(n.price);const i={domain:t.domain,mode:"pack",ratePerMin:s.ratePerMin,remainingSeconds:n.minutes*60,startedAt:Date.now(),spendRemainder:0,purchasePrice:n.price,purchasedSeconds:n.minutes*60};return await a.setSession(t.domain,i),console.log(`‚úÖ Purchased ${n.minutes} minutes for ${t.domain} (offline mode)`),{success:!0,session:i}}catch(i){return{success:!1,error:i.message}}}async function K(t){const e=await P("/paywall/metered",{domain:t.domain});if(e.ok)return{success:!0,session:e.session};const s=await a.getMarketRate(t.domain);if(!s)return{success:!1,error:"No rate configured for this domain"};const n={domain:t.domain,mode:"metered",ratePerMin:s.ratePerMin,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0};return await a.setSession(t.domain,n),console.log(`‚úÖ Started metered session for ${t.domain} (offline mode)`),{success:!0,session:n}}async function q(t){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"paywall:pause",payload:t}));const e=await a.getSession(t.domain);return e?(e.paused=!0,await a.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function V(t){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"paywall:resume",payload:t}));const e=await a.getSession(t.domain);return e?(e.paused=!1,await a.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function z(t){const e=await a.getSession(t.domain);if(!e)return{success:!1,error:"No session found"};const s=O(e),n=o&&o.readyState===WebSocket.OPEN;n&&o.send(JSON.stringify({type:"paywall:end",payload:{domain:t.domain}})),(n?{ok:!0}:await B(t.domain)).ok||s>0&&await a.earnCoins(s),await a.clearSession(t.domain);const r=await p();return r&&r.url&&r.id&&new URL(r.url).hostname.replace(/^www\./,"")===t.domain&&await f(r.id,t.domain,"ended"),{success:!0,refund:s}}chrome.runtime.onStartup.addListener(()=>{a.init(),k()});
