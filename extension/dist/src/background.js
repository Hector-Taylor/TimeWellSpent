const $={wallet:{balance:100,lastSynced:Date.now()},marketRates:{"twitter.com":{domain:"twitter.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"x.com":{domain:"x.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"reddit.com":{domain:"reddit.com",ratePerMin:2,packs:[{minutes:10,price:18},{minutes:30,price:50}],hourlyModifiers:Array(24).fill(1)},"youtube.com":{domain:"youtube.com",ratePerMin:2.5,packs:[{minutes:10,price:23},{minutes:30,price:65}],hourlyModifiers:Array(24).fill(1)}},settings:{frivolityDomains:["twitter.com","x.com","reddit.com","youtube.com","facebook.com","instagram.com","tiktok.com"],productiveDomains:["github.com","stackoverflow.com"],neutralDomains:["gmail.com","calendar.google.com"],idleThreshold:15,emergencyPolicy:"balanced",economyExchangeRate:1.6666666666666667,journal:{url:null,minutes:10},peekEnabled:!0,peekAllowNewPages:!1},pendingCategorisation:null,sessions:{},libraryItems:[],pendingLibrarySync:{},nextLibraryTempId:-1,lastDesktopSync:0,lastFrivolityAt:null,consumedReading:{},rotMode:{enabled:!1,startedAt:null},emergency:{usage:{day:new Date().toISOString().slice(0,10),tokensUsed:0,cooldownUntil:null},lastEnded:null,reviewStats:{total:0,kept:0,notKept:0}}};class pe{state=null;ensureStateDefaults(){if(!this.state)return;if(this.state.pendingLibrarySync||(this.state.pendingLibrarySync={}),typeof this.state.nextLibraryTempId!="number"&&(this.state.nextLibraryTempId=-1),this.state.emergency||(this.state.emergency=$.emergency),this.state.settings||(this.state.settings=$.settings),this.state.settings.emergencyPolicy||(this.state.settings.emergencyPolicy="balanced"),typeof this.state.settings.economyExchangeRate!="number"&&(this.state.settings.economyExchangeRate=5/3),typeof this.state.settings.peekEnabled!="boolean"&&(this.state.settings.peekEnabled=!0),typeof this.state.settings.peekAllowNewPages!="boolean"&&(this.state.settings.peekAllowNewPages=!1),!this.state.settings.journal||typeof this.state.settings.journal!="object")this.state.settings.journal={url:null,minutes:10};else{const n=this.state.settings.journal,i=typeof n.url=="string"?n.url.trim():"",r=typeof n.minutes=="number"&&Number.isFinite(n.minutes)?Math.max(1,Math.min(180,Math.round(n.minutes))):10;this.state.settings.journal={url:i||null,minutes:r}}if(this.state.consumedReading||(this.state.consumedReading={}),this.state.lastFrivolityAt===void 0&&(this.state.lastFrivolityAt=null),this.state.pendingCategorisation===void 0&&(this.state.pendingCategorisation=null),!this.state.rotMode||typeof this.state.rotMode!="object")this.state.rotMode={enabled:!1,startedAt:null};else{const n=this.state.rotMode,i=typeof n.enabled=="boolean"?n.enabled:!1,r=typeof n.startedAt=="number"?n.startedAt:null;this.state.rotMode={enabled:i,startedAt:r}}const e=this.state;if(Array.isArray(e.storeItems)&&e.storeItems.length){const n=Array.isArray(e.libraryItems)?e.libraryItems:[],i=new Map;for(const r of n)r?.kind==="url"&&typeof r.url=="string"&&i.set(r.url,r);for(const r of e.storeItems){const o=typeof r?.url=="string"?r.url:"";if(!o)continue;const s=i.get(o);s?(typeof s.price!="number"&&typeof r.price=="number"&&(s.price=r.price),!s.title&&r.title&&(s.title=r.title)):n.unshift({id:typeof r.id=="number"?r.id:this.state.nextLibraryTempId--,kind:"url",url:o,domain:r.domain??this.toStoreDomain(o),title:r.title??void 0,note:void 0,purpose:"allow",price:typeof r.price=="number"?r.price:void 0,createdAt:r.createdAt??new Date().toISOString(),lastUsedAt:r.lastUsedAt??void 0})}e.libraryItems=n,delete e.storeItems}if(Array.isArray(e.libraryItems)&&(e.libraryItems=e.libraryItems.filter(n=>n&&(n.kind==="url"||n.kind==="app")).map(n=>{const i=n.bucket,r=n.purpose==="replace"||n.purpose==="allow"||n.purpose==="temptation"||n.purpose==="productive"?n.purpose:i==="attractor"?"replace":i==="frivolous"?"temptation":"allow",o={id:n.id,kind:n.kind,url:n.url,app:n.app,domain:n.domain??(n.kind==="url"?this.toStoreDomain(n.url):String(n.app??"")),title:n.title,note:n.note,purpose:r,price:n.price,createdAt:n.createdAt,lastUsedAt:n.lastUsedAt,consumedAt:n.consumedAt};return delete o.bucket,o})),e.pendingStoreSync&&typeof e.pendingStoreSync=="object"){const n=e.pendingStoreSync;for(const i of Object.values(n)){const r=typeof i?.url=="string"?i.url:"";if(!r)continue;const o=typeof i?.updatedAt=="number"?i.updatedAt:Date.now(),s=this.state.pendingLibrarySync[r];s&&s.updatedAt>o||(this.state.pendingLibrarySync[r]={url:r,purpose:"allow",price:typeof i?.price=="number"?i.price:null,title:i?.title??null,note:null,updatedAt:o})}delete e.pendingStoreSync}delete e.nextStoreTempId,this.state.libraryItems||(this.state.libraryItems=[])}async init(){const e=await chrome.storage.local.get("state");e.state?(this.state=e.state,this.ensureStateDefaults()):(this.state=$,await this.save())}async save(){this.state&&await chrome.storage.local.set({state:this.state})}async getWallet(){return this.state||await this.init(),this.state.wallet}async getBalance(){return(await this.getWallet()).balance}async spendCoins(e){if(this.state||await this.init(),this.state.wallet.balance<e)throw new Error("Insufficient funds");return this.state.wallet.balance-=e,await this.save(),this.state.wallet.balance}async earnCoins(e){return this.state||await this.init(),this.state.wallet.balance+=e,await this.save(),this.state.wallet.balance}async getMarketRate(e){this.state||await this.init();const n=this.state.marketRates[e];return n||(e==="x.com"?this.state.marketRates["twitter.com"]??null:null)}async setMarketRate(e){this.state||await this.init(),this.state.marketRates[e.domain]=e,await this.save()}async isFrivolous(e){this.state||await this.init();const n=[e];return e==="x.com"&&n.push("twitter.com"),this.state.settings.frivolityDomains.some(i=>n.some(r=>r.includes(i)||i.includes(r)))}async getIdleThreshold(){return this.state||await this.init(),this.state.settings.idleThreshold??15}async getRotMode(){return this.state||await this.init(),this.state.rotMode}async setRotMode(e){this.state||await this.init();const n=!!e;return this.state.rotMode={enabled:n,startedAt:n?Date.now():null},await this.save(),this.state.rotMode}async getSession(e){return this.state||await this.init(),this.state.sessions[e]||null}async setSession(e,n){this.state||await this.init(),this.state.sessions[e]=n,await this.save()}async clearSession(e){this.state||await this.init(),delete this.state.sessions[e],await this.save()}async getAllSessions(){return this.state||await this.init(),this.state.sessions}async getState(){return this.state||await this.init(),this.state}toStoreDomain(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return e}}mergeLibraryItemsWithPending(e){if(!this.state)return e;const n=Object.values(this.state.pendingLibrarySync??{});if(!n.length)return e;const i=[...e];for(const r of n){const o=i.findIndex(s=>s.kind==="url"&&s.url===r.url);if(o>=0){const s=i[o];i[o]={...s,purpose:r.purpose,price:r.price===void 0?s.price:typeof r.price=="number"?r.price:void 0,title:r.title??s.title,note:r.note??s.note,consumedAt:r.consumedAt===void 0?s.consumedAt:r.consumedAt??void 0}}else{const s=this.state.nextLibraryTempId--;i.unshift({id:s,kind:"url",url:r.url,domain:this.toStoreDomain(r.url),title:r.title??void 0,note:r.note??void 0,purpose:r.purpose,price:typeof r.price=="number"?r.price:void 0,createdAt:new Date().toISOString(),consumedAt:r.consumedAt??void 0})}}return i}async updateFromDesktop(e){if(this.state||await this.init(),e.wallet&&(this.state.wallet=e.wallet),e.marketRates&&(this.state.marketRates=e.marketRates),e.settings&&(this.state.settings=e.settings),e.sessions&&(this.state.sessions=e.sessions),e.libraryItems){const n=e.libraryItems??[];this.state.libraryItems=this.mergeLibraryItemsWithPending(n)}e.lastFrivolityAt!==void 0&&(this.state.lastFrivolityAt=e.lastFrivolityAt),this.ensureStateDefaults(),this.state.pendingCategorisation&&(this.state.settings={...this.state.settings,productiveDomains:this.state.pendingCategorisation.productiveDomains,neutralDomains:this.state.pendingCategorisation.neutralDomains,frivolityDomains:this.state.pendingCategorisation.frivolityDomains}),this.state.lastDesktopSync=Date.now(),await this.save()}async queueCategorisationUpdate(e){this.state||await this.init(),this.state.settings={...this.state.settings,productiveDomains:e.productiveDomains,neutralDomains:e.neutralDomains,frivolityDomains:e.frivolityDomains},this.state.pendingCategorisation={...e,updatedAt:Date.now()},await this.save()}async getPendingCategorisationUpdate(){return this.state||await this.init(),this.state.pendingCategorisation??null}async clearPendingCategorisationUpdate(){this.state||await this.init(),this.state.pendingCategorisation=null,await this.save()}async recordEmergencyEnded(e){this.state||await this.init(),this.state.emergency.lastEnded=e,await this.save()}async recordEmergencyReview(e){return this.state||await this.init(),this.state.emergency.reviewStats.total+=1,e==="kept"?this.state.emergency.reviewStats.kept+=1:this.state.emergency.reviewStats.notKept+=1,await this.save(),this.state.emergency.reviewStats}async getEmergencyUsage(){return this.state||await this.init(),this.state.emergency.usage}async setEmergencyUsage(e){this.state||await this.init(),this.state.emergency.usage=e,await this.save()}async getLastSyncTime(){return this.state||await this.init(),this.state.lastDesktopSync}async getLastFrivolityAt(){return this.state||await this.init(),this.state.lastFrivolityAt??null}async setLastFrivolityAt(e){this.state||await this.init(),this.state.lastFrivolityAt=typeof e=="number"?e:null,await this.save()}async getLibraryItems(){return this.state||await this.init(),this.state.libraryItems??[]}async setLibraryItemConsumed(e,n){this.state||await this.init();const i=this.state.libraryItems??[],r=i.findIndex(s=>s.id===e);if(r<0)return;const o=i[r];i[r]={...o,consumedAt:n??void 0},this.state.libraryItems=i,await this.save()}async markReadingConsumed(e,n){this.state||await this.init();const i=(e??"").trim();i&&(this.state.consumedReading||(this.state.consumedReading={}),n?this.state.consumedReading[i]=Date.now():delete this.state.consumedReading[i],await this.save())}async queueLibrarySync(e){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");this.state.pendingLibrarySync[e.url]={url:e.url,purpose:e.purpose,price:e.price,title:e.title??null,note:e.note??null,consumedAt:e.consumedAt,updatedAt:Date.now()},await this.save()}async getPendingLibrarySync(){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");return this.state.pendingLibrarySync}async clearPendingLibrarySync(e){if(this.state||await this.init(),!this.state)throw new Error("Storage state not initialized");delete this.state.pendingLibrarySync[e],await this.save()}}const a=new pe,w="http://127.0.0.1:17600",me="ws://127.0.0.1:17600/events",he=12,X=chrome.runtime.getURL("assets/notification.png"),d={rootSave:"tws-save",rootDomain:"tws-domain",saveReplace:"save-to-library-replace",saveProductive:"save-to-library-productive",saveAllow:"save-to-library-allow",saveTemptation:"save-to-library-temptation",savePriced:"save-to-library-priced",domainProductive:"label-domain-productive",domainNeutral:"label-domain-neutral",domainFrivolous:"label-domain-frivolous"};let f=null,I=null,Y=null,L="active",N=Date.now();const ye=2e4,we=2400,P=[],F=new Set,E=new Map,M=new Map,C=new Map,z=5e3;function ge(t){switch(t){case"off":return{id:t,durationSeconds:0,tokensPerDay:0,cooldownSeconds:0,urlLocked:!0};case"gentle":return{id:t,durationSeconds:300,tokensPerDay:null,cooldownSeconds:0,urlLocked:!0};case"strict":return{id:t,durationSeconds:120,tokensPerDay:1,cooldownSeconds:3600,urlLocked:!0};case"balanced":default:return{id:"balanced",durationSeconds:180,tokensPerDay:2,cooldownSeconds:1800,urlLocked:!0}}}function Q(t){let e=C.get(t);return e||(e={createdAt:Date.now(),lastNavigationAt:null,lastUrl:null},C.set(t,e)),e}function Z(t,e){const n=Q(t);n.lastNavigationAt=Date.now(),n.lastUrl=e??null}function Se(t,e){if(!e)return!1;const n=e.split(":")[0];if(n==="webNavigation"||n==="onUpdated")return!0;if(n==="onActivated"){const i=C.get(t);if(!i)return!1;const r=Date.now(),o=i.lastNavigationAt?r-i.lastNavigationAt<z:!1,s=i.createdAt?r-i.createdAt<z:!1;return o||s}return!1}function U(t){try{const e=new URL(t);return`${e.origin}${e.pathname}`}catch{return null}}function ve(t){if(t.mode!=="pack"||!t.purchasePrice||!t.purchasedSeconds)return 0;const n=Math.max(0,Math.min(t.purchasedSeconds,t.remainingSeconds))/t.purchasedSeconds;return Math.round(t.purchasePrice*n)}a.init().then(()=>{console.log("TimeWellSpent: Storage initialized"),De(),Ie(),B()});chrome.tabs.onRemoved.addListener(t=>{C.delete(t);const e=E.get(t);!e||(E.delete(t),Date.now()-e.openedAt<ye)||Xe(e).catch(()=>{})});chrome.notifications?.onButtonClicked?.addListener((t,e)=>{const n=M.get(t);if(n){if(M.delete(t),e===0){typeof n.libraryId=="number"&&ce({id:n.libraryId,consumed:!0}).catch(()=>{}),n.readingId&&a.markReadingConsumed(n.readingId,!0).catch(()=>{});return}e===1&&chrome.tabs.create({url:n.url,active:!0}).then(i=>{i?.id!=null&&E.set(i.id,{...n,openedAt:Date.now()})}).catch(()=>{})}});chrome.notifications?.onClosed?.addListener(t=>{M.delete(t)});function B(){f||(console.log("Attempting to connect to desktop app..."),f=new WebSocket(me),f.onopen=async()=>{console.log("‚úÖ Connected to desktop app"),I&&(clearTimeout(I),I=null),await A(),await G(),await ae(),Te()},f.onclose=()=>{console.log("‚ùå Disconnected from desktop app (extension will work offline)"),f=null,be()},f.onerror=t=>{console.error("Desktop connection error:",t),f=null},f.onmessage=t=>{try{const e=JSON.parse(t.data);ke(e)}catch(e){console.error("Failed to parse desktop message",e)}})}function be(){I||(I=setTimeout(()=>{I=null,B()},3e4))}async function A(){try{const t=await fetch(`${w}/extension/state`);if(t.ok){const e=await t.json();await a.updateFromDesktop(e),console.log("‚úÖ Synced state from desktop app")}}catch{console.log("Desktop app not available for sync")}}function ke(t){if(t.type==="wallet")a.updateFromDesktop({wallet:t.payload});else if(t.type==="market-update")a.updateFromDesktop({marketRates:t.payload});else if(t.type==="library-sync"){const e=Array.isArray(t.payload?.items)?t.payload.items:t.payload;Array.isArray(e)&&a.updateFromDesktop({libraryItems:e})}else if(t.type==="paywall-session-started"){const e=t.payload;e?.domain&&(a.setSession(e.domain,{domain:e.domain,mode:e.mode,ratePerMin:e.ratePerMin,remainingSeconds:e.remainingSeconds??1/0,startedAt:Date.now(),paused:e.paused??!1,spendRemainder:e.spendRemainder??0,purchasePrice:e.purchasePrice,purchasedSeconds:e.purchasedSeconds,justification:e.justification,lastReminder:e.lastReminder,allowedUrl:e.allowedUrl}),e.mode!=="emergency"&&a.setLastFrivolityAt(Date.now()))}else if(t.type==="paywall-session-ended"){if(t.payload?.domain){const{domain:e,reason:n}=t.payload;a.getSession(e).then(i=>{i?.mode==="emergency"&&n==="emergency-expired"&&a.recordEmergencyEnded({domain:e,justification:i.justification,endedAt:Date.now()}),a.clearSession(e)}),console.log(`üõë Session ended for ${e} (${n})`),x().then(async i=>{i&&i.url&&i.id&&new URL(i.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to session end`),await g(i.id,e,n,"session-ended"))})}}else if(t.type==="paywall-session-paused"){if(t.payload?.domain){const e=t.payload.domain;a.getSession(e).then(n=>{n&&a.setSession(e,{...n,paused:!0})}),x().then(async n=>{n&&n.url&&n.id&&new URL(n.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to pause`),await g(n.id,e,"paused","session-paused"))})}}else if(t.type==="paywall-session-resumed"){if(t.payload?.domain){const e=t.payload.domain;a.getSession(e).then(n=>{n&&a.setSession(e,{...n,paused:!1})})}}else if(t.type==="paywall-reminder"&&t.payload?.domain){const{domain:e,justification:n}=t.payload;chrome.notifications?.create(`tws-reminder-${e}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${e}${n?` ‚Äî Reason: ${n}`:""}.`})}}chrome.tabs.onCreated.addListener(t=>{typeof t.id=="number"&&Q(t.id)});chrome.tabs.onActivated.addListener(async t=>{const e=await chrome.tabs.get(t.tabId);e.url&&await J(e.id,e.url,"onActivated"),await K("tab-activated")});chrome.tabs.onUpdated.addListener(async(t,e,n)=>{e.status==="loading"&&n.url&&n.url.startsWith("http")&&Z(t,n.url),(e.status==="loading"||e.status==="complete")&&n.url&&await J(t,n.url,`onUpdated:${e.status}`),e.status==="complete"&&n.active&&await K("tab-updated")});chrome.webNavigation.onCommitted.addListener(async t=>{t.frameId===0&&(Z(t.tabId,t.url),await J(t.tabId,t.url,"webNavigation:onCommitted"))});chrome.windows.onFocusChanged.addListener(async()=>{await K("window-focus")});async function Ae(t,e,n){if(F.has(e))return!0;F.add(e);try{return await a.getBalance()<1?(await g(t,e,"insufficient-funds",`rot-mode:${n}`),!1):(await le({domain:e})).success?!0:(await g(t,e,void 0,`rot-mode:${n}`),!1)}finally{F.delete(e)}}async function J(t,e,n){if(!(!e||!e.startsWith("http")))try{const r=new URL(e).hostname.replace(/^www\./,"");if(await a.isFrivolous(r)){const s=await a.getSession(r);if(s&&!s.paused)if(s.allowedUrl){const u=U(e);if(!(!u||u!==s.allowedUrl)){if(s.mode==="metered")return;if(s.remainingSeconds>0)return}}else{if(s.mode==="metered")return;if(s.remainingSeconds>0)return}if((await a.getRotMode()).enabled&&await Ae(t,r,n))return;const c=s?.allowedUrl?"url-locked":void 0;console.log(`üö´ Blocking ${r} (source: ${n})`),await g(t,r,c,n)}}catch(i){console.error("Error checking URL:",i)}}function De(){Y||(Y=setInterval(async()=>{await ee()},15e3))}async function ee(){const t=Date.now();if(f&&f.readyState===WebSocket.OPEN)return;const e=await a.getAllSessions(),n=await chrome.tabs.query({active:!0,currentWindow:!0}),i=async()=>{await Promise.all(Object.entries(e).map(([c,u])=>a.setSession(c,{...u,paused:!0})))};if(n.length===0){await i();return}const r=n[0];if(!r.url||!r.url.startsWith("http")){await i();return}const s=new URL(r.url).hostname.replace(/^www\./,""),l=e[s];if(Object.entries(e).forEach(async([c,u])=>{c!==s&&!u.paused?await a.setSession(c,{...u,paused:!0}):c===s&&u.paused&&await a.setSession(c,{...u,paused:!1})}),!!l){if(l.mode!=="emergency"&&l.allowedUrl){const c=U(r.url);if(!c||c!==l.allowedUrl){l.paused||await a.setSession(s,{...l,paused:!0}),r.id&&await g(r.id,s,"url-locked","session-url-locked");return}}if(l.mode==="emergency"){if(l.allowedUrl){const y=U(r.url);if(!y||y!==l.allowedUrl){l.paused||await a.setSession(s,{...l,paused:!0}),r.id&&await g(r.id,s,"url-locked","session-url-locked");return}}const c=300*1e3,u=l.lastReminder??l.startedAt;Date.now()-u>c&&(l.lastReminder=Date.now(),await a.setSession(s,l),chrome.notifications?.create(`tws-reminder-${s}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${s}${l.justification?` ‚Äî Reason: ${l.justification}`:""}.`}));const m=l.lastTick??l.startedAt,p=Math.max(0,Math.round((t-m)/1e3));l.remainingSeconds-=p,l.lastTick=t,l.remainingSeconds<=0?(await a.recordEmergencyEnded({domain:s,justification:l.justification,endedAt:t}),await a.clearSession(s),r.id&&await g(r.id,s,"emergency-expired","session-expired")):await a.setSession(s,l);return}else if(l.mode==="metered"){const c=(await a.getMarketRate(s))?.ratePerMin??l.ratePerMin,u=l.lastTick??l.startedAt,m=Math.max(0,Math.round((t-u)/1e3)),p=c/60*m+(l.spendRemainder??0),y=Math.floor(p),h=p-y;try{y>0&&await a.spendCoins(y),l.ratePerMin=c,l.spendRemainder=h,l.lastTick=t,await a.setSession(s,l)}catch{console.log(`‚ùå Insufficient funds for ${s}`),await a.clearSession(s),r.id&&await g(r.id,s,"insufficient-funds","session-insufficient-funds")}}else{const c=l.lastTick??l.startedAt,u=Math.max(0,Math.round((t-c)/1e3));l.remainingSeconds-=u,l.lastTick=t,l.remainingSeconds<=0?(console.log(`‚è∞ Time's up for ${s}`),await a.clearSession(s),r.id&&await g(r.id,s,"time-expired","session-expired")):await a.setSession(s,l)}}}async function Ie(){const t=await a.getIdleThreshold();chrome.idle.setDetectionInterval(t),chrome.idle.queryState(t,e=>{L=e,e==="active"&&(N=Date.now())}),chrome.idle.onStateChanged.addListener(e=>{L=e,e==="active"&&(N=Date.now())}),chrome.storage.onChanged.addListener(e=>{if(e.state&&e.state.newValue){const n=e.state.newValue,i=e.state.oldValue,r=n.settings?.idleThreshold,o=i?.settings?.idleThreshold;r&&r!==o&&(console.log("Updating idle threshold to",r),chrome.idle.setDetectionInterval(r))}})}async function K(t){const e=await x();if(!e||!e.url)return;const n=new URL(e.url).hostname.replace(/^www\./,""),i=L==="active"?0:Math.floor((Date.now()-N)/1e3),r={type:"activity",reason:t,payload:{timestamp:Date.now(),source:"url",appName:ne(),windowTitle:e.title??n,url:e.url,domain:n,idleSeconds:i}};te(r)}async function x(){const t=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t.length===0)return null;const e=t[0];return!e.url||!e.url.startsWith("http")?null:e}function te(t){f&&f.readyState===WebSocket.OPEN?f.send(JSON.stringify(t)):(P.push(t),P.length>we&&P.shift())}function Te(){if(!(!f||f.readyState!==WebSocket.OPEN))for(;P.length>0;){const t=P.shift();t&&f.send(JSON.stringify(t))}}function ne(){const t=navigator.userAgent.toLowerCase();return t.includes("brave")?"Brave":t.includes("edg/")?"Edge":t.includes("arc")?"Arc":t.includes("firefox")?"Firefox":"Chrome"}async function Pe(t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content-loader.js"]})}catch{}}async function Ee(t,e){const n=await a.getState(),i=n.settings?.peekEnabled!==!1,r=!!n.settings?.peekAllowNewPages,o=Se(t,e);return{allowed:i&&(r||!o),isNewPage:o}}async function g(t,e,n,i){await Pe(t);try{await chrome.tabs.sendMessage(t,{type:"TWS_PING"})}catch{await new Promise(r=>setTimeout(r,150))}try{const r=await Ee(t,i);await chrome.tabs.sendMessage(t,{type:"BLOCK_SCREEN",payload:{domain:e,reason:n,peek:r}}),console.log(`üîí Block screen message sent to tab ${t} for ${e}`)}catch(r){console.warn("Failed to send block message",r)}}async function ie(t,e){try{const n=await fetch(`${w}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});if(!n.ok)throw new Error("desktop unreachable");const i=await n.json();return await a.updateFromDesktop({sessions:{[i.domain]:{...i,startedAt:Date.now(),paused:!1,spendRemainder:i.spendRemainder??0}}}),await a.setLastFrivolityAt(Date.now()),await A(),{ok:!0,session:i}}catch(n){return console.log("Desktop purchase failed, falling back to local",n),{ok:!1,error:n.message}}}async function Me(t){try{const e=await fetch(`${w}/paywall/emergency`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!e.ok){const i=await e.json().catch(()=>null);return{ok:!1,error:i?.error?String(i.error):"Desktop rejected request",canFallback:!1}}const n=await e.json();return await a.updateFromDesktop({sessions:{[n.domain]:{...n,startedAt:Date.now(),paused:!1,spendRemainder:n.spendRemainder??0}}}),await A(),{ok:!0,session:n}}catch(e){return console.log("Desktop emergency start failed, falling back to local",e),{ok:!1,error:e.message,canFallback:!0}}}async function Ue(t){try{if(!(await fetch(`${w}/paywall/end`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:t}),cache:"no-store"})).ok)throw new Error("desktop unreachable");return await A(),{ok:!0}}catch(e){return console.log("Desktop end-session failed, falling back to local",e),{ok:!1,error:e.message}}}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="GET_STATUS")return st(t.payload).then(n),!0;if(t.type==="GET_CONNECTION")return ct().then(n),!0;if(t.type==="PAGE_HEARTBEAT")return Le(t.payload,e).then(n),!0;if(t.type==="GET_LINK_PREVIEWS")return Ye(t.payload).then(n),!0;if(t.type==="OPEN_URL")return lt(t.payload,e).then(n),!0;if(t.type==="OPEN_APP")return ut(t.payload).then(n),!0;if(t.type==="OPEN_DESKTOP_ACTION")return Ne(t.payload).then(n),!0;if(t.type==="OPEN_DESKTOP_VIEW")return Ce(t.payload).then(n),!0;if(t.type==="UPSERT_LIBRARY_ITEM")return it(t.payload).then(n),!0;if(t.type==="SET_DOMAIN_CATEGORY")return oe(t.payload).then(n),!0;if(t.type==="BUY_PACK")return ft(t.payload).then(n),!0;if(t.type==="START_METERED")return le(t.payload).then(n),!0;if(t.type==="PAUSE_SESSION")return pt(t.payload).then(n),!0;if(t.type==="RESUME_SESSION")return mt(t.payload).then(n),!0;if(t.type==="END_SESSION")return ht(t.payload).then(n),!0;if(t.type==="START_EMERGENCY")return yt(t.payload).then(n),!0;if(t.type==="START_STORE_SESSION")return ot(t.payload).then(n),!0;if(t.type==="EMERGENCY_REVIEW")return wt(t.payload).then(n),!0;if(t.type==="MARK_LIBRARY_CONSUMED")return ce(t.payload).then(n),!0;if(t.type==="MARK_READING_CONSUMED")return dt(t.payload).then(n),!0;if(t.type==="SET_ROT_MODE")return at(t.payload).then(n),!0});function Re(t,e){const n=String(t.url??"");if(!n||!/^https?:/i.test(n))return;let i;try{i=new URL(n).hostname.replace(/^www\./,"")}catch{return}const r=L==="active"?0:Math.floor((Date.now()-N)/1e3);te({type:"activity",reason:e,payload:{timestamp:Date.now(),source:"url",appName:ne(),windowTitle:t.title??i,url:n,domain:i,idleSeconds:r}})}async function Le(t,e){try{if(e.tab&&e.tab.active===!1)return{ok:!0};const n=typeof t?.url=="string"?t.url:e.tab?.url;return n?(Re({url:n,title:typeof t?.title=="string"?t.title:e.tab?.title??void 0},"content-heartbeat"),await ee(),{ok:!0}):{ok:!0}}catch{return{ok:!0}}}async function Ne(t){if(!t||t.kind!=="deeplink"&&t.kind!=="file")return{success:!1,error:"Invalid action"};try{const e=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});return e.ok?{success:!0}:{success:!1,error:(await e.json().catch(()=>null))?.error??"Failed to open in desktop app"}}catch(e){return{success:!1,error:e.message}}}async function Ce(t){try{const e=String(t?.view??"").trim();if(!e)return{success:!1,error:"Missing view"};const n=await fetch(`${w}/ui/navigate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({view:e}),cache:"no-store"});return n.ok?{success:!0}:{success:!1,error:(await n.json().catch(()=>null))?.error??"Failed to open desktop view"}}catch(e){return{success:!1,error:e.message}}}const xe=10080*60*1e3,Oe=250;function re(t){try{const e=new URL(t);return e.hash="",e.toString()}catch{return null}}function _(t){return`chrome://favicon2/?size=64&url=${encodeURIComponent(t)}`}function S(t,e,n){const i=new RegExp(`<meta\\s+[^>]*${e}=["']${Je(n)}["'][^>]*content=["']([^"']+)["'][^>]*>`,"i"),r=t.match(i);if(r?.[1])return O(r[1]).trim()}function $e(t){const e=S(t,"property","og:title");if(e)return e;const n=t.match(/<title[^>]*>([^<]{1,200})<\/title>/i);if(n?.[1])return O(n[1]).trim()}function Fe(t){return S(t,"property","og:description")??S(t,"name","description")}function _e(t){return S(t,"property","og:image:secure_url")??S(t,"property","og:image:url")??S(t,"property","og:image")}function je(t){return S(t,"name","twitter:image")??S(t,"name","twitter:image:src")??S(t,"property","twitter:image")}function We(t){const e=t.match(/<link\\s+[^>]*rel=["']image_src["'][^>]*href=["']([^"']+)["'][^>]*>/i)??t.match(/<link\\s+[^>]*href=["']([^"']+)["'][^>]*rel=["']image_src["'][^>]*>/i);if(e?.[1])return O(e[1]).trim()}function Be(t){const e=t.match(/<link\s+[^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*href=["']([^"']+)["'][^>]*>/i)??t.match(/<link\s+[^>]*href=["']([^"']+)["'][^>]*rel=["'][^"']*(?:shortcut\s+icon|icon)[^"']*["'][^>]*>/i);if(e?.[1])return O(e[1]).trim()}function T(t,e){if(t)try{return new URL(t,e).toString()}catch{return}}function Je(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function O(t){return t.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function Ke(t){const e=t.hostname.replace(/^www\./,"");if(e==="youtu.be"){const n=t.pathname.split("/").filter(Boolean)[0];return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}if(e.endsWith("youtube.com")){const n=t.searchParams.get("v");return n?`https://i.ytimg.com/vi/${encodeURIComponent(n)}/hqdefault.jpg`:null}return null}async function qe(t){const e=re(t);if(!e)return null;try{const n=new URL(e),i=Ke(n),r=new AbortController,o=setTimeout(()=>r.abort(),4500),s=await fetch(e,{method:"GET",redirect:"follow",cache:"no-store",signal:r.signal}).finally(()=>clearTimeout(o));if(!s.ok)throw new Error(`HTTP ${s.status}`);if(!(s.headers.get("content-type")??"").includes("text/html"))return{url:e,title:void 0,description:void 0,imageUrl:i??void 0,iconUrl:_(e)};const c=await s.text(),u=$e(c),m=Fe(c),y=i??T(_e(c),e)??T(je(c),e)??T(S(c,"itemprop","image"),e)??T(We(c),e)??void 0,h=T(Be(c),e)??_(e);return{url:e,title:u,description:m,imageUrl:y,iconUrl:h}}catch{return{url:e,iconUrl:_(e)}}}async function Ge(){const e=(await chrome.storage.local.get("linkPreviewCache")).linkPreviewCache;return!e||typeof e!="object"?{}:e}async function Ve(t){const e=Object.entries(t).filter(([,i])=>i&&typeof i.url=="string").sort((i,r)=>(r[1].updatedAt??0)-(i[1].updatedAt??0)),n={};for(const[i,r]of e.slice(0,Oe))n[i]=r;await chrome.storage.local.set({linkPreviewCache:n})}async function Ye(t){const n=(Array.isArray(t?.urls)?t.urls:[]).map(c=>re(String(c))).filter(c=>!!c),i=[...new Set(n)];if(!i.length)return{success:!0,previews:{}};const r=Date.now(),o=await Ge(),s={};let l=!1;return await Promise.all(i.map(async c=>{const u=o[c];if(u&&r-u.updatedAt<xe){s[c]=u;return}const m=await qe(c);if(!m){s[c]=null;return}const p={...m,updatedAt:r};o[c]=p,s[c]=p,l=!0})),l&&await Ve(o),{success:!0,previews:s}}function q(){chrome.contextMenus?.create&&chrome.contextMenus.removeAll(()=>{const t=chrome.runtime.lastError;t&&console.warn("Failed to clear context menus",t),chrome.contextMenus.create({id:d.rootSave,title:"Save to TimeWellSpent",contexts:["page","link"]}),chrome.contextMenus.create({id:d.saveReplace,parentId:d.rootSave,title:"Replace (Try this instead)",contexts:["page","link"]}),chrome.contextMenus.create({id:d.saveProductive,parentId:d.rootSave,title:"Productive (counts as productive time)",contexts:["page","link"]}),chrome.contextMenus.create({id:d.saveAllow,parentId:d.rootSave,title:"Allow (good link)",contexts:["page","link"]}),chrome.contextMenus.create({id:d.saveTemptation,parentId:d.rootSave,title:"Temptation (keep contained)",contexts:["page","link"]}),chrome.contextMenus.create({id:d.savePriced,parentId:d.rootSave,title:"Allow (priced)‚Ä¶",contexts:["page","link"]}),chrome.contextMenus.create({id:d.rootDomain,title:"Label this domain",contexts:["page"]}),chrome.contextMenus.create({id:d.domainProductive,parentId:d.rootDomain,title:"Productive",contexts:["page"]}),chrome.contextMenus.create({id:d.domainNeutral,parentId:d.rootDomain,title:"Neutral",contexts:["page"]}),chrome.contextMenus.create({id:d.domainFrivolous,parentId:d.rootDomain,title:"Frivolous",contexts:["page"]})})}function ze(t){if(!t)return null;let e=t.trim();if(!e||e.startsWith("chrome://")||e.startsWith("about:"))return null;/^https?:/i.test(e)||(e=`https://${e}`);try{return new URL(e).toString()}catch{return null}}function R(t){if(!t)return;const e=t.trim();if(e)return e.slice(0,80)}function H(t,e,n,i){const r=R(e)??R(n)??R(i);if(r)return r;try{return new URL(t).hostname}catch{return t}}function He(t,e){const n=t.find(i=>i.kind==="url"&&i.url===e&&typeof i.price=="number");if(n)return n;try{const i=new URL(e),r=`${i.origin}${i.pathname}`;return t.find(o=>o.kind==="url"&&o.url===r&&typeof o.price=="number")??null}catch{return null}}async function k(t,e){if(chrome.notifications)try{await chrome.notifications.create("",{type:"basic",iconUrl:X,title:"TimeWellSpent",message:t,priority:0});return}catch(n){console.warn("Notification failed",n)}if(e)try{await chrome.scripting.executeScript({target:{tabId:e},func:n=>alert(n),args:[t]});return}catch(n){console.warn("Failed to show in-tab alert",n)}console.log(t)}async function Xe(t){const e=(t.title??"").trim(),n=(()=>{try{return new URL(t.url).hostname.replace(/^www\./,"")}catch{return"this tab"}})(),i=e||n;if(chrome.notifications){const r=`tws-roulette-${Date.now()}-${Math.random().toString(16).slice(2)}`;M.set(r,t);try{await chrome.notifications.create(r,{type:"basic",iconUrl:X,title:"TimeWellSpent",message:`Done with ‚Äú${i}‚Äù?`,buttons:[{title:"Done"},{title:"Keep open"}],priority:0});return}catch(o){M.delete(r),console.warn("Failed to show roulette completion notification",o)}}}async function se(t){const n=((await a.getState()).libraryItems||[]).find(i=>i.kind==="url"&&i.url===t)??null;if(n)return n;try{const i=await fetch(`${w}/library/check?url=${encodeURIComponent(t)}`,{cache:"no-store"});if(i.ok)return(await i.json())?.item??null}catch{}return null}async function Qe(t){try{const e=await fetch(`${w}/library/check?url=${encodeURIComponent(t)}`,{cache:"no-store"});return e.ok?(await e.json())?.item??null:null}catch{return null}}async function Ze(t){const e=await fetch(`${w}/library`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"url",url:t.url,purpose:t.purpose,price:t.price===void 0?void 0:t.price,title:t.title??void 0,note:t.note??void 0,consumedAt:t.consumedAt}),cache:"no-store"});if(!e.ok){let n="Failed to save to desktop app. Is it running?";try{const i=await e.json();i?.error&&(n=i.error)}catch{}throw new Error(n)}}async function et(t,e){const n=await fetch(`${w}/library/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({purpose:e.purpose,price:e.price===void 0?void 0:e.price,title:e.title??void 0,note:e.note??void 0,consumedAt:e.consumedAt}),cache:"no-store"});if(!n.ok){let i="Failed to update the library item. Is the desktop app running?";try{const r=await n.json();r?.error&&(i=r.error)}catch{}throw new Error(i)}}async function tt(t){const e=await Qe(t.url);return e?(await et(e.id,t),{action:"updated"}):(await Ze(t),{action:"added"})}async function G(t){const e=await a.getPendingLibrarySync(),n=Object.values(e).filter(r=>!t||t.includes(r.url)).sort((r,o)=>r.updatedAt-o.updatedAt);if(!n.length)return{attempted:0,succeeded:0};let i=0;for(const r of n)try{await tt(r),await a.clearPendingLibrarySync(r.url),i+=1}catch(o){console.warn("Failed to sync library item to desktop",o)}return i>0&&await A(),{attempted:n.length,succeeded:i}}async function W(t){const n=await se(t.url)?"updated":"added";await a.queueLibrarySync(t);const i=await G([t.url]);return{action:n,synced:i.succeeded>0}}function D(t){const e=(t??"").trim().toLowerCase();if(!e)return null;if(e.startsWith("http://")||e.startsWith("https://"))try{return new URL(e).hostname.replace(/^www\./,"")}catch{return null}return e.split("/")[0].replace(/^www\./,"")||null}function j(t){const e=new Set,n=[];for(const i of t){const r=D(i);!r||e.has(r)||(e.add(r),n.push(r))}return n}async function nt(t){const e=await fetch(`${w}/settings/categorisation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productive:t.productiveDomains,neutral:t.neutralDomains,frivolity:t.frivolityDomains}),cache:"no-store"});if(!e.ok){let n="Failed to update categorisation on desktop app.";try{const i=await e.json();i?.error&&(n=i.error)}catch{}throw new Error(n)}}async function ae(){const t=await a.getPendingCategorisationUpdate();if(!t)return{attempted:0,succeeded:0};try{return await nt(t),await a.clearPendingCategorisationUpdate(),await A(),{attempted:1,succeeded:1}}catch(e){return console.warn("Failed to sync categorisation update to desktop",e),{attempted:1,succeeded:0}}}async function it(t){const e=typeof t?.url=="string"?t.url.trim():"",n=t?.purpose;if(!e)return{success:!1,error:"Missing URL"};if(n!=="replace"&&n!=="allow"&&n!=="temptation"&&n!=="productive")return{success:!1,error:"Invalid purpose"};if(n!=="allow"&&typeof t.price=="number")return{success:!1,error:"Only Allow items can be priced"};if(t.price!==void 0&&t.price!==null){const i=Number(t.price);if(!Number.isFinite(i)||!Number.isInteger(i)||i<1)return{success:!1,error:"Invalid price"}}try{return{success:!0,...await W({url:e,purpose:n,price:t.price,title:t?.title??null,note:t?.note??null})}}catch(i){return{success:!1,error:i.message}}}async function oe(t){const e=t?.category,n=D(t?.domain??"");if(!n)return{success:!1,error:"Invalid domain"};if(e!=="productive"&&e!=="neutral"&&e!=="frivolous")return{success:!1,error:"Invalid category"};const i=await a.getState(),r=j((i.settings?.productiveDomains??[]).filter(u=>D(u)!==n)),o=j((i.settings?.neutralDomains??[]).filter(u=>D(u)!==n)),s=j((i.settings?.frivolityDomains??[]).filter(u=>D(u)!==n));e==="productive"&&r.unshift(n),e==="neutral"&&o.unshift(n),e==="frivolous"&&s.unshift(n);const l={productiveDomains:r,neutralDomains:o,frivolityDomains:s};return await a.queueCategorisationUpdate(l),{success:!0,synced:(await ae()).succeeded>0}}async function rt(t,e){const i=(await chrome.scripting.executeScript({target:{tabId:t},func:r=>{const o=prompt(`Save a one-time unlock

Price (f-coins) for:
${r.url}`,String(r.price));if(o===null)return null;const s=o.trim();if(!s)return{error:"Price is required"};const l=parseInt(s,10);if(isNaN(l)||l<1)return{error:"Invalid price"};const c=prompt(`Optional title:
${r.url}`,r.title??"");if(c===null)return null;const u=c.trim();return{url:r.url,price:l,title:u||null}},args:[e]}))[0]?.result;if(!i)return null;if(i.error)throw new Error(i.error??"Invalid input");return i}async function st(t){await A().catch(()=>{});const e=await a.getBalance(),n=await a.getMarketRate(t.domain),i=await a.getSession(t.domain),r=await a.getLastSyncTime(),o=await a.getState(),s=o.libraryItems??[],l=t.url?He(s,t.url):null;let c=[];try{const m=await fetch(`${w}/integrations/reading?limit=12`,{cache:"no-store"});if(m.ok){const p=await m.json();Array.isArray(p.items)&&(c=p.items)}}catch{}const u=o.consumedReading??{};return c=c.filter(m=>m?.id&&!u[String(m.id)]),{balance:e,rate:n,session:i,matchedPricedItem:l,lastSync:r,desktopConnected:f?.readyState===WebSocket.OPEN,rotMode:o.rotMode,emergencyPolicy:o.settings.emergencyPolicy??"balanced",emergency:o.emergency,journal:o.settings.journal??{url:null,minutes:10},library:{items:s,replaceItems:s.filter(m=>m.purpose==="replace"&&!m.consumedAt),productiveItems:s.filter(m=>m.purpose==="productive"&&!m.consumedAt),productiveDomains:o.settings.productiveDomains??[],readingItems:c}}}async function at(t){const e=!!t?.enabled;return{success:!0,rotMode:await a.setRotMode(e)}}async function ot(t){if(f&&f.readyState===WebSocket.OPEN)return f.send(JSON.stringify({type:"paywall:start-store",payload:t})),{success:!0};try{await a.spendCoins(t.price);const e={domain:t.domain,mode:"store",ratePerMin:0,remainingSeconds:1/0,startedAt:Date.now(),lastTick:Date.now(),paused:!1,purchasePrice:t.price,spendRemainder:0,allowedUrl:t.url?U(t.url)??void 0:void 0};return await a.setSession(t.domain,e),await a.setLastFrivolityAt(Date.now()),fetch(`${w}/paywall/start-store-fallback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(()=>{}),{success:!0,session:e}}catch(e){return{success:!1,error:e.message}}}async function ct(){const t=await a.getLastSyncTime(),e=await a.getAllSessions(),n=await a.getLastFrivolityAt();return{desktopConnected:f?.readyState===WebSocket.OPEN,lastSync:t,sessions:e,lastFrivolityAt:n}}async function lt(t,e){const n=typeof t?.url=="string"?t.url.trim():"";if(!n)return{success:!1,error:"Missing URL"};if(!/^https?:/i.test(n))return{success:!1,error:"Only http(s) URLs are supported"};try{const i=e.tab?.id;if(typeof i=="number")return await chrome.tabs.update(i,{url:n}),t.roulette&&E.set(i,{openedAt:Date.now(),url:n,title:typeof t.roulette.title=="string"?t.roulette.title:void 0,libraryId:typeof t.roulette.libraryId=="number"?t.roulette.libraryId:void 0,readingId:typeof t.roulette.readingId=="string"?t.roulette.readingId:void 0}),{success:!0};const r=await chrome.tabs.create({url:n,active:!0});return t.roulette&&r?.id!=null&&E.set(r.id,{openedAt:Date.now(),url:n,title:typeof t.roulette.title=="string"?t.roulette.title:void 0,libraryId:typeof t.roulette.libraryId=="number"?t.roulette.libraryId:void 0,readingId:typeof t.roulette.readingId=="string"?t.roulette.readingId:void 0}),{success:!0}}catch(i){return{success:!1,error:i.message}}}async function ut(t){const e=typeof t?.app=="string"?t.app.trim():"";if(!e)return{success:!1,error:"Missing app name"};try{const n=await fetch(`${w}/actions/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"app",app:e}),cache:"no-store"});if(!n.ok){const i=await n.json().catch(()=>null);return{success:!1,error:i?.error?String(i.error):"Failed to open app"}}return{success:!0}}catch(n){return{success:!1,error:n.message}}}async function ce(t){const e=typeof t?.id=="number"&&Number.isFinite(t.id)?t.id:null;if(e==null)return{success:!1,error:"Missing library item id"};const i=t?.consumed!==!1?new Date().toISOString():null,o=((await a.getState()).libraryItems??[]).find(l=>l?.id===e)??null;return o?o.kind!=="url"||!o.url?{success:!1,error:"Only URL items can be marked as consumed"}:(await a.setLibraryItemConsumed(e,i),await a.queueLibrarySync({url:o.url,purpose:o.purpose,price:typeof o.price=="number"?o.price:void 0,title:o.title??null,note:o.note??null,consumedAt:i}),{success:!0,synced:(await G([o.url])).succeeded>0}):{success:!1,error:"Library item not found"}}async function dt(t){const e=typeof t?.id=="string"?t.id.trim():"";if(!e)return{success:!1,error:"Missing reading id"};const n=t?.consumed!==!1;return await a.markReadingConsumed(e,n),{success:!0}}async function ft(t){const e=await ie("/paywall/packs",{domain:t.domain,minutes:t.minutes});if(e.ok)return{success:!0,session:e.session};const n=await a.getMarketRate(t.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const i=n.packs.find(r=>r.minutes===t.minutes);if(!i)return{success:!1,error:"Pack not found"};try{await a.spendCoins(i.price);const r={domain:t.domain,mode:"pack",ratePerMin:n.ratePerMin,remainingSeconds:i.minutes*60,startedAt:Date.now(),spendRemainder:0,purchasePrice:i.price,purchasedSeconds:i.minutes*60};return await a.setSession(t.domain,r),await a.setLastFrivolityAt(Date.now()),console.log(`‚úÖ Purchased ${i.minutes} minutes for ${t.domain} (offline mode)`),{success:!0,session:r}}catch(r){return{success:!1,error:r.message}}}async function le(t){const e=await ie("/paywall/metered",{domain:t.domain});if(e.ok)return{success:!0,session:e.session};const n=await a.getMarketRate(t.domain);if(!n)return{success:!1,error:"No rate configured for this domain"};const i={domain:t.domain,mode:"metered",ratePerMin:n.ratePerMin,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0};return await a.setSession(t.domain,i),await a.setLastFrivolityAt(Date.now()),console.log(`‚úÖ Started metered session for ${t.domain} (offline mode)`),{success:!0,session:i}}async function pt(t){f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"paywall:pause",payload:t}));const e=await a.getSession(t.domain);return e?(e.paused=!0,await a.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function mt(t){f&&f.readyState===WebSocket.OPEN&&f.send(JSON.stringify({type:"paywall:resume",payload:t}));const e=await a.getSession(t.domain);return e?(e.paused=!1,await a.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function ht(t){const e=await a.getSession(t.domain);if(!e)return{success:!1,error:"No session found"};const n=ve(e),i=f&&f.readyState===WebSocket.OPEN;i&&f&&f.send(JSON.stringify({type:"paywall:end",payload:{domain:t.domain}})),(i?{ok:!0}:await Ue(t.domain)).ok||n>0&&await a.earnCoins(n),await a.clearSession(t.domain);const o=await x();return o&&o.url&&o.id&&new URL(o.url).hostname.replace(/^www\./,"")===t.domain&&await g(o.id,t.domain,"ended","session-ended"),{success:!0,refund:n}}async function yt(t){const e=await Me(t);if(e.ok)return{success:!0,session:e.session};if(!e.canFallback)return{success:!1,error:e.error};const i=(await a.getState()).settings.emergencyPolicy??"balanced",r=ge(i);if(r.id==="off")return{success:!1,error:"Emergency access is disabled in Settings."};const o=Date.now(),s=new Date(o).toISOString().slice(0,10),l=await a.getEmergencyUsage(),c=l.day===s?l:{day:s,tokensUsed:0,cooldownUntil:null};if(c.cooldownUntil&&o<c.cooldownUntil)return{success:!1,error:`Emergency cooldown active (${Math.max(1,Math.ceil((c.cooldownUntil-o)/6e4))}m remaining).`};if(typeof r.tokensPerDay=="number"&&c.tokensUsed>=r.tokensPerDay)return{success:!1,error:`No emergency uses left today (${r.tokensPerDay}/day).`};const u={...c,tokensUsed:c.tokensUsed+(typeof r.tokensPerDay=="number"?1:0),cooldownUntil:r.cooldownSeconds>0?o+r.cooldownSeconds*1e3:null};await a.setEmergencyUsage(u);const m=r.urlLocked&&t.url?U(t.url):null,p={domain:t.domain,mode:"emergency",ratePerMin:0,remainingSeconds:r.durationSeconds,startedAt:o,lastTick:o,paused:!1,spendRemainder:0,justification:t.justification,lastReminder:o,allowedUrl:m??void 0};return await a.setSession(t.domain,p),console.log(`‚úÖ Started emergency session for ${t.domain} (offline mode)`),{success:!0,session:p}}async function wt(t){const e=t?.outcome;if(e!=="kept"&&e!=="not-kept")return{success:!1,error:"Invalid outcome"};const n=await a.recordEmergencyReview(e);if(f&&f.readyState===WebSocket.OPEN)return f.send(JSON.stringify({type:"paywall:emergency-review",payload:{outcome:e,domain:t.domain}})),{success:!0,stats:n};try{await fetch(`${w}/paywall/emergency-review`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({outcome:e}),cache:"no-store"})}catch{}return{success:!0,stats:n}}chrome.runtime.onStartup.addListener(()=>{a.init(),B(),q()});chrome.runtime.onInstalled.addListener(()=>{q()});q();chrome.contextMenus.onClicked.addListener(async(t,e)=>{const n=t.tabId??e?.id,i=t.linkUrl||t.pageUrl,r=ze(i),o=t.linkText??null,s=typeof t.selectionText=="string"?t.selectionText:null,l=e?.title??null,c=String(t.menuItemId),u=c===d.saveReplace||c===d.saveProductive||c===d.saveAllow||c===d.saveTemptation||c===d.savePriced,m=p=>p===d.saveReplace?"replace":p===d.saveProductive?"productive":p===d.saveAllow?"allow":p===d.saveTemptation?"temptation":p===d.savePriced?"allow":null;if(u){if(!r){await k("Unable to capture that link.",n);return}const p=m(c);if(!p)return;if(c===d.savePriced){if(!n)return;try{const h=await se(r),b={url:r,price:typeof h?.price=="number"?h.price:he,title:h?.title??H(r,o,s,l)},v=await rt(n,b);if(!v)return;const ue=R(v.title??null)??null,V=await W({url:v.url,purpose:"allow",price:v.price,title:ue,note:null}),de=V.action==="updated"?"Updated":"Saved",fe=V.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${de} priced unlock (${v.price} f-coins). ${fe}`,n)}catch(h){await k(h.message||"Failed to save priced unlock",n)}return}const y=H(r,o,s,l);try{const h=await W({url:r,purpose:p,title:y,note:null}),b=h.action==="updated"?"Updated":"Saved",v=h.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`${b} to Library (${p}). ${v}`,n)}catch(h){await k(h.message||"Failed to save to library",n)}return}if(c===d.domainProductive||c===d.domainNeutral||c===d.domainFrivolous){const p=typeof t.pageUrl=="string"?t.pageUrl:typeof e?.url=="string"?e.url:"",y=D(p);if(!y){await k("Unable to detect a domain for this page.",n);return}const h=c===d.domainProductive?"productive":c===d.domainNeutral?"neutral":"frivolous",b=await oe({domain:y,category:h});if(!b.success){await k(b.error??"Failed to label domain",n);return}const v=b.synced?"Synced to desktop.":"Saved locally. Will sync when desktop is available.";await k(`Marked ${y} as ${h}. ${v}`,n)}});
