const A={wallet:{balance:100,lastSynced:Date.now()},marketRates:{"twitter.com":{domain:"twitter.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"x.com":{domain:"x.com",ratePerMin:3,packs:[{minutes:10,price:25},{minutes:30,price:60}],hourlyModifiers:Array(24).fill(1)},"reddit.com":{domain:"reddit.com",ratePerMin:2,packs:[{minutes:10,price:18},{minutes:30,price:50}],hourlyModifiers:Array(24).fill(1)},"youtube.com":{domain:"youtube.com",ratePerMin:2.5,packs:[{minutes:10,price:23},{minutes:30,price:65}],hourlyModifiers:Array(24).fill(1)}},settings:{frivolityDomains:["twitter.com","x.com","reddit.com","youtube.com","facebook.com","instagram.com","tiktok.com"],productiveDomains:["github.com","stackoverflow.com"],neutralDomains:["gmail.com","calendar.google.com"],idleThreshold:15},sessions:{},lastDesktopSync:0};class O{state=null;async init(){const e=await chrome.storage.local.get("state");e.state?this.state=e.state:(this.state=A,await this.save())}async save(){this.state&&await chrome.storage.local.set({state:this.state})}async getWallet(){return this.state||await this.init(),this.state.wallet}async getBalance(){return(await this.getWallet()).balance}async spendCoins(e){if(this.state||await this.init(),this.state.wallet.balance<e)throw new Error("Insufficient funds");return this.state.wallet.balance-=e,await this.save(),this.state.wallet.balance}async earnCoins(e){return this.state||await this.init(),this.state.wallet.balance+=e,await this.save(),this.state.wallet.balance}async getMarketRate(e){this.state||await this.init();const s=this.state.marketRates[e];return s||(e==="x.com"?this.state.marketRates["twitter.com"]??null:null)}async setMarketRate(e){this.state||await this.init(),this.state.marketRates[e.domain]=e,await this.save()}async isFrivolous(e){this.state||await this.init();const s=[e];return e==="x.com"&&s.push("twitter.com"),this.state.settings.frivolityDomains.some(i=>s.some(a=>a.includes(i)||i.includes(a)))}async getIdleThreshold(){return this.state||await this.init(),this.state.settings.idleThreshold??15}async getSession(e){return this.state||await this.init(),this.state.sessions[e]||null}async setSession(e,s){this.state||await this.init(),this.state.sessions[e]=s,await this.save()}async clearSession(e){this.state||await this.init(),delete this.state.sessions[e],await this.save()}async getAllSessions(){return this.state||await this.init(),this.state.sessions}async getState(){return this.state||await this.init(),this.state}async updateFromDesktop(e){this.state||await this.init(),e.wallet&&(this.state.wallet=e.wallet),e.marketRates&&(this.state.marketRates=e.marketRates),e.settings&&(this.state.settings=e.settings),e.sessions&&(this.state.sessions=e.sessions),this.state.lastDesktopSync=Date.now(),await this.save()}async getLastSyncTime(){return this.state||await this.init(),this.state.lastDesktopSync}}const n=new O,y="http://127.0.0.1:17600",$="ws://127.0.0.1:17600/events";let o=null,f=null,R=null,E=null,k="active",b=Date.now();const w=[];function C(t){if(t.mode!=="pack"||!t.purchasePrice||!t.purchasedSeconds)return 0;const s=Math.max(0,Math.min(t.purchasedSeconds,t.remainingSeconds))/t.purchasedSeconds;return Math.round(t.purchasePrice*s)}n.init().then(()=>{console.log("TimeWellSpent: Storage initialized"),U(),F(),j(),D()});function D(){o||(console.log("Attempting to connect to desktop app..."),o=new WebSocket($),o.onopen=async()=>{console.log("‚úÖ Connected to desktop app"),f&&(clearTimeout(f),f=null),await S(),_()},o.onclose=()=>{console.log("‚ùå Disconnected from desktop app (extension will work offline)"),o=null,L()},o.onerror=t=>{console.error("Desktop connection error:",t),o=null},o.onmessage=t=>{try{const e=JSON.parse(t.data);I(e)}catch(e){console.error("Failed to parse desktop message",e)}})}function L(){f||(f=setTimeout(()=>{f=null,D()},3e4))}async function S(){try{const t=await fetch(`${y}/extension/state`);if(t.ok){const e=await t.json();await n.updateFromDesktop(e),console.log("‚úÖ Synced state from desktop app")}}catch{console.log("Desktop app not available for sync")}}function I(t){if(t.type==="wallet")n.updateFromDesktop({wallet:t.payload});else if(t.type==="market-update")n.updateFromDesktop({marketRates:t.payload});else if(t.type==="paywall-session-started"){const e=t.payload;e?.domain&&n.setSession(e.domain,{domain:e.domain,mode:e.mode,ratePerMin:e.ratePerMin,remainingSeconds:e.remainingSeconds??1/0,startedAt:Date.now(),paused:e.paused??!1,spendRemainder:e.spendRemainder??0,purchasePrice:e.purchasePrice,purchasedSeconds:e.purchasedSeconds,justification:e.justification,lastReminder:e.lastReminder})}else if(t.type==="paywall-session-ended"){if(t.payload?.domain){const{domain:e,reason:s}=t.payload;n.clearSession(e),console.log(`üõë Session ended for ${e} (${s})`),p().then(async i=>{i&&i.url&&i.id&&new URL(i.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to session end`),await m(i.id,e,s))})}}else if(t.type==="paywall-session-paused"){if(t.payload?.domain){const e=t.payload.domain;n.getSession(e).then(s=>{s&&n.setSession(e,{...s,paused:!0})}),p().then(async s=>{s&&s.url&&s.id&&new URL(s.url).hostname.replace(/^www\./,"")===e&&(console.log(`üö´ Immediately blocking ${e} due to pause`),await m(s.id,e,"paused"))})}}else if(t.type==="paywall-session-resumed"){if(t.payload?.domain){const e=t.payload.domain;n.getSession(e).then(s=>{s&&n.setSession(e,{...s,paused:!1})})}}else if(t.type==="paywall-reminder"&&t.payload?.domain){const{domain:e,justification:s}=t.payload;chrome.notifications?.create(`tws-reminder-${e}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${e}${s?` ‚Äî Reason: ${s}`:""}.`})}}chrome.tabs.onActivated.addListener(async t=>{const e=await chrome.tabs.get(t.tabId);e.url&&await T(e.id,e.url,"onActivated"),await h("tab-activated")});chrome.tabs.onUpdated.addListener(async(t,e,s)=>{(e.status==="loading"||e.status==="complete")&&s.url&&await T(t,s.url,`onUpdated:${e.status}`),e.status==="complete"&&s.active&&await h("tab-updated")});chrome.webNavigation.onCommitted.addListener(async t=>{t.frameId===0&&await T(t.tabId,t.url,"webNavigation:onCommitted")});chrome.windows.onFocusChanged.addListener(async()=>{await h("window-focus")});async function T(t,e,s){if(!(!e||!e.startsWith("http")))try{const a=new URL(e).hostname.replace(/^www\./,"");if(await n.isFrivolous(a)){const c=await n.getSession(a);if(c&&!c.paused&&(c.mode==="metered"||c.mode==="emergency"||c.remainingSeconds>0))return;console.log(`üö´ Blocking ${a} (source: ${s})`),await m(t,a)}}catch(i){console.error("Error checking URL:",i)}}function U(){R||(R=setInterval(async()=>{await W(),await h("heartbeat")},15e3))}async function W(){const t=Date.now();if(o&&o.readyState===WebSocket.OPEN)return;const e=await n.getAllSessions(),s=await chrome.tabs.query({active:!0,currentWindow:!0}),i=async()=>{await Promise.all(Object.entries(e).map(([l,u])=>n.setSession(l,{...u,paused:!0})))};if(s.length===0){await i();return}const a=s[0];if(!a.url||!a.url.startsWith("http")){await i();return}const c=new URL(a.url).hostname.replace(/^www\./,""),r=e[c];if(Object.entries(e).forEach(async([l,u])=>{l!==c&&!u.paused?await n.setSession(l,{...u,paused:!0}):l===c&&u.paused&&await n.setSession(l,{...u,paused:!1})}),!!r)if(r.mode==="emergency"){const u=r.lastReminder??r.startedAt;Date.now()-u>3e5&&(r.lastReminder=Date.now(),await n.setSession(c,r),chrome.notifications?.create(`tws-reminder-${c}-${Date.now()}`,{type:"basic",iconUrl:"icons/icon128.png",title:"Emergency access reminder",message:`You are on borrowed time for ${c}${r.justification?` ‚Äî Reason: ${r.justification}`:""}.`}));return}else if(r.mode==="metered"){const l=(await n.getMarketRate(c))?.ratePerMin??r.ratePerMin,u=r.lastTick??r.startedAt,M=Math.max(0,Math.round((t-u)/1e3)),v=l/60*M+(r.spendRemainder??0),g=Math.floor(v),N=v-g;try{g>0&&await n.spendCoins(g),r.ratePerMin=l,r.spendRemainder=N,r.lastTick=t,await n.setSession(c,r)}catch{console.log(`‚ùå Insufficient funds for ${c}`),await n.clearSession(c),a.id&&await m(a.id,c,"insufficient-funds")}}else{const l=r.lastTick??r.startedAt,u=Math.max(0,Math.round((t-l)/1e3));r.remainingSeconds-=u,r.lastTick=t,r.remainingSeconds<=0?(console.log(`‚è∞ Time's up for ${c}`),await n.clearSession(c),a.id&&await m(a.id,c,"time-expired")):await n.setSession(c,r)}}function F(){E||(E=setInterval(async()=>{await h("background")},1e4))}async function j(){const t=await n.getIdleThreshold();chrome.idle.setDetectionInterval(t),chrome.idle.queryState(t,e=>{k=e,e==="active"&&(b=Date.now())}),chrome.idle.onStateChanged.addListener(e=>{k=e,e==="active"&&(b=Date.now())}),chrome.storage.onChanged.addListener(e=>{if(e.state&&e.state.newValue){const s=e.state.newValue,i=e.state.oldValue,a=s.settings?.idleThreshold,d=i?.settings?.idleThreshold;a&&a!==d&&(console.log("Updating idle threshold to",a),chrome.idle.setDetectionInterval(a))}})}async function h(t){const e=await p();if(!e||!e.url)return;const s=new URL(e.url).hostname.replace(/^www\./,""),i=k==="active"?0:Math.floor((Date.now()-b)/1e3),a={type:"activity",reason:t,payload:{timestamp:Date.now(),source:"url",appName:B(),windowTitle:e.title??s,url:e.url,domain:s,idleSeconds:i}};x(a)}async function p(){const t=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t.length===0)return null;const e=t[0];return!e.url||!e.url.startsWith("http")?null:e}function x(t){o&&o.readyState===WebSocket.OPEN?o.send(JSON.stringify(t)):(w.push(t),w.length>50&&w.shift())}function _(){if(!(!o||o.readyState!==WebSocket.OPEN))for(;w.length>0;){const t=w.shift();t&&o.send(JSON.stringify(t))}}function B(){const t=navigator.userAgent.toLowerCase();return t.includes("brave")?"Brave":t.includes("edg/")?"Edge":t.includes("arc")?"Arc":t.includes("firefox")?"Firefox":"Chrome"}async function J(t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content-loader.js"]})}catch{}}async function m(t,e,s){await J(t);try{await chrome.tabs.sendMessage(t,{type:"TWS_PING"})}catch{await new Promise(i=>setTimeout(i,150))}try{await chrome.tabs.sendMessage(t,{type:"BLOCK_SCREEN",payload:{domain:e,reason:s}}),console.log(`üîí Block screen message sent to tab ${t} for ${e}`)}catch(i){console.warn("Failed to send block message",i)}}async function P(t,e){try{const s=await fetch(`${y}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),cache:"no-store"});if(!s.ok)throw new Error("desktop unreachable");const i=await s.json();return await n.updateFromDesktop({sessions:{[i.domain]:{...i,startedAt:Date.now(),paused:!1,spendRemainder:i.spendRemainder??0}}}),await S(),{ok:!0,session:i}}catch(s){return console.log("Desktop purchase failed, falling back to local",s),{ok:!1,error:s.message}}}async function G(t){try{const e=await fetch(`${y}/paywall/emergency`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!e.ok)throw new Error("desktop unreachable");const s=await e.json();return await n.updateFromDesktop({sessions:{[s.domain]:{...s,startedAt:Date.now(),paused:!1,spendRemainder:s.spendRemainder??0}}}),await S(),{ok:!0,session:s}}catch(e){return console.log("Desktop emergency start failed, falling back to local",e),{ok:!1,error:e.message}}}async function K(t){try{if(!(await fetch(`${y}/paywall/end`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:t}),cache:"no-store"})).ok)throw new Error("desktop unreachable");return await S(),{ok:!0}}catch(e){return console.log("Desktop end-session failed, falling back to local",e),{ok:!1,error:e.message}}}chrome.runtime.onMessage.addListener((t,e,s)=>{if(t.type==="GET_STATUS")return Y(t.payload).then(s),!0;if(t.type==="GET_CONNECTION")return q().then(s),!0;if(t.type==="BUY_PACK")return V(t.payload).then(s),!0;if(t.type==="START_METERED")return z(t.payload).then(s),!0;if(t.type==="PAUSE_SESSION")return H(t.payload).then(s),!0;if(t.type==="RESUME_SESSION")return Q(t.payload).then(s),!0;if(t.type==="END_SESSION")return X(t.payload).then(s),!0;if(t.type==="START_EMERGENCY")return Z(t.payload).then(s),!0});async function Y(t){const e=await n.getBalance(),s=await n.getMarketRate(t.domain),i=await n.getSession(t.domain),a=await n.getLastSyncTime();return{balance:e,rate:s,session:i,lastSync:a,desktopConnected:o?.readyState===WebSocket.OPEN}}async function q(){const t=await n.getLastSyncTime(),e=await n.getAllSessions();return{desktopConnected:o?.readyState===WebSocket.OPEN,lastSync:t,sessions:e}}async function V(t){const e=await P("/paywall/packs",{domain:t.domain,minutes:t.minutes});if(e.ok)return{success:!0,session:e.session};const s=await n.getMarketRate(t.domain);if(!s)return{success:!1,error:"No rate configured for this domain"};const i=s.packs.find(a=>a.minutes===t.minutes);if(!i)return{success:!1,error:"Pack not found"};try{await n.spendCoins(i.price);const a={domain:t.domain,mode:"pack",ratePerMin:s.ratePerMin,remainingSeconds:i.minutes*60,startedAt:Date.now(),spendRemainder:0,purchasePrice:i.price,purchasedSeconds:i.minutes*60};return await n.setSession(t.domain,a),console.log(`‚úÖ Purchased ${i.minutes} minutes for ${t.domain} (offline mode)`),{success:!0,session:a}}catch(a){return{success:!1,error:a.message}}}async function z(t){const e=await P("/paywall/metered",{domain:t.domain});if(e.ok)return{success:!0,session:e.session};const s=await n.getMarketRate(t.domain);if(!s)return{success:!1,error:"No rate configured for this domain"};const i={domain:t.domain,mode:"metered",ratePerMin:s.ratePerMin,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0};return await n.setSession(t.domain,i),console.log(`‚úÖ Started metered session for ${t.domain} (offline mode)`),{success:!0,session:i}}async function H(t){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"paywall:pause",payload:t}));const e=await n.getSession(t.domain);return e?(e.paused=!0,await n.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function Q(t){o&&o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({type:"paywall:resume",payload:t}));const e=await n.getSession(t.domain);return e?(e.paused=!1,await n.setSession(t.domain,e),{success:!0}):{success:!1,error:"No session found"}}async function X(t){const e=await n.getSession(t.domain);if(!e)return{success:!1,error:"No session found"};const s=C(e),i=o&&o.readyState===WebSocket.OPEN;i&&o&&o.send(JSON.stringify({type:"paywall:end",payload:{domain:t.domain}})),(i?{ok:!0}:await K(t.domain)).ok||s>0&&await n.earnCoins(s),await n.clearSession(t.domain);const d=await p();return d&&d.url&&d.id&&new URL(d.url).hostname.replace(/^www\./,"")===t.domain&&await m(d.id,t.domain,"ended"),{success:!0,refund:s}}async function Z(t){if(o&&o.readyState===WebSocket.OPEN)return o.send(JSON.stringify({type:"paywall:start-emergency",payload:t})),{success:!0};const e=await G(t);if(e.ok)return{success:!0,session:e.session};const s={domain:t.domain,mode:"emergency",ratePerMin:0,remainingSeconds:1/0,startedAt:Date.now(),spendRemainder:0,justification:t.justification,lastReminder:Date.now()};return await n.setSession(t.domain,s),console.log(`‚úÖ Started emergency session for ${t.domain}`),{success:!0,session:s}}chrome.runtime.onStartup.addListener(()=>{n.init(),D()});
